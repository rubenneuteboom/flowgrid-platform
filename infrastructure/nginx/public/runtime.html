<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowTime ‚Äì Flowgrid</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0b1220;
            --border-default: #334155;
            --accent-primary: #5dd5c0;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            --info: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 1.5rem;
        }
        .header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem; flex-wrap: wrap; }
        .header h1 { font-size: 1.4rem; }
        select, .btn {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            color: var(--text-primary); border-radius: 6px; padding: 0.35rem 0.65rem;
            font-size: 0.8rem; cursor: pointer;
        }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2394a3b8' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.5rem center;
            padding-right: 1.8rem; transition: border-color 0.15s, background-color 0.15s;
        }
        select:hover { border-color: #475569; background-color: #131c2e; }
        select:focus, .btn:focus { outline: none; border-color: var(--accent-primary); }
        .btn-primary { background: rgba(93,213,192,0.15); border-color: var(--accent-primary); color: var(--accent-primary); font-weight: 600; }
        .btn-primary:hover { background: rgba(93,213,192,0.25); }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.78rem; }

        /* Run cards */
        .runs { display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem; }
        .run-card {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: 10px; padding: 1rem; cursor: pointer; transition: border-color 0.15s;
        }
        .run-card:hover { border-color: #475569; }
        .run-card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .run-id { font-family: monospace; font-size: 0.78rem; color: var(--text-muted); }
        .badge {
            font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 10px;
            text-transform: uppercase; letter-spacing: 0.04em;
        }
        .badge-running { background: rgba(59,130,246,0.15); color: var(--info); animation: pulse 2s infinite; }
        .badge-completed { background: rgba(34,197,94,0.15); color: var(--success); }
        .badge-failed { background: rgba(239,68,68,0.15); color: var(--danger); }
        .badge-paused { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-cancelled { background: #334155; color: #94a3b8; }
        .badge-pending { background: #334155; color: #64748b; }
        .badge-waiting_approval { background: rgba(245,158,11,0.15); color: var(--warning); }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        .run-meta { font-size: 0.8rem; color: var(--text-secondary); }

        /* Detail view */
        .detail-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 100; justify-content: center; align-items: center;
        }
        .detail-overlay.show { display: flex; }
        .detail-panel {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh;
            overflow-y: auto; padding: 1.5rem;
        }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .detail-header h2 { font-size: 1.1rem; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }

        /* Pipeline visualization */
        .pipeline {
            display: flex; align-items: center; gap: 0; overflow-x: auto;
            padding: 1rem 0; margin-bottom: 1rem;
        }
        .pipe-step {
            display: flex; flex-direction: column; align-items: center; min-width: 100px;
            cursor: pointer; position: relative;
        }
        .pipe-dot {
            width: 32px; height: 32px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;
            border: 2px solid var(--border-default); background: var(--bg-primary);
        }
        .pipe-dot.running { border-color: var(--info); background: rgba(59,130,246,0.2); animation: pulse 2s infinite; }
        .pipe-dot.completed { border-color: var(--success); background: rgba(34,197,94,0.2); }
        .pipe-dot.failed { border-color: var(--danger); background: rgba(239,68,68,0.2); }
        .pipe-dot.waiting_approval { border-color: var(--warning); background: rgba(245,158,11,0.2); }
        .pipe-dot.pending { border-color: #475569; }
        .pipe-label { font-size: 0.72rem; color: var(--text-secondary); margin-top: 0.3rem; text-align: center; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pipe-arrow { color: var(--border-default); font-size: 1.2rem; margin: 0 0.2rem; }

        /* Step detail */
        .step-details { margin-top: 1rem; }
        .step-card {
            background: var(--bg-primary); border: 1px solid var(--border-default);
            border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem;
        }
        .step-card-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .step-card-meta { display: flex; gap: 0.6rem; align-items: center; font-size: 0.72rem; color: var(--text-muted); margin-top: 0.3rem; }
        .step-card-body { display: none; margin-top: 0.6rem; font-size: 0.82rem; color: var(--text-secondary); }
        .step-card-body.show { display: block; }
        .step-card-body pre {
            background: var(--bg-secondary); border-radius: 6px; padding: 0.5rem;
            overflow-x: auto; font-size: 0.75rem; max-height: 200px; margin-top: 0.3rem;
        }

        /* Data toggle buttons */
        .data-toggles { display: flex; gap: 0.4rem; margin-top: 0.5rem; }
        .data-toggle-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            color: var(--text-muted); border-radius: 6px; padding: 0.2rem 0.5rem;
            font-size: 0.72rem; cursor: pointer; transition: all 0.15s;
        }
        .data-toggle-btn:hover { border-color: var(--accent-primary); color: var(--text-secondary); }
        .data-toggle-btn.active { border-color: var(--accent-primary); color: var(--accent-primary); background: rgba(93,213,192,0.08); }
        .data-panel {
            display: none; margin-top: 0.4rem; border-radius: 6px;
            background: #0b1220; border: 1px solid var(--border-default); overflow: hidden;
        }
        .data-panel.show { display: block; }
        .data-panel-content {
            padding: 0.6rem; font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.73rem; line-height: 1.5; overflow-x: auto; max-height: 300px; overflow-y: auto;
        }
        .data-panel-content .json-key { color: #60a5fa; }
        .data-panel-content .json-str { color: #5dd5c0; }
        .data-panel-content .json-num { color: #f59e0b; }
        .data-panel-content .json-bool { color: #c084fc; }
        .data-panel-content .json-null { color: #64748b; }
        .show-more-btn {
            background: none; border: none; color: var(--accent-primary); cursor: pointer;
            font-size: 0.72rem; padding: 0.3rem 0.6rem; opacity: 0.8;
        }
        .show-more-btn:hover { opacity: 1; text-decoration: underline; }

        /* Data flow indicator between steps */
        .pipe-flow-indicator {
            position: relative; cursor: pointer;
        }
        .pipe-flow-indicator .pipe-arrow { transition: color 0.15s; }
        .pipe-flow-indicator:hover .pipe-arrow { color: var(--accent-primary); }
        .flow-tooltip {
            display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background: var(--bg-primary); border: 1px solid var(--border-default); border-radius: 8px;
            padding: 0.5rem; font-size: 0.7rem; white-space: nowrap; z-index: 10; min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .pipe-flow-indicator:hover .flow-tooltip,
        .flow-tooltip.show { display: block; }
        .flow-field { padding: 1px 0; }
        .flow-field.matched { color: var(--success); }
        .flow-field.passthrough { color: var(--text-muted); }

        /* Flow summary panel */
        .flow-summary {
            background: var(--bg-primary); border: 1px solid var(--border-default);
            border-radius: 8px; margin-bottom: 1rem; overflow: hidden;
        }
        .flow-summary-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0.8rem; cursor: pointer; font-size: 0.85rem; font-weight: 600;
        }
        .flow-summary-header:hover { background: rgba(93,213,192,0.05); }
        .flow-summary-body { display: none; padding: 0 0.8rem 0.8rem; font-size: 0.8rem; }
        .flow-summary-body.show { display: block; }
        .flow-summary-row { display: flex; gap: 0.5rem; padding: 0.3rem 0; border-bottom: 1px solid rgba(51,65,85,0.4); }
        .flow-summary-row:last-child { border-bottom: none; }
        .flow-summary-label { color: var(--text-muted); min-width: 90px; font-size: 0.75rem; }
        .flow-summary-value { color: var(--text-secondary); word-break: break-word; }
        .flow-summary-value pre {
            background: #0b1220; border-radius: 4px; padding: 0.3rem 0.5rem;
            font-size: 0.72rem; max-height: 120px; overflow: auto; margin: 0;
        }

        /* Modal for new run */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 200; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            border-radius: 12px; padding: 1.5rem; width: 500px; max-width: 90%;
        }
        .modal h3 { margin-bottom: 1rem; }
        .modal textarea {
            width: 100%; height: 120px; background: var(--bg-primary); border: 1px solid var(--border-default);
            border-radius: 6px; color: var(--text-primary); padding: 0.5rem; font-family: monospace;
            font-size: 0.82rem; resize: vertical;
        }
        .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; }
        .empty { text-align: center; color: var(--text-muted); padding: 3rem 0; font-size: 0.9rem; }
        .filter-bar { display: flex; gap: 0.5rem; margin-top: 0.8rem; }
    </style>
</head>
<body>
    <div class="header" style="flex-direction:column;align-items:stretch;gap:0.6rem;">
        <h1 style="font-size:1.3rem;">‚è±Ô∏è FlowTime</h1>
        <div style="display:grid;grid-template-columns:5rem 1fr 6.5rem;align-items:center;gap:0.4rem 0.5rem;">
            <label style="font-size:0.75rem;color:var(--text-secondary);">Foundation</label>
            <select id="foundation-select"><option value="">Select a foundation‚Ä¶</option></select>
            <button class="btn btn-primary" id="deploy-btn" style="width:100%;text-align:center;">üöÄ Deploy</button>
            <label style="font-size:0.75rem;color:var(--text-secondary);">Workflow</label>
            <select id="orchestrator-filter"><option value="">Select a workflow‚Ä¶</option></select>
            <button class="btn btn-primary" id="run-btn" style="width:100%;text-align:center;">‚ñ∂Ô∏è New Run</button>
        </div>
    </div>
    <div class="filter-bar">
        <button class="btn btn-sm filter-btn active" data-status="">All</button>
        <button class="btn btn-sm filter-btn" data-status="running">Running</button>
        <button class="btn btn-sm filter-btn" data-status="paused">Paused</button>
        <button class="btn btn-sm filter-btn" data-status="completed">Completed</button>
        <button class="btn btn-sm filter-btn" data-status="failed">Failed</button>
        <span style="flex:1;"></span>
        <button class="btn btn-sm" onclick="clearAllRuns()" style="color:var(--danger);border-color:var(--danger);opacity:0.7;" title="Delete all runs for this foundation">üóëÔ∏è Clear Runs</button>
    </div>
    <div class="runs" id="runs-list"><div class="empty">Select a deployed foundation to see runs</div></div>

    <!-- New Run Modal -->
    <div class="modal-overlay" id="run-modal">
        <div class="modal">
            <h3>Start New Run</h3>
            <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:0.5rem">Describe what you want the agents to do:</p>
            <textarea id="run-input" style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:0.85rem;" placeholder="e.g. Create 3 t-shirt designs for a summer music festival with a tropical theme"></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="document.getElementById('run-modal').classList.remove('show')">Cancel</button>
                <button class="btn btn-primary" id="start-run-btn">‚ñ∂Ô∏è Start</button>
            </div>
        </div>
    </div>

    <!-- Run Detail Overlay -->
    <div class="detail-overlay" id="detail-overlay">
        <div class="detail-panel" id="detail-panel"></div>
    </div>

    <script src="/js/auth-ui.js"></script>
    <script>
    const API_BASE = '/api/runtime';
    let currentFilter = '';
    let pollTimer = null;

    function getHeaders() {
        const token = window.FlowgridAuthUI?.getAuthToken();
        return token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    }

    async function apiFetch(path, opts = {}) {
        const resp = await fetch(API_BASE + path, { headers: getHeaders(), ...opts });
        if (!resp.ok) throw new Error((await resp.json().catch(() => ({}))).error || resp.statusText);
        return resp.json();
    }

    // Load foundations (all, not just deployed)
    async function loadFoundations() {
        try {
            const resp = await fetch('/api/wizard/foundations', { headers: getHeaders() });
            if (!resp.ok) return;
            const data = await resp.json();
            const sel = document.getElementById('foundation-select');
            const foundations = data.foundations || data.data || [];
            foundations.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = f.name + (f.deployed_at ? ' ‚úÖ' : '');
                sel.appendChild(opt);
            });
        } catch (e) { console.error('Failed to load foundations:', e); }
    }

    // Load runs
    async function loadRuns() {
        const foundationId = document.getElementById('foundation-select').value;
        const list = document.getElementById('runs-list');
        try {
            let path = '/runs';
            const params = [];
            if (currentFilter) params.push(`status=${currentFilter}`);
            if (params.length) path += '?' + params.join('&');
            const data = await apiFetch(path);
            const runs = (data.data || []).filter(r => !foundationId || r.foundation_id === foundationId);
            if (runs.length === 0) {
                list.innerHTML = '<div class="empty">No runs found</div>';
                return;
            }
            list.innerHTML = runs.map(r => `
                <div class="run-card" onclick="showRunDetail('${r.id}')">
                    <div class="run-card-top">
                        <span class="run-id">${r.id.slice(0,8)}‚Ä¶</span>
                        <span style="display:flex;align-items:center;gap:0.4rem;">
                            <span class="badge badge-${r.status}">${r.status}</span>
                            <button class="btn btn-sm" onclick="event.stopPropagation();deleteRun('${r.id}')" style="color:var(--danger);border-color:transparent;padding:0.15rem 0.4rem;opacity:0.6;" title="Delete run">üóëÔ∏è</button>
                        </span>
                    </div>
                    <div class="run-meta">
                        <strong>${r.foundation_name || 'Foundation'}</strong> ¬∑ ${new Date(r.started_at).toLocaleString()}
                        ${r.completed_at ? ' ¬∑ ' + timeDiff(r.started_at, r.completed_at) : ''}
                    </div>
                </div>
            `).join('');
        } catch (e) {
            list.innerHTML = `<div class="empty" style="color:var(--danger)">${e.message}</div>`;
        }
    }

    function timeDiff(a, b) {
        const ms = new Date(b) - new Date(a);
        if (ms < 1000) return ms + 'ms';
        if (ms < 60000) return (ms/1000).toFixed(1) + 's';
        return (ms/60000).toFixed(1) + 'min';
    }

    // Show run detail
    async function showRunDetail(runId) {
        const overlay = document.getElementById('detail-overlay');
        const panel = document.getElementById('detail-panel');
        overlay.classList.add('show');
        panel.innerHTML = '<div class="empty">Loading‚Ä¶</div>';

        try {
            const data = await apiFetch(`/runs/${runId}`);
            renderDetail(data, panel);

            // Start polling if running/paused
            if (['running', 'paused'].includes(data.status)) {
                if (pollTimer) clearInterval(pollTimer);
                let lastStepHash = '';
                pollTimer = setInterval(async () => {
                    try {
                        const updated = await apiFetch(`/runs/${runId}`);
                        // Only re-render if steps changed (avoids collapsing expanded panels)
                        const stepHash = (updated.steps||[]).map(s => s.id + s.status).join(',');
                        if (stepHash !== lastStepHash) {
                            lastStepHash = stepHash;
                            renderDetail(updated, panel);
                        }
                        if (!['running', 'paused'].includes(updated.status)) clearInterval(pollTimer);
                    } catch (e) { /* ignore */ }
                }, 3000);
            }
        } catch (e) {
            panel.innerHTML = `<div class="empty" style="color:var(--danger)">${e.message}</div>`;
        }
    }

    function byteSize(data) {
        if (!data) return '0B';
        const bytes = new Blob([JSON.stringify(data)]).size;
        if (bytes < 1024) return bytes + 'B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + 'KB';
        return (bytes / 1048576).toFixed(1) + 'MB';
    }

    function syntaxHighlight(json) {
        if (json === null || json === undefined) return '<span class="json-null">null</span>';
        const str = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/"([^"]+)"(\s*:)/g, '<span class="json-key">"$1"</span>$2')
            .replace(/: "([^"]*)"/g, ': <span class="json-str">"$1"</span>')
            .replace(/: (\d+\.?\d*)/g, ': <span class="json-num">$1</span>')
            .replace(/: (true|false)/g, ': <span class="json-bool">$1</span>')
            .replace(/: (null)/g, ': <span class="json-null">$1</span>');
    }

    function renderImageGallery(images) {
        if (!images || !images.length) return '';
        return `<div style="display:flex;flex-wrap:wrap;gap:0.8rem;margin-top:0.6rem;">
            ${images.map(img => `<div style="flex:1;min-width:200px;max-width:400px;">
                <a href="${img.url}" target="_blank" rel="noopener" style="display:block;">
                    <img src="${img.url}" alt="${img.theme || 'Generated image'}" style="width:100%;border-radius:8px;border:1px solid var(--border-default);cursor:zoom-in;" loading="lazy">
                </a>
                <div style="font-size:0.72rem;color:var(--text-secondary);margin-top:0.3rem;">
                    <strong style="color:var(--accent-primary);">${img.theme || 'Image'}</strong>
                    ${img.prompt ? `<br><span style="color:var(--text-muted);">${img.prompt.length > 120 ? img.prompt.slice(0, 120) + '‚Ä¶' : img.prompt}</span>` : ''}
                </div>
            </div>`).join('')}
        </div>
        <div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.4rem;">‚ö†Ô∏è Image URLs expire after ~1 hour (OpenAI limitation)</div>`;
    }

    function renderDataPanel(data, id) {
        if (!data) return `<div class="data-panel" id="${id}"><div class="data-panel-content" style="color:var(--text-muted)">No data</div></div>`;

        // Check for images in output data
        let imagesHtml = '';
        if (data && typeof data === 'object' && Array.isArray(data.images) && data.images.length > 0) {
            imagesHtml = renderImageGallery(data.images);
        }

        const full = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        const truncated = full.length > 300;
        const display = truncated ? full.slice(0, 300) + '‚Ä¶' : full;
        const highlighted = typeof data === 'object' ? syntaxHighlight(data) : display;
        const truncHighlighted = truncated ? (display.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')) : highlighted;
        return `<div class="data-panel" id="${id}">
            ${imagesHtml ? `<div class="data-panel-content">${imagesHtml}</div>` : ''}
            <div class="data-panel-content"><pre style="margin:0;background:none;padding:0;max-height:none" id="${id}-pre">${truncated ? truncHighlighted : highlighted}</pre></div>
            ${truncated ? `<button class="show-more-btn" onclick="toggleFullData('${id}', this)" data-full="${btoa(unescape(encodeURIComponent(highlighted)))}">Show more (${full.length} chars)</button>` : ''}
        </div>`;
    }

    function toggleFullData(id, btn) {
        const pre = document.getElementById(id + '-pre');
        if (btn.textContent.startsWith('Show more')) {
            pre.innerHTML = decodeURIComponent(escape(atob(btn.dataset.full)));
            btn.textContent = 'Show less';
        } else {
            // Re-truncate
            const full = decodeURIComponent(escape(atob(btn.dataset.full)));
            pre.innerHTML = full.slice(0, 600) + '‚Ä¶';
            btn.textContent = 'Show more';
        }
    }

    function toggleDataPanel(stepIdx, type) {
        const panel = document.getElementById(`data-${type}-${stepIdx}`);
        const btn = document.getElementById(`btn-${type}-${stepIdx}`);
        if (panel) { panel.classList.toggle('show'); }
        if (btn) { btn.classList.toggle('active'); }
    }

    function getFlowFields(outputData, inputData) {
        if (!outputData || !inputData || typeof outputData !== 'object' || typeof inputData !== 'object') return [];
        const outKeys = Object.keys(outputData);
        const inKeys = Object.keys(inputData);
        const fields = [];
        const passKeys = ['request', 'flow_id', 'run_id', 'foundation_id', 'context'];
        outKeys.forEach(k => {
            if (inKeys.includes(k)) {
                fields.push({ key: k, matched: true, passthrough: passKeys.includes(k) });
            }
        });
        inKeys.forEach(k => {
            if (!outKeys.includes(k) && passKeys.includes(k)) {
                fields.push({ key: k, matched: false, passthrough: true });
            }
        });
        return fields;
    }

    function renderFlowSummary(data, steps) {
        const firstStep = steps[0];
        const lastCompleted = [...steps].reverse().find(s => s.status === 'completed');
        const gatewaySteps = steps.filter(s => s.step_type === 'gateway');
        const inputPreview = firstStep?.input_data ? JSON.stringify(firstStep.input_data).slice(0, 200) : 'N/A';
        const outputPreview = lastCompleted?.output_data ? JSON.stringify(lastCompleted.output_data).slice(0, 200) : 'N/A';
        const duration = data.started_at && data.completed_at ? timeDiff(data.started_at, data.completed_at) : 'In progress‚Ä¶';

        return `<div class="flow-summary">
            <div class="flow-summary-header" onclick="this.nextElementSibling.classList.toggle('show')">
                <span>üìä Flow Summary</span><span style="font-size:0.75rem;color:var(--text-muted)">‚ñº</span>
            </div>
            <div class="flow-summary-body">
                <div class="flow-summary-row">
                    <span class="flow-summary-label">Duration</span>
                    <span class="flow-summary-value">${duration}</span>
                </div>
                <div class="flow-summary-row">
                    <span class="flow-summary-label">Input</span>
                    <span class="flow-summary-value"><pre>${syntaxHighlight(firstStep?.input_data)}</pre></span>
                </div>
                <div class="flow-summary-row">
                    <span class="flow-summary-label">Final Output</span>
                    <span class="flow-summary-value"><pre>${lastCompleted ? syntaxHighlight(lastCompleted.output_data) : '<span style="color:var(--text-muted)">No output yet</span>'}</pre></span>
                </div>
                ${gatewaySteps.length ? `<div class="flow-summary-row">
                    <span class="flow-summary-label">Routing</span>
                    <span class="flow-summary-value">${gatewaySteps.map(g => `‚óá ${g.step_name || g.step_key} ‚Üí ${g.agent_name || 'auto'}`).join('<br>')}</span>
                </div>` : ''}
            </div>
        </div>`;
    }

    function renderDetail(data, panel) {
        const steps = data.steps || [];
        panel.innerHTML = `
            <div class="detail-header">
                <h2>${data.foundation_name} <span class="badge badge-${data.status}">${data.status}</span></h2>
                <button class="close-btn" onclick="closeDetail()">‚úï</button>
            </div>
            <div style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:0.5rem">
                Run ${data.id.slice(0,8)}‚Ä¶ ¬∑ Started ${new Date(data.started_at).toLocaleString()}
                ${data.completed_at ? ' ¬∑ Duration: ' + timeDiff(data.started_at, data.completed_at) : ''}
            </div>
            ${data.error ? `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:0.6rem;margin-bottom:0.8rem;font-size:0.82rem;color:var(--danger)">${data.error}</div>` : ''}
            ${data.status === 'paused' ? `<button class="btn btn-primary btn-sm" onclick="resumeRun('${data.id}')" style="margin-bottom:0.8rem">‚ñ∂Ô∏è Resume Run</button>` : ''}
            ${renderFlowSummary(data, steps)}
            <div class="pipeline">
                ${steps.map((s, i) => {
                    const flowFields = i > 0 ? getFlowFields(steps[i-1].output_data, s.input_data) : [];
                    const flowHtml = flowFields.length > 0
                        ? `<div class="pipe-flow-indicator">
                            <span class="pipe-arrow">‚Üí</span>
                            <div class="flow-tooltip">
                                <div style="font-weight:600;margin-bottom:3px;color:var(--text-primary)">Data Flow</div>
                                ${flowFields.map(f => `<div class="flow-field ${f.passthrough ? 'passthrough' : 'matched'}">${f.passthrough ? '‚óã' : '‚óè'} ${f.key}</div>`).join('')}
                            </div>
                           </div>`
                        : (i > 0 ? '<span class="pipe-arrow">‚Üí</span>' : '');
                    return `${flowHtml}
                    <div class="pipe-step" onclick="toggleStep('step-${i}')">
                        <div class="pipe-dot ${s.status}">${stepIcon(s.step_type)}</div>
                        <div class="pipe-label" title="${s.step_name || s.step_key}">${s.step_name || s.step_key}</div>
                    </div>`;
                }).join('')}
            </div>
            <div class="step-details">
                ${steps.map((s, i) => `
                    <div class="step-card" id="step-${i}">
                        <div class="step-card-header" onclick="toggleStep('step-${i}')">
                            <span><span class="badge badge-${s.status}">${s.status}</span> ${s.step_name || s.step_key} ${s.agent_name ? '(' + s.agent_name + ')' : ''}</span>
                            <span style="font-size:0.75rem;color:var(--text-muted)">${s.started_at ? timeDiff(s.started_at, s.completed_at || new Date().toISOString()) : '‚Äî'}</span>
                        </div>
                        <div class="step-card-meta">
                            <span>üì• ${byteSize(s.input_data)} ‚Üí üì§ ${byteSize(s.output_data)}</span>
                            ${s.started_at && s.completed_at ? `<span>‚è± ${timeDiff(s.started_at, s.completed_at)}</span>` : ''}
                        </div>
                        ${s.error ? `<div style="color:var(--danger);font-size:0.78rem;margin-top:0.3rem">‚ùå ${s.error}</div>` : ''}
                        ${s.step_type === 'human' && s.status === 'waiting_approval' ? '<div style="color:var(--warning);font-size:0.78rem;margin-top:0.3rem">‚è≥ Waiting for approval</div>' : ''}
                        <div class="data-toggles">
                            <button class="data-toggle-btn" id="btn-input-${i}" onclick="event.stopPropagation();toggleDataPanel(${i},'input')">üì• Input</button>
                            <button class="data-toggle-btn" id="btn-output-${i}" onclick="event.stopPropagation();toggleDataPanel(${i},'output')">üì§ Output</button>
                        </div>
                        ${renderDataPanel(s.input_data, 'data-input-' + i)}
                        ${renderDataPanel(s.output_data, 'data-output-' + i)}
                    </div>
                `).join('')}
            </div>
        `;
    }

    function stepIcon(type) {
        switch(type) {
            case 'start': return '‚ñ∂';
            case 'end': return '‚èπ';
            case 'human': return 'üë§';
            case 'gateway': return '‚óá';
            default: return '‚öô';
        }
    }

    function toggleStep(id) {
        const body = document.getElementById('step-body-' + id.replace('step-', ''));
        if (body) body.classList.toggle('show');
    }

    function closeDetail() {
        document.getElementById('detail-overlay').classList.remove('show');
        if (pollTimer) clearInterval(pollTimer);
        loadRuns();
    }

    async function resumeRun(runId) {
        try {
            await apiFetch(`/runs/${runId}/resume`, { method: 'POST' });
            showRunDetail(runId);
        } catch (e) { alert('Resume failed: ' + e.message); }
    }

    // Deploy
    document.getElementById('deploy-btn').addEventListener('click', async () => {
        const fId = document.getElementById('foundation-select').value;
        if (!fId) return alert('Select a foundation first');
        try {
            const data = await apiFetch(`/foundations/${fId}/deploy`, { method: 'POST' });
            alert('Deployed! Orchestrator: ' + data.orchestratorAgent);
            // Reload foundations to show checkmark
            document.getElementById('foundation-select').innerHTML = '<option value="">Select a foundation‚Ä¶</option>';
            await loadFoundations();
            document.getElementById('foundation-select').value = fId;
        } catch (e) { alert('Deploy failed: ' + e.message); }
    });

    // New Run
    document.getElementById('run-btn').addEventListener('click', () => {
        const fId = document.getElementById('foundation-select').value;
        if (!fId) return alert('Select a foundation first');
        const orchId = document.getElementById('orchestrator-filter').value;
        if (!orchId) return alert('Select a workflow first');
        document.getElementById('run-modal').classList.add('show');
    });

    document.getElementById('start-run-btn').addEventListener('click', async () => {
        const fId = document.getElementById('foundation-select').value;
        const orchestratorId = document.getElementById('orchestrator-filter').value;
        const rawInput = document.getElementById('run-input').value.trim();
        if (!rawInput) return alert('Please describe what you want the agents to do');
        let input;
        try { input = JSON.parse(rawInput); } catch { input = { request: rawInput }; }
        document.getElementById('run-modal').classList.remove('show');
        try {
            const data = await apiFetch(`/foundations/${fId}/run`, {
                method: 'POST',
                body: JSON.stringify({ input, orchestratorId })
            });
            loadRuns();
            setTimeout(() => showRunDetail(data.runId), 500);
        } catch (e) { alert('Start run failed: ' + e.message); }
    });

    // Filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.status;
            loadRuns();
        });
    });

    // Foundation change
    document.getElementById('foundation-select').addEventListener('change', async () => {
        loadRuns();
        // Populate orchestrator dropdown
        const fId = document.getElementById('foundation-select').value;
        const orchSel = document.getElementById('orchestrator-filter');
        orchSel.innerHTML = '<option value="">Select a workflow‚Ä¶</option>';
        if (!fId) return;
        try {
            const res = await fetch(`/api/agents?limit=500`, { headers: getHeaders() });
            const data = await res.json();
            const agents = (data.data || data).filter(a => a.config?.foundationId === fId);
            const orchestrators = agents.filter(a => a.config?.pattern === 'orchestrator' && a.config?.bpmnXml);
            orchestrators.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.id;
                opt.textContent = o.name.replace(/ Agent$/, '');
                orchSel.appendChild(opt);
            });
            if (orchestrators.length === 1) orchSel.value = orchestrators[0].id;
        } catch (e) { console.error('Failed to load orchestrators:', e); }
    });

    // Close overlays on escape
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            document.getElementById('run-modal').classList.remove('show');
            closeDetail();
        }
    });
    document.getElementById('detail-overlay').addEventListener('click', e => {
        if (e.target === e.currentTarget) closeDetail();
    });

    async function deleteRun(runId) {
        if (!confirm('Delete this run?')) return;
        try {
            await fetch(`${API_BASE}/runs/${runId}`, { method: 'DELETE', headers: getHeaders() });
            loadRuns();
        } catch (e) { console.error('Failed to delete run:', e); }
    }

    async function clearAllRuns() {
        const fId = document.getElementById('foundation-select').value;
        if (!fId) return alert('Select a foundation first');
        const orchId = document.getElementById('orchestrator-filter').value;
        const label = orchId ? 'this workflow' : 'this foundation';
        if (!confirm(`Delete all runs for ${label}?`)) return;
        try {
            const qs = orchId ? `?orchestrator_id=${orchId}` : '';
            await fetch(`${API_BASE}/foundations/${fId}/runs${qs}`, { method: 'DELETE', headers: getHeaders() });
            loadRuns();
        } catch (e) { console.error('Failed to clear runs:', e); }
    }

    // Init
    loadFoundations();
    loadRuns();
    </script>
</body>
</html>
