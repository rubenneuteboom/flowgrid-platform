<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowgrid Platform</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0b1220;
            --border-default: #334155;
            --border-hover: #475569;
            --accent-primary: #5dd5c0;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-shell {
            display: none;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            min-width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            padding: 1rem 0.8rem;
        }

        .brand {
            padding: 0.4rem 0.5rem 1rem;
            border-bottom: 1px solid var(--border-default);
            margin-bottom: 0.9rem;
        }

        .brand h1 {
            font-size: 1rem;
            color: var(--accent-primary);
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .brand p {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .nav-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .nav-label {
            color: var(--text-muted);
            font-size: 0.72rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin: 0.3rem 0.25rem;
        }

        .nav-link {
            text-align: left;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            padding: 0.55rem 0.7rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .nav-link:hover {
            background: #243245;
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .nav-link.active {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(93, 213, 192, 0.08);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-default);
            padding-top: 0.8rem;
        }

        .sign-out-link {
            color: var(--text-muted);
        }
        .sign-out-link:hover {
            color: var(--danger) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
            background: rgba(239, 68, 68, 0.08) !important;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-tertiary);
        }

        .content-header {
            height: 52px;
            padding: 0 1rem;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.86rem;
            background: var(--bg-secondary);
        }

        #active-title { color: var(--text-primary); font-weight: 600; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .frame-wrap {
            flex: 1;
            min-height: 0;
            position: relative;
        }

        #module-frame {
            width: 100%;
            height: 100%;
            border: 0;
            background: var(--bg-primary);
        }

        .boot-state {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-direction: column;
            gap: 0.8rem;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error { color: var(--danger); }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="boot" class="boot-state">
        <div class="spinner"></div>
        <p>Loading workspace‚Ä¶</p>
    </div>

    <div id="app-shell" class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <h1>Flowgrid</h1>
                <p>Platform workspace</p>
            </div>

            <div class="nav-group" id="module-links">
                <div class="nav-label">Modules</div>
                <button class="nav-link" data-url="/design/" data-title="FlowGrid Design Studio">üé® FlowGrid Design Studio</button>
                <button class="nav-link" data-url="/runtime.html" data-title="FlowGrid Simulate">üß™ FlowGrid Simulate</button>
            </div>

            <div class="sidebar-footer nav-group">
                <button class="nav-link" data-url="/approvals.html" data-title="Approvals" id="nav-approvals">üìã Approvals <span id="approval-badge" style="display:none;background:var(--accent-primary);color:#0f172a;border-radius:10px;padding:0 6px;font-size:0.72rem;font-weight:700;margin-left:4px"></span></button>
                <hr style="border:none;border-top:1px solid #334155;margin:0.5rem 0;">
                <div class="nav-label">Account</div>
                <button class="nav-link" data-url="/profile.html" data-title="Profile">üë§ Profile</button>
                <button class="nav-link" data-url="/settings.html" data-title="Settings">‚öôÔ∏è Settings</button>
                <button class="nav-link sign-out-link" id="shell-sign-out">üö™ Sign Out</button>
            </div>
        </aside>

        <section class="content">
            <div class="content-header">
                <span id="active-title">Flowgrid</span>
                <div class="user-info">
                    <span id="user-display-name"></span>
                </div>
            </div>
            <div class="frame-wrap">
                <iframe id="module-frame" title="Flowgrid Module"></iframe>
            </div>
        </section>
    </div>

    <script src="/js/auth-ui.js"></script>
    <script>
      const shellEl = document.getElementById('app-shell');
      const bootEl = document.getElementById('boot');
      const frameEl = document.getElementById('module-frame');
      const titleEl = document.getElementById('active-title');
      const navLinks = Array.from(document.querySelectorAll('.nav-link[data-url]'));

      function getAuthHeaders(extra = {}) {
        const token = window.FlowgridAuthUI.getAuthToken();
        return token ? { ...extra, Authorization: `Bearer ${token}` } : { ...extra };
      }

      async function isTenantPopulated() {
        const cacheBuster = `_t=${Date.now()}`;
        const response = await fetch(`/api/wizard/foundations?limit=1&${cacheBuster}`, {
          headers: getAuthHeaders(),
          credentials: 'include',
          cache: 'no-store'
        });

        if (response.status === 401 || response.status === 403) return null;

        if (!response.ok) {
          console.warn('[bootstrap] Foundations check failed, treating as empty');
          return false;
        }

        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) return false;

        const payload = await response.json();
        if (payload?.success === false) return false;
        if (Array.isArray(payload?.foundations)) return payload.foundations.length > 0;
        const total = payload?.meta?.total ?? payload?.total;
        return Number.isFinite(total) ? total > 0 : Array.isArray(payload?.data) && payload.data.length > 0;
      }

      function activateNav(activeButton) {
        navLinks.forEach(btn => btn.classList.toggle('active', btn === activeButton));
      }

      function loadModule(button) {
        const url = button.dataset.url;
        const title = button.dataset.title || 'Flowgrid';
        if (!url) return;
        frameEl.src = url;
        titleEl.textContent = title;
        activateNav(button);
      }

      function loadModuleByUrl(url, title) {
        const matchingButton = navLinks.find(btn => btn.dataset.url === url);
        if (matchingButton) {
          loadModule(matchingButton);
        } else {
          frameEl.src = url;
          titleEl.textContent = title || 'Flowgrid';
          navLinks.forEach(btn => btn.classList.remove('active'));
        }
      }

      // Expose for iframes (e.g., wizard completion ‚Üí navigate to design)
      window.loadModuleByUrl = loadModuleByUrl;

      function showShell() {
        bootEl.style.display = 'none';
        shellEl.style.display = 'flex';
      }

      function setupNav() {
        navLinks.forEach(button => {
          button.addEventListener('click', () => loadModule(button));
        });
      }

      function setupSignOut() {
        const btn = document.getElementById('shell-sign-out');
        if (btn && window.FlowgridAuthUI) {
          btn.addEventListener('click', () => {
            window.FlowgridAuthUI.signOut();
          });
        }
      }

      function showUserInfo() {
        try {
          const token = window.FlowgridAuthUI.getAuthToken();
          if (!token) return;
          const payload = JSON.parse(atob(token.split('.')[1]));
          const nameEl = document.getElementById('user-display-name');
          if (nameEl && payload.name) {
            nameEl.textContent = `üë§ ${payload.name}`;
          } else if (nameEl && payload.email) {
            nameEl.textContent = `üë§ ${payload.email}`;
          }
        } catch (e) { /* ignore */ }
      }

      async function bootstrap() {
        // Check auth
        if (!window.FlowgridAuthUI.isAuthenticated()) {
          window.FlowgridAuthUI.initPage({ requireAuth: true });
          return;
        }

        window.FlowgridAuthUI.initPage({ requireAuth: true, showSignOut: false });

        try {
          const populated = await isTenantPopulated();

          if (populated === null) {
            // Auth failed ‚Äî redirect to login
            const target = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.replace(`/login.html?redirect=${target}`);
            return;
          }

          // Always show the shell ‚Äî never redirect away
          showShell();
          setupNav();
          setupSignOut();
          showUserInfo();

          if (!populated) {
            // No foundations yet ‚Äî load wizard inside the iframe
            frameEl.src = '/wizard.html?onboarding=true';
            titleEl.textContent = 'Foundation Wizard';
          } else {
            // Load Design Studio by default
            const defaultButton = navLinks.find(btn => btn.dataset.url === '/design/') || navLinks[0];
            if (defaultButton) loadModule(defaultButton);
          }
        } catch (error) {
          console.error('[index-shell] bootstrap failed', error);
          // Still show the shell with an error state rather than a blank page
          showShell();
          setupNav();
          setupSignOut();
          frameEl.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ef4444;font-family:sans-serif;"><p>Failed to load workspace. Please refresh.</p></div>';
        }
      }

      document.addEventListener('DOMContentLoaded', bootstrap);

      // Approval badge polling
      async function updateApprovalBadge() {
        try {
          const token = window.FlowgridAuthUI?.getAuthToken();
          if (!token) return;
          const resp = await fetch('/api/approvals/stats', { headers: { Authorization: `Bearer ${token}` } });
          if (!resp.ok) return;
          const stats = await resp.json();
          const badge = document.getElementById('approval-badge');
          if (badge) {
            if (stats.pending > 0) {
              badge.textContent = stats.pending;
              badge.style.display = 'inline';
            } else {
              badge.style.display = 'none';
            }
          }
        } catch (e) { /* silent */ }
      }
      setInterval(updateApprovalBadge, 30000);
      setTimeout(updateApprovalBadge, 2000);
    </script>
</body>
</html>
