<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowgrid Platform</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #0b1220;
            --border-default: #334155;
            --border-hover: #475569;
            --accent-primary: #5dd5c0;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-shell {
            display: none;
            height: 100vh;
        }

        .sidebar {
            width: 230px;
            min-width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            padding: 1rem 0.8rem;
        }

        .brand {
            padding: 0.4rem 0.5rem 1rem;
            border-bottom: 1px solid var(--border-default);
            margin-bottom: 0.9rem;
        }

        .brand h1 {
            font-size: 1rem;
            color: var(--accent-primary);
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .brand p {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .nav-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .nav-label {
            color: var(--text-muted);
            font-size: 0.72rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin: 0.3rem 0.25rem;
        }

        .nav-link {
            text-align: left;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            padding: 0.55rem 0.7rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .nav-link:hover {
            background: #243245;
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .nav-link.active {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(93, 213, 192, 0.08);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-default);
            padding-top: 0.8rem;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-tertiary);
        }

        .content-header {
            height: 52px;
            padding: 0 1rem;
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.86rem;
            background: var(--bg-secondary);
        }

        #active-title { color: var(--text-primary); font-weight: 600; }

        .frame-wrap {
            flex: 1;
            min-height: 0;
            position: relative;
        }

        #module-frame {
            width: 100%;
            height: 100%;
            border: 0;
            background: var(--bg-primary);
        }

        .boot-state {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            flex-direction: column;
            gap: 0.8rem;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error { color: var(--danger); }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="boot" class="boot-state">
        <div class="spinner"></div>
        <p>Loading workspace‚Ä¶</p>
    </div>

    <div id="app-shell" class="app-shell">
        <aside class="sidebar">
            <div class="brand">
                <h1>Flowgrid</h1>
                <p>Platform workspace</p>
            </div>

            <div class="nav-group" id="module-links">
                <div class="nav-label">Modules</div>
                <button class="nav-link" data-url="/wizard.html" data-title="Onboarding Wizard">‚ú® Onboarding Wizard</button>
                <button class="nav-link" data-url="/design/" data-title="FlowGrid Design Studio">üé® FlowGrid Design Studio</button>
                <button class="nav-link" data-url="/status.html" data-title="Status">üìä Status</button>
            </div>

            <div class="sidebar-footer nav-group">
                <div class="nav-label">Account</div>
                <button class="nav-link" data-url="/profile.html" data-title="Profile">üë§ Profile</button>
                <button class="nav-link" data-url="/configuration.html" data-title="Configuration">‚öôÔ∏è Configuration</button>
            </div>
        </aside>

        <section class="content">
            <div class="content-header">
                <span id="active-title">Flowgrid</span>
                <span>Authenticated tenant workspace</span>
            </div>
            <div class="frame-wrap">
                <iframe id="module-frame" title="Flowgrid Module"></iframe>
            </div>
        </section>
    </div>

    <script src="/js/auth-ui.js"></script>
    <script>
      const shellEl = document.getElementById('app-shell');
      const bootEl = document.getElementById('boot');
      const frameEl = document.getElementById('module-frame');
      const titleEl = document.getElementById('active-title');
      const navLinks = Array.from(document.querySelectorAll('.nav-link'));

      function getAuthHeaders(extra = {}) {
        const token = window.FlowgridAuthUI.getAuthToken();
        return token ? { ...extra, Authorization: `Bearer ${token}` } : { ...extra };
      }

      async function isTenantPopulated() {
        // Cache-bust to ensure fresh data after wizard completion
        const cacheBuster = `_t=${Date.now()}`;
        const response = await fetch(`/api/agents?limit=1&${cacheBuster}`, {
          headers: getAuthHeaders(),
          credentials: 'include',
          cache: 'no-store'
        });

        if (response.status === 401 || response.status === 403) {
          const target = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.replace(`/login.html?redirect=${target}`);
          return null;
        }

        if (!response.ok) {
          const contentType = response.headers.get('content-type') || '';
          let detail = '';
          try {
            if (contentType.includes('application/json')) {
              const payload = await response.json();
              detail = payload?.error || payload?.message || '';
            } else {
              detail = (await response.text()).slice(0, 120);
            }
          } catch (_) {}
          throw new Error(`Population check failed: ${response.status}${detail ? ` - ${detail}` : ''}`);
        }

        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          throw new Error('Population check returned non-JSON response');
        }

        const payload = await response.json();
        const total = payload?.meta?.total;
        return Number.isFinite(total) ? total > 0 : Array.isArray(payload?.data) && payload.data.length > 0;
      }

      function activateNav(activeButton) {
        navLinks.forEach(btn => btn.classList.toggle('active', btn === activeButton));
      }

      function loadModule(button) {
        const url = button.dataset.url;
        const title = button.dataset.title || 'Flowgrid';
        if (!url) return;
        frameEl.src = url;
        titleEl.textContent = title;
        activateNav(button);
      }

      // Expose function for iframe to call (e.g., after wizard completion)
      window.loadModuleByUrl = function(url, title) {
        const matchingButton = navLinks.find(btn => btn.dataset.url === url);
        if (matchingButton) {
          loadModule(matchingButton);
        } else {
          frameEl.src = url;
          titleEl.textContent = title || 'Flowgrid';
          navLinks.forEach(btn => btn.classList.remove('active'));
        }
      };

      async function bootstrap() {
        // Check auth BEFORE any API calls - initPage redirects but doesn't stop execution
        if (!window.FlowgridAuthUI.isAuthenticated()) {
          window.FlowgridAuthUI.initPage({ requireAuth: true });
          return;
        }
        
        window.FlowgridAuthUI.initPage({ requireAuth: true });

        try {
          const populated = await isTenantPopulated();
          if (populated === null) return;

          if (!populated) {
            window.location.replace('/wizard.html?onboarding=true');
            return;
          }

          bootEl.style.display = 'none';
          shellEl.style.display = 'flex';

          navLinks.forEach((button) => {
            button.addEventListener('click', () => loadModule(button));
          });

          const defaultButton = navLinks.find((btn) => btn.dataset.url === '/design/') || navLinks[0];
          if (defaultButton) {
            loadModule(defaultButton);
          }
        } catch (error) {
          console.error('[index-shell] bootstrap failed', error);
          bootEl.innerHTML = '<p class="error">Failed to load workspace. Please refresh.</p>';
        }
      }

      document.addEventListener('DOMContentLoaded', bootstrap);
    </script>
</body>
</html>
