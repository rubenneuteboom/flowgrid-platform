<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>üí¨ Flowgrid Wizard - Agent Design</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- vis-network for graph -->
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
    <style>
        :root {
            /* Flowgrid v1 Dark Blue Theme */
            --bg-primary: #0f172a;
            --bg-secondary: #172554;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --bg-input: #0b1220;
            
            --border-default: #334155;
            --border-hover: #475569;
            --border-accent: #3b82f6;
            
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --accent-tertiary: #93c5fd;
            --accent-glow: rgba(59, 130, 246, 0.25);
            --accent-glow-strong: rgba(59, 130, 246, 0.45);
            
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #60a5fa;
            --purple: #8b5cf6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
        }
        .header-left {
            display: flex;
            flex-direction: column;
        }
        header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .header-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .back-btn:hover { 
            background: var(--bg-card-hover); 
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .existing-data-cta {
            margin-top: 0.9rem;
            display: none;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-accent);
            background: rgba(59, 130, 246, 0.10);
        }

        /* Progress Steps - Compact Horizontal */
        .progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            gap: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 1rem 1.5rem;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0 0.5rem;
        }
        .step:hover .step-circle { transform: scale(1.05); }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: all 0.2s;
            border: 2px solid var(--border-default);
        }
        .step.active .step-circle { 
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
            box-shadow: 0 0 16px var(--accent-glow);
        }
        .step.completed .step-circle { 
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        .step-label {
            margin-top: 0.4rem;
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
        }
        .step.active .step-label { color: var(--accent-primary); }
        .step.completed .step-label { color: var(--accent-secondary); }
        .step-line {
            width: 40px;
            height: 2px;
            background: var(--border-default);
            margin: 0 0.25rem;
            margin-bottom: 1.25rem;
            border-radius: 1px;
            transition: all 0.2s;
        }
        .step.completed + .step-line { background: var(--accent-primary); }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }
        .card p.subtitle { 
            color: var(--text-secondary); 
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        /* Input Method Tabs */
        .input-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .input-tab {
            padding: 0.65rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid var(--border-default);
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .input-tab:hover { 
            border-color: var(--accent-primary); 
            color: var(--text-primary); 
        }
        .input-tab.active { 
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-primary);
        }
        .input-content { display: none; }
        .input-content.active { display: block; }

        /* Form elements */
        .input-group { margin-bottom: 1.25rem; }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        textarea, input[type="text"], input[type="url"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 2px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }
        textarea { min-height: 140px; resize: vertical; }
        textarea::placeholder, input::placeholder { color: var(--text-muted); }
        .helper-text {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.4rem;
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border-default);
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-input);
            margin-bottom: 1.25rem;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(93, 213, 192, 0.05);
        }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.7; }
        .upload-zone.has-file { border-color: var(--success); background: rgba(93, 213, 192, 0.05); }
        .preview-image {
            max-width: 280px;
            max-height: 180px;
            border-radius: 8px;
            margin-top: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Buttons */
        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        .btn-primary:hover { 
            background: var(--accent-secondary); 
            box-shadow: 0 4px 16px var(--accent-glow);
        }
        .btn-primary:disabled {
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
        }
        .btn-success:hover { 
            background: var(--accent-secondary); 
            box-shadow: 0 4px 16px var(--accent-glow);
        }
        .btn-warning {
            background: var(--warning);
            color: var(--bg-primary);
        }
        .btn-warning:hover { background: #e69500; }
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }
        .btn-secondary:hover { 
            background: var(--bg-card-hover); 
            border-color: var(--accent-primary);
        }
        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.8rem; }
        .btn-group {
            display: flex;
            gap: 0.75rem;
            justify-content: space-between;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 2.5rem;
        }
        .loading.active { display: flex; }
        .loading-icon { font-size: 3rem; margin-bottom: 0.75rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-container {
            width: 100%;
            max-width: 350px;
            margin: 0.75rem 0;
        }
        .progress-track {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary));
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 3px;
        }
        .loading-status { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results containers */
        .results { display: none; }
        .results.active { display: block; }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--accent-primary);
        }
        .stat-card.green { border-left-color: var(--success); }
        .stat-card.yellow { border-left-color: var(--warning); }
        .stat-card.blue { border-left-color: var(--info); }
        .stat-card.purple { border-left-color: var(--purple); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--accent-primary); }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.yellow .stat-value { color: var(--warning); }
        .stat-card.blue .stat-value { color: var(--info); }
        .stat-card.purple .stat-value { color: var(--purple); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Capability tree */
        .capability-tree {
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 1rem;
            max-height: 380px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .cap-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0.65rem;
            margin-bottom: 0.4rem;
            background: var(--bg-card);
            border-radius: 6px;
            border-left: 3px solid var(--accent-primary);
            transition: all 0.2s;
        }
        .cap-item:hover { background: var(--bg-card-hover); }
        .cap-item.level-0 { border-left-color: var(--accent-primary); }
        .cap-item.level-1 { margin-left: 1.25rem; border-left-color: var(--purple); }
        .cap-item.level-2 { margin-left: 2.5rem; border-left-color: #c084fc; }
        .cap-checkbox { 
            width: 16px; 
            height: 16px; 
            accent-color: var(--accent-primary); 
            cursor: pointer;
            margin-top: 2px;
        }
        .cap-icon { font-size: 0.85rem; }
        .cap-info { flex: 1; }
        .cap-name { font-weight: 500; color: var(--text-primary); font-size: 0.85rem; cursor: pointer; }
        .cap-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.15rem; }
        .cap-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .cap-badge.high { background: var(--success); color: var(--bg-primary); }
        .cap-badge.medium { background: var(--warning); color: var(--bg-primary); }
        .cap-badge.low { background: var(--text-muted); color: var(--bg-primary); }
        
        /* Selection controls */
        .selection-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        .selection-count { margin-left: auto; font-size: 0.8rem; color: var(--success); }

        /* Agent cards grid */
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0.75rem;
            max-height: 480px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .agent-card {
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--accent-primary);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .agent-card:hover { 
            border-color: var(--accent-primary);
            background: var(--bg-card);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }
        .agent-name { font-weight: 600; color: var(--accent-primary); font-size: 0.95rem; }
        .agent-pattern {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }
        .agent-vs { font-size: 0.7rem; color: var(--info); margin-bottom: 0.4rem; }
        .agent-purpose { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            line-height: 1.4;
            margin-bottom: 0.6rem;
        }
        .agent-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .agent-tag {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }
        .agent-edit-hint {
            text-align: right;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Pattern colors */
        .pattern-routing { background: #1e40af; color: white; }
        .pattern-planning { background: #7c3aed; color: white; }
        .pattern-tool-use { background: #059669; color: white; }
        .pattern-orchestration { background: #dc2626; color: white; }
        .pattern-human-in-loop { background: #d97706; color: white; }
        .pattern-rag { background: #0891b2; color: white; }
        .pattern-reflection { background: #be185d; color: white; }
        .pattern-guardrails { background: #4b5563; color: white; }
        .pattern-specialist { background: var(--accent-primary); color: var(--bg-primary); }
        .pattern-orchestrator { background: #dc2626; color: white; }
        .pattern-coordinator { background: #f59e0b; color: white; }
        .pattern-gateway { background: var(--info); color: white; }
        .pattern-monitor { background: #6366f1; color: white; }
        .pattern-executor { background: #ef4444; color: white; }
        .pattern-analyzer { background: #14b8a6; color: white; }
        .pattern-aggregator { background: #f97316; color: white; }
        .pattern-router { background: #ec4899; color: white; }

        /* Pattern legend */
        .pattern-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            justify-content: center;
            margin-bottom: 1.25rem;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
        }
        .legend-item {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Process design cards */
        .process-card {
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .process-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .process-title { color: var(--accent-primary); font-weight: 600; font-size: 0.95rem; }
        .process-field { margin-bottom: 0.6rem; }
        .process-field label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .process-field textarea {
            font-size: 0.8rem;
            min-height: 70px;
            background: var(--bg-card);
            border-color: var(--border-default);
        }

        /* Interactions tabs */
        .int-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .int-tab {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .int-tab.active { background: var(--accent-primary); color: var(--bg-primary); }
        .int-tab:hover:not(.active) { background: var(--bg-card-hover); }
        .int-content { display: none; }
        .int-content.active { display: block; }

        /* Relationship items */
        .rel-item {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            border-left: 3px solid var(--accent-primary);
        }
        .rel-agents {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
        }
        .rel-agent { font-size: 0.8rem; font-weight: 500; }
        .rel-agent.source { color: var(--success); }
        .rel-agent.target { color: var(--info); }
        .rel-arrow { color: var(--text-muted); }
        .rel-type { font-size: 0.7rem; color: var(--warning); margin-bottom: 0.15rem; }
        .rel-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* Integration items */
        .int-item {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            border-left: 3px solid var(--purple);
        }
        .int-name { font-weight: 600; color: var(--purple); font-size: 0.85rem; }
        .int-meta { font-size: 0.7rem; color: var(--text-muted); }
        .int-agent { font-size: 0.7rem; color: var(--success); }

        /* Message items */
        .msg-item {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            border-left: 3px solid var(--warning);
        }
        .msg-name { font-weight: 600; color: var(--warning); font-size: 0.85rem; }
        .msg-desc { font-size: 0.75rem; color: var(--text-muted); }

        /* Summary section */
        .summary-agents {
            max-height: 280px;
            overflow-y: auto;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .summary-agent {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.6rem;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 0.4rem;
        }
        .summary-agent-name { font-weight: 500; color: var(--text-primary); font-size: 0.85rem; }
        .summary-agent-caps { font-size: 0.7rem; color: var(--text-muted); }

        /* Graph container */
        .graph-container {
            height: 280px;
            background: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }
        .modal.active { display: block; }
        .modal-content {
            max-width: 680px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-default);
        }
        .modal-title { color: var(--accent-primary); font-size: 1rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s;
        }
        .modal-close:hover { color: var(--error); }
        .modal-body {
            padding: 1.25rem;
            max-height: 65vh;
            overflow-y: auto;
        }
        .modal-section {
            margin-bottom: 1.25rem;
        }
        .modal-section h4 {
            color: var(--accent-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.6rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid var(--border-default);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.6rem;
        }
        .form-group { margin-bottom: 0.6rem; }
        .form-group label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.2rem; }
        .form-group input, .form-group select, .form-group textarea {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.6rem;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-default);
        }

        /* Error display */
        .error-box {
            display: none;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            color: #fca5a5;
            font-size: 0.85rem;
        }
        .error-box.active { display: block; }

        /* Success card */
        .success-card {
            text-align: center;
            padding: 2.5rem;
        }
        .success-icon { font-size: 4rem; margin-bottom: 0.75rem; }
        .success-title { font-size: 1.35rem; margin-bottom: 0.4rem; color: var(--accent-primary); }
        .success-subtitle { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; opacity: 0.5; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

        /* Hidden utility */
        .hidden { display: none !important; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .agents-grid { grid-template-columns: 1fr; }
            .step-label { display: none; }
            .step-line { width: 20px; }
            header { flex-direction: column; gap: 0.75rem; text-align: center; }
        }

        /* Cookie Consent Banner */
        .consent-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--accent-primary);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }
        .consent-banner.hidden { display: none; }
        .consent-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .consent-text a {
            color: var(--accent-primary);
            text-decoration: none;
        }
        .consent-text a:hover { text-decoration: underline; }
        .consent-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .consent-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .consent-accept {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        .consent-accept:hover { background: var(--accent-secondary); }
        .consent-decline {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
        }
        .consent-decline:hover { border-color: var(--accent-primary); }

        /* Footer */
        .wizard-footer {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .wizard-footer a {
            color: var(--accent-primary);
            text-decoration: none;
        }
        .wizard-footer a:hover { text-decoration: underline; }

        /* Character counter */
        .char-counter {
            text-align: right;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .char-counter.warning { color: var(--warning); }
        .char-counter.error { color: var(--error); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-left">
                <h1>üí¨ Welcome to Flowgrid</h1>
                <span class="header-subtitle">Configure your Agent Network in 6 steps</span>
            </div>
            <a href="/" class="back-btn">‚Üê Dashboard</a>
        </header>

        <!-- Progress Bar - 6 Steps -->
        <div class="progress-bar">
            <div class="step active" data-step="1" onclick="navigateToStep(1)">
                <div class="step-circle">1</div>
                <span class="step-label">Identify</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)">
                <div class="step-circle">2</div>
                <span class="step-label">Review</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)">
                <div class="step-circle">3</div>
                <span class="step-label">Agents</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)">
                <div class="step-circle">4</div>
                <span class="step-label">Processes</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)">
                <div class="step-circle">5</div>
                <span class="step-label">Interactions</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)">
                <div class="step-circle">6</div>
                <span class="step-label">Import</span>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- STEP 1: IDENTIFY CAPABILITIES -->
        <!-- ============================================================ -->
        <section id="step1" class="step-content">
            <div class="card">
                <div style="text-align: center; margin-bottom: 1.25rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.8;">üéØ</div>
                    <h2>Identify Your Capabilities</h2>
                    <p class="subtitle">Choose how to define your capabilities ‚Äî describe them, upload XML, or use AI image analysis.</p>
                    <div id="existingDataCta" class="existing-data-cta">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.6rem;">‚úÖ Existing organization data detected.</p>
                        <a href="/design" class="btn btn-primary" style="display: inline-flex; text-decoration: none;">‚û°Ô∏è Go to Design Module</a>
                    </div>
                </div>

                <!-- Input Method Tabs -->
                <div class="input-tabs">
                    <button class="input-tab active" data-method="text" onclick="switchInputMethod('text')">
                        üìù Describe
                    </button>
                    <button class="input-tab" data-method="xml" onclick="switchInputMethod('xml')">
                        üìÑ XML Upload
                    </button>
                    <button class="input-tab" data-method="image" onclick="switchInputMethod('image')">
                        üñºÔ∏è Image Analysis
                    </button>
                </div>

                <!-- Text Input -->
                <div id="input-text" class="input-content active">
                    <div class="input-group">
                        <label for="descriptionInput">üìù Description</label>
                        <textarea id="descriptionInput" maxlength="50000" placeholder="Example: We are the IT Service Management department of a mid-sized company. We handle about 500 tickets per month, 60% incidents and 40% service requests. We use ServiceNow as our ITSM tool and want to automate: ticket triage, knowledge base searches, and standard approvals..." oninput="updateCharCounter(this, 50000)"></textarea>
                        <div class="char-counter" id="descriptionCounter">0 / 50,000</div>
                        <p class="helper-text">The more detail you provide, the better the capability map. Describe processes, tools, volumes, and automatable tasks.</p>
                    </div>
                    <div class="input-group">
                        <label for="websiteUrl">üåê Corporate Website <span style="color: var(--text-muted); font-weight: 400;">(optional)</span></label>
                        <input type="url" id="websiteUrl" placeholder="https://www.company.com">
                        <p class="helper-text">The website will be analyzed for additional context about products, services, and company structure.</p>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="analyzeText()">
                        üß† Generate Capability Map
                    </button>
                </div>

                <!-- XML Upload -->
                <div id="input-xml" class="input-content">
                    <div class="upload-zone" id="xmlDropZone" onclick="document.getElementById('xmlFileInput').click()">
                        <input type="file" id="xmlFileInput" accept=".xml">
                        <div class="upload-icon">üìÑ</div>
                        <p><strong>Drop an XML file here</strong></p>
                        <p style="color: var(--text-muted); font-size: 0.85rem;">or click to browse</p>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem;">Supported: Archi export (.xml), Open Group ArchiMate (.xml)</p>
                    </div>
                </div>

                <!-- Image Upload -->
                <div id="input-image" class="input-content">
                    <div style="background: var(--bg-input); border: 1px solid var(--border-default); border-radius: 6px; padding: 0.6rem; margin-bottom: 1.25rem; text-align: center;">
                        <span style="color: var(--text-muted); font-size: 0.75rem;">
                            üîç GPT-4o Vision ‚Üí üß† Claude Analysis = <span style="color: var(--accent-primary);">Hybrid AI</span>
                        </span>
                    </div>
                    
                    <div class="upload-zone" id="imageDropZone" onclick="document.getElementById('imageFileInput').click()">
                        <input type="file" id="imageFileInput" accept="image/jpeg,image/png,image/gif,image/webp">
                        <div id="imageUploadPrompt">
                            <div class="upload-icon">üñºÔ∏è</div>
                            <p><strong>Drop an image here</strong></p>
                            <p style="color: var(--text-muted); font-size: 0.85rem;">or click to browse</p>
                            <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem;">JPG, PNG, GIF, WebP (max 20MB)</p>
                        </div>
                        <div id="imagePreviewContainer" style="display: none;">
                            <img id="imagePreview" class="preview-image" alt="Preview">
                            <p id="imagePreviewName" style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.8rem;"></p>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearImagePreview();" style="margin-top: 0.5rem;">‚úï Remove</button>
                        </div>
                    </div>
                    
                    <div id="imageAdvancedOptions" style="display: none; margin-top: 0.75rem;">
                        <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="toggleAdvancedOptions()" id="advancedToggle">
                            ‚ñ∂ Advanced Options
                        </button>
                        <div id="advancedContent" style="display: none; margin-top: 0.6rem;">
                            <div class="input-group">
                                <label>üìù Custom Instructions <span style="color: var(--text-muted); font-weight: 400;">(optional)</span></label>
                                <textarea id="customPromptInput" rows="3" maxlength="5000" placeholder="e.g., This is an IT4IT capability model showing 5 value streams. Focus on the R2D and S2P streams..." oninput="updateCharCounter(this, 5000)"></textarea>
                                <div class="char-counter" id="customPromptCounter">0 / 5,000</div>
                                <p class="helper-text">üí° Describe what type of model this is, what the colors mean, or which areas to focus on.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button id="analyzeImageBtn" class="btn btn-success" style="display: none; width: 100%; margin-top: 0.75rem;" onclick="analyzeImage()">
                        üöÄ Start AI Analysis
                    </button>
                </div>

                <!-- Error display -->
                <div class="error-box" id="step1Error"></div>

                <!-- Loading state -->
                <div class="loading" id="step1Loading">
                    <div class="loading-icon">üîÑ</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Analyzing your input...</h3>
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-fill" id="step1Progress"></div>
                        </div>
                    </div>
                    <p class="loading-status" id="step1Status">Starting analysis...</p>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 2: REVIEW CAPABILITIES -->
        <!-- ============================================================ -->
        <section id="step2" class="step-content hidden">
            <div class="card">
                <!-- Loading state -->
                <div class="loading" id="step2Loading">
                    <div class="loading-icon">üîÑ</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Extracting Capabilities...</h3>
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-fill" id="step2Progress"></div>
                        </div>
                    </div>
                    <p class="loading-status" id="step2Status">AI is reading your capability model...</p>
                </div>

                <!-- Results -->
                <div class="results" id="step2Results">
                    <h2>üì¶ Extracted Capabilities</h2>
                    <p class="subtitle"><span id="capCount">0</span> capabilities found. Review and adjust if needed.</p>

                    <div class="selection-controls">
                        <button class="btn btn-secondary btn-sm" onclick="selectAllCapabilities(true)">‚úÖ Select All</button>
                        <button class="btn btn-secondary btn-sm" onclick="selectAllCapabilities(false)">‚¨ú Deselect All</button>
                        <span class="selection-count" id="selectedCount">0 selected</span>
                    </div>

                    <div class="capability-tree" id="capabilityTree">
                        <!-- Capabilities rendered here -->
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="startAgentDesign()">Next: Agent Design ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 3: AGENT DESIGN & PATTERNS -->
        <!-- ============================================================ -->
        <section id="step3" class="step-content hidden">
            <div class="card">
                <!-- Loading state -->
                <div class="loading" id="step3Loading">
                    <div class="loading-icon">ü§ñ</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Designing Agents...</h3>
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-fill" id="step3Progress"></div>
                        </div>
                    </div>
                    <p class="loading-status" id="step3Status">AI is grouping capabilities into agents...</p>
                </div>

                <!-- Results -->
                <div class="results" id="step3Results">
                    <h2>ü§ñ Agent Design & Patterns</h2>
                    <p class="subtitle"><span id="agentCount">0</span> agents suggested. Click any agent to edit its configuration.</p>

                    <!-- Pattern Legend -->
                    <div class="pattern-legend">
                        <span class="legend-item pattern-routing">üîÄ Routing</span>
                        <span class="legend-item pattern-planning">üìã Planning</span>
                        <span class="legend-item pattern-tool-use">üîß Tool Use</span>
                        <span class="legend-item pattern-orchestration">üé≠ Orchestration</span>
                        <span class="legend-item pattern-human-in-loop">üë§ Human-in-Loop</span>
                        <span class="legend-item pattern-rag">üìö RAG</span>
                        <span class="legend-item pattern-reflection">üîç Reflection</span>
                        <span class="legend-item pattern-guardrails">üõ°Ô∏è Guardrails</span>
                    </div>

                    <div class="agents-grid" id="agentsGrid">
                        <!-- Agent cards rendered here -->
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="startProcessDesign()">Next: Process Design ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 4: PROCESS DESIGN -->
        <!-- ============================================================ -->
        <section id="step4" class="step-content hidden">
            <div class="card">
                <!-- Loading state -->
                <div class="loading" id="step4Loading">
                    <div class="loading-icon">üîÑ</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Generating Process Flows...</h3>
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-fill" id="step4Progress"></div>
                        </div>
                    </div>
                    <p class="loading-status" id="step4Status">AI is designing processes for each agent...</p>
                </div>

                <!-- Results -->
                <div class="results" id="step4Results">
                    <h2>üîÑ Process Design</h2>
                    <p class="subtitle">Define process flows, decision points, and error handling for each agent.</p>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.25rem;">
                        <button class="btn btn-warning btn-sm" onclick="generateAllProcesses()">
                            ü§ñ Generate All with AI
                        </button>
                    </div>

                    <div id="processCards" style="max-height: 480px; overflow-y: auto;">
                        <!-- Process cards rendered here -->
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="startInteractionDesign()">Next: Interactions ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 5: INTERACTIONS -->
        <!-- ============================================================ -->
        <section id="step5" class="step-content hidden">
            <div class="card">
                <!-- Loading state -->
                <div class="loading" id="step5Loading">
                    <div class="loading-icon">üîó</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Generating Interactions...</h3>
                    <div class="progress-container">
                        <div class="progress-track">
                            <div class="progress-fill" id="step5Progress"></div>
                        </div>
                    </div>
                    <p class="loading-status" id="step5Status">AI is defining agent relationships...</p>
                </div>

                <!-- Results -->
                <div class="results" id="step5Results">
                    <h2>üîó Agent Interactions</h2>
                    <p class="subtitle"><span id="relCount">0</span> relationships and <span id="intCount">0</span> integrations defined.</p>

                    <!-- Tabs -->
                    <div class="int-tabs">
                        <button class="int-tab active" onclick="showInteractionTab('relationships')">üîó Relations</button>
                        <button class="int-tab" onclick="showInteractionTab('integrations')">üîå Integrations</button>
                        <button class="int-tab" onclick="showInteractionTab('messages')">üì® Messages</button>
                    </div>

                    <!-- Content areas -->
                    <div style="background: var(--bg-input); border: 1px solid var(--border-default); border-radius: 8px; padding: 0.75rem; max-height: 350px; overflow-y: auto; margin-bottom: 0.75rem;">
                        <div id="intRelationships" class="int-content active"></div>
                        <div id="intIntegrations" class="int-content"></div>
                        <div id="intMessages" class="int-content"></div>
                    </div>

                    <!-- Graph visualization -->
                    <h3 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üìä Interaction Graph</h3>
                    <div class="graph-container" id="interactionGraph"></div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back</button>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-warning btn-sm" onclick="regenerateInteractions()">üîÑ Regenerate</button>
                        </div>
                        <button class="btn btn-primary" onclick="goToStep(6)">Next: Import ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 6: IMPORT & SAVE -->
        <!-- ============================================================ -->
        <section id="step6" class="step-content hidden">
            <div class="card">
                <h2>üöÄ Ready to Import</h2>
                <p class="subtitle">Review the summary and click Import to activate your Agent Network.</p>

                <!-- Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-value" id="summaryAgents">0</div>
                        <div class="stat-label">Agents</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="summaryCapabilities">0</div>
                        <div class="stat-label">Capabilities</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-value" id="summaryInteractions">0</div>
                        <div class="stat-label">Interactions</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-value" id="summaryIntegrations">0</div>
                        <div class="stat-label">Integrations</div>
                    </div>
                </div>

                <!-- Agent preview -->
                <h3 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.6rem;">Agent Overview</h3>
                <div class="summary-agents" id="summaryAgentList">
                    <!-- Agent list rendered here -->
                </div>

                <!-- Error display -->
                <div class="error-box" id="step6Error"></div>

                <!-- Loading state -->
                <div class="loading" id="step6Loading">
                    <div class="spinner"></div>
                    <p class="loading-status">Creating agents in database...</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(5)">‚Üê Back</button>
                    <button class="btn btn-success" style="font-size: 1rem; padding: 0.8rem 2.5rem;" onclick="performImport()">
                        üöÄ Import & Start
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 7: SUCCESS (shown after import) -->
        <!-- ============================================================ -->
        <section id="step7" class="step-content hidden">
            <div class="card success-card">
                <div class="success-icon">üéâ</div>
                <h2 class="success-title">Agents Created Successfully!</h2>
                <p class="success-subtitle" id="successMessage">Your agents have been created and are ready to configure.</p>

                <div class="stats-grid" id="finalSummary"></div>

                <div class="btn-group" style="justify-content: center;">
                    <a href="/design" class="btn btn-primary">üé® Open Design Module ‚Üí</a>
                    <button class="btn btn-secondary" onclick="location.reload()">Create More Agents</button>
                </div>
            </div>
        </section>
    </div>

        <!-- Footer with Privacy Policy link -->
        <footer class="wizard-footer">
            <p>¬© 2026 Flowgrid Platform ¬∑ <a href="/privacy-policy.html" target="_blank">Privacy Policy</a></p>
        </footer>
    </div>

    <!-- Cookie Consent Banner -->
    <div class="consent-banner hidden" id="consentBanner">
        <div class="consent-text">
            üç™ We use cookies and local storage to save your wizard progress and provide our AI-powered services.
            Your data may be processed by <a href="https://openai.com/privacy" target="_blank">OpenAI</a> and 
            <a href="https://www.anthropic.com/privacy" target="_blank">Anthropic</a> for AI analysis.
            <a href="/privacy-policy.html" target="_blank">Learn more</a>.
        </div>
        <div class="consent-buttons">
            <button class="consent-btn consent-decline" onclick="handleConsent(false)">Decline</button>
            <button class="consent-btn consent-accept" onclick="handleConsent(true)">Accept</button>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- AGENT EDIT MODAL -->
    <!-- ============================================================ -->
    <div class="modal" id="agentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalAgentTitle">ü§ñ Agent Configuration</h3>
                <button class="modal-close" onclick="closeAgentModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalAgentId">
                
                <!-- Basic Info -->
                <div class="modal-section">
                    <h4>üìã Basic Information</h4>
                    <div class="form-group">
                        <label>Agent Name</label>
                        <input type="text" id="modalAgentName">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Value Stream</label>
                            <input type="text" id="modalAgentValueStream">
                        </div>
                        <div class="form-group">
                            <label>Capability Group</label>
                            <input type="text" id="modalAgentCapGroup">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Purpose</label>
                        <textarea id="modalAgentPurpose" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>üéØ Objectives (one per line)</label>
                        <textarea id="modalAgentObjectives" rows="3" placeholder="Reduce incident resolution time by 30%&#10;Automate routine ticket triage"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Capabilities (comma-separated)</label>
                        <textarea id="modalAgentCapabilities" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Behavior -->
                <div class="modal-section">
                    <h4>‚öôÔ∏è Behavior</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Agent Pattern</label>
                            <select id="modalAgentPattern">
                                <option value="routing">üîÄ Routing</option>
                                <option value="planning">üìã Planning</option>
                                <option value="tool-use">üîß Tool Use</option>
                                <option value="orchestration">üé≠ Orchestration</option>
                                <option value="human-in-loop">üë§ Human-in-Loop</option>
                                <option value="rag">üìö RAG</option>
                                <option value="reflection">üîç Reflection</option>
                                <option value="guardrails">üõ°Ô∏è Guardrails</option>
                                <option value="Specialist">Specialist</option>
                                <option value="Orchestrator">Orchestrator</option>
                                <option value="Coordinator">Coordinator</option>
                                <option value="Gateway">Gateway</option>
                                <option value="Monitor">Monitor</option>
                                <option value="Executor">Executor</option>
                                <option value="Analyzer">Analyzer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Decision Authority</label>
                            <select id="modalAgentDecision">
                                <option value="autonomous">Autonomous</option>
                                <option value="propose-and-execute">Propose & Execute</option>
                                <option value="recommend-only">Recommend Only</option>
                                <option value="execute-only">Execute Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Autonomy Level</label>
                            <select id="modalAgentAutonomy">
                                <option value="full">Full</option>
                                <option value="supervised">Supervised</option>
                                <option value="assisted">Assisted</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Risk Appetite</label>
                            <select id="modalAgentRisk">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Interactions -->
                <div class="modal-section">
                    <h4>üîó Interactions</h4>
                    <div class="form-group">
                        <label>Interaction Pattern</label>
                        <select id="modalAgentInteraction">
                            <option value="request-response">Request-Response</option>
                            <option value="event-driven">Event-Driven</option>
                            <option value="broadcast">Broadcast</option>
                            <option value="choreography">Choreography</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Triggers (comma-separated)</label>
                            <input type="text" id="modalAgentTriggers">
                        </div>
                        <div class="form-group">
                            <label>Outputs (comma-separated)</label>
                            <input type="text" id="modalAgentOutputs">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Escalation Path</label>
                        <input type="text" id="modalAgentEscalation">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAgentModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveAgentModal()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================================ -->
    <script src="/js/auth-ui.js"></script>
    <script>
        // ==========================================
        // STATE & CONFIGURATION
        // ==========================================
        let currentStep = 1;
        let sessionId = null;
        let analysisResult = null;
        let selectedCapabilities = new Set();
        let selectedImageFile = null;
        let interactionGraph = null;
        let csrfToken = null;
        let hasConsent = null;
        
        const STATE_KEY = 'flowgrid_wizard_state';
        const CONSENT_KEY = 'flowgrid_consent';
        const ENCRYPTION_KEY_STORAGE = 'flowgrid_encryption_key';
        
        // Rate limiting state
        const rateLimitState = {
            lastAnalyzeText: 0,
            lastAnalyzeImage: 0,
            lastGenerate: 0,
            cooldownMs: 5000 // 5 seconds between AI calls
        };
        
        const agenticPatterns = [
            { id: 'routing', name: 'Routing', emoji: 'üîÄ', color: '#1e40af' },
            { id: 'planning', name: 'Planning', emoji: 'üìã', color: '#7c3aed' },
            { id: 'tool-use', name: 'Tool Use', emoji: 'üîß', color: '#059669' },
            { id: 'orchestration', name: 'Orchestration', emoji: 'üé≠', color: '#dc2626' },
            { id: 'human-in-loop', name: 'Human-in-Loop', emoji: 'üë§', color: '#d97706' },
            { id: 'rag', name: 'RAG', emoji: 'üìö', color: '#0891b2' },
            { id: 'reflection', name: 'Reflection', emoji: 'üîç', color: '#be185d' },
            { id: 'guardrails', name: 'Guardrails', emoji: 'üõ°Ô∏è', color: '#4b5563' }
        ];
        
        // ==========================================
        // SECURITY: AUTHENTICATION
        // ==========================================
        
        function getAuthToken() {
            return window.FlowgridAuthUI.getAuthToken();
        }
        
        function setAuthToken(token) {
            // Write both keys during transition to avoid auth regressions across pages
            localStorage.setItem('accessToken', token);
            localStorage.setItem('flowgrid_access_token', token);
        }
        
        function clearAuthToken() {
            window.FlowgridAuthUI.clearAuthState();
        }
        
        function redirectToLogin(message) {
            clearAuthToken();
            alert(message || 'Please log in to use the wizard.');
            window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
        }
        
        async function parseApiResponse(response) {
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return response.json().catch(() => null);
            }

            const text = await response.text().catch(() => '');
            const snippet = (text || '').replace(/\s+/g, ' ').slice(0, 180);
            return {
                error: `Unexpected response format (${response.status})`,
                details: snippet,
            };
        }

        async function extractErrorMessage(response, fallback = 'Request failed') {
            const payload = await parseApiResponse(response);
            return payload?.error || payload?.message || payload?.details || `${fallback} (HTTP ${response.status})`;
        }

        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            
            // Prepare headers
            const headers = {
                ...options.headers,
            };
            
            // Add auth header if token exists
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Add CSRF token for state-changing requests
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes((options.method || 'GET').toUpperCase())) {
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }
            }
            
            const response = await fetch(url, { ...options, headers });
            
            // Handle auth errors
            if (response.status === 401) {
                const data = await parseApiResponse(response) || {};
                if (data.code === 'TOKEN_EXPIRED') {
                    // Try to refresh token
                    const refreshed = await refreshAuthToken();
                    if (refreshed) {
                        // Retry request with new token
                        headers['Authorization'] = `Bearer ${getAuthToken()}`;
                        return fetch(url, { ...options, headers });
                    }
                }
                redirectToLogin(data.message || data.error || 'Session expired. Please log in again.');
                throw new Error('Authentication required');
            }
            
            // Handle CSRF errors
            if (response.status === 403) {
                const data = await parseApiResponse(response) || {};
                if (data.code?.startsWith('CSRF_')) {
                    // Refresh CSRF token and retry
                    await fetchCsrfToken();
                    headers['X-CSRF-Token'] = csrfToken;
                    return fetch(url, { ...options, headers });
                }
            }
            
            return response;
        }
        
        async function refreshAuthToken() {
            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include' // Include cookies
                });
                
                if (response.ok) {
                    const data = await response.json();
                    setAuthToken(data.accessToken);
                    return true;
                }
                return false;
            } catch {
                return false;
            }
        }
        
        async function fetchCsrfToken() {
            try {
                const response = await fetch('/api/wizard/csrf-token');
                if (response.ok) {
                    const data = await response.json();
                    csrfToken = data.csrfToken;
                }
            } catch (e) {
                console.error('Failed to fetch CSRF token:', e);
            }
        }
        
        // ==========================================
        // SECURITY: LOCALSTORAGE ENCRYPTION
        // ==========================================
        
        // Generate or retrieve encryption key (stored in sessionStorage - cleared on tab close)
        async function getEncryptionKey() {
            const storedKey = sessionStorage.getItem(ENCRYPTION_KEY_STORAGE);
            if (storedKey) {
                const keyData = Uint8Array.from(atob(storedKey), c => c.charCodeAt(0));
                return await crypto.subtle.importKey('raw', keyData, 'AES-GCM', false, ['encrypt', 'decrypt']);
            }
            
            // Generate new key
            const key = await crypto.subtle.generateKey(
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
            
            // Export and store key
            const exported = await crypto.subtle.exportKey('raw', key);
            sessionStorage.setItem(ENCRYPTION_KEY_STORAGE, btoa(String.fromCharCode(...new Uint8Array(exported))));
            
            return key;
        }
        
        async function encryptData(data) {
            try {
                const key = await getEncryptionKey();
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encoded = new TextEncoder().encode(JSON.stringify(data));
                
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    encoded
                );
                
                // Combine IV and ciphertext
                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encrypted), iv.length);
                
                return btoa(String.fromCharCode(...combined));
            } catch (e) {
                console.error('Encryption failed:', e);
                return null;
            }
        }
        
        async function decryptData(encryptedString) {
            try {
                const key = await getEncryptionKey();
                const combined = Uint8Array.from(atob(encryptedString), c => c.charCodeAt(0));
                
                const iv = combined.slice(0, 12);
                const ciphertext = combined.slice(12);
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    ciphertext
                );
                
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }
        
        // ==========================================
        // SECURITY: CONSENT MANAGEMENT
        // ==========================================
        
        function checkConsent() {
            const consent = localStorage.getItem(CONSENT_KEY);
            if (consent !== null) {
                hasConsent = consent === 'true';
                return hasConsent;
            }
            // Show consent banner if no consent recorded
            document.getElementById('consentBanner').classList.remove('hidden');
            return null;
        }
        
        function handleConsent(accepted) {
            hasConsent = accepted;
            localStorage.setItem(CONSENT_KEY, accepted ? 'true' : 'false');
            document.getElementById('consentBanner').classList.add('hidden');
            
            if (!accepted) {
                // Clear any stored data if consent declined
                localStorage.removeItem(STATE_KEY);
                alert('Storage consent declined. Wizard progress will not be saved.');
            }
        }
        
        // ==========================================
        // SECURITY: RATE LIMITING (DEBOUNCE)
        // ==========================================
        
        function canMakeAICall(type) {
            const now = Date.now();
            const lastCall = rateLimitState[`last${type}`] || 0;
            const remaining = Math.max(0, rateLimitState.cooldownMs - (now - lastCall));
            
            if (remaining > 0) {
                return { allowed: false, remainingMs: remaining };
            }
            return { allowed: true, remainingMs: 0 };
        }
        
        function recordAICall(type) {
            rateLimitState[`last${type}`] = Date.now();
        }
        
        function updateButtonCooldown(button, remainingMs) {
            if (remainingMs <= 0) {
                button.disabled = false;
                button.dataset.originalText = button.dataset.originalText || button.textContent;
                button.textContent = button.dataset.originalText;
                return;
            }
            
            button.disabled = true;
            const seconds = Math.ceil(remainingMs / 1000);
            button.dataset.originalText = button.dataset.originalText || button.textContent;
            button.textContent = `Wait ${seconds}s...`;
            
            setTimeout(() => updateButtonCooldown(button, remainingMs - 1000), 1000);
        }
        
        // ==========================================
        // UI HELPERS
        // ==========================================
        
        function updateCharCounter(textarea, maxLength) {
            const current = textarea.value.length;
            const counter = document.getElementById(textarea.id + 'Counter');
            if (counter) {
                counter.textContent = `${current.toLocaleString()} / ${maxLength.toLocaleString()}`;
                counter.className = 'char-counter';
                if (current > maxLength * 0.9) counter.className = 'char-counter warning';
                if (current >= maxLength) counter.className = 'char-counter error';
            }
        }
        
        // ==========================================
        // STATE PERSISTENCE (with encryption)
        // ==========================================
        async function saveState() {
            // Don't save if user declined consent
            if (hasConsent === false) return;
            
            const state = {
                currentStep,
                sessionId,
                analysisResult,
                selectedCapabilities: Array.from(selectedCapabilities),
                savedAt: new Date().toISOString()
            };
            
            try {
                const encrypted = await encryptData(state);
                if (encrypted) {
                    localStorage.setItem(STATE_KEY, encrypted);
                }
            } catch (e) {
                // Fallback to unencrypted if crypto fails (older browsers)
                console.warn('Encryption not available, saving unencrypted');
                localStorage.setItem(STATE_KEY, JSON.stringify(state));
            }
        }
        
        async function loadState() {
            try {
                const saved = localStorage.getItem(STATE_KEY);
                if (!saved) return null;
                
                let state;
                
                // Try to decrypt first
                try {
                    state = await decryptData(saved);
                } catch {
                    // Fallback: try parsing as JSON (legacy or unencrypted)
                    state = JSON.parse(saved);
                }
                
                if (state && state.savedAt) {
                    const savedAt = new Date(state.savedAt);
                    if ((Date.now() - savedAt.getTime()) < 24 * 60 * 60 * 1000) {
                        return state;
                    }
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return null;
        }
        
        function clearState() {
            localStorage.removeItem(STATE_KEY);
            sessionStorage.removeItem(ENCRYPTION_KEY_STORAGE);
        }
        
        async function restoreState() {
            // Restore flow intentionally disabled.
            // Always start a fresh wizard run from step 1.
            return false;
        }
        
        // ==========================================
        // NAVIGATION
        // ==========================================
        function navigateToStep(step) {
            if (step <= currentStep || (analysisResult && step <= 6)) {
                goToStep(step);
            }
        }
        
        function goToStep(step) {
            currentStep = step;
            
            document.querySelectorAll('.step').forEach(s => {
                const stepNum = parseInt(s.dataset.step);
                const circle = s.querySelector('.step-circle');
                s.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    s.classList.add('completed');
                    circle.innerHTML = '‚úì';
                } else if (stepNum === step) {
                    s.classList.add('active');
                    circle.innerHTML = stepNum;
                } else {
                    circle.innerHTML = stepNum;
                }
            });
            
            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            const stepEl = document.getElementById(`step${step}`);
            if (stepEl) stepEl.classList.remove('hidden');
            
            if (step === 2 && analysisResult) {
                showStep2Results();
            } else if (step === 3 && analysisResult) {
                showStep3Results();
            } else if (step === 4 && analysisResult) {
                showStep4Results();
            } else if (step === 5 && analysisResult) {
                showStep5Results();
            } else if (step === 6 && analysisResult) {
                showStep6Summary();
            }
            
            saveState();
        }
        
        // ==========================================
        // STEP 1: INPUT METHODS
        // ==========================================
        function switchInputMethod(method) {
            document.querySelectorAll('.input-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.method === method);
            });
            document.querySelectorAll('.input-content').forEach(c => {
                c.classList.remove('active');
            });
            document.getElementById(`input-${method}`).classList.add('active');
        }
        
        async function analyzeText() {
            const description = document.getElementById('descriptionInput').value.trim();
            if (description.length < 20) {
                showError('step1Error', 'Please provide a more detailed description (at least 20 characters)');
                return;
            }
            
            // Rate limiting check
            const button = event?.target;
            const rateCheck = canMakeAICall('AnalyzeText');
            if (!rateCheck.allowed) {
                if (button) updateButtonCooldown(button, rateCheck.remainingMs);
                showError('step1Error', `Please wait ${Math.ceil(rateCheck.remainingMs / 1000)} seconds before trying again`);
                return;
            }
            
            hideError('step1Error');
            showLoading('step1', true);
            updateProgress('step1', 30, 'Sending to AI...');
            
            try {
                recordAICall('AnalyzeText');
                const websiteUrl = document.getElementById('websiteUrl').value.trim();
                
                const response = await fetchWithAuth('/api/wizard/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, requirements: [] })
                    // Note: tenantId is now extracted from JWT, not sent by client
                });
                
                updateProgress('step1', 70, 'Processing response...');
                
                if (!response.ok) {
                    const errorMessage = await extractErrorMessage(response, 'Analysis failed');
                    throw new Error(errorMessage);
                }
                
                const data = await parseApiResponse(response);
                sessionId = data.sessionId;
                analysisResult = data.analysis;
                
                updateProgress('step1', 100, 'Complete!');
                await delay(500);
                
                showLoading('step1', false);
                goToStep(2);
                
            } catch (error) {
                showLoading('step1', false);
                showError('step1Error', error.message);
            }
        }
        
        function clearImagePreview() {
            selectedImageFile = null;
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('imageUploadPrompt').style.display = 'block';
            document.getElementById('analyzeImageBtn').style.display = 'none';
            document.getElementById('imageAdvancedOptions').style.display = 'none';
            document.getElementById('customPromptInput').value = '';
        }
        
        function showImagePreview(file) {
            selectedImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                document.getElementById('imagePreviewContainer').style.display = 'block';
                document.getElementById('imageUploadPrompt').style.display = 'none';
                document.getElementById('analyzeImageBtn').style.display = 'block';
                document.getElementById('imageAdvancedOptions').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function toggleAdvancedOptions() {
            const content = document.getElementById('advancedContent');
            const toggle = document.getElementById('advancedToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñº Advanced Options';
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñ∂ Advanced Options';
            }
        }
        
        async function analyzeImage() {
            if (!selectedImageFile) {
                showError('step1Error', 'Please select an image first');
                return;
            }
            
            hideError('step1Error');
            showLoading('step1', true);
            updateProgress('step1', 20, 'Uploading image...');
            
            try {
                const formData = new FormData();
                formData.append('file', selectedImageFile);
                // Note: tenantId is extracted server-side from JWT auth context
                
                const customPrompt = document.getElementById('customPromptInput').value.trim();
                if (customPrompt) {
                    formData.append('customPrompt', customPrompt);
                }
                
                updateProgress('step1', 50, 'AI is analyzing the image...');
                
                const response = await fetchWithAuth('/api/wizard/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress('step1', 80, 'Processing response...');
                
                if (!response.ok) {
                    const errorMessage = await extractErrorMessage(response, 'Image analysis failed');
                    throw new Error(errorMessage);
                }
                
                const data = await parseApiResponse(response);
                sessionId = data.sessionId;
                analysisResult = data.analysis;
                
                updateProgress('step1', 100, 'Complete!');
                await delay(500);
                
                showLoading('step1', false);
                goToStep(2);
                
            } catch (error) {
                showLoading('step1', false);
                showError('step1Error', error.message);
            }
        }
        
        async function processXmlUpload(file) {
            hideError('step1Error');
            showLoading('step1', true);
            updateProgress('step1', 30, 'Parsing XML file...');
            
            try {
                await delay(1000);
                throw new Error('XML upload requires ArchiMate parser on server. Use Text or Image input instead.');
                
            } catch (error) {
                showLoading('step1', false);
                showError('step1Error', error.message);
            }
        }
        
        // ==========================================
        // STEP 2: REVIEW CAPABILITIES
        // ==========================================
        function showStep2Results() {
            document.getElementById('step2Loading').classList.remove('active');
            document.getElementById('step2Results').classList.add('active');
            
            const capabilities = analysisResult?.extractedCapabilities || [];
            selectedCapabilities = new Set(capabilities.map(c => c.name));
            
            renderCapabilityTree(capabilities);
            document.getElementById('capCount').textContent = capabilities.length;
            updateSelectedCount();
        }
        
        function renderCapabilityTree(capabilities) {
            const container = document.getElementById('capabilityTree');
            if (!capabilities || capabilities.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No capabilities found</p>';
                return;
            }
            
            const roots = capabilities.filter(c => !c.parentName);
            const byParent = {};
            capabilities.forEach(c => {
                if (c.parentName) {
                    if (!byParent[c.parentName]) byParent[c.parentName] = [];
                    byParent[c.parentName].push(c);
                }
            });
            
            if (roots.length === 0) {
                container.innerHTML = capabilities.map(cap => renderCapItem(cap, 0)).join('');
            } else {
                function renderNode(cap, level) {
                    const children = byParent[cap.name] || [];
                    return renderCapItem(cap, level) + children.map(c => renderNode(c, level + 1)).join('');
                }
                container.innerHTML = roots.map(r => renderNode(r, 0)).join('');
            }
        }
        
        function renderCapItem(cap, level) {
            const hasChildren = cap.children && cap.children.length > 0;
            const automation = cap.automationPotential || 'medium';
            const capId = cap.name.replace(/[^a-zA-Z0-9]/g, '_');
            
            return `
                <div class="cap-item level-${level}">
                    <input type="checkbox" class="cap-checkbox" id="cap-${capId}" checked 
                           onchange="toggleCapability('${cap.name.replace(/'/g, "\\'")}', this.checked)">
                    <span class="cap-icon">${hasChildren ? 'üìÅ' : 'üìÑ'}</span>
                    <div class="cap-info">
                        <label for="cap-${capId}" class="cap-name">${escapeHtml(cap.name)}</label>
                        ${cap.description ? `<div class="cap-desc">${escapeHtml(cap.description)}</div>` : ''}
                    </div>
                    <span class="cap-badge ${automation}">${automation}</span>
                </div>
            `;
        }
        
        function toggleCapability(name, selected) {
            if (selected) {
                selectedCapabilities.add(name);
            } else {
                selectedCapabilities.delete(name);
            }
            updateSelectedCount();
        }
        
        function selectAllCapabilities(selectAll) {
            document.querySelectorAll('.cap-checkbox').forEach(cb => cb.checked = selectAll);
            
            if (selectAll && analysisResult?.extractedCapabilities) {
                selectedCapabilities = new Set(analysisResult.extractedCapabilities.map(c => c.name));
            } else {
                selectedCapabilities.clear();
            }
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const el = document.getElementById('selectedCount');
            el.textContent = `${selectedCapabilities.size} selected`;
            el.style.color = selectedCapabilities.size > 0 ? 'var(--success)' : 'var(--error)';
        }
        
        // ==========================================
        // STEP 3: AGENT DESIGN
        // ==========================================
        function startAgentDesign() {
            if (selectedCapabilities.size === 0) {
                alert('‚ö†Ô∏è Select at least 1 capability to continue.');
                return;
            }
            goToStep(3);
        }
        
        function showStep3Results() {
            document.getElementById('step3Loading').classList.remove('active');
            document.getElementById('step3Results').classList.add('active');
            
            const selected = Array.from(selectedCapabilities);
            let agents = analysisResult?.agents || [];
            
            agents = agents.filter(agent => {
                const agentCaps = agent.capabilities || [];
                return agentCaps.some(cap => selected.includes(typeof cap === 'string' ? cap : cap.name));
            }).map(agent => ({
                ...agent,
                capabilities: (agent.capabilities || []).filter(cap => 
                    selected.includes(typeof cap === 'string' ? cap : cap.name)
                )
            }));
            
            analysisResult.filteredAgents = agents;
            renderAgentCards(agents);
            
            const countEl = document.getElementById('agentCount');
            if (countEl) {
                countEl.textContent = agents.length;
            }
            
            const subtitle = document.querySelector('#step3Results .subtitle');
            if (subtitle && agents.length > 0) {
                subtitle.innerHTML = `<span id="agentCount">${agents.length}</span> agents suggested. Select the appropriate <strong>Agentic Pattern</strong> per agent.`;
            }
        }
        
        function renderAgentCards(agents) {
            const container = document.getElementById('agentsGrid');
            container.innerHTML = agents.map(agent => {
                const pattern = getPatternInfo(agent.pattern);
                return `
                    <div class="agent-card" onclick="openAgentModal('${agent.id}')">
                        <div class="agent-header">
                            <span class="agent-name">${escapeHtml(agent.name)}</span>
                            <span class="agent-pattern pattern-${(agent.pattern || 'specialist').toLowerCase().replace(/[^a-z]/g, '-')}">${pattern.emoji} ${pattern.name}</span>
                        </div>
                        ${agent.valueStream ? `<div class="agent-vs">üìç ${escapeHtml(agent.valueStream)}</div>` : ''}
                        <div class="agent-purpose">${escapeHtml((agent.purpose || agent.description || '').substring(0, 100))}${(agent.purpose || '').length > 100 ? '...' : ''}</div>
                        <div class="agent-meta">
                            <span class="agent-tag">${agent.autonomyLevel || 'supervised'}</span>
                            <span class="agent-tag">${agent.riskAppetite || 'medium'} risk</span>
                            <span class="agent-tag">${(agent.capabilities || []).length} caps</span>
                        </div>
                        <div class="agent-edit-hint">‚úèÔ∏è Click to edit</div>
                    </div>
                `;
            }).join('');
        }
        
        function getPatternInfo(pattern) {
            const p = agenticPatterns.find(ap => ap.id === pattern || ap.name === pattern);
            return p || { emoji: 'ü§ñ', name: pattern || 'Specialist', color: '#3b82f6' };
        }
        
        function openAgentModal(agentId) {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            document.getElementById('modalAgentId').value = agentId;
            document.getElementById('modalAgentTitle').textContent = `ü§ñ ${agent.name}`;
            document.getElementById('modalAgentName').value = agent.name || '';
            document.getElementById('modalAgentValueStream').value = agent.valueStream || '';
            document.getElementById('modalAgentCapGroup').value = agent.capabilityGroup || '';
            document.getElementById('modalAgentPurpose').value = agent.purpose || agent.description || '';
            document.getElementById('modalAgentObjectives').value = (agent.objectives || []).join('\n');
            document.getElementById('modalAgentCapabilities').value = (agent.capabilities || []).map(c => typeof c === 'string' ? c : c.name).join(', ');
            document.getElementById('modalAgentPattern').value = agent.pattern || 'Specialist';
            document.getElementById('modalAgentDecision').value = agent.decisionAuthority || 'propose-and-execute';
            document.getElementById('modalAgentAutonomy').value = agent.autonomyLevel || 'supervised';
            document.getElementById('modalAgentRisk').value = agent.riskAppetite || 'medium';
            document.getElementById('modalAgentInteraction').value = agent.interactionPattern || 'request-response';
            document.getElementById('modalAgentTriggers').value = (agent.triggers || []).join(', ');
            document.getElementById('modalAgentOutputs').value = (agent.outputs || []).join(', ');
            document.getElementById('modalAgentEscalation').value = agent.escalationPath || '';
            
            document.getElementById('agentModal').classList.add('active');
        }
        
        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('active');
        }
        
        function saveAgentModal() {
            const agentId = document.getElementById('modalAgentId').value;
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            agent.name = document.getElementById('modalAgentName').value;
            agent.valueStream = document.getElementById('modalAgentValueStream').value;
            agent.capabilityGroup = document.getElementById('modalAgentCapGroup').value;
            agent.purpose = document.getElementById('modalAgentPurpose').value;
            agent.description = document.getElementById('modalAgentPurpose').value;
            agent.objectives = document.getElementById('modalAgentObjectives').value.split('\n').filter(s => s.trim());
            agent.capabilities = document.getElementById('modalAgentCapabilities').value.split(',').map(s => s.trim()).filter(s => s);
            agent.pattern = document.getElementById('modalAgentPattern').value;
            agent.decisionAuthority = document.getElementById('modalAgentDecision').value;
            agent.autonomyLevel = document.getElementById('modalAgentAutonomy').value;
            agent.riskAppetite = document.getElementById('modalAgentRisk').value;
            agent.interactionPattern = document.getElementById('modalAgentInteraction').value;
            agent.triggers = document.getElementById('modalAgentTriggers').value.split(',').map(s => s.trim()).filter(s => s);
            agent.outputs = document.getElementById('modalAgentOutputs').value.split(',').map(s => s.trim()).filter(s => s);
            agent.escalationPath = document.getElementById('modalAgentEscalation').value;
            
            const mainAgents = analysisResult?.agents || [];
            const mainAgent = mainAgents.find(a => a.id === agentId);
            if (mainAgent) Object.assign(mainAgent, agent);
            
            renderAgentCards(agents);
            saveState();
            closeAgentModal();
        }
        
        // ==========================================
        // STEP 4: PROCESS DESIGN
        // ==========================================
        function startProcessDesign() {
            goToStep(4);
        }
        
        function showStep4Results() {
            document.getElementById('step4Loading').classList.remove('active');
            document.getElementById('step4Results').classList.add('active');
            renderProcessCards();
        }
        
        function renderProcessCards() {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const container = document.getElementById('processCards');
            
            container.innerHTML = agents.map((agent, idx) => `
                <div class="process-card">
                    <div class="process-header">
                        <span class="process-title">${escapeHtml(agent.name)}</span>
                        <button class="btn btn-warning btn-sm" onclick="generateProcess(${idx})">ü§ñ Generate</button>
                    </div>
                    <div class="process-field">
                        <label>üìã Process Steps</label>
                        <textarea id="process-steps-${idx}" placeholder="1. Receive trigger&#10;2. Validate input&#10;3. Execute action&#10;4. Notify result">${agent.processSteps || ''}</textarea>
                    </div>
                    <div class="process-field">
                        <label>üîÄ Decision Points</label>
                        <textarea id="process-decisions-${idx}" rows="2" placeholder="IF condition THEN action">${agent.decisionPoints || ''}</textarea>
                    </div>
                    <div class="process-field">
                        <label>‚ö†Ô∏è Error Handling</label>
                        <textarea id="process-errors-${idx}" rows="2" placeholder="ON error THEN action">${agent.errorHandling || ''}</textarea>
                    </div>
                </div>
            `).join('');
        }
        
        async function generateProcess(idx) {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const agent = agents[idx];
            if (!agent) return;
            
            const stepsEl = document.getElementById(`process-steps-${idx}`);
            const decisionsEl = document.getElementById(`process-decisions-${idx}`);
            const errorsEl = document.getElementById(`process-errors-${idx}`);
            
            stepsEl.value = '‚è≥ Generating...';
            decisionsEl.value = '';
            errorsEl.value = '';
            
            try {
                const response = await fetchWithAuth('/api/wizard/generate-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agent })
                });
                
                if (!response.ok) {
                    const errorMessage = await extractErrorMessage(response, 'Process generation failed');
                    throw new Error(errorMessage);
                }
                
                const data = await parseApiResponse(response);
                const reply = `PROCESS STEPS:\n${data.processSteps}\n\nDECISION POINTS:\n${data.decisionPoints}\n\nERROR HANDLING:\n${data.errorHandling}`;
                
                const stepsMatch = reply.match(/PROCESS STEPS:([\s\S]*?)(?=DECISION POINTS:|$)/i);
                const decisionsMatch = reply.match(/DECISION POINTS:([\s\S]*?)(?=ERROR HANDLING:|$)/i);
                const errorsMatch = reply.match(/ERROR HANDLING:([\s\S]*?)$/i);
                
                stepsEl.value = stepsMatch ? stepsMatch[1].trim() : reply;
                decisionsEl.value = decisionsMatch ? decisionsMatch[1].trim() : '';
                errorsEl.value = errorsMatch ? errorsMatch[1].trim() : '';
                
                agent.processSteps = stepsEl.value;
                agent.decisionPoints = decisionsEl.value;
                agent.errorHandling = errorsEl.value;
                saveState();
                
            } catch (e) {
                stepsEl.value = 'Error: ' + e.message;
            }
        }
        
        async function generateAllProcesses() {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            
            document.getElementById('step4Loading').classList.add('active');
            document.getElementById('step4Results').classList.remove('active');
            
            for (let i = 0; i < agents.length; i++) {
                updateProgress('step4', ((i + 1) / agents.length) * 100, `Generating: ${agents[i].name} (${i + 1}/${agents.length})`);
                await generateProcess(i);
                await delay(500);
            }
            
            document.getElementById('step4Loading').classList.remove('active');
            document.getElementById('step4Results').classList.add('active');
            renderProcessCards();
        }
        
        // ==========================================
        // STEP 5: INTERACTIONS
        // ==========================================
        function startInteractionDesign() {
            goToStep(5);
        }
        
        function showStep5Results() {
            document.getElementById('step5Loading').classList.remove('active');
            document.getElementById('step5Results').classList.add('active');
            
            renderInteractions();
            renderInteractionGraph();
        }
        
        function showInteractionTab(tab) {
            document.querySelectorAll('.int-tab').forEach(t => {
                t.classList.toggle('active', t.textContent.toLowerCase().includes(tab.substring(0, 3)));
            });
            document.querySelectorAll('.int-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`int${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
        }
        
        function renderInteractions() {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const relationships = analysisResult?.agentRelationships || [];
            const integrations = analysisResult?.integrations || [];
            
            const getAgentName = (id) => {
                if (!id) return 'Unknown';
                const agent = agents.find(a => a.id === id);
                return agent ? agent.name : id;
            };
            
            const relContainer = document.getElementById('intRelationships');
            relContainer.innerHTML = relationships.length ? relationships.map(r => `
                <div class="rel-item">
                    <div class="rel-agents">
                        <span class="rel-agent source">${escapeHtml(getAgentName(r.sourceAgentId || r.from))}</span>
                        <span class="rel-arrow">‚Üí</span>
                        <span class="rel-agent target">${escapeHtml(getAgentName(r.targetAgentId || r.to))}</span>
                    </div>
                    <div class="rel-type">üì® ${r.messageType || 'message'}</div>
                    <div class="rel-desc">${escapeHtml(r.description || 'No description')}</div>
                </div>
            `).join('') : '<p style="color: var(--text-muted);">No relationships defined</p>';
            
            const intContainer = document.getElementById('intIntegrations');
            intContainer.innerHTML = integrations.length ? integrations.map(i => `
                <div class="int-item">
                    <div class="int-name">üîå ${escapeHtml(i.name || i.system)}</div>
                    <div class="int-meta">${i.type} ‚Ä¢ ${i.system} ‚Ä¢ ${i.direction}</div>
                    <div class="int-agent">Agent: ${escapeHtml(getAgentName(i.agentId))}</div>
                </div>
            `).join('') : '<p style="color: var(--text-muted);">No integrations defined</p>';
            
            const msgContainer = document.getElementById('intMessages');
            const messageTypes = analysisResult?.messageTypes || [];
            const relMsgTypes = [...new Set(relationships.map(r => r.messageType).filter(Boolean))];
            const allMessages = messageTypes.length ? messageTypes : relMsgTypes.map(m => ({ name: m, description: 'From relationships' }));
            
            msgContainer.innerHTML = allMessages.length ? allMessages.map(m => `
                <div class="msg-item">
                    <div class="msg-name">üì® ${escapeHtml(m.name)}</div>
                    <div class="msg-desc">${escapeHtml(m.description || '')}</div>
                </div>
            `).join('') : '<p style="color: var(--text-muted);">No message types defined</p>';
            
            document.getElementById('relCount').textContent = relationships.length;
            document.getElementById('intCount').textContent = integrations.length;
        }
        
        function renderInteractionGraph() {
            const container = document.getElementById('interactionGraph');
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const relationships = analysisResult?.agentRelationships || [];
            
            if (agents.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-muted);">No agents to visualize</p>';
                return;
            }
            
            const nodes = agents.map((a, i) => ({
                id: a.id,
                label: a.name,
                color: { background: '#1e293b', border: '#3b82f6' },
                font: { color: '#e2e8f0' }
            }));
            
            const edges = relationships.map(r => ({
                from: r.sourceAgentId || r.from,
                to: r.targetAgentId || r.to,
                label: r.messageType || '',
                color: { color: '#60a5fa' },
                font: { color: '#cbd5e1', size: 10 },
                arrows: 'to'
            }));
            
            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                nodes: { shape: 'box', borderWidth: 2 },
                edges: { smooth: { type: 'cubicBezier' } },
                physics: { enabled: true, stabilization: { iterations: 100 } },
                interaction: { hover: true }
            };
            
            if (interactionGraph) interactionGraph.destroy();
            interactionGraph = new vis.Network(container, data, options);
        }
        
        async function regenerateInteractions() {
            try {
                const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
                
                const response = await fetchWithAuth('/api/design/suggest-interactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(await extractErrorMessage(response, 'Interaction generation failed'));
                }
                
                const data = await parseApiResponse(response);
                
                if (data.suggestions && data.suggestions.length > 0) {
                    const newRelationships = data.suggestions.map(s => {
                        const sourceAgent = agents.find(a => a.name === s.sourceAgent);
                        const targetAgent = agents.find(a => a.name === s.targetAgent);
                        return {
                            sourceAgentId: sourceAgent?.id || s.sourceAgent,
                            targetAgentId: targetAgent?.id || s.targetAgent,
                            messageType: s.messageType,
                            description: s.description
                        };
                    });
                    
                    analysisResult.agentRelationships = newRelationships;
                    renderInteractions();
                    renderInteractionGraph();
                    saveState();
                    alert(`‚úÖ Generated ${newRelationships.length} new interactions`);
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
        }
        
        // ==========================================
        // STEP 6: SUMMARY & IMPORT
        // ==========================================
        function showStep6Summary() {
            const agents = analysisResult?.filteredAgents || analysisResult?.agents || [];
            const capabilities = selectedCapabilities.size;
            const relationships = analysisResult?.agentRelationships?.length || 0;
            const integrations = analysisResult?.integrations?.length || 0;
            
            document.getElementById('summaryAgents').textContent = agents.length;
            document.getElementById('summaryCapabilities').textContent = capabilities;
            document.getElementById('summaryInteractions').textContent = relationships;
            document.getElementById('summaryIntegrations').textContent = integrations;
            
            const listContainer = document.getElementById('summaryAgentList');
            listContainer.innerHTML = agents.map(agent => {
                const pattern = getPatternInfo(agent.pattern);
                return `
                    <div class="summary-agent">
                        <div>
                            <span class="summary-agent-name">ü§ñ ${escapeHtml(agent.name)}</span>
                            <span class="summary-agent-caps">${(agent.capabilities || []).length} caps</span>
                        </div>
                        <span class="agent-pattern pattern-${(agent.pattern || 'specialist').toLowerCase().replace(/[^a-z]/g, '-')}" style="font-size: 0.65rem;">${pattern.emoji} ${pattern.name}</span>
                    </div>
                `;
            }).join('');
        }
        
        async function performImport() {
            if (!sessionId) {
                showError('step6Error', 'No session ID. Please start the wizard again.');
                return;
            }
            
            hideError('step6Error');
            document.getElementById('step6Loading').classList.add('active');
            
            try {
                const response = await fetchWithAuth('/api/wizard/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // tenantId is resolved by backend from authenticated request context
                    body: JSON.stringify({ sessionId })
                });
                
                if (!response.ok) {
                    const errorMessage = await extractErrorMessage(response, 'Import failed');
                    throw new Error(errorMessage);
                }
                
                const data = await parseApiResponse(response);
                
                document.getElementById('step6Loading').classList.remove('active');
                
                document.getElementById('successMessage').textContent = 
                    `Created ${data.created.agents} agents with ${data.created.interactions} interactions and ${data.created.integrations} integrations.`;
                
                document.getElementById('finalSummary').innerHTML = `
                    <div class="stat-card green">
                        <div class="stat-value">${data.created.agents}</div>
                        <div class="stat-label">Agents Created</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value">${data.created.interactions}</div>
                        <div class="stat-label">Interactions</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-value">${data.created.integrations}</div>
                        <div class="stat-label">Integrations</div>
                    </div>
                `;
                
                // Primary success path: open Design module immediately.
                // NOTE: Keep wizard state until navigation succeeds. Clearing it too early
                // can force users back to step 1 if /design is temporarily unavailable.
                const redirectUrl = data.redirectUrl || '/design';
                try {
                    window.location.href = redirectUrl;
                    return;
                } catch (navError) {
                    console.warn('Navigation to Design module failed, showing success screen:', navError);
                }
                
                // Fallback: show success screen in place and clear state only here.
                clearState();
                document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
                document.getElementById('step7').classList.remove('hidden');
                
            } catch (error) {
                document.getElementById('step6Loading').classList.remove('active');
                showError('step6Error', error.message);
            }
        }
        
        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showLoading(step, show) {
            const loading = document.getElementById(`${step}Loading`);
            if (loading) {
                if (show) {
                    loading.classList.add('active');
                } else {
                    loading.classList.remove('active');
                }
            }
        }
        
        function updateProgress(step, percent, status) {
            const progress = document.getElementById(`${step}Progress`);
            const statusEl = document.getElementById(`${step}Status`);
            if (progress) progress.style.width = `${percent}%`;
            if (statusEl) statusEl.textContent = status;
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = '‚ùå ' + message;
                el.classList.add('active');
            }
        }
        
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.classList.remove('active');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function checkExistingOrgData() {
            const cta = document.getElementById('existingDataCta');
            if (!cta) return;

            try {
                const response = await fetchWithAuth('/api/agents', { method: 'GET' });
                if (!response.ok) return;

                const data = await parseApiResponse(response);
                if (Array.isArray(data) && data.length > 0) {
                    cta.style.display = 'block';
                }
            } catch (e) {
                console.warn('Could not check existing org data:', e);
            }
        }
        
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        document.getElementById('imageFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) showImagePreview(e.target.files[0]);
        });
        
        const imageDropZone = document.getElementById('imageDropZone');
        imageDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageDropZone.classList.add('dragover');
        });
        imageDropZone.addEventListener('dragleave', () => {
            imageDropZone.classList.remove('dragover');
        });
        imageDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            imageDropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.type.startsWith('image/')) {
                showImagePreview(e.dataTransfer.files[0]);
            }
        });
        
        document.getElementById('xmlFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) processXmlUpload(e.target.files[0]);
        });
        
        const xmlDropZone = document.getElementById('xmlDropZone');
        xmlDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            xmlDropZone.classList.add('dragover');
        });
        xmlDropZone.addEventListener('dragleave', () => {
            xmlDropZone.classList.remove('dragover');
        });
        xmlDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            xmlDropZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]?.name.endsWith('.xml')) {
                processXmlUpload(e.dataTransfer.files[0]);
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAgentModal();
        });
        
        document.getElementById('agentModal').addEventListener('click', (e) => {
            if (e.target.id === 'agentModal') closeAgentModal();
        });
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            window.FlowgridAuthUI.initPage({ requireAuth: true, showSignOut: false });
            await checkExistingOrgData();

            // Remove prior-session restore behavior completely.
            clearState();
            goToStep(1);
        });
    </script>
</body>
</html>
