<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>üí¨ Flowgrid Wizard - Agent Design</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- vis-network for graph -->
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
    <!-- bpmn-js for BPMN viewer -->
    <script src="/js/bpmn-navigated-viewer.production.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #172554;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --bg-input: #0b1220;
            --border-default: #334155;
            --border-hover: #475569;
            --border-accent: #3b82f6;
            --accent-primary: #3b82f6;
            --accent-secondary: #60a5fa;
            --accent-tertiary: #93c5fd;
            --accent-glow: rgba(59, 130, 246, 0.25);
            --accent-glow-strong: rgba(59, 130, 246, 0.45);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #60a5fa;
            --purple: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; min-height: 100vh; }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding: 1rem 1.5rem;
            background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 12px;
        }
        .header-left { display: flex; flex-direction: column; }
        header h1 { font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); display: flex; align-items: center; gap: 0.5rem; }
        .header-subtitle { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; }
        .back-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-default);
            padding: 0.5rem 1rem; border-radius: 6px; color: var(--text-primary);
            cursor: pointer; text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;
        }
        .back-btn:hover { background: var(--bg-card-hover); border-color: var(--accent-primary); color: var(--accent-primary); }

        /* Progress Steps */
        .progress-bar {
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 2rem; gap: 0;
            background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 12px; padding: 1rem 1rem;
            overflow-x: auto;
        }
        .step { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.2s; padding: 0 0.35rem; }
        .step:hover .step-circle { transform: scale(1.05); }
        .step-circle {
            width: 30px; height: 30px; border-radius: 50%; background: var(--bg-secondary);
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 0.8rem; color: var(--text-muted);
            transition: all 0.2s; border: 2px solid var(--border-default);
        }
        .step.active .step-circle { background: var(--accent-primary); border-color: var(--accent-primary); color: var(--bg-primary); box-shadow: 0 0 16px var(--accent-glow); }
        .step.completed .step-circle { background: var(--bg-card-hover); border-color: var(--accent-primary); color: var(--accent-primary); }
        .step-label { margin-top: 0.35rem; font-size: 0.6rem; font-weight: 500; color: var(--text-muted); text-align: center; white-space: nowrap; }
        .step.active .step-label { color: var(--accent-primary); }
        .step.completed .step-label { color: var(--accent-secondary); }
        .step-line { width: 24px; height: 2px; background: var(--border-default); margin: 0 0.15rem; margin-bottom: 1.25rem; border-radius: 1px; transition: all 0.2s; }
        .step.completed + .step-line { background: var(--accent-primary); }

        /* Cards */
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .card p.subtitle { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem; }

        /* Form elements */
        .input-group { margin-bottom: 1.25rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); font-size: 0.85rem; }
        textarea, input[type="text"], input[type="url"] {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-default); border-radius: 8px;
            background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; font-family: inherit; transition: all 0.2s;
        }
        select {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-default); border-radius: 8px;
            background: var(--bg-input); color: var(--text-primary); font-size: 0.9rem; font-family: inherit; transition: all 0.2s;
        }
        textarea:focus, input:focus, select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-glow); }
        textarea { min-height: 100px; resize: vertical; }
        textarea::placeholder, input::placeholder { color: var(--text-muted); }
        .helper-text { color: var(--text-muted); font-size: 0.75rem; margin-top: 0.4rem; }

        /* Buttons */
        .btn {
            padding: 0.7rem 1.5rem; border: none; border-radius: 8px; font-size: 0.9rem;
            font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--accent-primary); color: var(--bg-primary); }
        .btn-primary:hover { background: var(--accent-secondary); box-shadow: 0 4px 16px var(--accent-glow); }
        .btn-primary:disabled { background: var(--bg-secondary); color: var(--text-muted); cursor: not-allowed; }
        .btn-success { background: var(--success); color: var(--bg-primary); }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: var(--bg-primary); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-default); }
        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--accent-primary); }
        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.8rem; }
        .btn-danger { background: var(--error); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-group { display: flex; gap: 0.75rem; justify-content: space-between; margin-top: 1.5rem; flex-wrap: wrap; }

        /* Loading */
        .loading { display: none; flex-direction: column; align-items: center; padding: 2.5rem; }
        .loading.active { display: flex; }
        .loading-icon { font-size: 3rem; margin-bottom: 0.75rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-container { width: 100%; max-width: 350px; margin: 0.75rem 0; }
        .progress-track { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary)); width: 0%; transition: width 0.5s ease-out; border-radius: 3px; }
        .loading-status { color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; }
        .spinner { width: 24px; height: 24px; border: 3px solid var(--border-default); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results */
        .results { display: none; }
        .results.active { display: block; }

        /* Stats grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.25rem; }
        .stat-card { background: var(--bg-card); padding: 1rem; border-radius: 8px; text-align: center; border-left: 4px solid var(--accent-primary); }
        .stat-card.green { border-left-color: var(--success); }
        .stat-card.yellow { border-left-color: var(--warning); }
        .stat-card.blue { border-left-color: var(--info); }
        .stat-card.purple { border-left-color: var(--purple); }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--accent-primary); }
        .stat-card.green .stat-value { color: var(--success); }
        .stat-card.yellow .stat-value { color: var(--warning); }
        .stat-card.blue .stat-value { color: var(--info); }
        .stat-card.purple .stat-value { color: var(--purple); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Agent cards */
        .agents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
        .agent-card {
            background: var(--bg-input); border: 1px solid var(--border-default); border-left: 4px solid var(--accent-primary);
            border-radius: 10px; padding: 1rem; transition: all 0.2s; position: relative;
        }
        .agent-card:hover { border-color: var(--accent-primary); background: var(--bg-card); box-shadow: 0 0 20px var(--accent-glow); }
        .agent-card.orchestrator { border-left-color: #dc2626; background: rgba(220, 38, 38, 0.05); }
        .agent-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .agent-name { font-weight: 600; color: var(--accent-primary); font-size: 0.95rem; }
        .agent-card.orchestrator .agent-name { color: #f87171; }
        .agent-pattern {
            font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600;
            background: var(--accent-primary); color: var(--bg-primary);
        }
        .agent-card.orchestrator .agent-pattern { background: #dc2626; color: white; }
        .agent-purpose { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 0.6rem; }
        .agent-responsibilities { list-style: none; padding: 0; }
        .agent-responsibilities li { font-size: 0.75rem; color: var(--text-muted); padding: 0.15rem 0; }
        .agent-responsibilities li::before { content: '‚Ä¢ '; color: var(--accent-primary); }
        .agent-card.orchestrator .agent-responsibilities li::before { color: #f87171; }
        .agent-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }

        /* Editable agent card form elements */
        .agent-card input, .agent-card textarea, .agent-card select {
            font-size: 0.8rem; padding: 0.4rem 0.6rem; margin-top: 0.25rem;
        }
        .agent-card textarea { min-height: 60px; }

        /* BPMN viewer */
        .bpmn-container { height: 600px; background: white; border-radius: 8px; border: 1px solid var(--border-default); margin-bottom: 1rem; }

        /* Tabs */
        .tab-bar { display: flex; gap: 0.25rem; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 0.25rem; }
        .tab-btn {
            padding: 0.5rem 1rem; border: 1px solid var(--border-default); border-radius: 6px 6px 0 0;
            background: var(--bg-secondary); color: var(--text-secondary); cursor: pointer;
            font-size: 0.8rem; font-weight: 500; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--accent-primary); color: var(--bg-primary); border-color: var(--accent-primary); }
        .tab-btn:hover:not(.active) { background: var(--bg-card-hover); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Config cards */
        .config-card {
            background: var(--bg-input); border: 1px solid var(--border-default); border-radius: 8px;
            padding: 1rem; margin-bottom: 0.75rem;
        }
        .config-card h4 { color: var(--accent-primary); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .config-section { margin-bottom: 0.75rem; }
        .config-section h5 { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.35rem; }
        .config-list { list-style: none; padding: 0; }
        .config-list li { font-size: 0.8rem; color: var(--text-secondary); padding: 0.2rem 0; padding-left: 1rem; position: relative; }
        .config-list li::before { content: '‚Üí'; position: absolute; left: 0; color: var(--accent-primary); }

        /* Error display */
        .error-box {
            display: none; background: rgba(245, 101, 101, 0.1); border: 1px solid rgba(245, 101, 101, 0.3);
            padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; color: #fca5a5; font-size: 0.85rem;
        }
        .error-box.active { display: block; }

        /* Success card */
        .success-card { text-align: center; padding: 2.5rem; }
        .success-icon { font-size: 4rem; margin-bottom: 0.75rem; }
        .success-title { font-size: 1.35rem; margin-bottom: 0.4rem; color: var(--accent-primary); }
        .success-subtitle { color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem; }

        /* Process select list */
        .process-list { max-height: 400px; overflow-y: auto; }
        .process-item {
            padding: 1rem; border: 1px solid var(--border-default); border-radius: 8px;
            margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; background: var(--bg-input);
        }
        .process-item:hover { border-color: var(--accent-primary); background: var(--bg-card); }
        .process-item.selected { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 12px var(--accent-glow); }
        .process-item-name { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; }
        .process-item-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; opacity: 0.5; }

        .hidden { display: none !important; }

        /* Footer */
        .wizard-footer { text-align: center; padding: 1rem; margin-top: 1rem; color: var(--text-muted); font-size: 0.75rem; }
        .wizard-footer a { color: var(--accent-primary); text-decoration: none; }

        /* Cookie Consent */
        .consent-banner {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card);
            border-top: 2px solid var(--accent-primary); padding: 1rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center; gap: 1rem; z-index: 1001;
        }
        .consent-banner.hidden { display: none; }
        .consent-text { flex: 1; font-size: 0.85rem; color: var(--text-secondary); }
        .consent-text a { color: var(--accent-primary); text-decoration: none; }
        .consent-buttons { display: flex; gap: 0.5rem; }
        .consent-btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
        .consent-accept { background: var(--accent-primary); color: var(--bg-primary); }
        .consent-decline { background: var(--bg-secondary); border: 1px solid var(--border-default); color: var(--text-primary); }

        @media (max-width: 768px) {
            .agents-grid { grid-template-columns: 1fr; }
            .step-label { display: none; }
            .step-line { width: 12px; }
            header { flex-direction: column; gap: 0.75rem; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-left">
                <h1>üí¨ Flowgrid Design Wizard</h1>
                <span class="header-subtitle">Process-first agent swarm design in 8 steps</span>
            </div>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <a href="/design/" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.85rem; text-decoration: none; background: var(--accent-primary); color: white; border-radius: 6px;">‚ö° Design Module</a>
                <a href="/" target="_top" class="back-btn">‚Üê Dashboard</a>
            </div>
        </header>

        <!-- Progress Bar - 8 Steps -->
        <div class="progress-bar">
            <div class="step active" data-step="1" onclick="navigateToStep(1)">
                <div class="step-circle">1</div>
                <span class="step-label">Process</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="2" onclick="navigateToStep(2)">
                <div class="step-circle">2</div>
                <span class="step-label">Sub-process</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="3" onclick="navigateToStep(3)">
                <div class="step-circle">3</div>
                <span class="step-label">Agents</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="4" onclick="navigateToStep(4)">
                <div class="step-circle">4</div>
                <span class="step-label">Review</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="5" onclick="navigateToStep(5)">
                <div class="step-circle">5</div>
                <span class="step-label">Flows</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="6" onclick="navigateToStep(6)">
                <div class="step-circle">6</div>
                <span class="step-label">Review Flows</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="7" onclick="navigateToStep(7)">
                <div class="step-circle">7</div>
                <span class="step-label">Config</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="8" onclick="navigateToStep(8)">
                <div class="step-circle">8</div>
                <span class="step-label">Import</span>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- STEP 1: SELECT PROCESS -->
        <!-- ============================================================ -->
        <section id="step1" class="step-content">
            <div class="card">
                <div style="text-align: center; margin-bottom: 1.25rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.8;">üéØ</div>
                    <h2>Select a Process</h2>
                    <p class="subtitle">Choose a process from your foundation to agentize.</p>
                </div>

                <div class="input-group">
                    <label for="foundationSelect">üìö Select Foundation</label>
                    <select id="foundationSelect" onchange="onFoundationSelect(this.value)" style="padding: 0.75rem; font-size: 1rem;">
                        <option value="">-- Select a foundation --</option>
                    </select>
                </div>

                <div id="foundationPreview" style="display: none; margin-bottom: 1.25rem;">
                    <div style="background: var(--bg-input); border: 1px solid var(--border-default); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h4 id="foundationPreviewName" style="color: var(--accent-primary); margin-bottom: 0.5rem;"></h4>
                        <p id="foundationPreviewDesc" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;"></p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 80px; text-align: center; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div id="foundationCapCount" style="font-size: 1.5rem; font-weight: bold; color: #22d3ee;">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Capabilities</div>
                            </div>
                            <div style="flex: 1; min-width: 80px; text-align: center; padding: 0.5rem; background: var(--bg-secondary); border-radius: 6px;">
                                <div id="foundationProcCount" style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Processes</div>
                            </div>
                        </div>
                    </div>

                    <label>üîÑ Select a Process to Agentize</label>
                    <div class="process-list" id="processList">
                        <!-- Process items rendered here -->
                    </div>
                </div>

                <div id="selectedProcessInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-primary); border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Selected Process</div>
                    <div id="selectedProcessName" style="font-size: 1.1rem; font-weight: 600; color: var(--accent-primary); margin-top: 0.25rem;"></div>
                    <div id="selectedProcessDesc" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;"></div>
                </div>

                <div id="noFoundationsMsg" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                    <p>No foundations found. Create a Discovery Foundation first.</p>
                    <a href="/discovery/" class="btn btn-secondary" style="margin-top: 1rem; display: inline-block; text-decoration: none;">üîç Create Discovery Foundation</a>
                </div>

                <div class="error-box" id="step1Error"></div>

                <div class="btn-group">
                    <div></div>
                    <button class="btn btn-primary" id="step1ContinueBtn" disabled onclick="goToStep(2)">Continue ‚Üí</button>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 2: DEFINE SUB-PROCESS -->
        <!-- ============================================================ -->
        <section id="step2" class="step-content hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <h2>üìã Define Sub-Process</h2>
                        <p class="subtitle">Describe what you want to automate within the selected process.</p>
                    </div>
                    <button class="btn btn-secondary" onclick="surpriseMe()" style="white-space: nowrap;">üé≤ Surprise Me</button>
                </div>

                <div class="input-group">
                    <label for="subProcessName">Sub-process Name *</label>
                    <input type="text" id="subProcessName" placeholder="e.g., Incident Triage & Assignment">
                </div>
                <div class="input-group">
                    <label for="subProcessDesc">What should be automated? *</label>
                    <textarea id="subProcessDesc" placeholder="Describe the workflow you want agents to handle. Be specific about inputs, steps, and expected behavior..."></textarea>
                </div>
                <div class="input-group">
                    <label for="subProcessOutcome">Expected Outcome *</label>
                    <textarea id="subProcessOutcome" rows="3" style="min-height: 70px;" placeholder="What does success look like? e.g., Incidents are automatically triaged, categorized, and assigned to the right team within 5 minutes"></textarea>
                </div>
                <div class="input-group">
                    <label for="subProcessConstraints">Constraints / Requirements <span style="color: var(--text-muted); font-weight: 400;">(optional)</span></label>
                    <textarea id="subProcessConstraints" rows="3" style="min-height: 70px;" placeholder="e.g., Must integrate with ServiceNow, human approval needed for P1 incidents, max 3 agents"></textarea>
                </div>

                <div class="error-box" id="step2Error"></div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                    <button class="btn btn-success" onclick="identifyAgents()">ü§ñ Generate Agents</button>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 3: AI AGENT IDENTIFICATION -->
        <!-- ============================================================ -->
        <section id="step3" class="step-content hidden">
            <div class="card">
                <div class="loading" id="step3Loading">
                    <div class="loading-icon">ü§ñ</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Identifying & Optimizing Agents...</h3>
                    <div class="progress-container">
                        <div class="progress-track"><div class="progress-fill" id="step3Progress"></div></div>
                    </div>
                    <p class="loading-status" id="step3Status">AI is analyzing your process...</p>
                </div>

                <div class="results" id="step3Results">
                    <h2>ü§ñ Proposed Agent Swarm</h2>
                    <p class="subtitle">AI has identified <span id="proposedAgentCount">0</span> agents for your sub-process.</p>

                    <div class="agents-grid" id="proposedAgentsGrid">
                        <!-- Proposed agent cards rendered here -->
                    </div>

                    <div class="error-box" id="step3Error"></div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goToStep(4)">Review & Edit Agents ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 4: REVIEW & EDIT AGENTS -->
        <!-- ============================================================ -->
        <section id="step4" class="step-content hidden">
            <div class="card">
                <h2>‚úèÔ∏è Review & Edit Agents</h2>
                <p class="subtitle">Adjust agent names, purposes, patterns, and responsibilities. Add or remove agents as needed.</p>

                <div class="agents-grid" id="editableAgentsGrid">
                    <!-- Editable agent cards rendered here -->
                </div>

                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="addNewAgent()">‚ûï Add Agent</button>
                </div>

                <div class="error-box" id="step4Error"></div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                    <button class="btn btn-success" onclick="generateAllBpmn()">üìä Approve & Generate Agent Flows</button>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 5: AI BPMN GENERATION -->
        <!-- ============================================================ -->
        <section id="step5" class="step-content hidden">
            <div class="card">
                <div class="loading" id="step5Loading">
                    <div class="loading-icon">üìä</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Generating Agent Flows...</h3>
                    <div class="progress-container">
                        <div class="progress-track"><div class="progress-fill" id="step5Progress"></div></div>
                    </div>
                    <p class="loading-status" id="step5Status">Generating orchestrator flow...</p>
                </div>

                <div class="results" id="step5Results">
                    <h2>‚úÖ Agent Flows Generated</h2>
                    <p class="subtitle">All workflows have been generated. Review them in the next step.</p>

                    <div class="stats-grid">
                        <div class="stat-card green">
                            <div class="stat-value" id="bpmnAgentCount">0</div>
                            <div class="stat-label">Agent Workflows</div>
                        </div>
                        <div class="stat-card blue">
                            <div class="stat-value">1</div>
                            <div class="stat-label">Orchestrator Flow</div>
                        </div>
                    </div>

                    <div class="error-box" id="step5Error"></div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="goToStep(6)">Review Agent Flows ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 6: REVIEW & APPROVE BPMN -->
        <!-- ============================================================ -->
        <section id="step6" class="step-content hidden">
            <div class="card">
                <h2>üìä Review Agent Flows</h2>
                <p class="subtitle">Review the generated flows for each agent. Switch between tabs to inspect. These flows are fully editable in the Design Module after import.</p>

                <div class="tab-bar" id="bpmnTabBar">
                    <!-- Tabs rendered dynamically -->
                </div>

                <div id="bpmnTabContents">
                    <!-- Tab contents rendered dynamically -->
                </div>

                <div class="error-box" id="step6Error"></div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(5)">‚Üê Regenerate</button>
                    <button class="btn btn-success" onclick="generateAgentConfigs()">‚úÖ Approve All & Configure</button>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 7: AI AGENT CONFIGURATION -->
        <!-- ============================================================ -->
        <section id="step7" class="step-content hidden">
            <div class="card">
                <div class="loading" id="step7Loading">
                    <div class="loading-icon">‚öôÔ∏è</div>
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Generating Agent Configurations...</h3>
                    <div class="progress-container">
                        <div class="progress-track"><div class="progress-fill" id="step7Progress"></div></div>
                    </div>
                    <p class="loading-status" id="step7Status">Defining skills and A2A configurations...</p>
                </div>

                <div class="results" id="step7Results">
                    <h2>‚öôÔ∏è Agent Configurations</h2>
                    <p class="subtitle">A2A-compliant configurations generated for each agent.</p>

                    <div id="agentConfigCards">
                        <!-- Config cards rendered here -->
                    </div>

                    <div class="error-box" id="step7Error"></div>

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="goToStep(6)">‚Üê Back</button>
                        <button class="btn btn-success" onclick="goToStep(8)">‚úÖ Approve & Import</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================================ -->
        <!-- STEP 8: IMPORT & CREATE -->
        <!-- ============================================================ -->
        <section id="step8" class="step-content hidden">
            <div class="card" id="step8ImportCard">
                <h2>üöÄ Ready to Import</h2>
                <p class="subtitle">Review the summary and create your agent swarm.</p>

                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-value" id="summaryAgents">0</div>
                        <div class="stat-label">Agents</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="summaryBpmn">0</div>
                        <div class="stat-label">Agent Flows</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-value" id="summarySkills">0</div>
                        <div class="stat-label">Skills</div>
                    </div>
                </div>

                <div id="summaryAgentList" style="background: var(--bg-input); border: 1px solid var(--border-default); border-radius: 8px; padding: 0.75rem; margin-bottom: 1.25rem; max-height: 300px; overflow-y: auto;">
                    <!-- Agent summary rendered here -->
                </div>

                <div class="error-box" id="step8Error"></div>

                <div class="loading" id="step8Loading">
                    <div class="spinner"></div>
                    <p class="loading-status" id="step8LoadingText">Creating agents...</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(7)">‚Üê Back</button>
                    <button class="btn btn-success" style="font-size: 1rem; padding: 0.8rem 2.5rem;" onclick="performImport()">
                        üöÄ Import & Create Swarm
                    </button>
                </div>
            </div>

            <!-- Success state -->
            <div class="card success-card hidden" id="step8Success">
                <div class="success-icon">üéâ</div>
                <h2 class="success-title">Agent Swarm Created!</h2>
                <p class="success-subtitle" id="successMessage">Your agents have been created and are ready to configure.</p>
                <div class="stats-grid" id="finalSummary"></div>
                <div class="btn-group" style="justify-content: center;">
                    <a id="openDesignLink" href="/design/" class="btn btn-primary" style="text-decoration: none;" onclick="event.preventDefault(); if (window.parent && window.parent.loadModuleByUrl) { window.parent.loadModuleByUrl(this.href, 'FlowGrid Design Studio'); } else { window.location.href = this.href; }">üé® Open Design Module ‚Üí</a>
                    <button class="btn btn-secondary" onclick="location.reload()">Create Another Swarm</button>
                </div>
            </div>
        </section>
    </div>

    <footer class="wizard-footer">
        <p>¬© 2026 Flowgrid Platform ¬∑ <a href="/privacy-policy.html" target="_blank">Privacy Policy</a></p>
    </footer>

    <!-- Cookie Consent Banner -->
    <div class="consent-banner hidden" id="consentBanner">
        <div class="consent-text">
            üç™ We use cookies and local storage for wizard progress. Data may be processed by
            <a href="https://www.anthropic.com/privacy" target="_blank">Anthropic</a> for AI analysis.
            <a href="/privacy-policy.html" target="_blank">Learn more</a>.
        </div>
        <div class="consent-buttons">
            <button class="consent-btn consent-decline" onclick="handleConsent(false)">Decline</button>
            <button class="consent-btn consent-accept" onclick="handleConsent(true)">Accept</button>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- JAVASCRIPT -->
    <!-- ============================================================ -->
    <!-- Global Error Notification Element -->
    <div id="globalNotification" style="display:none; position:fixed; top:1rem; right:1rem; z-index:2000; max-width:420px; padding:1rem 1.25rem; border-radius:10px; font-size:0.9rem; box-shadow:0 4px 24px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out;" role="alert">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem;">
            <span id="globalNotificationText"></span>
            <button onclick="hideGlobalNotification()" style="background:none; border:none; color:inherit; cursor:pointer; font-size:1.1rem; line-height:1; opacity:0.7;">‚úï</button>
        </div>
    </div>
    <style>
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notif-error { background: rgba(239,68,68,0.95); color: white; border: 1px solid #dc2626; }
        .notif-success { background: rgba(16,185,129,0.95); color: white; border: 1px solid #059669; }
        .notif-info { background: rgba(59,130,246,0.95); color: white; border: 1px solid #3b82f6; }
    </style>

    <script src="/js/auth-ui.js"></script>
    <script>
        // ==========================================
        // GLOBAL ERROR BOUNDARY
        // ==========================================
        let _notifTimer = null;

        function showGlobalNotification(message, type = 'error', durationMs = 6000) {
            const el = document.getElementById('globalNotification');
            const text = document.getElementById('globalNotificationText');
            if (!el || !text) return;
            const prefix = type === 'error' ? '‚ùå ' : type === 'success' ? '‚úÖ ' : '‚ÑπÔ∏è ';
            text.textContent = prefix + message;
            el.className = `notif-${type}`;
            el.style.display = 'block';
            if (_notifTimer) clearTimeout(_notifTimer);
            if (durationMs > 0) _notifTimer = setTimeout(hideGlobalNotification, durationMs);
        }

        function hideGlobalNotification() {
            const el = document.getElementById('globalNotification');
            if (el) el.style.display = 'none';
            if (_notifTimer) { clearTimeout(_notifTimer); _notifTimer = null; }
        }

        window.addEventListener('error', function(event) {
            console.error('Uncaught error:', event.error || event.message);
            showGlobalNotification('Something went wrong. Please try again or refresh the page.');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            const msg = (event.reason && (event.reason.message || String(event.reason))) || 'An unexpected error occurred.';
            showGlobalNotification(msg);
        });
        // ==========================================
        // STATE
        // ==========================================
        let currentStep = 1;
        let csrfToken = null;
        let hasConsent = null;

        // Wizard state
        let selectedFoundation = null;
        let availableFoundations = [];
        let wizardState = {
            selectedProcess: null,       // { name, description, id }
            subProcessInfo: null,        // { name, description, expectedOutcome, constraints }
            proposedAgents: null,        // { orchestrator: {...}, specialists: [...] }
            approvedAgents: [],          // array of final agent objects
            generatedBpmn: {},           // map of agentId ‚Üí bpmnXml
            agentConfigs: [],            // array of { agentId, skills, tools, interactions }
        };

        const CONSENT_KEY = 'flowgrid_consent';
        const WIZARD_STATE_KEY = 'flowgrid_design_wizard_state';

        // Save wizard state to localStorage
        function saveWizardState() {
            try {
                const stateToSave = {
                    currentStep,
                    selectedFoundation,
                    wizardState,
                    savedAt: Date.now()
                };
                localStorage.setItem(WIZARD_STATE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.warn('Failed to save wizard state:', e);
            }
        }

        // Load wizard state from localStorage
        function loadWizardState() {
            try {
                const saved = localStorage.getItem(WIZARD_STATE_KEY);
                if (!saved) return null;
                const state = JSON.parse(saved);
                // Expire after 24 hours
                if (Date.now() - state.savedAt > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem(WIZARD_STATE_KEY);
                    return null;
                }
                return state;
            } catch (e) {
                console.warn('Failed to load wizard state:', e);
                return null;
            }
        }

        // Clear wizard state
        function clearWizardState() {
            localStorage.removeItem(WIZARD_STATE_KEY);
        }

        // ==========================================
        // AUTH & FETCH (kept from original)
        // ==========================================
        function getAuthToken() { return window.FlowgridAuthUI.getAuthToken(); }
        function setAuthToken(token) {
            localStorage.setItem('accessToken', token);
            localStorage.setItem('flowgrid_access_token', token);
        }
        function clearAuthToken() { window.FlowgridAuthUI.clearAuthState(); }
        function redirectToLogin(message) {
            clearAuthToken();
            // Note: notification may not be visible long since we redirect immediately
            window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
        }

        async function parseApiResponse(response) {
            const ct = response.headers.get('content-type') || '';
            if (ct.includes('application/json')) return response.json().catch(() => null);
            const text = await response.text().catch(() => '');
            return { error: `Unexpected response (${response.status})`, details: text.slice(0, 180) };
        }

        async function extractErrorMessage(response, fallback = 'Request failed') {
            const p = await parseApiResponse(response);
            return p?.error || p?.message || p?.details || `${fallback} (HTTP ${response.status})`;
        }

        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            const headers = { ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes((options.method || 'GET').toUpperCase()) && csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401) {
                const refreshed = await refreshAuthToken();
                if (refreshed) {
                    headers['Authorization'] = `Bearer ${getAuthToken()}`;
                    return fetch(url, { ...options, headers });
                }
                redirectToLogin('Session expired. Please log in again.');
                throw new Error('Authentication required');
            }
            if (response.status === 403) {
                const d = await parseApiResponse(response) || {};
                if (d.code?.startsWith('CSRF_')) {
                    await fetchCsrfToken();
                    headers['X-CSRF-Token'] = csrfToken;
                    return fetch(url, { ...options, headers });
                }
            }
            return response;
        }

        async function refreshAuthToken() {
            try {
                const r = await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
                if (r.ok) { const d = await r.json(); setAuthToken(d.accessToken); return true; }
                return false;
            } catch { return false; }
        }

        async function fetchCsrfToken() {
            try {
                const r = await fetch('/api/wizard/csrf-token');
                if (r.ok) { const d = await r.json(); csrfToken = d.csrfToken; }
            } catch (e) { console.error('CSRF token fetch failed:', e); }
        }

        // ==========================================
        // CONSENT
        // ==========================================
        function checkConsent() {
            const c = localStorage.getItem(CONSENT_KEY);
            if (c !== null) { hasConsent = c === 'true'; return hasConsent; }
            document.getElementById('consentBanner').classList.remove('hidden');
            return null;
        }
        function handleConsent(accepted) {
            hasConsent = accepted;
            localStorage.setItem(CONSENT_KEY, accepted ? 'true' : 'false');
            document.getElementById('consentBanner').classList.add('hidden');
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function navigateToStep(step) {
            if (step <= currentStep) goToStep(step);
        }

        function goToStep(step) {
            currentStep = step;
            document.querySelectorAll('.step').forEach(s => {
                const n = parseInt(s.dataset.step);
                const c = s.querySelector('.step-circle');
                s.classList.remove('active', 'completed');
                if (n < step) { s.classList.add('completed'); c.innerHTML = '‚úì'; }
                else if (n === step) { s.classList.add('active'); c.innerHTML = n; }
                else { c.innerHTML = n; }
            });
            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            const el = document.getElementById(`step${step}`);
            if (el) el.classList.remove('hidden');

            // Render step-specific content
            if (step === 3 && wizardState.proposedAgents) renderProposedAgents();
            if (step === 4) renderEditableAgents();
            if (step === 6) renderBpmnReview();
            if (step === 7 && wizardState.agentConfigs.length) renderAgentConfigs();
            if (step === 8) renderImportSummary();

            // Save state after each step (except step 8 which is the final import)
            if (step < 8) saveWizardState();
        }

        // ==========================================
        // FOUNDATION LOADING (kept from original)
        // ==========================================
        async function loadFoundations() {
            try {
                const token = localStorage.getItem('flowgrid_access_token') || localStorage.getItem('accessToken') || getAuthToken();
                if (!token) {
                    console.warn('No auth token found for loadFoundations');
                    return;
                }
                const response = await fetch('/api/wizard/foundations', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) return;
                const data = await response.json();
                availableFoundations = (data.foundations || []).filter(f => !f.is_archived);
                const select = document.getElementById('foundationSelect');
                const noMsg = document.getElementById('noFoundationsMsg');
                if (availableFoundations.length === 0) {
                    noMsg.style.display = 'block';
                    select.style.display = 'none';
                } else {
                    noMsg.style.display = 'none';
                    select.innerHTML = '<option value="">-- Select a foundation --</option>' +
                        availableFoundations.map(f => `<option value="${f.id}">${f.name} (${f.capability_count || 0} capabilities)</option>`).join('');
                }
                const urlParams = new URLSearchParams(window.location.search);
                const fId = urlParams.get('foundation');
                if (fId) { select.value = fId; await onFoundationSelect(fId); }
            } catch (e) { console.error('Failed to load foundations:', e); }
        }

        async function onFoundationSelect(foundationId) {
            const preview = document.getElementById('foundationPreview');
            if (!foundationId) { preview.style.display = 'none'; selectedFoundation = null; return; }
            try {
                const token = localStorage.getItem('flowgrid_access_token') || localStorage.getItem('accessToken') || getAuthToken();
                const r = await fetch(`/api/wizard/foundations/${foundationId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!r.ok) throw new Error('Foundation not found');
                const data = await r.json();
                selectedFoundation = data.foundation;
                document.getElementById('foundationPreviewName').textContent = selectedFoundation.name;
                document.getElementById('foundationPreviewDesc').textContent = selectedFoundation.description || 'No description';
                document.getElementById('foundationCapCount').textContent = (selectedFoundation.capabilities || []).length;
                document.getElementById('foundationProcCount').textContent = (selectedFoundation.processes || []).length;
                preview.style.display = 'block';
                renderProcessList();
            } catch (e) { console.error('Failed to load foundation:', e); preview.style.display = 'none'; }
        }

        function renderProcessList() {
            const container = document.getElementById('processList');
            const processes = selectedFoundation?.processes || [];
            if (processes.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">No processes found in this foundation.</p>';
                return;
            }
            container.innerHTML = processes.map((p, i) => `
                <div class="process-item" data-index="${i}" onclick="selectProcess(${i})">
                    <div class="process-item-name">üîÑ ${escapeHtml(p.name)}</div>
                    ${p.description ? `<div class="process-item-desc">${escapeHtml(p.description)}</div>` : ''}
                </div>
            `).join('');
        }

        function selectProcess(index) {
            const processes = selectedFoundation?.processes || [];
            const process = processes[index];
            if (!process) return;

            wizardState.selectedProcess = { name: process.name, description: process.description || '', id: process.id || `proc-${index}` };

            // Update UI
            document.querySelectorAll('.process-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.process-item[data-index="${index}"]`)?.classList.add('selected');

            document.getElementById('selectedProcessInfo').style.display = 'block';
            document.getElementById('selectedProcessName').textContent = process.name;
            document.getElementById('selectedProcessDesc').textContent = process.description || 'No description';
            document.getElementById('step1ContinueBtn').disabled = false;
        }

        // ==========================================
        // SURPRISE ME - AI-powered sub-process suggestion
        // ==========================================
        async function surpriseMe() {
            const processName = wizardState.selectedProcess?.name || 'IT Service Management';
            const btn = event.target;
            const originalText = btn.textContent;
            
            try {
                // Show loading state
                btn.disabled = true;
                btn.textContent = 'üé≤ Thinking...';
                
                // Clear existing values
                document.getElementById('subProcessName').value = '';
                document.getElementById('subProcessDesc').value = 'Generating AI suggestion...';
                document.getElementById('subProcessOutcome').value = '';
                document.getElementById('subProcessConstraints').value = '';

                const response = await fetchWithAuth('/api/wizard/suggest-subprocess', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        processName,
                        foundationContext: selectedFoundation?.name || null
                    })
                });

                if (!response.ok) {
                    throw new Error(await extractErrorMessage(response, 'Failed to generate suggestion'));
                }

                const data = await response.json();
                
                if (data.success && data.suggestion) {
                    const s = data.suggestion;
                    document.getElementById('subProcessName').value = s.name || '';
                    document.getElementById('subProcessDesc').value = s.description || '';
                    document.getElementById('subProcessOutcome').value = s.expectedOutcome || '';
                    document.getElementById('subProcessConstraints').value = s.constraints || '';
                } else {
                    throw new Error('Invalid response from AI');
                }

            } catch (error) {
                console.error('Surprise Me error:', error);
                document.getElementById('subProcessDesc').value = '';
                showError('step2Error', 'Failed to generate suggestion: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // ==========================================
        // STEP 2‚Üí3: IDENTIFY AGENTS
        // ==========================================
        async function identifyAgents() {
            const name = document.getElementById('subProcessName').value.trim();
            const desc = document.getElementById('subProcessDesc').value.trim();
            const outcome = document.getElementById('subProcessOutcome').value.trim();
            const constraints = document.getElementById('subProcessConstraints').value.trim();

            if (!name || !desc || !outcome) {
                showError('step2Error', 'Please fill in the sub-process name, description, and expected outcome.');
                return;
            }
            hideError('step2Error');

            wizardState.subProcessInfo = { name, description: desc, expectedOutcome: outcome, constraints };

            // Move to step 3 and show loading
            goToStep(3);
            document.getElementById('step3Loading').classList.add('active');
            document.getElementById('step3Results').classList.remove('active');
            updateProgress('step3', 10, 'üîç Phase 1: Identifying agents...');

            try {
                const capabilities = (selectedFoundation?.capabilities || []).map(c => c.name);
                const integrations = []; // Could be expanded from foundation data

                // Phase 1: Identify agents
                const identifyResponse = await fetchWithAuth('/api/wizard/identify-agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        process: wizardState.selectedProcess,
                        subProcess: wizardState.subProcessInfo,
                        foundationCapabilities: capabilities,
                        foundationIntegrations: integrations,
                    })
                });

                updateProgress('step3', 40, 'üîç Agents identified, preparing optimization...');

                if (!identifyResponse.ok) throw new Error(await extractErrorMessage(identifyResponse, 'Agent identification failed'));

                const identifyData = await parseApiResponse(identifyResponse);
                if (!identifyData.success) throw new Error(identifyData.error || 'Agent identification failed');

                // Phase 2: Optimize agents
                updateProgress('step3', 50, '‚ö° Phase 2: Optimizing agent design...');

                const processCtx = `Process: ${wizardState.selectedProcess?.name || ''}. Sub-process: ${wizardState.subProcessInfo?.name || ''}. ${wizardState.subProcessInfo?.description || ''}`;

                try {
                    const optimizeResponse = await fetchWithAuth('/api/wizard/optimize-agents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            proposedAgents: identifyData.data,
                            processContext: processCtx,
                        })
                    });

                    if (optimizeResponse.ok) {
                        const optimizeData = await parseApiResponse(optimizeResponse);
                        if (optimizeData.success) {
                            updateProgress('step3', 90, '‚úÖ Optimization complete!');
                            // Merge interaction fields from identify step if optimizer dropped them
                            const origAgents = identifyData.data?.agents || [];
                            const optAgents = optimizeData.data?.agents || optimizeData.data?.optimizedAgents || [];
                            for (const optAgent of optAgents) {
                                const orig = origAgents.find(a => a.id === optAgent.id);
                                if (orig) {
                                    if (!optAgent.triggers?.length && orig.triggers?.length) optAgent.triggers = orig.triggers;
                                    if (!optAgent.outputs?.length && orig.outputs?.length) optAgent.outputs = orig.outputs;
                                    if (!optAgent.interactionPattern && orig.interactionPattern) optAgent.interactionPattern = orig.interactionPattern;
                                    if (!optAgent.escalationPath && orig.escalationPath) optAgent.escalationPath = orig.escalationPath;
                                    if (!optAgent.decisionAuthority && orig.decisionAuthority) optAgent.decisionAuthority = orig.decisionAuthority;
                                }
                            }
                            wizardState.proposedAgents = optimizeData.data;
                            wizardState.optimizationMeta = optimizeData.meta?.optimization || null;
                        } else {
                            console.warn('Optimization returned error, using unoptimized result:', optimizeData.error);
                            wizardState.proposedAgents = identifyData.data;
                            wizardState.optimizationMeta = null;
                        }
                    } else {
                        console.warn('Optimization request failed, using unoptimized result');
                        wizardState.proposedAgents = identifyData.data;
                        wizardState.optimizationMeta = null;
                    }
                } catch (optError) {
                    console.warn('Optimization pass failed, using unoptimized result:', optError);
                    wizardState.proposedAgents = identifyData.data;
                    wizardState.optimizationMeta = null;
                }

                // Build approvedAgents from proposed
                rebuildApprovedAgents();

                updateProgress('step3', 100, '‚úÖ Agents ready!');
                await delay(400);

                document.getElementById('step3Loading').classList.remove('active');
                document.getElementById('step3Results').classList.add('active');
                renderProposedAgents();

            } catch (error) {
                document.getElementById('step3Loading').classList.remove('active');
                document.getElementById('step3Results').classList.add('active');
                showError('step3Error', error.message);
            }
        }

        function rebuildApprovedAgents() {
            const pa = wizardState.proposedAgents;
            if (!pa) return;
            wizardState.approvedAgents = [];

            // Orchestrator
            wizardState.approvedAgents.push({
                id: 'orch-1',
                name: pa.orchestrator.name,
                purpose: pa.orchestrator.purpose,
                shortDescription: pa.orchestrator.shortDescription || '',
                pattern: pa.orchestrator.pattern || 'Orchestrator',
                decisionAuthority: pa.orchestrator.decisionAuthority || 'propose-and-execute',
                autonomyLevel: pa.orchestrator.autonomyLevel || 'supervised',
                interactionPattern: pa.orchestrator.interactionPattern || 'orchestrated',
                triggers: pa.orchestrator.triggers || [],
                outputs: pa.orchestrator.outputs || [],
                escalationPath: pa.orchestrator.escalationPath || '',
                isOrchestrator: true,
            });

            // Specialists
            (pa.specialists || []).forEach((s, i) => {
                wizardState.approvedAgents.push({
                    id: `spec-${i + 1}`,
                    name: s.name,
                    purpose: s.purpose,
                    shortDescription: s.shortDescription || '',
                    pattern: s.pattern || 'Specialist',
                    decisionAuthority: s.decisionAuthority || 'propose-and-execute',
                    autonomyLevel: s.autonomyLevel || 'supervised',
                    interactionPattern: s.interactionPattern || 'event-driven',
                    triggers: s.triggers || [],
                    outputs: s.outputs || [],
                    escalationPath: s.escalationPath || '',
                    rationale: s.rationale,
                    isOrchestrator: false,
                });
            });
        }

        function renderProposedAgents() {
            const pa = wizardState.proposedAgents;
            if (!pa) return;
            const total = 1 + (pa.specialists?.length || 0);
            document.getElementById('proposedAgentCount').textContent = total;

            const container = document.getElementById('proposedAgentsGrid');
            let html = '';

            // Orchestrator
            html += renderAgentCard(pa.orchestrator, true);
            // Specialists
            (pa.specialists || []).forEach(s => { html += renderAgentCard(s, false); });

            container.innerHTML = html;
        }

        function renderAgentCard(agent, isOrch) {
            const patternLabel = (agent.pattern || 'specialist').charAt(0).toUpperCase() + (agent.pattern || 'specialist').slice(1);
            return `
                <div class="agent-card ${isOrch ? 'orchestrator' : ''}">
                    <div class="agent-header">
                        <span class="agent-name">${escapeHtml(agent.name)}</span>
                        <span class="agent-pattern">${isOrch ? 'üé≠' : 'ü§ñ'} ${patternLabel}</span>
                    </div>
                    <div class="agent-purpose">${escapeHtml(agent.purpose)}</div>
                    <ul class="agent-responsibilities">
                        ${(agent.responsibilities || []).map(r => `<li>${escapeHtml(r)}</li>`).join('')}
                    </ul>
                    ${agent.rationale ? `<div style="font-size: 0.7rem; color: var(--info); margin-top: 0.5rem; font-style: italic;">üí° ${escapeHtml(agent.rationale)}</div>` : ''}
                </div>
            `;
        }

        // ==========================================
        // STEP 4: REVIEW & EDIT AGENTS
        // ==========================================
        function renderEditableAgents() {
            const container = document.getElementById('editableAgentsGrid');
            container.innerHTML = wizardState.approvedAgents.map((agent, i) => `
                <div class="agent-card ${agent.isOrchestrator ? 'orchestrator' : ''}" id="edit-agent-${i}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">${agent.isOrchestrator ? 'üé≠ Orchestrator' : 'ü§ñ Agent'}</span>
                        ${!agent.isOrchestrator ? `<button class="btn btn-danger btn-sm" onclick="deleteAgent(${i})">üóëÔ∏è</button>` : ''}
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem;">Agent type</label>
                        <select onchange="updateAgent(${i}, 'pattern', this.value)">
                            ${['orchestrator','specialist','coordinator','gateway','monitor','executor','analyzer','validator','router'].map(p =>
                                `<option value="${p}" ${agent.pattern === p ? 'selected' : ''}>${p.charAt(0).toUpperCase() + p.slice(1)}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem;">Name</label>
                        <input type="text" value="${escapeHtml(agent.name)}" onchange="updateAgent(${i}, 'name', this.value)">
                    </div>
                    <div class="input-group" style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.7rem;">Purpose</label>
                        <p style="font-size: 0.8rem; color: #e2e8f0; background: #1e293b; border-radius: 6px; padding: 0.5rem; margin: 0; line-height: 1.4;">${escapeHtml(agent.purpose)}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateAgent(index, field, value) {
            if (wizardState.approvedAgents[index]) {
                wizardState.approvedAgents[index][field] = value;
            }
        }

        function deleteAgent(index) {
            if (wizardState.approvedAgents[index]?.isOrchestrator) return;
            wizardState.approvedAgents.splice(index, 1);
            renderEditableAgents();
        }

        function addNewAgent() {
            const id = `custom-${Date.now()}`;
            wizardState.approvedAgents.push({
                id,
                name: 'New Agent',
                purpose: '',
                pattern: 'specialist',
                responsibilities: [],
                isOrchestrator: false,
            });
            renderEditableAgents();
            // Scroll to new agent
            const el = document.getElementById(`edit-agent-${wizardState.approvedAgents.length - 1}`);
            if (el) el.scrollIntoView({ behavior: 'smooth' });
        }

        // ==========================================
        // STEP 5: BPMN GENERATION
        // ==========================================
        async function generateAllBpmn() {
            const agents = wizardState.approvedAgents;
            if (agents.length === 0) { showError('step4Error', 'No agents to generate BPMN for.'); return; }
            hideError('step4Error');

            goToStep(5);
            document.getElementById('step5Loading').classList.add('active');
            document.getElementById('step5Results').classList.remove('active');
            wizardState.generatedBpmn = {};

            const orchestrator = agents.find(a => a.isOrchestrator);
            const specialists = agents.filter(a => !a.isOrchestrator);
            const total = 1 + specialists.length;
            let completed = 0;

            try {
                // Generate ALL flows in parallel (orchestrator + specialists)
                updateProgress('step5', 10, `Generating ${total} agent flows in parallel...`);
                const allPromises = [];

                if (orchestrator) {
                    allPromises.push(
                        generateBpmnForAgent(orchestrator, agents, true).then(bpmn => {
                            wizardState.generatedBpmn[orchestrator.id] = bpmn;
                            completed++;
                            updateProgress('step5', (completed / total) * 90 + 10, `Completed ${completed}/${total} flows...`);
                            return bpmn;
                        })
                    );
                }

                for (const agent of specialists) {
                    allPromises.push(
                        generateBpmnForAgent(agent, agents, false).then(bpmn => {
                            wizardState.generatedBpmn[agent.id] = bpmn;
                            completed++;
                            updateProgress('step5', (completed / total) * 90 + 10, `Completed ${completed}/${total} flows...`);
                            return bpmn;
                        })
                    );
                }

                await Promise.all(allPromises);

                updateProgress('step5', 100, 'All BPMN generated!');
                await delay(400);

                document.getElementById('bpmnAgentCount').textContent = specialists.length;
                document.getElementById('step5Loading').classList.remove('active');
                document.getElementById('step5Results').classList.add('active');

            } catch (error) {
                document.getElementById('step5Loading').classList.remove('active');
                document.getElementById('step5Results').classList.add('active');
                showError('step5Error', error.message);
            }
        }

        async function generateBpmnForAgent(agent, allAgents, isOrchestrator) {
            try {
                const endpoint = isOrchestrator ? '/api/wizard/generate-orchestrator-bpmn' : '/api/wizard/generate-bpmn';

                // Build skills from triggers/outputs or empty array
                const agentSkills = (agent.triggers || []).concat(agent.outputs || []).map((s, i) => ({ id: `skill-${i}`, name: s, description: s }));
                
                const body = isOrchestrator ? {
                    orchestratorAgent: { id: agent.id, name: agent.name, purpose: agent.purpose, skills: agentSkills },
                    participantAgents: allAgents.filter(a => !a.isOrchestrator).map(a => {
                        const skills = (a.triggers || []).concat(a.outputs || []).map((s, i) => ({ id: `skill-${i}`, name: s, description: s }));
                        return { id: a.id, name: a.name, purpose: a.purpose, skills };
                    }),
                    processDescription: wizardState.subProcessInfo?.description || agent.purpose,
                } : {
                    processId: agent.id,
                    processName: agent.name,
                    processDescription: agent.purpose,
                    involvedAgents: [agent.name],
                    capabilities: (agent.triggers || []).concat(agent.outputs || []),
                    triggers: agent.triggers || [],
                    outputs: agent.outputs || [],
                };

                const response = await fetchWithAuth(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error(await extractErrorMessage(response, 'BPMN generation failed'));
                const data = await parseApiResponse(response);
                return data?.data?.bpmnXml || data?.bpmnXml || '<bpmn><!-- empty --></bpmn>';
            } catch (e) {
                console.error(`BPMN generation failed for ${agent.name}:`, e);
                return `<!-- BPMN generation failed: ${e.message} -->`;
            }
        }

        // ==========================================
        // STEP 6: REVIEW BPMN
        // ==========================================
        const bpmnViewers = {};

        function renderBpmnReview() {
            const agents = wizardState.approvedAgents;
            const tabBar = document.getElementById('bpmnTabBar');
            const contents = document.getElementById('bpmnTabContents');

            tabBar.innerHTML = agents.map((a, i) => `
                <button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchBpmnTab(${i})">${a.isOrchestrator ? 'üé≠' : 'ü§ñ'} ${escapeHtml(a.name)}</button>
            `).join('');

            contents.innerHTML = agents.map((a, i) => {
                const bpmn = wizardState.generatedBpmn[a.id];
                const hasBpmn = bpmn && !bpmn.startsWith('<!--');
                return `
                    <div class="tab-content ${i === 0 ? 'active' : ''}" id="bpmn-tab-${i}">
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.85rem; color: var(--text-secondary);">${a.isOrchestrator ? 'Orchestrator Flow' : 'Internal Workflow'}: <strong>${escapeHtml(a.name)}</strong></span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-warning btn-sm" onclick="regenerateBpmnForAgent('${a.id}', ${i})">üîÑ Regenerate</button>
                                <button class="btn btn-secondary btn-sm" onclick="copyBpmn('${a.id}')">üìã Copy XML</button>
                                <button class="btn btn-secondary btn-sm" onclick="downloadBpmn('${a.id}', '${escapeHtml(a.name)}')">üíæ Download</button>
                            </div>
                        </div>
                        ${hasBpmn
                            ? `<div class="bpmn-container" id="bpmn-viewer-${i}"></div>`
                            : `<div style="padding: 2rem; text-align: center; color: var(--text-muted); background: var(--bg-input); border-radius: 8px;">
                                <p>‚ö†Ô∏è BPMN generation failed for this agent.</p>
                                <pre style="font-size: 0.7rem; margin-top: 0.5rem; color: var(--error);">${escapeHtml(bpmn || 'No data')}</pre>
                               </div>`
                        }
                    </div>
                `;
            }).join('');

            // Initialize BPMN viewers after a short delay (needed for container to be visible)
            setTimeout(() => {
                agents.forEach((a, i) => {
                    const bpmn = wizardState.generatedBpmn[a.id];
                    if (bpmn && !bpmn.startsWith('<!--')) {
                        initBpmnViewer(i, bpmn);
                    }
                });
                // Force re-zoom on first tab after init with multiple delays
                const fitFirst = () => {
                    if (bpmnViewers[0]) {
                        try { bpmnViewers[0].get('canvas').zoom('fit-viewport'); } catch {}
                    }
                };
                setTimeout(fitFirst, 100);
                setTimeout(fitFirst, 300);
                setTimeout(fitFirst, 600);
            }, 100);
        }

        async function initBpmnViewer(index, bpmnXml) {
            const containerId = `bpmn-viewer-${index}`;
            const container = document.getElementById(containerId);
            if (!container) return;

            try {
                if (bpmnViewers[index]) { bpmnViewers[index].destroy(); }
                const viewer = new BpmnJS({ container: `#${containerId}` });
                bpmnViewers[index] = viewer;
                await viewer.importXML(bpmnXml);
                
                // Multiple delayed fit attempts to handle visibility timing
                const fitCanvas = () => {
                    try { viewer.get('canvas').zoom('fit-viewport'); } catch {}
                };
                fitCanvas();
                setTimeout(fitCanvas, 50);
                setTimeout(fitCanvas, 150);
                setTimeout(fitCanvas, 300);
                setTimeout(fitCanvas, 500);
            } catch (e) {
                console.error('BPMN viewer error:', e);
                container.innerHTML = `<div style="padding: 1rem; color: var(--error); font-size: 0.8rem;">Failed to render BPMN: ${escapeHtml(e.message)}<br><textarea style="width:100%;height:200px;font-size:0.7rem;margin-top:0.5rem;" readonly>${escapeHtml(bpmnXml)}</textarea></div>`;
            }
        }

        function switchBpmnTab(index) {
            document.querySelectorAll('#bpmnTabBar .tab-btn').forEach((b, i) => b.classList.toggle('active', i === index));
            document.querySelectorAll('#bpmnTabContents .tab-content').forEach((c, i) => c.classList.toggle('active', i === index));
            // Re-zoom viewer when switching tabs (needed because hidden containers don't render)
            if (bpmnViewers[index]) {
                const fitCanvas = () => {
                    try { bpmnViewers[index].get('canvas').zoom('fit-viewport'); } catch {}
                };
                fitCanvas();
                setTimeout(fitCanvas, 50);
                setTimeout(fitCanvas, 150);
            }
        }

        function copyBpmn(agentId) {
            const xml = wizardState.generatedBpmn[agentId];
            if (xml) navigator.clipboard.writeText(xml).then(() => showGlobalNotification('BPMN XML copied to clipboard!', 'success', 3000));
        }

        function downloadBpmn(agentId, agentName) {
            const xml = wizardState.generatedBpmn[agentId];
            if (!xml) return;
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${agentName.replace(/\s+/g, '-').toLowerCase()}.bpmn`; a.click();
            URL.revokeObjectURL(url);
        }

        async function regenerateBpmnForAgent(agentId, tabIndex) {
            const agent = wizardState.approvedAgents.find(a => a.id === agentId);
            if (!agent) return;

            // Show loading state in the tab ‚Äî use tab content as fallback if viewer div doesn't exist
            let container = document.getElementById(`bpmn-viewer-${tabIndex}`);
            const tabContent = document.getElementById(`bpmn-tab-${tabIndex}`);
            if (!container && tabContent) {
                // Create the viewer container if it doesn't exist (e.g., after initial failure)
                const existingError = tabContent.querySelector('[style*="text-align: center"]');
                if (existingError) existingError.remove();
                const div = document.createElement('div');
                div.className = 'bpmn-container';
                div.id = `bpmn-viewer-${tabIndex}`;
                tabContent.appendChild(div);
                container = div;
            }
            if (container) {
                container.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                    <div class="spinner" style="margin-bottom: 0.5rem;"></div>
                    <span>Regenerating BPMN for ${escapeHtml(agent.name)}...</span>
                </div>`;
            }

            try {
                const bpmn = await generateBpmnForAgent(agent, wizardState.approvedAgents, agent.isOrchestrator);
                wizardState.generatedBpmn[agentId] = bpmn;

                // Re-init viewer with new BPMN
                if (bpmn && !bpmn.startsWith('<!--')) {
                    await initBpmnViewer(tabIndex, bpmn);
                } else {
                    if (container) {
                        container.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--error);">
                            ‚ö†Ô∏è BPMN generation failed. <pre style="font-size: 0.7rem; margin-top: 0.5rem;">${escapeHtml(bpmn || 'No data')}</pre>
                        </div>`;
                    }
                }
            } catch (error) {
                if (container) {
                    container.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--error);">
                        ‚ö†Ô∏è Error: ${escapeHtml(error.message)}
                    </div>`;
                }
            }
        }

        // ==========================================
        // STEP 7: AGENT CONFIGURATION
        // ==========================================
        async function generateAgentConfigs() {
            goToStep(7);
            document.getElementById('step7Loading').classList.add('active');
            document.getElementById('step7Results').classList.remove('active');
            wizardState.agentConfigs = [];

            const agents = wizardState.approvedAgents;
            const total = agents.length;

            try {
                for (let i = 0; i < agents.length; i++) {
                    const agent = agents[i];
                    updateProgress('step7', ((i + 1) / total) * 90, `Configuring ${agent.name} (${i + 1}/${total})...`);

                    // Build A2A config from agent data + foundation
                    // Build skills from triggers and outputs
                    const skillSources = (agent.triggers || []).concat(agent.outputs || []);
                    const config = {
                        agentId: agent.id,
                        agentName: agent.name,
                        pattern: agent.pattern,
                        purpose: agent.purpose,
                        shortDescription: agent.shortDescription || '',
                        skills: skillSources.map((s, si) => ({
                            skillId: `${agent.id}-skill-${si}`,
                            name: s,
                            description: s,
                            tags: [agent.pattern, wizardState.selectedProcess?.name?.toLowerCase().replace(/\s+/g, '-') || 'general'],
                        })),
                        tools: (selectedFoundation?.integrations || []).filter(() => agent.pattern === 'gateway').map(int => int.name || int),
                        interactions: {
                            triggers: agent.triggers || (agent.isOrchestrator ? ['process-start', 'manual-trigger'] : ['orchestrator-request']),
                            outputs: agent.outputs || (agent.isOrchestrator ? ['process-complete', 'escalation'] : ['task-result', 'error-report']),
                            escalation: agent.escalationPath || (agent.isOrchestrator ? 'human-operator' : wizardState.approvedAgents.find(a => a.isOrchestrator)?.name || 'orchestrator'),
                        },
                        hasBpmn: !!wizardState.generatedBpmn[agent.id],
                    };

                    wizardState.agentConfigs.push(config);
                }

                updateProgress('step7', 100, 'All configurations generated!');
                await delay(300);

                document.getElementById('step7Loading').classList.remove('active');
                document.getElementById('step7Results').classList.add('active');
                renderAgentConfigs();

            } catch (error) {
                document.getElementById('step7Loading').classList.remove('active');
                document.getElementById('step7Results').classList.add('active');
                showError('step7Error', error.message);
            }
        }

        function renderAgentConfigs() {
            const container = document.getElementById('agentConfigCards');
            container.innerHTML = wizardState.agentConfigs.map(config => `
                <div class="config-card">
                    <h4>${config.pattern === 'orchestrator' ? 'üé≠' : 'ü§ñ'} ${escapeHtml(config.agentName)}</h4>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <span style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 4px; background: var(--accent-primary); color: var(--bg-primary);">${config.pattern}</span>
                        ${config.hasBpmn ? '<span style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 4px; background: var(--success); color: var(--bg-primary);">‚úÖ BPMN</span>' : ''}
                    </div>
                    <div class="config-section">
                        <h5>Skills (${config.skills.length})</h5>
                        <ul class="config-list">
                            ${config.skills.map(s => `<li>${escapeHtml(s.name)}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="config-section">
                        <h5>Interactions</h5>
                        <ul class="config-list">
                            <li><strong>Triggers:</strong> ${config.interactions.triggers.join(', ')}</li>
                            <li><strong>Outputs:</strong> ${config.interactions.outputs.join(', ')}</li>
                            <li><strong>Escalation:</strong> ${config.interactions.escalation}</li>
                        </ul>
                    </div>
                    ${config.tools.length > 0 ? `
                    <div class="config-section">
                        <h5>Tools</h5>
                        <ul class="config-list">
                            ${config.tools.map(t => `<li>${escapeHtml(t)}</li>`).join('')}
                        </ul>
                    </div>` : ''}
                </div>
            `).join('');
        }

        // ==========================================
        // STEP 8: IMPORT & CREATE
        // ==========================================
        function renderImportSummary() {
            const agents = wizardState.approvedAgents;
            const bpmnCount = Object.keys(wizardState.generatedBpmn).filter(k => !wizardState.generatedBpmn[k].startsWith('<!--')).length;
            const skillCount = wizardState.agentConfigs.reduce((sum, c) => sum + c.skills.length, 0);

            document.getElementById('summaryAgents').textContent = agents.length;
            document.getElementById('summaryBpmn').textContent = bpmnCount;
            document.getElementById('summarySkills').textContent = skillCount;

            document.getElementById('summaryAgentList').innerHTML = agents.map(a => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: var(--bg-card); border-radius: 6px; margin-bottom: 0.4rem;">
                    <div>
                        <span style="font-weight: 500; color: var(--text-primary); font-size: 0.85rem;">${a.isOrchestrator ? 'üé≠' : 'ü§ñ'} ${escapeHtml(a.name)}</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted); margin-left: 0.5rem;">${a.pattern}</span>
                    </div>
                    <span style="font-size: 0.7rem; color: ${wizardState.generatedBpmn[a.id] && !wizardState.generatedBpmn[a.id].startsWith('<!--') ? 'var(--success)' : 'var(--warning)'};">
                        ${wizardState.generatedBpmn[a.id] && !wizardState.generatedBpmn[a.id].startsWith('<!--') ? '‚úÖ BPMN' : '‚ö†Ô∏è No BPMN'}
                    </span>
                </div>
            `).join('');
        }

        async function performImport() {
            hideError('step8Error');
            document.getElementById('step8Loading').classList.add('active');

            try {
                const agents = wizardState.approvedAgents;
                const createdAgents = [];

                // Create each agent
                for (let i = 0; i < agents.length; i++) {
                    const agent = agents[i];
                    const config = wizardState.agentConfigs.find(c => c.agentId === agent.id) || {};
                    document.getElementById('step8LoadingText').textContent = `Creating ${agent.name} (${i + 1}/${agents.length})...`;

                    const body = {
                        name: agent.name,
                        type: 'Agent',  // Required field
                        description: agent.purpose,
                        status: 'draft',
                        config: {
                            purpose: agent.purpose,
                            shortDescription: agent.shortDescription || '',
                            pattern: agent.pattern,
                            decisionAuthority: agent.decisionAuthority || 'propose-and-execute',
                            autonomyLevel: agent.autonomyLevel || 'supervised',
                            interactionPattern: agent.interactionPattern || 'event-driven',
                            triggers: agent.triggers || [],
                            outputs: agent.outputs || [],
                            escalationPath: agent.escalationPath || '',
                            isOrchestrator: agent.isOrchestrator,
                            skills: config.skills || [],
                            interactions: config.interactions || {},
                            bpmnXml: wizardState.generatedBpmn[agent.id] || null,
                            foundationId: selectedFoundation?.id || null,
                            processName: wizardState.selectedProcess?.name,
                            subProcessName: wizardState.subProcessInfo?.name,
                        },
                    };

                    const response = await fetchWithAuth('/api/agents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        const data = await parseApiResponse(response);
                        createdAgents.push(data);

                        // Create skills for this agent in agent_skills table
                        const agentId = data.id || data.agentId;
                        const skills = config.skills || [];
                        for (const skill of skills) {
                            try {
                                await fetchWithAuth(`/api/agents/${agentId}/skills`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        name: skill.name?.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '') || skill.skillId,
                                        display_name: skill.name,
                                        description: skill.description || skill.name,
                                        tags: skill.tags || [agent.pattern || 'general'],
                                        input_schema: skill.inputSchema || {},
                                        examples: skill.examples || [],
                                    })
                                });
                            } catch (e) { console.warn(`Skill creation failed for ${skill.name}:`, e); }
                        }
                    } else {
                        const errMsg = await extractErrorMessage(response);
                        console.error(`Failed to create agent ${agent.name}:`, errMsg);
                        throw new Error(`Failed to create ${agent.name}: ${errMsg}`);
                    }
                }

                // Create relationships between orchestrator and specialists
                const orchestrator = createdAgents.find((_, i) => agents[i]?.isOrchestrator);
                if (orchestrator) {
                    document.getElementById('step8LoadingText').textContent = 'Creating relationships...';
                    for (const created of createdAgents) {
                        if (created === orchestrator) continue;
                        try {
                            await fetchWithAuth('/api/relationships', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    sourceAgentId: orchestrator.id || orchestrator.agentId,
                                    targetAgentId: created.id || created.agentId,
                                    relationshipType: 'orchestrates',
                                    description: `${orchestrator.name || 'Orchestrator'} delegates to ${created.name || 'agent'}`,
                                })
                            });
                        } catch (e) { console.warn('Relationship creation failed:', e); }
                    }
                }

                // Clear saved state on successful import
                clearWizardState();

                // Show success
                document.getElementById('step8Loading').classList.remove('active');
                document.getElementById('step8ImportCard').classList.add('hidden');
                document.getElementById('step8Success').classList.remove('hidden');
                document.getElementById('successMessage').textContent =
                    `Created ${createdAgents.length} agents for "${wizardState.subProcessInfo?.name}" in the "${wizardState.selectedProcess?.name}" process.`;
                
                // Set design link with foundation ID
                const designLink = document.getElementById('openDesignLink');
                if (designLink && selectedFoundation?.id) {
                    designLink.href = `/design/?foundation=${selectedFoundation.id}`;
                }
                document.getElementById('finalSummary').innerHTML = `
                    <div class="stat-card green"><div class="stat-value">${createdAgents.length}</div><div class="stat-label">Agents Created</div></div>
                    <div class="stat-card blue"><div class="stat-value">${Object.keys(wizardState.generatedBpmn).length}</div><div class="stat-label">Agent Flows</div></div>
                    <div class="stat-card yellow"><div class="stat-value">${wizardState.agentConfigs.reduce((s, c) => s + c.skills.length, 0)}</div><div class="stat-label">Skills Defined</div></div>
                `;

            } catch (error) {
                document.getElementById('step8Loading').classList.remove('active');
                showError('step8Error', error.message);
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function updateProgress(step, percent, status) {
            const p = document.getElementById(`${step}Progress`);
            const s = document.getElementById(`${step}Status`);
            if (p) p.style.width = `${percent}%`;
            if (s) s.textContent = status;
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            if (el) { el.textContent = '‚ùå ' + msg; el.classList.add('active'); }
        }
        function hideError(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('active');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            window.FlowgridAuthUI.initPage({ requireAuth: true, showSignOut: false });
            checkConsent();
            await fetchCsrfToken();
            await loadFoundations();
            
            // Try to restore saved state
            const savedState = loadWizardState();
            if (savedState && savedState.currentStep > 1) {
                // Restore state
                if (savedState.selectedFoundation) {
                    selectedFoundation = savedState.selectedFoundation;
                    const select = document.getElementById('foundationSelect');
                    if (select) select.value = selectedFoundation.id || '';
                }
                if (savedState.wizardState) {
                    wizardState = savedState.wizardState;
                }
                
                // Show inline resume prompt instead of confirm()
                const resumeBanner = document.createElement('div');
                resumeBanner.id = 'resumeBanner';
                resumeBanner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:2100;background:var(--bg-card);border-bottom:2px solid var(--accent-primary);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;';
                // Hide sign-out button while banner is visible to prevent overlap
                const signOutBtn = document.getElementById('flowgrid-signout-btn');
                if (signOutBtn) signOutBtn.style.display = 'none';
                resumeBanner.innerHTML = `
                    <span style="color:var(--text-secondary);font-size:0.9rem;">üìù You have a saved wizard session (Step ${savedState.currentStep}). Resume where you left off?</span>
                    <div style="display:flex;gap:0.5rem;flex-shrink:0;">
                        <button id="resumeYes" class="btn btn-primary btn-sm">Resume</button>
                        <button id="resumeNo" class="btn btn-secondary btn-sm">Start Over</button>
                    </div>`;
                document.body.prepend(resumeBanner);
                document.getElementById('resumeYes').onclick = () => { resumeBanner.remove(); if (signOutBtn) signOutBtn.style.display = ''; goToStep(savedState.currentStep); };
                document.getElementById('resumeNo').onclick = () => { resumeBanner.remove(); if (signOutBtn) signOutBtn.style.display = ''; clearWizardState(); goToStep(1); };
                return;
            }
            
            goToStep(1);
        });
    </script>
</body>
</html>
