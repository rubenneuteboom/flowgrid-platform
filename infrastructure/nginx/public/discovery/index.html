<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foundation Wizard | FlowGrid</title>
  <style>
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #475569;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .header h1 span { color: var(--primary); }
    .header-actions { display: flex; gap: 1rem; align-items: center; }

    /* Progress Steps */
    .progress-container {
      background: var(--bg-card);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
    }
    .progress-steps {
      display: flex;
      justify-content: center;
      max-width: 800px;
      margin: 0 auto;
    }
    .progress-step { display: flex; align-items: center; flex: 1; }
    .step-circle {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-input); border: 2px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; flex-shrink: 0; transition: all 0.3s;
    }
    .step-circle.active { background: var(--primary); border-color: var(--primary); }
    .step-circle.completed { background: var(--success); border-color: var(--success); }
    .step-line { flex: 1; height: 2px; background: var(--border); margin: 0 0.5rem; }
    .step-line.completed { background: var(--success); }
    .step-label {
      position: absolute; top: 50px; white-space: nowrap;
      font-size: 0.75rem; color: var(--text-secondary);
    }
    .step-wrapper {
      position: relative; display: flex; flex-direction: column; align-items: center;
    }

    /* Main */
    .main-content { max-width: 1100px; margin: 2rem auto; padding: 0 2rem; }
    .wizard-card {
      background: var(--bg-card); border-radius: 12px;
      border: 1px solid var(--border); padding: 2rem;
      max-width: 100%; overflow: hidden; box-sizing: border-box;
    }
    .wizard-card h2 { margin-bottom: 0.5rem; }
    .wizard-card p.subtitle { color: var(--text-secondary); margin-bottom: 1.5rem; }

    /* Form */
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 0.75rem 1rem;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-primary); font-size: 1rem;
      font-family: inherit;
    }
    .form-group textarea { min-height: 150px; resize: vertical; }

    /* Upload */
    .upload-area {
      border: 2px dashed var(--border); border-radius: 12px;
      padding: 3rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .upload-area:hover { border-color: var(--primary); background: rgba(99,102,241,0.1); }
    .upload-area.dragover { border-color: var(--primary); background: rgba(99,102,241,0.2); }
    .upload-icon { font-size: 3rem; margin-bottom: 1rem; }
    .upload-area p { color: var(--text-secondary); }
    .upload-area input[type="file"] { display: none; }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem; border-radius: 8px; border: none;
      font-weight: 500; cursor: pointer; transition: all 0.2s;
      display: inline-flex; align-items: center; gap: 0.5rem;
      font-size: 0.9rem; text-decoration: none;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; }
    .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
    .btn-danger:hover { background: rgba(239,68,68,0.1); }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group {
      display: flex; justify-content: space-between;
      margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);
    }

    /* Item card */
    .item-card {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; padding: 0.75rem 1rem;
      display: flex; align-items: center; gap: 0.75rem;
      transition: all 0.15s; cursor: default;
    }
    .item-card:hover { border-color: var(--primary); background: rgba(99,102,241,0.05); }
    .item-card.selected { border-color: var(--primary); background: rgba(99,102,241,0.1); }
    .item-card input[type="checkbox"] {
      width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-info h4 { font-size: 0.9rem; margin-bottom: 0.15rem; }
    .item-info p { font-size: 0.78rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-actions { display: flex; gap: 0.25rem; flex-shrink: 0; }
    .item-btn {
      background: none; border: none; color: var(--text-secondary);
      cursor: pointer; padding: 0.25rem; font-size: 0.85rem; border-radius: 4px;
      transition: color 0.15s;
    }
    .item-btn:hover { color: var(--text-primary); }
    .item-btn.delete:hover { color: var(--danger); }

    /* Badges */
    .badge {
      padding: 0.2rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 500;
    }
    .badge-capability { background: rgba(99,102,241,0.2); color: #a5b4fc; }
    .badge-data { background: rgba(16,185,129,0.2); color: #6ee7b7; }
    .badge-process { background: rgba(245,158,11,0.2); color: #fcd34d; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 0.75rem 1.5rem; cursor: pointer;
      border-bottom: 2px solid transparent; transition: all 0.2s; color: var(--text-secondary);
    }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-count {
      background: var(--bg-input); padding: 0.125rem 0.5rem;
      border-radius: 10px; font-size: 0.75rem; margin-left: 0.5rem;
    }

    /* Loading */
    .loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15,23,42,0.9); display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 1000;
    }
    .loading-overlay.hidden { display: none; }
    .hidden { display: none !important; }
    .spinner {
      width: 50px; height: 50px; border: 3px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 1rem; color: var(--text-secondary); }
    .step-content { display: none; }
    .step-content.active { display: block; }

    /* Summary */
    .summary-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .summary-card { background: var(--bg-input); border-radius: 8px; padding: 1.25rem; text-align: center; }
    .summary-card .count { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .summary-card .label { color: var(--text-secondary); font-size: 0.875rem; }

    /* Modal */
    .modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(15,23,42,0.9); display: flex;
      align-items: center; justify-content: center; z-index: 1000;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: var(--bg-card); border-radius: 12px;
      border: 1px solid var(--border); width: 90%; max-width: 500px; padding: 1.5rem;
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }

    /* ===== DUAL LIST EDITOR ===== */
    .dual-list-container { display: flex; gap: 0; align-items: stretch; margin-bottom: 1.5rem; width: 100%; overflow: hidden; }
    .list-panel {
      flex: 1; min-width: 0; background: var(--bg-dark); border: 1px solid var(--border);
      border-radius: 10px; display: flex; flex-direction: column; min-height: 350px; overflow: hidden;
    }
    .list-header {
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      background: var(--bg-card); border-radius: 10px 10px 0 0;
    }
    .list-header h3 { font-size: 0.95rem; display: flex; align-items: center; gap: 0.4rem; }
    .list-header .count-badge {
      background: var(--bg-input); padding: 0.15rem 0.5rem;
      border-radius: 10px; font-size: 0.75rem; color: var(--text-secondary);
    }
    .list-add-row {
      padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border);
      display: flex; gap: 0.5rem;
    }
    .list-add-row input {
      flex: 1; padding: 0.4rem 0.6rem; background: var(--bg-input);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-primary); font-size: 0.85rem; font-family: inherit;
    }
    .list-add-row input::placeholder { color: var(--text-secondary); }
    .list-items {
      flex: 1; overflow-y: auto; padding: 0.5rem;
      display: flex; flex-direction: column; gap: 0.4rem;
      max-height: 400px;
    }
    .list-items::-webkit-scrollbar { width: 6px; }
    .list-items::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .list-footer {
      padding: 0.5rem 0.75rem; border-top: 1px solid var(--border);
      display: flex; justify-content: flex-end;
    }

    /* Transfer arrows */
    .transfer-arrows {
      display: flex; flex-direction: column; justify-content: center;
      gap: 0.5rem; padding: 0 0.5rem;
    }
    .transfer-btn {
      width: 40px; height: 40px; border-radius: 8px;
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text-secondary); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .transfer-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .transfer-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .transfer-btn:disabled:hover { background: var(--bg-card); color: var(--text-secondary); border-color: var(--border); }

    /* Data objects collapsible */
    .data-objects-section { margin-top: 1rem; }
    .collapsible-header {
      display: flex; align-items: center; gap: 0.5rem; cursor: pointer;
      padding: 0.75rem 1rem; background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; transition: all 0.2s; user-select: none;
    }
    .collapsible-header:hover { background: var(--border); }
    .collapsible-header .arrow { transition: transform 0.2s; }
    .collapsible-header.open .arrow { transform: rotate(90deg); }
    .collapsible-body {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      border: 1px solid var(--border); border-top: none;
      border-radius: 0 0 8px 8px;
    }
    .collapsible-body.open { max-height: 500px; }
    .collapsible-body-inner { padding: 0.75rem; }
    .data-items-list { display: flex; flex-direction: column; gap: 0.4rem; max-height: 250px; overflow-y: auto; }
    .data-add-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
    .data-add-row input {
      flex: 1; padding: 0.4rem 0.6rem; background: var(--bg-input);
      border: 1px solid var(--border); border-radius: 6px;
      color: var(--text-primary); font-size: 0.85rem; font-family: inherit;
    }

    /* Skip button */
    .skip-section {
      margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);
      text-align: center;
    }
    .btn-skip {
      background: transparent; color: var(--text-secondary); border: 1px dashed var(--border);
      padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer;
      font-size: 0.95rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-skip:hover { color: var(--text-primary); border-color: var(--primary); background: rgba(99,102,241,0.05); }

    /* Inline edit */
    .inline-edit-input {
      background: var(--bg-dark); border: 1px solid var(--primary);
      border-radius: 4px; color: var(--text-primary); padding: 0.2rem 0.4rem;
      font-size: inherit; font-family: inherit; width: 100%;
    }

    /* Empty state */
    .empty-state {
      text-align: center; padding: 2rem 1rem; color: var(--text-secondary);
      font-size: 0.85rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dual-list-container { flex-direction: column; }
      .transfer-arrows { flex-direction: row; justify-content: center; padding: 0.5rem 0; }
      .transfer-btn { transform: rotate(90deg); }
      .main-content { padding: 0 1rem; }
      .summary-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; gap: 0.5rem; text-align: center; }
    }
  </style>
</head>
<body>
  <header class="header" style="display:none;">
    <h1>üîç <span>Foundation</span> Wizard</h1>
    <div class="header-actions">
      <a href="/design/" class="btn btn-primary">‚ö° Design Module</a>
      <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
    </div>
  </header>

  <div class="progress-container">
    <div class="progress-steps">
      <div class="step-wrapper">
        <div class="step-circle active" data-step="1">1</div>
        <span class="step-label">Upload</span>
      </div>
      <div class="step-line"></div>
      <div class="step-wrapper">
        <div class="step-circle" data-step="2">2</div>
        <span class="step-label">Extract</span>
      </div>
      <div class="step-line"></div>
      <div class="step-wrapper">
        <div class="step-circle" data-step="3">3</div>
        <span class="step-label">Edit</span>
      </div>
      <div class="step-line"></div>
      <div class="step-wrapper">
        <div class="step-circle" data-step="4">4</div>
        <span class="step-label">Save</span>
      </div>
    </div>
  </div>

  <main class="main-content">
    <!-- Step 1: Upload -->
    <div class="step-content active" data-step="1">
      <div class="wizard-card">
        <h2>üì§ Upload Materials</h2>
        <p class="subtitle">Provide information about your domain, or start from scratch.</p>

        <div class="tabs">
          <div class="tab active" data-tab="image">üñºÔ∏è Image</div>
          <div class="tab" data-tab="data">üìÑ Data File</div>
          <div class="tab" data-tab="website">üåê Website</div>
        </div>

        <div class="tab-content" data-tab="image">
          <div class="upload-area" id="uploadAreaImage">
            <div class="upload-icon">üñºÔ∏è</div>
            <p><strong>Drop image here</strong> or click to browse</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Supports: PNG, JPG, GIF, WebP</p>
            <input type="file" id="fileInputImage" accept=".png,.jpg,.jpeg,.gif,.webp">
          </div>
          <div id="fileListImage" style="margin-top: 1rem;"></div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>Additional Context <span style="color: var(--text-secondary); font-weight: normal;">(optional)</span></label>
            <textarea id="imageContext" placeholder="Provide any additional context about the image..." rows="3"></textarea>
          </div>
        </div>

        <div class="tab-content hidden" data-tab="data">
          <div class="upload-area" id="uploadAreaData">
            <div class="upload-icon">üìÑ</div>
            <p><strong>Drop data file here</strong> or click to browse</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Supports: XML, ArchiMate, CSV, Excel (.xlsx)</p>
            <input type="file" id="fileInputData" accept=".xml,.archimate,.csv,.xlsx,.xls">
          </div>
          <div id="fileListData" style="margin-top: 1rem;"></div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>Additional Context <span style="color: var(--text-secondary); font-weight: normal;">(optional)</span></label>
            <textarea id="dataContext" placeholder="Describe what this data represents..." rows="3"></textarea>
          </div>
        </div>

        <div class="tab-content hidden" data-tab="website">
          <div class="form-group">
            <label>Company Website URL</label>
            <input type="url" id="websiteUrl" placeholder="https://example.com">
          </div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>Additional Context <span style="color: var(--text-secondary); font-weight: normal;">(optional)</span></label>
            <textarea id="websiteContext" placeholder="Tell us what to focus on..." rows="3"></textarea>
          </div>
        </div>

        <div class="btn-group">
          <div></div>
          <button class="btn btn-primary" id="btnExtract" disabled>Extract with AI ‚Üí</button>
        </div>

        <div class="skip-section">
          <button class="btn-skip" onclick="skipToEdit()">
            Skip ‚Äî Start from Scratch ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Extract -->
    <div class="step-content" data-step="2">
      <div class="wizard-card" style="text-align: center; padding: 4rem 2rem;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <h2 style="margin-top: 1.5rem;">ü§ñ Analyzing your materials...</h2>
        <p class="subtitle" id="extractionStatus">Extracting capabilities and processes...</p>
      </div>
    </div>

    <!-- Step 3: Edit Foundation -->
    <div class="step-content" data-step="3">
      <div class="wizard-card">
        <h2>üìã Edit Foundation</h2>
        <p class="subtitle">Build your foundation by managing capabilities and processes. Use the arrows to reclassify items.</p>

        <div class="summary-grid">
          <div class="summary-card">
            <div class="count" id="capabilityCount">0</div>
            <div class="label">Capabilities</div>
          </div>
          <div class="summary-card">
            <div class="count" id="dataObjectCount">0</div>
            <div class="label">Data Objects</div>
          </div>
          <div class="summary-card">
            <div class="count" id="processCount">0</div>
            <div class="label">Processes</div>
          </div>
        </div>

        <!-- Dual List -->
        <div class="dual-list-container">
          <!-- Capabilities -->
          <div class="list-panel">
            <div class="list-header">
              <h3>üì¶ Capabilities <span class="count-badge" id="capListCount">0</span></h3>
            </div>
            <div class="list-add-row">
              <input type="text" id="addCapInput" placeholder="New capability name‚Ä¶">
              <button class="btn btn-primary btn-sm" onclick="addItem('capabilities')">+ Add</button>
            </div>
            <div class="list-items" id="capabilitiesList"></div>
            <div class="list-footer">
              <button class="btn btn-danger btn-sm" onclick="removeSelected('capabilities')">üóëÔ∏è Remove Selected</button>
            </div>
          </div>

          <!-- Transfer Arrows -->
          <div class="transfer-arrows">
            <button class="transfer-btn" onclick="transferSelected('toProcess')" title="Move to Processes" id="btnToProcess">‚Üí</button>
            <button class="transfer-btn" onclick="transferSelected('toCapability')" title="Move to Capabilities" id="btnToCap">‚Üê</button>
          </div>

          <!-- Processes -->
          <div class="list-panel">
            <div class="list-header">
              <h3>üîÑ Processes <span class="count-badge" id="procListCount">0</span></h3>
            </div>
            <div class="list-add-row">
              <input type="text" id="addProcInput" placeholder="New process name‚Ä¶">
              <button class="btn btn-primary btn-sm" onclick="addItem('processes')">+ Add</button>
            </div>
            <div class="list-items" id="processesList"></div>
            <div class="list-footer">
              <button class="btn btn-danger btn-sm" onclick="removeSelected('processes')">üóëÔ∏è Remove Selected</button>
            </div>
          </div>
        </div>

        <!-- Data Objects (collapsible) -->
        <div class="data-objects-section">
          <div class="collapsible-header" onclick="toggleDataObjects()">
            <span class="arrow">‚ñ∂</span>
            <span>üìä Data Objects</span>
            <span class="count-badge" id="dataListCount">0</span>
          </div>
          <div class="collapsible-body" id="dataObjectsBody">
            <div class="collapsible-body-inner">
              <div class="data-add-row">
                <input type="text" id="addDataInput" placeholder="New data object name‚Ä¶">
                <button class="btn btn-primary btn-sm" onclick="addItem('dataObjects')">+ Add</button>
              </div>
              <div class="data-items-list" id="dataObjectsList"></div>
              <div style="margin-top: 0.5rem; text-align: right;">
                <button class="btn btn-danger btn-sm" onclick="removeSelected('dataObjects')">üóëÔ∏è Remove Selected</button>
              </div>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
          <button class="btn btn-primary" onclick="goToStep(4)">Continue to Save ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Step 4: Save -->
    <div class="step-content" data-step="4">
      <div class="wizard-card">
        <h2>üíæ Save Foundation</h2>
        <p class="subtitle">Save this discovery as a foundation for agent design.</p>

        <div class="form-group">
          <label>Foundation Name *</label>
          <input type="text" id="foundationName" placeholder="e.g., IT Service Management Foundation">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="foundationDescription" placeholder="Describe what this foundation covers..." style="min-height: 100px;"></textarea>
        </div>

        <div class="summary-grid" style="margin-top: 1.5rem;">
          <div class="summary-card">
            <div class="count" id="finalCapCount">0</div>
            <div class="label">Capabilities</div>
          </div>
          <div class="summary-card">
            <div class="count" id="finalDataCount">0</div>
            <div class="label">Data Objects</div>
          </div>
          <div class="summary-card">
            <div class="count" id="finalProcessCount">0</div>
            <div class="label">Processes</div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
          <button class="btn btn-primary" id="btnSave">üíæ Save Foundation</button>
        </div>
      </div>
    </div>

    <!-- Step 5: Done -->
    <div class="step-content" data-step="5">
      <div class="wizard-card" style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
        <h2>Foundation Saved!</h2>
        <p class="subtitle">Your discovery foundation has been saved and is ready for agent design.</p>
        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
          <a id="designWizardLink" href="/design/" class="btn btn-primary">‚Üí Start Design Wizard</a>
          <a href="/discovery/" class="btn btn-secondary">+ New Foundation</a>
        </div>
        <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
          Foundation ID: <code id="savedFoundationId" style="background: var(--bg-input); padding: 0.25rem 0.5rem; border-radius: 4px;">-</code>
        </p>
      </div>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div class="loading-overlay hidden" id="loadingOverlay">
    <div class="spinner"></div>
    <p class="loading-text" id="loadingText">Processing...</p>
  </div>

  <!-- Edit Modal -->
  <div class="modal hidden" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="editModalTitle">Edit Item</h3>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="editName">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="editDescription" style="min-height: 80px;"></textarea>
      </div>
      <div class="btn-group" style="border-top: none; padding-top: 0;">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <script src="/js/auth-ui.js"></script>
  <script>
    // ===== STATE =====
    let currentStep = 1;
    let imageFile = null;
    let dataFile = null;
    let extractedData = { capabilities: [], dataObjects: [], processes: [] };
    let selectedItems = { capabilities: new Set(), dataObjects: new Set(), processes: new Set() };
    let editingItem = null;
    let csrfToken = '';
    let idCounters = { cap: 0, proc: 0, data: 0 };

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('flowgrid_access_token') || sessionStorage.getItem('flowgrid_access_token');
      if (!token) { window.location.href = '/login.html?redirect=/discovery/'; return; }

      try {
        const res = await fetch('/api/wizard/csrf-token', { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.status === 401) {
          localStorage.removeItem('flowgrid_access_token');
          sessionStorage.removeItem('flowgrid_access_token');
          window.location.href = '/login.html?redirect=/discovery/';
          return;
        }
        const data = await res.json();
        csrfToken = data.csrfToken;
      } catch (e) { console.error('Failed to get CSRF token:', e); }

      initTabs();
      initUpload();
      initButtons();
      initKeyboardShortcuts();
    });

    // ===== TABS =====
    function initTabs() {
      document.querySelectorAll('.tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content[data-tab]').forEach(c => c.classList.add('hidden'));
          tab.classList.add('active');
          document.querySelector(`.tab-content[data-tab="${tab.dataset.tab}"]`).classList.remove('hidden');
          updateExtractButton();
        });
      });
    }

    // ===== FILE UPLOAD =====
    function initUpload() {
      const setupDrop = (areaId, inputId, handler) => {
        const area = document.getElementById(areaId);
        const input = document.getElementById(inputId);
        area.addEventListener('click', () => input.click());
        area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
        area.addEventListener('dragleave', () => area.classList.remove('dragover'));
        area.addEventListener('drop', e => { e.preventDefault(); area.classList.remove('dragover'); handler(e.dataTransfer.files[0]); });
        input.addEventListener('change', e => handler(e.target.files[0]));
      };
      setupDrop('uploadAreaImage', 'fileInputImage', handleImageFile);
      setupDrop('uploadAreaData', 'fileInputData', handleDataFile);

      ['imageContext','dataContext','websiteUrl','websiteContext'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateExtractButton);
      });
    }

    function handleImageFile(file) { if (!file) return; imageFile = file; renderFileList('image'); updateExtractButton(); }
    function handleDataFile(file) { if (!file) return; dataFile = file; renderFileList('data'); updateExtractButton(); }

    function renderFileList(type) {
      const file = type === 'image' ? imageFile : dataFile;
      const list = document.getElementById(type === 'image' ? 'fileListImage' : 'fileListData');
      if (!file) { list.innerHTML = ''; return; }
      const icon = type === 'image' ? 'üñºÔ∏è' : 'üìÑ';
      list.innerHTML = `<div class="item-card"><div class="item-info"><h4>${icon} ${file.name}</h4><p>${(file.size/1024).toFixed(1)} KB</p></div><button class="btn btn-secondary" onclick="removeFile('${type}')" style="padding:0.5rem;">‚úï</button></div>`;
    }

    function removeFile(type) {
      if (type === 'image') { imageFile = null; document.getElementById('fileInputImage').value = ''; }
      else { dataFile = null; document.getElementById('fileInputData').value = ''; }
      renderFileList(type); updateExtractButton();
    }

    function updateExtractButton() {
      const activeTab = document.querySelector('.tab[data-tab].active').dataset.tab;
      let valid = false;
      if (activeTab === 'image' && imageFile) valid = true;
      if (activeTab === 'data' && dataFile) valid = true;
      if (activeTab === 'website' && document.getElementById('websiteUrl').value.trim().length > 5) valid = true;
      document.getElementById('btnExtract').disabled = !valid;
    }

    // ===== BUTTONS =====
    function initButtons() {
      document.getElementById('btnExtract').addEventListener('click', startExtraction);
      document.getElementById('btnSave').addEventListener('click', saveFoundation);
    }

    function initKeyboardShortcuts() {
      ['addCapInput','addProcInput','addDataInput'].forEach(id => {
        document.getElementById(id).addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const type = id === 'addCapInput' ? 'capabilities' : id === 'addProcInput' ? 'processes' : 'dataObjects';
            addItem(type);
          }
        });
      });
    }

    // ===== SKIP =====
    function skipToEdit() {
      extractedData = { capabilities: [], dataObjects: [], processes: [] };
      selectedItems = { capabilities: new Set(), dataObjects: new Set(), processes: new Set() };
      renderAllLists();
      goToStep(3);
    }

    // ===== STEP NAVIGATION =====
    function goToStep(step) {
      currentStep = step;
      document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
      document.querySelector(`.step-content[data-step="${step}"]`).classList.add('active');

      document.querySelectorAll('.step-circle').forEach(c => {
        const s = parseInt(c.dataset.step);
        c.classList.remove('active', 'completed');
        if (s < step) c.classList.add('completed');
        if (s === step) c.classList.add('active');
      });
      document.querySelectorAll('.step-line').forEach((line, i) => {
        line.classList.toggle('completed', i < step - 1);
      });

      if (step === 4) {
        document.getElementById('finalCapCount').textContent = extractedData.capabilities.length;
        document.getElementById('finalDataCount').textContent = extractedData.dataObjects.length;
        document.getElementById('finalProcessCount').textContent = extractedData.processes.length;
      }
    }

    // ===== EXTRACTION =====
    async function startExtraction() {
      goToStep(2);
      const token = localStorage.getItem('flowgrid_access_token') || sessionStorage.getItem('flowgrid_access_token');
      const activeTab = document.querySelector('.tab[data-tab].active').dataset.tab;

      if (!token) { alert('Please log in first'); window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname); return; }

      try {
        let response;

        if (activeTab === 'image') {
          document.getElementById('extractionStatus').textContent = 'Analyzing image...';
          const formData = new FormData();
          formData.append('file', imageFile);
          const context = document.getElementById('imageContext').value.trim();
          if (context) formData.append('context', context);
          response = await fetch('/api/wizard/upload-image', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'X-CSRF-Token': csrfToken },
            body: formData
          });
        } else if (activeTab === 'data') {
          const fileName = dataFile.name.toLowerCase();
          const context = document.getElementById('dataContext').value.trim();
          const formData = new FormData();
          formData.append('file', dataFile);
          if (context) formData.append('context', context);
          let endpoint;
          if (fileName.endsWith('.xml') || fileName.endsWith('.archimate')) {
            document.getElementById('extractionStatus').textContent = 'Parsing XML/ArchiMate file...';
            endpoint = '/api/wizard/upload-xml';
          } else if (fileName.endsWith('.csv') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            document.getElementById('extractionStatus').textContent = 'Analyzing spreadsheet data...';
            endpoint = '/api/wizard/upload-data';
          } else { throw new Error('Unsupported file type'); }
          response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'X-CSRF-Token': csrfToken },
            body: formData
          });
        } else if (activeTab === 'website') {
          document.getElementById('extractionStatus').textContent = 'Analyzing website...';
          const websiteUrl = document.getElementById('websiteUrl').value.trim();
          const context = document.getElementById('websiteContext').value.trim();
          response = await fetch('/api/wizard/analyze-website', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ url: websiteUrl, context })
          });
        }

        if (!response.ok) throw new Error('Extraction failed');
        const data = await response.json();
        const analysis = data.analysis || data;

        extractedData.capabilities = (analysis.extractedCapabilities || analysis.capabilities || [])
          .map((c, i) => ({ id: `cap-${i}`, name: c.name, description: c.description || c.rationale || '' }));
        extractedData.dataObjects = (analysis.dataObjects || [])
          .map((d, i) => ({ id: `data-${i}`, name: d.name, description: d.description || '' }));
        extractedData.processes = (analysis.processes || [])
          .map((p, i) => ({ id: `proc-${i}`, name: p.name, description: p.description || '' }));

        if (analysis.agents && analysis.agents.length > 0 && extractedData.processes.length === 0) {
          extractedData.processes = analysis.agents
            .map((a, i) => ({ id: `proc-${i}`, name: a.name, description: a.purpose || a.description || '' }));
        }

        // Set counters past extracted IDs
        idCounters.cap = extractedData.capabilities.length;
        idCounters.proc = extractedData.processes.length;
        idCounters.data = extractedData.dataObjects.length;

        selectedItems = { capabilities: new Set(), dataObjects: new Set(), processes: new Set() };
        renderAllLists();
        goToStep(3);
      } catch (error) {
        console.error('Extraction error:', error);
        alert('Extraction failed: ' + error.message);
        goToStep(1);
      }
    }

    // ===== DUAL LIST RENDERING =====
    function renderAllLists() {
      renderList('capabilities');
      renderList('processes');
      renderList('dataObjects');
      updateCounts();
    }

    function renderList(type) {
      const items = extractedData[type];
      const listEl = document.getElementById(type === 'capabilities' ? 'capabilitiesList' : type === 'processes' ? 'processesList' : 'dataObjectsList');

      if (items.length === 0) {
        listEl.innerHTML = `<div class="empty-state">${type === 'capabilities' ? 'üì¶ No capabilities yet' : type === 'processes' ? 'üîÑ No processes yet' : 'üìä No data objects yet'}</div>`;
        return;
      }

      listEl.innerHTML = items.map(item => {
        const checked = selectedItems[type].has(item.id) ? 'checked' : '';
        const selectedClass = selectedItems[type].has(item.id) ? 'selected' : '';
        return `
          <div class="item-card ${selectedClass}" data-id="${item.id}">
            <input type="checkbox" ${checked} onchange="toggleSelect('${type}','${item.id}', this.checked)">
            <div class="item-info" ondblclick="startInlineEdit('${type}','${item.id}', this)">
              <h4>${escapeHtml(item.name)}</h4>
              <p>${escapeHtml(item.description || 'No description')}</p>
            </div>
            <div class="item-actions">
              <button class="item-btn" onclick="editItem('${type}','${item.id}')" title="Edit">‚úèÔ∏è</button>
              <button class="item-btn delete" onclick="deleteSingleItem('${type}','${item.id}')" title="Delete">‚úï</button>
            </div>
          </div>`;
      }).join('');
    }

    function updateCounts() {
      const caps = extractedData.capabilities.length;
      const data = extractedData.dataObjects.length;
      const procs = extractedData.processes.length;

      document.getElementById('capabilityCount').textContent = caps;
      document.getElementById('dataObjectCount').textContent = data;
      document.getElementById('processCount').textContent = procs;
      document.getElementById('capListCount').textContent = caps;
      document.getElementById('procListCount').textContent = procs;
      document.getElementById('dataListCount').textContent = data;

      // Transfer button states
      document.getElementById('btnToProcess').disabled = selectedItems.capabilities.size === 0;
      document.getElementById('btnToCap').disabled = selectedItems.processes.size === 0;
    }

    // ===== SELECTION =====
    function toggleSelect(type, id, checked) {
      if (checked) selectedItems[type].add(id);
      else selectedItems[type].delete(id);
      renderList(type);
      updateCounts();
    }

    // ===== ADD ITEM =====
    function addItem(type) {
      const inputId = type === 'capabilities' ? 'addCapInput' : type === 'processes' ? 'addProcInput' : 'addDataInput';
      const input = document.getElementById(inputId);
      const name = input.value.trim();
      if (!name) return;

      const prefix = type === 'capabilities' ? 'cap' : type === 'processes' ? 'proc' : 'data';
      const id = `${prefix}-${idCounters[prefix]++}`;
      extractedData[type].push({ id, name, description: '' });
      input.value = '';
      renderList(type);
      updateCounts();

      // Scroll to bottom
      const listEl = document.getElementById(type === 'capabilities' ? 'capabilitiesList' : type === 'processes' ? 'processesList' : 'dataObjectsList');
      listEl.scrollTop = listEl.scrollHeight;
    }

    // ===== REMOVE SELECTED =====
    function removeSelected(type) {
      const sel = selectedItems[type];
      if (sel.size === 0) return;
      extractedData[type] = extractedData[type].filter(i => !sel.has(i.id));
      sel.clear();
      renderList(type);
      updateCounts();
    }

    // ===== DELETE SINGLE =====
    function deleteSingleItem(type, id) {
      extractedData[type] = extractedData[type].filter(i => i.id !== id);
      selectedItems[type].delete(id);
      renderList(type);
      updateCounts();
    }

    // ===== TRANSFER =====
    function transferSelected(direction) {
      if (direction === 'toProcess') {
        const sel = selectedItems.capabilities;
        if (sel.size === 0) return;
        const moving = extractedData.capabilities.filter(i => sel.has(i.id));
        extractedData.capabilities = extractedData.capabilities.filter(i => !sel.has(i.id));
        moving.forEach(item => {
          item.id = `proc-${idCounters.proc++}`;
          extractedData.processes.push(item);
        });
        sel.clear();
      } else {
        const sel = selectedItems.processes;
        if (sel.size === 0) return;
        const moving = extractedData.processes.filter(i => sel.has(i.id));
        extractedData.processes = extractedData.processes.filter(i => !sel.has(i.id));
        moving.forEach(item => {
          item.id = `cap-${idCounters.cap++}`;
          extractedData.capabilities.push(item);
        });
        sel.clear();
      }
      renderAllLists();
    }

    // ===== EDIT MODAL =====
    function editItem(type, id) {
      const item = extractedData[type].find(i => i.id === id);
      if (!item) return;
      editingItem = { type, id };
      document.getElementById('editModalTitle').textContent = `Edit ${type === 'capabilities' ? 'Capability' : type === 'processes' ? 'Process' : 'Data Object'}`;
      document.getElementById('editName').value = item.name;
      document.getElementById('editDescription').value = item.description || '';
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); editingItem = null; }

    function saveEdit() {
      if (!editingItem) return;
      const item = extractedData[editingItem.type].find(i => i.id === editingItem.id);
      if (item) {
        item.name = document.getElementById('editName').value;
        item.description = document.getElementById('editDescription').value;
      }
      closeEditModal();
      renderList(editingItem.type);
    }

    // ===== INLINE EDIT (double-click) =====
    function startInlineEdit(type, id, el) {
      const item = extractedData[type].find(i => i.id === id);
      if (!item) return;
      const h4 = el.querySelector('h4');
      const oldName = item.name;
      h4.innerHTML = `<input class="inline-edit-input" value="${escapeAttr(oldName)}" />`;
      const inp = h4.querySelector('input');
      inp.focus();
      inp.select();
      const finish = () => {
        const val = inp.value.trim();
        item.name = val || oldName;
        renderList(type);
      };
      inp.addEventListener('blur', finish);
      inp.addEventListener('keydown', e => { if (e.key === 'Enter') inp.blur(); if (e.key === 'Escape') { inp.value = oldName; inp.blur(); } });
    }

    // ===== DATA OBJECTS COLLAPSIBLE =====
    function toggleDataObjects() {
      const header = document.querySelector('.collapsible-header');
      const body = document.getElementById('dataObjectsBody');
      header.classList.toggle('open');
      body.classList.toggle('open');
    }

    // ===== SAVE =====
    async function saveFoundation() {
      const name = document.getElementById('foundationName').value.trim();
      if (!name) { alert('Please enter a foundation name'); return; }

      const token = localStorage.getItem('flowgrid_access_token') || sessionStorage.getItem('flowgrid_access_token');
      showLoading('Saving foundation...');

      try {
        const response = await fetch('/api/wizard/foundations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, 'X-CSRF-Token': csrfToken },
          body: JSON.stringify({
            name,
            description: document.getElementById('foundationDescription').value,
            capabilities: extractedData.capabilities,
            data_objects: extractedData.dataObjects,
            processes: extractedData.processes
          })
        });

        if (!response.ok) throw new Error('Failed to save foundation');
        const result = await response.json();
        const foundationId = result.foundation?.id;

        if (foundationId) {
          document.getElementById('designWizardLink').href = `/wizard.html?foundation=${foundationId}`;
          document.getElementById('savedFoundationId').textContent = foundationId;
        }

        hideLoading();
        goToStep(5);
      } catch (error) {
        hideLoading();
        alert('Failed to save: ' + error.message);
      }
    }

    // ===== HELPERS =====
    function showLoading(text) { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').classList.remove('hidden'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
    function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function escapeAttr(s) { return s.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
  </script>
</body>
</html>
