# =============================================================================
# Flowgrid Platform - nginx Gateway Configuration
# Routes traffic to microservices (works with Azure Container Apps internal DNS)
# =============================================================================

# Upstreams for Azure Container Apps (use environment-injected hostnames)
# In Container Apps, internal ingress uses port 80 (or use env vars for flexibility)
upstream agent_service {
    server ${AGENT_SERVICE_HOST:-agent-service}:${AGENT_SERVICE_PORT:-3001};
}

upstream auth_service {
    server ${AUTH_SERVICE_HOST:-auth-service}:${AUTH_SERVICE_PORT:-3002};
}

upstream design_service {
    server ${DESIGN_SERVICE_HOST:-design-service}:${DESIGN_SERVICE_PORT:-3003};
}

upstream integration_service {
    server ${INTEGRATION_SERVICE_HOST:-integration-service}:${INTEGRATION_SERVICE_PORT:-3004};
}

upstream wizard_service {
    server ${WIZARD_SERVICE_HOST:-wizard-service}:${WIZARD_SERVICE_PORT:-3005};
}

upstream design_module {
    server ${DESIGN_MODULE_HOST:-design-module}:${DESIGN_MODULE_PORT:-3006};
}

# =============================================================================
# HTTP Server - Redirect to HTTPS (Production only)
# =============================================================================
server {
    listen 80;
    server_name _;
    
    # Use relative redirects (browser preserves original URL including port)
    absolute_redirect off;
    port_in_redirect on;

    # Health check endpoint (needed for load balancers before SSL)
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    # Readiness check
    location /ready {
        access_log off;
        return 200 'Ready';
        add_header Content-Type text/plain;
    }

    # Allow localhost for development
    # In production, comment out and uncomment the redirect below
    # Redirect all HTTP traffic to HTTPS
    # return 301 https://$host$request_uri;

    # For now, continue serving HTTP (development mode)
    include /etc/nginx/conf.d/routes.conf*;
}

# =============================================================================
# HTTPS Server (Production) - Uncomment when SSL certs are available
# =============================================================================
# server {
#     listen 443 ssl http2;
#     server_name _;
#
#     # SSL Configuration
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#
#     include /etc/nginx/conf.d/routes.conf*;
# }
