<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>‚ö° Flowgrid Design - Flowgrid Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/bpmn-js@17/dist/bpmn-modeler.development.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/bpmn-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/bpmn-font/css/bpmn-embedded.css">
  <style>
    /* BPMN Custom Color Scheme - Light Blue */
    .bjs-container .djs-visual > * {
      stroke: #60a5fa !important;
    }
    .bjs-container .djs-visual text {
      fill: #60a5fa !important;
    }
    .bjs-container .djs-visual path,
    .bjs-container .djs-visual rect,
    .bjs-container .djs-visual circle,
    .bjs-container .djs-visual polygon {
      stroke: #60a5fa !important;
      fill: transparent !important;
    }
    .bjs-container .djs-visual .djs-hit {
      stroke: transparent !important;
      fill: transparent !important;
    }
    .bjs-container .djs-connection .djs-visual path {
      stroke: #60a5fa !important;
      marker-end: url(#sequenceflow-end-white-hsl-225-10-15);
    }
    /* Markers/arrows */
    .bjs-container marker path {
      fill: #60a5fa !important;
      stroke: #60a5fa !important;
    }
    /* Selection and hover */
    .bjs-container .djs-outline {
      stroke: #f59e0b !important;
    }
    /* Palette icons */
    .bjs-container .djs-palette .entry:hover {
      color: #60a5fa;
    }
    /* Canvas background */
    .bjs-container {
      background: #1e293b !important;
    }
    .bjs-container .djs-palette {
      background: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
    }
    .bjs-container .djs-palette .entry {
      color: #000000 !important;
    }
    .bjs-container .djs-palette .entry:hover {
      color: #60a5fa !important;
    }
    .bjs-container .djs-palette .entry img,
    .bjs-container .djs-palette .entry svg {
      filter: invert(0) !important;
    }
  </style>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #0f172a; 
      color: #e2e8f0; 
    }
    
    /* Header */
    .header { 
      background: #1e293b; 
      padding: 0.75rem 1.5rem; 
      border-bottom: 1px solid #334155; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    .header h1 { 
      font-size: 1.25rem; 
      color: #f59e0b; 
      display: flex; 
      align-items: center; 
      gap: 0.5rem;
    }
    .header .nav-links {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .header .nav-link {
      color: #94a3b8;
      text-decoration: none;
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .header .nav-link:hover { background: #334155; color: #e2e8f0; }
    .header .stats { 
      display: flex; 
      gap: 1.5rem; 
      font-size: 0.85rem; 
      color: #94a3b8; 
    }
    .header .stat { text-align: center; }
    .header .stat-value { 
      font-size: 1.25rem; 
      font-weight: bold; 
      color: #f1f5f9; 
    }
    
    /* Main Layout */
    .container { 
      display: flex; 
      height: calc(100vh - 56px); 
    }
    
    /* Sidebar */
    .sidebar { 
      background: #1e293b; 
      border-right: 1px solid #334155; 
      overflow-y: auto; 
      width: 280px; 
      min-width: 200px; 
      max-width: 400px; 
      flex-shrink: 0; 
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .sidebar-section { 
      padding: 1rem; 
      border-bottom: 1px solid #334155; 
    }
    .sidebar-section h3 { 
      font-size: 0.8rem; 
      color: #94a3b8; 
      margin-bottom: 0.5rem; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
    }
    .sidebar-section.elements-section {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    
    /* Search & Filters */
    input, select { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #334155; 
      border-radius: 6px; 
      background: #0f172a; 
      color: #e2e8f0; 
      margin-bottom: 0.5rem; 
      font-size: 0.85rem;
    }
    input:focus, select:focus { 
      outline: none; 
      border-color: #60a5fa; 
    }
    
    /* Element List */
    .element-list { 
      flex: 1;
      overflow-y: auto; 
    }
    .element-item { 
      padding: 0.6rem 0.75rem; 
      cursor: pointer; 
      border-radius: 6px; 
      margin-bottom: 2px; 
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      transition: all 0.15s;
    }
    .element-item:hover { background: #334155; }
    .element-item.selected { background: #3b82f6; }
    .element-name { font-weight: 500; }
    .element-type { 
      font-size: 0.7rem; 
      color: #94a3b8; 
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .element-item.selected .element-type { color: #bfdbfe; }

    /* Progress Section - Legacy Style */
    .progress-section {
      padding: 1rem;
      background: #1e293b;
    }
    .progress-section h3 {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .progress-counters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .progress-counter {
      flex: 1;
      background: #0f172a;
      border-radius: 6px;
      padding: 0.5rem;
      text-align: center;
    }
    .progress-counter-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #f1f5f9;
    }
    .progress-counter-label {
      font-size: 0.65rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .progress-counter.configured .progress-counter-value { color: #60a5fa; }
    .progress-counter.compiled .progress-counter-value { color: #a78bfa; }
    .progress-counter.deployed .progress-counter-value { color: #10b981; }
    
    .progress-bar-container {
      margin-bottom: 0.75rem;
    }
    .progress-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .progress-bar {
      height: 6px;
      background: #334155;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .progress-stats {
      font-size: 0.75rem;
      color: #64748b;
    }
    .progress-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.2rem 0;
    }
    .progress-stat-value {
      color: #94a3b8;
    }
    
    /* Main Content */
    .main-content { 
      flex: 1; 
      min-width: 300px; 
      position: relative; 
      padding: 1rem; 
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
    }
    
    /* Agent Explore Header */
    .agent-explore-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .agent-explore-header h2 {
      font-size: 1rem;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Graph Legend - Legacy Style */
    .graph-legend-container {
      background: #1e293b;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }
    .legend-row:last-of-type { margin-bottom: 0; }
    .legend-label {
      font-size: 0.7rem;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      min-width: 65px;
    }
    .legend-item { 
      display: flex; 
      align-items: center; 
      gap: 0.3rem; 
      font-size: 0.75rem; 
      color: #94a3b8; 
      cursor: pointer; 
      padding: 0.2rem 0.4rem; 
      border-radius: 3px; 
      transition: all 0.2s; 
    }
    .legend-item:hover { background: #334155; }
    .legend-item.disabled { opacity: 0.4; text-decoration: line-through; }
    .legend-color { 
      width: 12px; 
      height: 12px; 
      border-radius: 3px; 
    }
    .legend-line {
      width: 20px;
      height: 3px;
      border-radius: 1px;
    }
    .legend-stats {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid #334155;
    }
    
    /* Graph Container */
    .graph-container { 
      flex: 1;
      min-height: 400px; 
      background: #0f172a; 
      border-radius: 8px; 
      border: 1px solid #334155;
      position: relative;
    }

    .graph-state-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.82);
      border-radius: 8px;
      z-index: 10;
      text-align: center;
      padding: 1rem;
    }
    .graph-state-overlay.active { display: flex; }
    .graph-state-card { max-width: 420px; }
    .graph-state-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .graph-state-title { font-size: 1rem; color: #f1f5f9; margin-bottom: 0.35rem; }
    .graph-state-message { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; }

    /* Interaction Legend */
    .interaction-legend {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
    }
    .interaction-legend-title {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .interaction-legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    /* Overview Panel - Legacy Style */
    .overview-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }
    .select-element-card {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #334155;
    }
    .select-element-card h3 {
      color: #10b981;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .select-element-card p {
      color: #94a3b8;
      font-size: 0.85rem;
    }
    
    .element-distribution-card {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #334155;
      flex: 1;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }
    .element-distribution-card h3 {
      color: #10b981;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .distribution-chart-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      flex: 1;
    }
    .chart-wrapper {
      width: 220px;
      height: 220px;
      position: relative;
    }
    .chart-legend {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #cbd5e1;
    }
    .chart-legend-color {
      width: 16px;
      height: 12px;
      border-radius: 2px;
    }
    
    /* Detail Panel */
    .detail-panel { 
      background: #1e293b; 
      border-left: 1px solid #334155; 
      padding: 1rem; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      width: 420px; 
      min-width: 350px; 
      max-width: 600px; 
      flex-shrink: 0; 
      position: relative; 
    }
    .detail-panel h2 { 
      font-size: 1rem; 
      color: #60a5fa; 
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .detail-panel .agent-type {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 1rem;
    }
    
    /* Detail Tabs - Legacy Style */
    .detail-tabs { 
      display: flex; 
      gap: 0.15rem; 
      margin-bottom: 1rem; 
      border-bottom: 1px solid #334155; 
      padding-bottom: 0.5rem; 
      flex-wrap: wrap; 
    }
    .detail-tab { 
      padding: 0.4rem 0.6rem; 
      background: transparent; 
      border-radius: 4px 4px 0 0; 
      cursor: pointer; 
      font-size: 0.75rem; 
      color: #94a3b8; 
      border: 1px solid transparent; 
      white-space: nowrap; 
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .detail-tab:hover { color: #e2e8f0; background: #334155; }
    .detail-tab.active { 
      background: #3b82f6; 
      color: white; 
      border-color: #3b82f6; 
    }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Form Styles */
    .form-group { margin-bottom: 0.75rem; }
    .form-group label { 
      display: block; 
      color: #94a3b8; 
      font-size: 0.75rem; 
      margin-bottom: 0.25rem; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
    }
    .form-group textarea { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #334155; 
      border-radius: 6px; 
      background: #0f172a; 
      color: #e2e8f0; 
      font-size: 0.85rem; 
      font-family: inherit;
      min-height: 80px;
      resize: vertical;
    }
    .form-group textarea:focus { outline: none; border-color: #60a5fa; }
    
    /* Buttons */
    .btn { 
      padding: 0.5rem 1rem; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: 500; 
      font-size: 0.85rem;
      transition: all 0.2s; 
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #334155; color: #e2e8f0; }
    .btn-secondary:hover { background: #475569; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    
    /* Cards */
    .info-card {
      background: #0f172a;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .info-card h4 {
      color: #60a5fa;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    .info-card p {
      color: #cbd5e1;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    
    /* Relationship List */
    .relationship-item {
      background: #0f172a;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    .relationship-type {
      background: #334155;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: #94a3b8;
    }
    .relationship-target {
      color: #60a5fa;
      cursor: pointer;
    }
    .relationship-target:hover { text-decoration: underline; }
    
    /* Code View */
    .code-container pre {
      background: #0f172a;
      padding: 1rem;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color: #e2e8f0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }
    
    /* Integration List */
    .integration-item {
      background: #0f172a;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .integration-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .integration-badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      background: #334155;
      color: #94a3b8;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #64748b;
    }
    .empty-state .icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }
    
    /* Resize Handle */
    .resize-handle { 
      width: 4px; 
      background: transparent; 
      cursor: col-resize; 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      z-index: 10; 
      transition: background 0.2s; 
    }
    .resize-handle:hover, .resize-handle.active { background: #3b82f6; }
    .sidebar .resize-handle { right: 0; }
    .detail-panel .resize-handle { left: 0; }
    
    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #64748b;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .workspace-panel { display: none; }
    .workspace-panel.active { display: flex; flex-direction: column; gap: 0.75rem; min-height: 0; flex: 1; }
    .legacy-header { gap: 1rem; }

    @media (max-width: 1400px) {
      .detail-panel { width: 360px; min-width: 320px; }
      .sidebar { width: 240px; }
    }

    @media (max-width: 1080px) {
      .container { flex-direction: column; height: auto; }
      .sidebar, .detail-panel { width: 100%; min-width: 0; max-width: none; border: 0; border-top: 1px solid #334155; }
      .main-content { min-height: 55vh; }
      .resize-handle { display: none; }
      .header { flex-wrap: wrap; }
      .distribution-chart-container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header legacy-header">
    <h1>‚ö° Flowgrid Design</h1>
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="stat-elements">0</div>
        <div>Elements</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-relationships">0</div>
        <div>Relationships</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-agents">0</div>
        <div>Agents</div>
      </div>
    </div>
  </header>
  <input type="file" id="design-import-input" accept="application/json" style="display: none;">

  <div class="container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="resize-handle" id="sidebar-resize"></div>
      <div class="sidebar-section elements-section">
        <h3>üìã Elements</h3>
        <div class="element-list" id="element-list">
          <div class="loading"><div class="loading-spinner"></div><p style="margin-top: 0.5rem;">Loading...</p></div>
        </div>
      </div>
      <!-- Progress Section - Legacy Style -->
      <div class="progress-section">
        <h3>üìà Progress</h3>
        <div class="progress-counters">
          <div class="progress-counter configured">
            <div class="progress-counter-value" id="progress-configured">0</div>
            <div class="progress-counter-label">Configured</div>
          </div>
          <div class="progress-counter compiled">
            <div class="progress-counter-value" id="progress-compiled">0</div>
            <div class="progress-counter-label">Compiled</div>
          </div>
          <div class="progress-counter deployed">
            <div class="progress-counter-value" id="progress-deployed">0</div>
            <div class="progress-counter-label">Deployed</div>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-label">
            <span>Deployed</span>
            <span id="progress-percentage">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%;"></div>
          </div>
        </div>
        <div class="progress-stats">
          <div class="progress-stat-row">
            <span>Total Agents:</span>
            <span class="progress-stat-value" id="stat-total-agents">0</span>
          </div>
          <div class="progress-stat-row">
            <span>With Purpose:</span>
            <span class="progress-stat-value" id="stat-with-purpose">0</span>
          </div>
          <div class="progress-stat-row">
            <span>With Design:</span>
            <span class="progress-stat-value" id="stat-with-design">0</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content - Agent Explore -->
    <main class="main-content">
      <div class="agent-explore-header">
        <h2>üîé Agent Explore</h2>
      </div>
      <div class="detail-tabs" style="margin-bottom:0.75rem;">
        <button class="detail-tab active workspace-tab" data-tab="overview" onclick="showWorkspaceTab('overview')">Overview</button>
        <button class="detail-tab workspace-tab" data-tab="graph" onclick="showWorkspaceTab('graph')">Graph</button>
        <button class="detail-tab workspace-tab" data-tab="capabilities" onclick="showWorkspaceTab('capabilities')">üì¶ Capabilities</button>
        <button class="detail-tab workspace-tab" data-tab="relationships" onclick="showWorkspaceTab('relationships')">Relationships</button>
        <button class="detail-tab workspace-tab" data-tab="integrations" onclick="showWorkspaceTab('integrations')">üîå Integrations</button>
        <button class="detail-tab workspace-tab" data-tab="bpmn" onclick="showWorkspaceTab('bpmn')">üîÑ BPMN</button>
        <button class="detail-tab workspace-tab" data-tab="a2a-card" onclick="showWorkspaceTab('a2a-card')">ü§ñ A2A Card</button>
      </div>

      <!-- Overview Tab - Legacy Style with Donut Chart -->
      <section class="workspace-panel active" id="workspace-overview">
        <div class="overview-content">
          <div class="select-element-card">
            <h3>Select an element</h3>
            <p>Click on an element in the sidebar to view its details and relationships.</p>
          </div>
          <div class="element-distribution-card">
            <h3>Element Distribution</h3>
            <div class="distribution-chart-container">
              <div class="chart-wrapper">
                <canvas id="distribution-chart"></canvas>
              </div>
              <div class="chart-legend" id="chart-legend">
                <!-- Legend items will be populated by JS -->
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Graph Tab -->
      <section class="workspace-panel" id="workspace-graph">
        <div class="graph-legend-container" id="graph-legend">
          <div class="legend-row" id="elements-legend-row">
            <span class="legend-label">ELEMENTS:</span>
            <!-- Populated dynamically -->
          </div>
          <div class="legend-row" id="relations-legend-row">
            <span class="legend-label">RELATIONS:</span>
            <!-- Populated dynamically -->
          </div>
          <div class="legend-stats">Click to toggle ‚Ä¢ <span id="graph-node-count">0</span> nodes, <span id="graph-edge-count">0</span> edges</div>
        </div>
        <div class="graph-container" id="graph-container">
          <div class="graph-state-overlay" id="graph-overlay">
            <div class="graph-state-card">
              <div class="graph-state-icon" id="graph-overlay-icon">‚è≥</div>
              <div class="graph-state-title" id="graph-overlay-title">Loading graph</div>
              <div class="graph-state-message" id="graph-overlay-message">Preparing network data...</div>
              <button class="btn btn-secondary" id="graph-overlay-action" style="display:none;" onclick="refreshData()">Retry</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Capabilities Tab -->
      <section class="workspace-panel" id="workspace-capabilities">
        <div style="padding: 1rem;">
          <h3 style="color: #22d3ee; margin-bottom: 0.5rem;">üì¶ Capabilities</h3>
          <p style="color: #94a3b8; margin-bottom: 1rem;">Capabilities owned by the selected agent.</p>
          
          <div id="capabilities-empty" style="color: #64748b; padding: 2rem; text-align: center;">
            Select an agent to view its capabilities.
          </div>
          
          <div id="capabilities-list" style="display: none;">
            <div id="capabilities-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
              <!-- Capabilities populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- Relationships Tab -->
      <section class="workspace-panel" id="workspace-relationships">
        <div style="padding: 1rem;">
          <h3 style="color: #60a5fa; margin-bottom: 0.5rem;">Relationships</h3>
          <p style="color: #94a3b8; margin-bottom: 1.5rem;">Explore relationships and connections for the selected element.</p>
          
          <div id="relationships-empty" style="color: #64748b; padding: 2rem; text-align: center;">
            Select an element to inspect relationships.
          </div>
          
          <div id="relationships-content" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
              <!-- Outgoing Column -->
              <div>
                <h4 style="color: #f59e0b; margin-bottom: 1rem;" id="outgoing-header">Outgoing ‚Üí (0)</h4>
                <div id="outgoing-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
              <!-- Incoming Column -->
              <div>
                <h4 style="color: #60a5fa; margin-bottom: 1rem;" id="incoming-header">‚Üê Incoming (0)</h4>
                <div id="incoming-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Integrations Tab -->
      <section class="workspace-panel" id="workspace-integrations">
        <div id="workspace-integrations-list" class="info-card">
          <h4>Integrations</h4>
          <p>Select an agent to inspect integrations.</p>
        </div>
      </section>

      <!-- Interactions Tab -->
      <section class="workspace-panel" id="workspace-interactions">
        <div class="info-card">
          <h4>A2A Interactions</h4>
          <p>Interaction contracts are shown in the right panel when an agent is selected.</p>
        </div>
      </section>

      <!-- Agents Tab -->
      <section class="workspace-panel" id="workspace-agents">
        <div class="info-card">
          <h4>Agents</h4>
          <p id="workspace-agents-list">Loading agent roster‚Ä¶</p>
        </div>
      </section>

      <!-- BPMN Tab -->
      <section class="workspace-panel" id="workspace-bpmn">
        <div style="display: grid; grid-template-columns: 280px 1fr; gap: 1rem; height: calc(100vh - 200px);">
          <!-- Process List -->
          <div style="background: #1e293b; border-radius: 8px; padding: 1rem; overflow-y: auto;">
            <h4 style="color: #f59e0b; margin-bottom: 0.75rem;">üîÑ Processes</h4>
            <p style="color: #64748b; font-size: 0.8rem; margin-bottom: 1rem;">Select a process to view/edit its BPMN diagram.</p>
            <div id="bpmn-process-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <!-- BPMN Canvas Area -->
          <div style="display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <div>
                <h3 style="color: #f59e0b; margin-bottom: 0.25rem;" id="bpmn-process-title">üìä Select a Process</h3>
                <p style="color: #64748b; font-size: 0.85rem;" id="bpmn-process-desc">Choose a process from the list to view its workflow</p>
              </div>
              <div style="display: flex; gap: 0.5rem;" id="bpmn-actions" style="display: none;">
                <button class="btn btn-success" onclick="saveCurrentBPMN()" style="font-size: 0.85rem;" id="bpmn-save-btn">üíæ Save</button>
                <button class="btn btn-primary" onclick="regenerateProcessBPMN()" style="font-size: 0.85rem;">üîÑ Regenerate</button>
                <button class="btn btn-secondary" onclick="document.getElementById('bpmn-import-input').click()" style="font-size: 0.85rem;">üì§ Import</button>
                <button class="btn btn-secondary" onclick="exportProcessBPMN()" style="font-size: 0.85rem;">üì• Export</button>
                <input type="file" id="bpmn-import-input" accept=".bpmn,.xml" style="display: none;" onchange="importBPMNFile(event)">
              </div>
            </div>
            
            <!-- Empty state -->
            <div id="bpmn-empty-state" style="flex: 1; display: flex; align-items: center; justify-content: center; background: #1e293b; border: 1px dashed #334155; border-radius: 8px;">
              <div style="text-align: center; color: #64748b;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <p>Select a process from the list to view its BPMN diagram</p>
              </div>
            </div>
            
            <!-- BPMN Canvas -->
            <div id="bpmn-canvas-main" style="flex: 1; display: none; background: #1e293b; border: 1px solid #334155; border-radius: 8px;"></div>
            
            <div style="margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
              <small style="color: #64748b;">Powered by <a href="https://bpmn.io" target="_blank" style="color: #60a5fa;">bpmn.io</a></small>
              <small style="color: #64748b;" id="bpmn-stats"></small>
            </div>
          </div>
        </div>
      </section>

      <!-- A2A Card Tab -->
      <section class="workspace-panel" id="workspace-a2a-card">
        <div class="a2a-card-container" style="padding: 1rem;">
          <div id="a2a-no-selection" style="text-align: center; color: #64748b; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
            <h3 style="color: #94a3b8; margin-bottom: 0.5rem;">No Agent Selected</h3>
            <p>Select an agent from the sidebar to view its A2A Card</p>
          </div>
          <div id="a2a-card-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="color: #f59e0b; margin: 0;">ü§ñ A2A Agent Card</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm" onclick="copyA2ACard()" title="Copy to clipboard">üìã Copy</button>
                <button class="btn btn-sm btn-primary" onclick="downloadA2ACard()" title="Download JSON">‚¨áÔ∏è Download</button>
              </div>
            </div>
            <div id="a2a-card-json" style="background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; overflow: auto; max-height: calc(100vh - 300px);">
              <pre style="margin: 0; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.8rem; color: #e2e8f0; white-space: pre-wrap;"><code id="a2a-card-code"></code></pre>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background: #1e3a5f; border: 1px solid #3b82f6; border-radius: 6px;">
              <div style="font-size: 0.85rem; color: #93c5fd;">
                <strong>üí° A2A Protocol</strong><br>
                This card follows the <a href="https://google.github.io/A2A/" target="_blank" style="color: #60a5fa;">Agent-to-Agent Protocol</a> specification.
                Use it to register this agent with A2A-compatible orchestrators.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Right Sidebar - Detail Panel with Legacy Tabs -->
    <aside class="detail-panel" id="detail-panel">
      <div class="resize-handle" id="detail-resize"></div>
      <div id="detail-empty" style="display: none;"></div>
      <div id="detail-content" style="display: none;">
        <h2 id="detail-name">Agent Name</h2>
        <div class="agent-type" id="detail-type">ü§ñ Agent ‚Ä¢ Specialist</div>
        
        <!-- Legacy-style tabs: Description, Design, Configure, Verify, Code, Deploy -->
        <div class="detail-tabs">
          <button class="detail-tab active" data-tab="description" onclick="showDetailTab('description')">üìù Description</button>
          <button class="detail-tab" data-tab="design" onclick="showDetailTab('design')">üé® Design</button>
          <button class="detail-tab" data-tab="configure" onclick="showDetailTab('configure')">‚öôÔ∏è Configure</button>
          <button class="detail-tab" data-tab="verify" onclick="showDetailTab('verify')">‚úÖ Verify</button>
          <button class="detail-tab" data-tab="code" onclick="showDetailTab('code')">üíª Code</button>
          <button class="detail-tab" data-tab="deploy" onclick="showDetailTab('deploy')">üöÄ Deploy</button>
        </div>

        <!-- Description Tab - Legacy Style -->
        <div id="tab-description" class="tab-content active">
          <div style="margin-bottom: 1rem;">
            <h3 style="color: #10b981; font-size: 1rem; margin-bottom: 0.25rem;">üìù Agent Description</h3>
            <p style="color: #64748b; font-size: 0.8rem;">Define what this agent does in clear, business-friendly terms.</p>
          </div>
          <div class="form-group">
            <label>Agent Name (Display)</label>
            <input type="text" id="agent-display-name" placeholder="Display name for this agent">
          </div>
          <div class="form-group">
            <label>Short Description</label>
            <input type="text" id="agent-short-desc" placeholder="Brief one-line description">
          </div>
          <div class="form-group">
            <label>Detailed Purpose</label>
            <textarea id="agent-purpose" placeholder="Describe what this agent does and its core function..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Business Value</label>
            <textarea id="agent-business-value" placeholder="What value does this agent provide to the business?" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>Key Responsibilities</label>
            <textarea id="agent-responsibilities" placeholder="List the main responsibilities (one per line)" rows="4"></textarea>
          </div>
          <div class="form-group">
            <label>Success Criteria</label>
            <textarea id="agent-success-criteria" placeholder="How do we measure if this agent is successful?" rows="2"></textarea>
          </div>
          <button class="btn btn-success" style="width: 100%; margin-top: 0.5rem;" onclick="saveAgent()">üíæ Save Description</button>
          
          <!-- Capabilities Section -->
          <div id="agent-capabilities-section" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
            <h3 style="color: #22d3ee; font-size: 1rem; margin-bottom: 0.75rem;">üì¶ Capabilities</h3>
            <div id="agent-capabilities-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <span style="color: #64748b; font-size: 0.85rem;">No capabilities loaded</span>
            </div>
          </div>
          
          <!-- Process Info Section (shown for Process elements) -->
          <div id="process-info-section" style="display: none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
            <h3 style="color: #ec4899; font-size: 1rem; margin-bottom: 1rem;">üîÑ Process Flow Details</h3>
            <div class="form-group">
              <label>Process Steps</label>
              <textarea id="agent-process-steps" placeholder="The steps in this process..." rows="4" readonly style="background: #0f172a;"></textarea>
            </div>
            <div class="form-group">
              <label>Decision Points</label>
              <textarea id="agent-decision-points" placeholder="Key decision points in the process..." rows="3" readonly style="background: #0f172a;"></textarea>
            </div>
            <div class="form-group">
              <label>Error Handling</label>
              <textarea id="agent-error-handling" placeholder="How errors are handled..." rows="3" readonly style="background: #0f172a;"></textarea>
            </div>
          </div>
          </div>
        </div>

        <!-- Design Tab -->
        <div id="tab-design" class="tab-content">
          <div class="form-group">
            <label>Pattern</label>
            <select id="agent-pattern">
              <option value="routing">üîÄ Routing</option>
              <option value="planning">üìã Planning</option>
              <option value="tool-use">üîß Tool Use</option>
              <option value="orchestration">üé≠ Orchestration</option>
              <option value="human-in-loop">üë§ Human-in-Loop</option>
              <option value="rag">üìö RAG</option>
              <option value="reflection">üîç Reflection</option>
              <option value="guardrails">üõ°Ô∏è Guardrails</option>
            </select>
          </div>
          <div class="form-group">
            <label>Capability Group</label>
            <input type="text" id="agent-capgroup" placeholder="e.g., Incident Management">
          </div>
          <div class="form-group">
            <label>Objectives (one per line)</label>
            <textarea id="agent-objectives" rows="6"></textarea>
          </div>
          <div class="form-group">
            <label>KPIs</label>
            <textarea id="agent-kpis" rows="4"></textarea>
          </div>
          <button class="btn btn-primary" onclick="saveAgent()">üíæ Save Design</button>
        </div>

        <!-- Configure Tab -->
        <div id="tab-configure" class="tab-content">
          <h4 style="color:#94a3b8;font-size:.8rem;margin-bottom:.75rem;">INTEGRATIONS</h4>
          <div id="integrations-list">
            <div class="empty-state">
              <div class="icon">üîå</div>
              <p>No integrations configured</p>
            </div>
          </div>
          <button class="btn btn-success" style="margin-top:1rem;" onclick="addIntegration()">‚ûï Add Integration</button>
          
          <h4 style="color:#94a3b8;font-size:.8rem;margin:1.5rem 0 .75rem;">INTERACTIONS</h4>
          <div id="interactions-list">
            <div class="empty-state" style="padding:1rem;"><p>No interaction contracts found</p></div>
          </div>
        </div>

        <!-- Verify Tab -->
        <div id="tab-verify" class="tab-content">
          <div class="info-card">
            <h4>Verification Status</h4>
            <p id="verify-status">Run verification to check agent configuration completeness.</p>
          </div>
          <div id="verify-results"></div>
          <button class="btn btn-primary" style="margin-top:1rem;" onclick="runVerification()">üîç Run Verification</button>
        </div>

        <!-- Code Tab -->
        <div id="tab-code" class="tab-content">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
            <h4 style="color:#94a3b8;font-size:.8rem;">GENERATED PROMPT</h4>
            <button class="btn btn-secondary" onclick="copyCode()">üìã Copy</button>
          </div>
          <div class="code-container">
            <pre id="agent-code">// Select an agent to view generated code</pre>
          </div>
          <button class="btn btn-success" style="margin-top:1rem;" onclick="generateCode()">ü§ñ Regenerate with AI</button>
        </div>

        <!-- Deploy Tab -->
        <div id="tab-deploy" class="tab-content">
          <div class="info-card">
            <h4>Deployment Status</h4>
            <p id="deploy-status">Agent is not yet deployed.</p>
          </div>
          <div style="display:flex;gap:.5rem;margin-top:1rem;">
            <button class="btn btn-success" onclick="deployAgent()">üöÄ Deploy Agent</button>
            <button class="btn btn-danger" onclick="deleteAgent()">üóëÔ∏è Delete</button>
          </div>
        </div>

      </div>
    </aside>
  </div>
  
  <script src="./auth-ui.js"></script>
  <script>
    // ============================================================================
    // Configuration
    // ============================================================================
    
    const API_BASE = '/api/agents';

    function getAccessToken() {
      if (window.FlowgridAuthUI?.getAuthToken) {
        return window.FlowgridAuthUI.getAuthToken();
      }
      return localStorage.getItem('flowgrid_access_token') || localStorage.getItem('accessToken');
    }
    
    // State
    let agents = [];
    let relationships = [];
    let selectedAgentId = null;
    let network = null;
    let distributionChart = null;
    let hiddenTypes = new Set();
    let hiddenRelations = new Set();
    let graphState = 'loading';
    
    function normalizeNodeType(value) {
      if (!value) return 'Agent';
      const lower = String(value).toLowerCase();
      // Map common variations to standard types
      const typeMap = {
        'agent': 'Agent',
        'capability': 'Capability',
        'dataobject': 'DataObject',
        'data object': 'DataObject',
        'process': 'Process',
        'applicationfunction': 'ApplicationFunction',
        'application function': 'ApplicationFunction',
        'grouping': 'Grouping',
        'resource': 'Resource',
        'applicationservice': 'ApplicationService',
        'application service': 'ApplicationService',
        'requirement': 'Requirement',
        'businessservice': 'BusinessService',
        'business service': 'BusinessService',
      };
      return typeMap[lower] || value; // Return original if not mapped
    }

    // Node colors by element type (legacy + new)
    const nodeColors = {
      // Legacy ArchiMate types
      'ApplicationFunction': '#a855f7', // purple
      'Grouping': '#06b6d4', // cyan
      'Resource': '#10b981', // green
      'ApplicationService': '#f59e0b', // orange
      'Requirement': '#3b82f6', // blue
      'DataObject': '#ec4899', // pink
      'BusinessService': '#3b82f6', // blue
      // New FlowGrid types
      'Agent': '#10b981', // green
      'Capability': '#60a5fa', // blue
      'Process': '#ec4899', // pink
      'default': '#94a3b8'
    };

    // Relation/edge colors
    const relationColors = {
      'Realization': '#a855f7', // purple
      'Flow': '#3b82f6', // blue
      'Association': '#64748b', // gray
      'Composition': '#ec4899', // pink
      'Access': '#ef4444', // red
      'Serving': '#14b8a6', // teal
      'uses': '#60a5fa',
      'manages': '#22c55e',
      'delegates_to': '#f59e0b',
      'consults': '#a78bfa',
      'triggers': '#f97316',
      'reports_to': '#38bdf8',
      'depends_on': '#f43f5e',
      'informs': '#14b8a6',
      'message': '#64748b',
      'default': '#64748b'
    };

    // Extended element type colors for donut chart
    const elementTypeColors = {
      'Requirement': '#3b82f6',
      'Resource': '#10b981',
      'ApplicationService': '#f59e0b',
      'Artifact': '#ef4444',
      'ApplicationFunction': '#a855f7',
      'BusinessService': '#3b82f6',
      'DataObject': '#ec4899',
      'Grouping': '#06b6d4',
      'Capability': '#22c55e',
      'ValueStream': '#f97316',
      'Agent': '#10b981',
      'Process': '#ec4899',
    };

    // Note: relationColors is defined above and includes all interaction types

    function setGraphState(state, message) {
      graphState = state;
      const overlay = document.getElementById('graph-overlay');
      if (!overlay) return;

      const icon = document.getElementById('graph-overlay-icon');
      const title = document.getElementById('graph-overlay-title');
      const text = document.getElementById('graph-overlay-message');
      const action = document.getElementById('graph-overlay-action');

      if (state === 'ready') {
        overlay.classList.remove('active');
        return;
      }

      const byState = {
        loading: { icon: '‚è≥', title: 'Loading graph', message: 'Preparing network data...', action: false },
        empty: { icon: 'üï∏Ô∏è', title: 'No graph data yet', message: 'Create an agent or import a design bundle to start.', action: true },
        error: { icon: '‚ö†Ô∏è', title: 'Graph unavailable', message: message || 'Could not load graph data. Try refreshing.', action: true },
      };

      const config = byState[state] || byState.loading;
      icon.textContent = config.icon;
      title.textContent = config.title;
      text.textContent = message || config.message;
      action.style.display = config.action ? 'inline-flex' : 'none';
      overlay.classList.add('active');
    }
    
    // ============================================================================
    // Initialization
    // ============================================================================
    
    async function init() {
      console.log('[design-studio] Initializing...');
      setGraphState('loading');

      try {
        await loadAgents();
        await loadRelationships();
        renderGraphLegend();
        initGraph();
        updateStats();
        updateDistributionChart();
        console.log('[design-studio] Ready');
      } catch (error) {
        console.error('[design-studio] Init error:', error);
        setGraphState('error', 'Failed to load data. Make sure the gateway and agent-service are running.');
        showError('Failed to load data. Make sure agent-service is running.');
      }
    }
    
    // ============================================================================
    // Data Loading
    // ============================================================================

    function getAuthHeaders(extra = {}) {
      const accessToken = getAccessToken();
      return accessToken
        ? { ...extra, Authorization: `Bearer ${accessToken}` }
        : { ...extra };
    }
    
    async function loadAgents() {
      try {
        // Cache-bust to ensure fresh data after wizard completion
        const cacheBuster = `_t=${Date.now()}`;
        const response = await fetch(`${API_BASE}?limit=500&${cacheBuster}`, { 
          headers: getAuthHeaders(),
          cache: 'no-store'
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const payload = await response.json();
        const rawAgents = Array.isArray(payload)
          ? payload
          : Array.isArray(payload?.data)
            ? payload.data
            : [];

        console.log('[loadAgents] Raw response sample:', rawAgents.slice(0, 3).map(a => ({ name: a.name, elementType: a.elementType })));
        
        agents = rawAgents.map((agent) => ({
          ...agent,
          id: agent.id,
          name: agent.name || 'Unnamed agent',
          type: normalizeNodeType(agent.type),
          elementType: agent.elementType || 'Agent',
          pattern: agent.pattern || agent.config?.pattern || 'tool-use',
          purpose: agent.purpose || agent.description || '',
          valueStream: agent.valueStream || agent.config?.valueStream || '',
          capabilityGroup: agent.capabilityGroup || agent.config?.capabilityGroup || '',
          objectives: Array.isArray(agent.objectives) ? agent.objectives : [],
          kpis: Array.isArray(agent.kpis) ? agent.kpis : [],
          integrations: Array.isArray(agent.integrations) ? agent.integrations : [],
          status: agent.status || 'configured',
        }));

        renderElementList();
      } catch (error) {
        console.error('[loadAgents] Error:', error);
        agents = [];
        renderElementList();
      }
    }
    
    async function loadRelationships() {
      try {
        const cacheBuster = `_t=${Date.now()}`;
        const [relationshipsRes, interactionsRes] = await Promise.all([
          fetch(`${API_BASE}/relationships?${cacheBuster}`, { headers: getAuthHeaders(), cache: 'no-store' }),
          fetch(`/api/agent-interactions?${cacheBuster}`, { headers: getAuthHeaders(), cache: 'no-store' }),
        ]);

        const allRaw = [];

        if (relationshipsRes.ok) {
          const payload = await relationshipsRes.json();
          allRaw.push(...(Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : [])));
        }

        if (interactionsRes.ok) {
          const payload = await interactionsRes.json();
          allRaw.push(...(Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : [])));
        }

        const dedupe = new Map();
        allRaw.forEach((relation) => {
          const normalized = {
            id: relation.id,
            sourceId: relation.sourceId || relation.source_agent_id || relation.sourceAgentId,
            targetId: relation.targetId || relation.target_agent_id || relation.targetAgentId,
            type: relation.type || relation.message_type || relation.messageType || 'message',
            description: relation.description || '',
            config: relation.config || {},
          };
          if (normalized.sourceId && normalized.targetId) {
            dedupe.set(normalized.id || `${normalized.sourceId}:${normalized.targetId}:${normalized.type}`, normalized);
          }
        });

        relationships = Array.from(dedupe.values());
      } catch (error) {
        console.error('[loadRelationships] Error:', error);
        relationships = [];
      }
    }
    
    // ============================================================================
    // Element List Rendering
    // ============================================================================
    
    function renderElementList() {
      const container = document.getElementById('element-list');
      
      // Show all agents (filter dropdown removed)
      const filtered = agents;
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîç</div>
            <p>No elements found</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(a => `
        <div class="element-item ${a.id === selectedAgentId ? 'selected' : ''}" 
             onclick="selectAgent('${a.id}')"
             data-id="${a.id}">
          <span class="element-name">${escapeHtml(a.name)}</span>
          <span class="element-type">
            <span style="width: 8px; height: 8px; border-radius: 2px; background: ${nodeColors[a.elementType] || nodeColors.default};"></span>
            ${a.elementType || 'Agent'}
          </span>
        </div>
      `).join('');
    }

    // ============================================================================
    // Distribution Chart (Donut)
    // ============================================================================

    function updateDistributionChart() {
      const canvas = document.getElementById('distribution-chart');
      const legendContainer = document.getElementById('chart-legend');
      
      if (!canvas || !legendContainer) return;

      // Count elements by type
      const typeCounts = {};
      agents.forEach(a => {
        const type = a.type || 'Unknown';
        typeCounts[type] = (typeCounts[type] || 0) + 1;
      });

      const labels = Object.keys(typeCounts);
      const data = Object.values(typeCounts);
      const colors = labels.map(label => elementTypeColors[label] || '#64748b');

      // Destroy existing chart if any
      if (distributionChart) {
        distributionChart.destroy();
      }

      // Create new chart
      const ctx = canvas.getContext('2d');
      distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: '#1e293b',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '60%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1e293b',
              titleColor: '#f1f5f9',
              bodyColor: '#cbd5e1',
              borderColor: '#334155',
              borderWidth: 1,
            }
          }
        }
      });

      // Update legend
      legendContainer.innerHTML = labels.map((label, i) => `
        <div class="chart-legend-item">
          <div class="chart-legend-color" style="background: ${colors[i]};"></div>
          <span>${escapeHtml(label)}</span>
        </div>
      `).join('');
    }
    
    // ============================================================================
    // Graph Visualization
    // ============================================================================
    
    function initGraph() {
      const container = document.getElementById('graph-container');

      const visibleAgents = agents.filter(a => !hiddenTypes.has(a.elementType || a.type));
      if (visibleAgents.length === 0) {
        if (network) {
          network.destroy();
          network = null;
        }
        setGraphState('empty');
        return;
      }

      const nodes = new vis.DataSet(
        visibleAgents.map(a => {
          const elemType = a.elementType || a.type || 'default';
          const bgColor = nodeColors[elemType] || nodeColors.default;
          return {
            id: a.id,
            label: a.name,
            color: {
              background: bgColor,
              border: bgColor,
              highlight: { background: bgColor, border: '#ffffff' },
              hover: { background: bgColor, border: '#ffffff' }
            },
            font: { color: '#ffffff', size: 11, face: 'Inter, sans-serif' },
            shape: 'box',
            borderWidth: 2,
            borderWidthSelected: 3,
            margin: 8,
            title: elemType, // tooltip shows element type
          };
        })
      );
      
      const edges = new vis.DataSet(
        relationships
          .filter(r => {
            if (hiddenRelations.has(r.type)) return false;
            const source = agents.find(a => a.id === r.sourceId);
            const target = agents.find(a => a.id === r.targetId);
            return source && target && !hiddenTypes.has(source.elementType || source.type) && !hiddenTypes.has(target.elementType || target.type);
          })
          .map(r => {
            const edgeColor = relationColors[r.type] || relationColors.default;
            return {
              id: r.id,
              from: r.sourceId,
              to: r.targetId,
              label: r.type,
              arrows: { to: { enabled: true, scaleFactor: 0.6, type: 'arrow' } },
              color: { color: edgeColor, highlight: edgeColor, hover: edgeColor },
              font: { color: '#94a3b8', size: 9, align: 'middle', strokeWidth: 0 },
              smooth: { type: 'curvedCW', roundness: 0.2 },
              width: 2,
            };
          })
      );
      
      const options = {
        nodes: {
          shadow: false,
          margin: 8,
        },
        edges: {
          shadow: false,
        },
        physics: {
          enabled: true,
          barnesHut: {
            gravitationalConstant: -3000,
            centralGravity: 0.2,
            springLength: 180,
            springConstant: 0.03,
            damping: 0.15,
          },
          stabilization: { iterations: 150 },
        },
        interaction: {
          hover: true,
          tooltipDelay: 200,
          zoomView: true,
          dragView: true,
        },
      };
      
      network = new vis.Network(container, { nodes, edges }, options);
      
      network.on('click', function(params) {
        if (params.nodes.length > 0) {
          selectAgent(params.nodes[0]);
        }
      });
      
      network.on('doubleClick', function(params) {
        if (params.nodes.length > 0) {
          network.focus(params.nodes[0], { scale: 1.5, animation: true });
        }
      });

      // Update graph stats
      const nodeCountEl = document.getElementById('graph-node-count');
      const edgeCountEl = document.getElementById('graph-edge-count');
      if (nodeCountEl) nodeCountEl.textContent = nodes.length;
      if (edgeCountEl) edgeCountEl.textContent = edges.length;

      setGraphState('ready');
    }

    function renderInteractionLegend() {
      const container = document.getElementById('interaction-legend-items');
      if (!container) return;

      const visibleRelationships = relationships.filter(r => {
        const source = agents.find(a => a.id === r.sourceId);
        const target = agents.find(a => a.id === r.targetId);
        return source && target && !hiddenTypes.has(source.elementType || source.type) && !hiddenTypes.has(target.elementType || target.type);
      });

      const types = [...new Set(visibleRelationships.map(r => r.type).filter(Boolean))].sort();

      if (types.length === 0) {
        container.innerHTML = '<span style="font-size: 0.75rem; color: #64748b;">No interactions to display</span>';
        return;
      }

      container.innerHTML = types.map(type => `
        <div class="legend-item" title="${escapeHtml(type)}">
          <div class="legend-color" style="background: ${relationColors[type] || relationColors.default};"></div>
          <span>${escapeHtml(type)}</span>
        </div>
      `).join('');
    }
    
    function toggleLegend(type) {
      const item = document.querySelector(`.legend-item[data-type="${type}"]`);
      if (hiddenTypes.has(type)) {
        hiddenTypes.delete(type);
        if (item) item.classList.remove('disabled');
      } else {
        hiddenTypes.add(type);
        if (item) item.classList.add('disabled');
      }
      initGraph();
    }

    function toggleRelationLegend(relType) {
      const item = document.querySelector(`.legend-item[data-relation="${relType}"]`);
      if (hiddenRelations.has(relType)) {
        hiddenRelations.delete(relType);
        if (item) item.classList.remove('disabled');
      } else {
        hiddenRelations.add(relType);
        if (item) item.classList.add('disabled');
      }
      initGraph();
    }

    function renderGraphLegend() {
      // Get unique element types from data
      const elementTypes = [...new Set(agents.map(a => a.elementType || a.type).filter(Boolean))].sort();
      const relationTypes = [...new Set(relationships.map(r => r.type).filter(Boolean))].sort();

      // Render element legend
      const elemRow = document.getElementById('elements-legend-row');
      if (elemRow) {
        elemRow.innerHTML = '<span class="legend-label">ELEMENTS:</span>' + 
          elementTypes.map(type => {
            const color = nodeColors[type] || nodeColors.default;
            const disabled = hiddenTypes.has(type) ? 'disabled' : '';
            return `<div class="legend-item ${disabled}" data-type="${type}" onclick="toggleLegend('${type}')"><div class="legend-color" style="background: ${color};"></div><span>${type}</span></div>`;
          }).join('');
      }

      // Render relation legend
      const relRow = document.getElementById('relations-legend-row');
      if (relRow) {
        relRow.innerHTML = '<span class="legend-label">RELATIONS:</span>' + 
          relationTypes.map(type => {
            const color = relationColors[type] || relationColors.default;
            const disabled = hiddenRelations.has(type) ? 'disabled' : '';
            return `<div class="legend-item ${disabled}" data-relation="${type}" onclick="toggleRelationLegend('${type}')"><div class="legend-line" style="background: ${color};"></div><span>${type}</span></div>`;
          }).join('');
      }
    }
    
    // ============================================================================
    // Agent Selection & Detail View
    // ============================================================================
    
    async function selectAgent(id) {
      selectedAgentId = id;
      let agent = agents.find(a => a.id === id);
      const detailPanel = document.getElementById('detail-panel');
      
      // Fetch full agent details (includes integrations, capabilities)
      if (agent && !agent._detailsLoaded) {
        try {
          const response = await fetch(`${API_BASE}/${id}`, { headers: getAuthHeaders() });
          if (response.ok) {
            const details = await response.json();
            console.log('[selectAgent] Loaded details:', { id, capabilities: details.capabilities?.length, integrations: details.integrations?.length });
            // Explicitly copy key fields
            agent.capabilities = details.capabilities || [];
            agent.integrations = details.integrations || [];
            agent.interactions = details.interactions || [];
            agent.config = details.config || agent.config;
            agent.description = details.description || agent.description;
            agent._detailsLoaded = true;
          } else {
            console.warn('[selectAgent] Failed to load details:', response.status);
          }
        } catch (err) {
          console.warn('Failed to load agent details:', err);
        }
      }
      
      if (!agent) {
        document.getElementById('detail-empty').style.display = 'block';
        document.getElementById('detail-content').style.display = 'none';
        loadA2ACard(null); // Clear A2A card
        return;
      }
      
      // Only show right panel for Agent elements
      const isAgent = agent.elementType === 'Agent' || !agent.elementType;
      if (detailPanel) {
        detailPanel.style.display = isAgent ? 'flex' : 'none';
      }
      
      // Update workspace panels regardless of element type
      updateWorkspacePanels(agent);
      renderRelationships(id);
      
      // Highlight in list
      renderElementList();
      
      // Focus in graph
      if (network) {
        network.selectNodes([id]);
      }
      
      // If not an Agent, don't populate the right panel
      if (!isAgent) {
        return;
      }
      
      document.getElementById('detail-empty').style.display = 'none';
      document.getElementById('detail-content').style.display = 'block';
      
      // Update header
      document.getElementById('detail-name').textContent = agent.name;
      document.getElementById('detail-type').textContent = `${getTypeIcon(agent.type)} ${agent.type} ‚Ä¢ ${agent.pattern || 'General'}`;
      
      // Update Description tab
      document.getElementById('agent-purpose').value = agent.purpose || agent.description || '';
      
      // Update Capabilities section
      const capsContainer = document.getElementById('agent-capabilities-list');
      const caps = agent.capabilities || [];
      console.log('[selectAgent] Rendering capabilities for', agent.id, ':', caps.length, agent._detailsLoaded);
      capsContainer.innerHTML = caps.length 
        ? caps.map(c => `<span class="capability-tag" style="background: #164e63; color: #22d3ee; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${escapeHtml(c.capability_name || c.name || c)}</span>`).join('')
        : '<span style="color: #64748b; font-size: 0.85rem;">No capabilities</span>';
      const valuestreamEl = document.getElementById('agent-valuestream');
      if (valuestreamEl) valuestreamEl.value = agent.valueStream || '';
      
      // Hide Process Info section (only for Process elements, which don't show here anymore)
      const processSection = document.getElementById('process-info-section');
      if (processSection) {
        processSection.style.display = 'none';
      }
      
      // Update Design tab
      document.getElementById('agent-pattern').value = agent.pattern || 'tool-use';
      document.getElementById('agent-capgroup').value = agent.capabilityGroup || '';
      document.getElementById('agent-objectives').value = (agent.objectives || []).join('\n');
      document.getElementById('agent-kpis').value = (agent.kpis || []).join('\n');
      
      // Update Configure tab
      renderInteractions(id);
      renderIntegrations(agent);

      // Update Verify tab
      updateVerifyStatus(agent);

      // Update Deploy tab
      updateDeployStatus(agent);

      // Update Code tab
      generateAgentCode(agent);
    }
    
    function getTypeIcon(type) {
      const icons = {
        'Agent': 'ü§ñ',
        'Capability': 'üì¶',
        'DataObject': 'üìÑ',
        'Process': 'üîÑ',
      };
      return icons[type] || 'üìã';
    }

    function updateWorkspacePanels(agent) {
      // Update workspace relationships
      const relationsContainer = document.getElementById('workspace-relations');
      if (relationsContainer) {
        const outgoing = relationships.filter(r => r.sourceId === agent.id);
        const incoming = relationships.filter(r => r.targetId === agent.id);
        
        relationsContainer.innerHTML = `
          <h4>Relationships for ${escapeHtml(agent.name)}</h4>
          <div style="font-size:0.75rem;color:#94a3b8;margin:.35rem 0;">OUTGOING (${outgoing.length})</div>
          ${outgoing.length ? outgoing.map(r => {
            const target = agents.find(a => a.id === r.targetId);
            return `<div class="relationship-item"><span class="relationship-type">${escapeHtml(r.type || 'message')}</span><span>‚Üí</span><span class="relationship-target" onclick="selectAgent('${r.targetId}')">${escapeHtml(target?.name || 'Unknown')}</span></div>`;
          }).join('') : '<p style="color:#64748b;font-size:0.85rem;">No outgoing relationships</p>'}
          <div style="font-size:0.75rem;color:#94a3b8;margin:.75rem 0 .35rem;">INCOMING (${incoming.length})</div>
          ${incoming.length ? incoming.map(r => {
            const source = agents.find(a => a.id === r.sourceId);
            return `<div class="relationship-item"><span class="relationship-target" onclick="selectAgent('${r.sourceId}')">${escapeHtml(source?.name || 'Unknown')}</span><span>‚Üí</span><span class="relationship-type">${escapeHtml(r.type || 'message')}</span></div>`;
          }).join('') : '<p style="color:#64748b;font-size:0.85rem;">No incoming relationships</p>'}
        `;
      }

      // Update workspace integrations
      const integrationsContainer = document.getElementById('workspace-integrations-list');
      if (integrationsContainer) {
        const integrations = agent.integrations || [];
        integrationsContainer.innerHTML = `
          <h4>Integrations for ${escapeHtml(agent.name)}</h4>
          ${integrations.length ? integrations.map(i => `
            <div class="integration-item">
              <div class="integration-name">
                <span>${i.icon || 'üîå'}</span>
                <span>${escapeHtml(i.name || i.integration_type || 'Integration')}</span>
                <span class="integration-badge">${escapeHtml(i.type || i.status || 'external')}</span>
              </div>
            </div>
          `).join('') : '<p style="color:#64748b;font-size:0.85rem;">No integrations configured.</p>'}
        `;
      }
      
      // Update workspace capabilities
      const capsEmpty = document.getElementById('capabilities-empty');
      const capsList = document.getElementById('capabilities-list');
      const capsGrid = document.getElementById('capabilities-grid');
      if (capsEmpty && capsList && capsGrid) {
        const capabilities = agent.capabilities || [];
        if (capabilities.length > 0) {
          capsEmpty.style.display = 'none';
          capsList.style.display = 'block';
          capsGrid.innerHTML = capabilities.map(c => `
            <div class="capability-card" style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 0.75rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.25rem;">üì¶</span>
                <span style="color: #22d3ee; font-weight: 500;">${escapeHtml(c.capability_name || c.name || c)}</span>
              </div>
              <div style="font-size: 0.75rem; color: #64748b;">
                Type: ${escapeHtml(c.capability_type || 'action')}
                ${c.is_enabled === false ? ' ‚Ä¢ <span style="color: #f87171;">Disabled</span>' : ''}
              </div>
            </div>
          `).join('');
        } else {
          capsEmpty.style.display = 'block';
          capsList.style.display = 'none';
        }
      }
      
      // Update A2A Card panel
      loadA2ACard(agent.id);
      
      // Update BPMN process list
      renderBpmnProcessList();
    }
    
    // ============================================================================
    // A2A Card Functions
    // ============================================================================
    
    let currentA2ACard = null;
    
    async function loadA2ACard(agentId) {
      const noSelection = document.getElementById('a2a-no-selection');
      const content = document.getElementById('a2a-card-content');
      const codeEl = document.getElementById('a2a-card-code');
      
      if (!agentId) {
        noSelection.style.display = 'block';
        content.style.display = 'none';
        currentA2ACard = null;
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/${agentId}/a2a-card`, { headers: getAuthHeaders() });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        currentA2ACard = await response.json();
        
        // Pretty print with syntax highlighting
        const formatted = JSON.stringify(currentA2ACard, null, 2);
        codeEl.innerHTML = syntaxHighlightJSON(formatted);
        
        noSelection.style.display = 'none';
        content.style.display = 'block';
      } catch (error) {
        console.error('[A2A Card] Load error:', error);
        codeEl.textContent = `Error loading A2A card: ${error.message}`;
        noSelection.style.display = 'none';
        content.style.display = 'block';
        currentA2ACard = null;
      }
    }
    
    function syntaxHighlightJSON(json) {
      return json
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?)/g, (match) => {
          let cls = 'color: #a5d6ff;'; // string
          if (/:$/.test(match)) {
            cls = 'color: #7ee787;'; // key
          }
          return `<span style="${cls}">${match}</span>`;
        })
        .replace(/\b(true|false)\b/g, '<span style="color: #ff7b72;">$1</span>')
        .replace(/\b(null)\b/g, '<span style="color: #ff7b72;">$1</span>')
        .replace(/\b(\d+)\b/g, '<span style="color: #79c0ff;">$1</span>');
    }
    
    function copyA2ACard() {
      if (!currentA2ACard) {
        alert('No A2A card loaded');
        return;
      }
      
      const json = JSON.stringify(currentA2ACard, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        alert('‚úÖ A2A Card copied to clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('‚ùå Failed to copy to clipboard');
      });
    }
    
    function downloadA2ACard() {
      if (!currentA2ACard) {
        alert('No A2A card loaded');
        return;
      }
      
      const json = JSON.stringify(currentA2ACard, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentA2ACard.name?.toLowerCase().replace(/\s+/g, '-') || 'agent'}-a2a-card.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function renderRelationships(agentId) {
      // This updates the Configure tab's interactions section
      renderInteractions(agentId);
      
      // Also update the workspace Relationships tab
      renderWorkspaceRelationships(agentId);
    }
    
    function renderWorkspaceRelationships(agentId) {
      const emptyEl = document.getElementById('relationships-empty');
      const contentEl = document.getElementById('relationships-content');
      const outgoingHeader = document.getElementById('outgoing-header');
      const incomingHeader = document.getElementById('incoming-header');
      const outgoingList = document.getElementById('outgoing-list');
      const incomingList = document.getElementById('incoming-list');
      
      if (!contentEl) return;
      
      const agent = agents.find(a => a.id === agentId);
      if (!agent) {
        if (emptyEl) emptyEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }
      
      if (emptyEl) emptyEl.style.display = 'none';
      contentEl.style.display = 'block';
      
      const outgoing = relationships.filter(r => r.sourceId === agentId);
      const incoming = relationships.filter(r => r.targetId === agentId);
      
      // Update headers
      if (outgoingHeader) outgoingHeader.textContent = `Outgoing ‚Üí (${outgoing.length})`;
      if (incomingHeader) incomingHeader.textContent = `‚Üê Incoming (${incoming.length})`;
      
      const relationTypeColors = {
        'Realization': '#f97316',
        'Flow': '#3b82f6',
        'Association': '#eab308',
        'Composition': '#ec4899',
        'Access': '#ef4444',
        'Serving': '#14b8a6',
        'default': '#64748b'
      };
      
      function renderRelationCard(r, isOutgoing) {
        const otherAgent = isOutgoing 
          ? agents.find(a => a.id === r.targetId)
          : agents.find(a => a.id === r.sourceId);
        const typeColor = relationTypeColors[r.type] || relationTypeColors.default;
        const elementType = otherAgent?.elementType || otherAgent?.type || 'Unknown';
        
        return `
          <div style="background: #1e293b; border-left: 3px solid ${typeColor}; padding: 0.75rem 1rem; border-radius: 4px; cursor: pointer;" 
               onclick="selectAgent('${otherAgent?.id}')" 
               onmouseover="this.style.background='#334155'" 
               onmouseout="this.style.background='#1e293b'">
            <div style="color: ${typeColor}; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(r.type || 'Association')}</div>
            <div style="color: #e2e8f0; font-size: 0.9rem;">${escapeHtml(otherAgent?.name || 'Unknown')} <span style="color: #64748b;">(${elementType})</span></div>
          </div>
        `;
      }
      
      // Render outgoing
      if (outgoingList) {
        outgoingList.innerHTML = outgoing.length === 0 
          ? '<p style="color: #64748b; font-size: 0.85rem; padding: 1rem;">No outgoing relationships</p>'
          : outgoing.map(r => renderRelationCard(r, true)).join('');
      }
      
      // Render incoming
      if (incomingList) {
        incomingList.innerHTML = incoming.length === 0 
          ? '<p style="color: #64748b; font-size: 0.85rem; padding: 1rem;">No incoming relationships</p>'
          : incoming.map(r => renderRelationCard(r, false)).join('');
      }
    }
    
    function renderInteractions(agentId) {
      const container = document.getElementById('interactions-list');
      if (!container) return;

      const relevant = relationships.filter(r => r.sourceId === agentId || r.targetId === agentId);

      if (!relevant.length) {
        container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>No interaction contracts found</p></div>';
        return;
      }

      container.innerHTML = relevant.map((r) => {
        const source = agents.find(a => a.id === r.sourceId);
        const target = agents.find(a => a.id === r.targetId);
        const direction = r.sourceId === agentId ? 'outbound' : 'inbound';
        return `
          <div class="relationship-item" style="display:flex; flex-direction:column; gap:0.25rem;">
            <div style="display:flex; justify-content:space-between; gap:0.5rem;">
              <span class="relationship-type">${escapeHtml(r.type || 'message')}</span>
              <span style="font-size:0.7rem; color:#94a3b8; text-transform:uppercase;">${direction}</span>
            </div>
            <div style="font-size:0.8rem; color:#cbd5e1;">
              ${escapeHtml(source?.name || 'Unknown')} ‚Üí ${escapeHtml(target?.name || 'Unknown')}
            </div>
            ${r.description ? `<div style="font-size:0.75rem; color:#94a3b8;">${escapeHtml(r.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderIntegrations(agent) {
      const container = document.getElementById('integrations-list');
      const integrations = agent.integrations || [];
      
      if (integrations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîå</div>
            <p>No integrations configured</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = integrations.map(int => `
        <div class="integration-item">
          <div class="integration-name">
            <span>${int.icon || 'üîå'}</span>
            <span>${int.name}</span>
            <span class="integration-badge">${int.type}</span>
          </div>
          <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Configure</button>
        </div>
      `).join('');
    }

    function updateVerifyStatus(agent) {
      const statusEl = document.getElementById('verify-status');
      const resultsEl = document.getElementById('verify-results');
      
      const checks = [
        { name: 'Purpose defined', pass: !!agent.purpose },
        { name: 'Pattern selected', pass: !!agent.pattern },
        { name: 'Value stream assigned', pass: !!agent.valueStream },
        { name: 'Has integrations', pass: (agent.integrations || []).length > 0 },
      ];
      
      const passed = checks.filter(c => c.pass).length;
      const total = checks.length;
      
      statusEl.textContent = `${passed}/${total} checks passed`;
      resultsEl.innerHTML = checks.map(c => `
        <div class="relationship-item" style="justify-content: space-between;">
          <span>${escapeHtml(c.name)}</span>
          <span style="color: ${c.pass ? '#10b981' : '#f59e0b'};">${c.pass ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      `).join('');
    }

    function updateDeployStatus(agent) {
      const statusEl = document.getElementById('deploy-status');
      const status = agent.status || 'configured';
      
      const statusMessages = {
        'configured': 'Agent is configured but not yet deployed.',
        'compiled': 'Agent has been compiled and is ready for deployment.',
        'deployed': 'Agent is deployed and running.',
      };
      
      statusEl.textContent = statusMessages[status] || statusMessages.configured;
    }
    
    function generateAgentCode(agent) {
      const code = `# Agent: ${agent.name}
# Type: ${agent.type}
# Pattern: ${agent.pattern || 'general'}

## System Prompt

You are ${agent.name}, an AI agent in the Flowgrid platform.

### Purpose
${agent.purpose || 'No purpose defined'}

### Value Stream
${agent.valueStream || 'Not specified'}

### Capability Group  
${agent.capabilityGroup || 'Not specified'}

### Objectives
${(agent.objectives || ['No objectives defined']).map(o => `- ${o}`).join('\n')}

### Behavior Guidelines
- Follow the ${agent.pattern || 'general'} pattern
- Maintain audit trail of all actions
- Escalate when confidence is low
- Respect rate limits and quotas

### Integration Points
${(agent.integrations || []).map(i => `- ${i.name} (${i.type})`).join('\n') || '- None configured'}
`;
      
      document.getElementById('agent-code').textContent = code;
    }
    
    // ============================================================================
    // Tab Navigation
    // ============================================================================
    
    function showDetailTab(tabName) {
      document.querySelectorAll('#detail-content .detail-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      document.querySelectorAll('#detail-content .tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`)?.classList.add('active');
    }

    function showWorkspaceTab(tabName) {
      document.querySelectorAll('.workspace-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      document.querySelectorAll('.workspace-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(`workspace-${tabName}`)?.classList.add('active');
      
      if (tabName === 'graph' && network) {
        setTimeout(() => network.fit({ animation: { duration: 300 } }), 50);
      }
    }
    
    // ============================================================================
    // CRUD Operations
    // ============================================================================
    
    async function saveAgent() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      // Update from form
      agent.purpose = document.getElementById('agent-purpose').value;
      agent.valueStream = document.getElementById('agent-valuestream').value;
      agent.capabilityGroup = document.getElementById('agent-capgroup').value;
      agent.pattern = document.getElementById('agent-pattern').value;
      agent.objectives = document.getElementById('agent-objectives').value.split('\n').filter(o => o.trim());
      agent.kpis = document.getElementById('agent-kpis').value.split('\n').filter(k => k.trim());
      
      try {
        const response = await fetch(`${API_BASE}/${selectedAgentId}`, {
          method: 'PUT',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(agent),
        });
        
        if (response.ok) {
          showNotification('Agent saved successfully', 'success');
          generateAgentCode(agent);
          updateVerifyStatus(agent);
          updateStats();
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('[saveAgent] Error:', error);
        showNotification('Agent saved (demo mode)', 'success');
        generateAgentCode(agent);
        updateVerifyStatus(agent);
        updateStats();
      }
    }
    
    async function deleteAgent() {
      if (!selectedAgentId) return;
      
      if (!confirm('Are you sure you want to delete this agent?')) return;
      
      try {
        await fetch(`${API_BASE}/${selectedAgentId}`, { method: 'DELETE', headers: getAuthHeaders() });
        agents = agents.filter(a => a.id !== selectedAgentId);
        relationships = relationships.filter(r => r.sourceId !== selectedAgentId && r.targetId !== selectedAgentId);
        selectedAgentId = null;
        renderElementList();
        initGraph();
        updateStats();
        updateDistributionChart();
        document.getElementById('detail-empty').style.display = 'block';
        document.getElementById('detail-content').style.display = 'none';
        showNotification('Agent deleted', 'success');
      } catch (error) {
        console.error('[deleteAgent] Error:', error);
        showNotification('Delete failed (demo mode)', 'error');
      }
    }

    async function deployAgent() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;

      showNotification('Deploying agent...', 'info');
      
      // Simulate deployment
      setTimeout(() => {
        agent.status = 'deployed';
        updateDeployStatus(agent);
        updateStats();
        showNotification('Agent deployed successfully', 'success');
      }, 1500);
    }

    function runVerification() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;

      showNotification('Running verification...', 'info');
      
      setTimeout(() => {
        updateVerifyStatus(agent);
        showNotification('Verification complete', 'success');
      }, 500);
    }
    
    async function addIntegration() {
      if (!selectedAgentId) return;

      try {
        const catalogRes = await fetch('/api/integrations/catalog', { headers: getAuthHeaders() });
        if (!catalogRes.ok) throw new Error(`Catalog HTTP ${catalogRes.status}`);
        const catalogPayload = await catalogRes.json();
        const options = (catalogPayload.integrations || []).filter(i => i.status === 'available');

        if (!options.length) {
          showNotification('No integrations currently available', 'info');
          return;
        }

        const choice = prompt(`Add integration (${options.map(i => i.name).join(', ')})`, options[0].name);
        if (!choice) return;

        const putRes = await fetch(`/api/integrations/agent/${selectedAgentId}/${encodeURIComponent(choice)}`, {
          method: 'PUT',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ status: 'pending', config: {} }),
        });

        if (!putRes.ok) throw new Error(`Save HTTP ${putRes.status}`);

        const agent = agents.find(a => a.id === selectedAgentId);
        if (agent) {
          agent.integrations = Array.isArray(agent.integrations) ? agent.integrations : [];
          if (!agent.integrations.some(i => i.name === choice)) {
            agent.integrations.push({ name: choice, type: 'external', icon: 'üîå' });
          }
          renderIntegrations(agent);
          updateVerifyStatus(agent);
        }

        showNotification(`Integration '${choice}' added`, 'success');
      } catch (error) {
        console.error('[addIntegration] Error:', error);
        showNotification('Failed to add integration', 'error');
      }
    }
    
    async function generateCode() {
      if (!selectedAgentId) return;

      try {
        const response = await fetch(`/api/design/generate-code/${selectedAgentId}`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ language: 'typescript', framework: 'express' }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const payload = await response.json();
        document.getElementById('agent-code').textContent = payload.code || '// No code generated';
        showNotification('Code generated successfully', 'success');
      } catch (error) {
        console.error('[generateCode] Error:', error);
        showNotification('AI code generation failed', 'error');
      }
    }

    async function refreshData() {
      await init();
      showNotification('Data refreshed', 'success');
    }

    async function createAgent() {
      const name = prompt('New agent name');
      if (!name) return;

      try {
        const response = await fetch(`${API_BASE}`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ name, type: 'Agent', description: '' }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        await loadAgents();
        updateStats();
        updateDistributionChart();
        initGraph();

        const created = agents.find(a => a.name === name) || agents[0];
        if (created) selectAgent(created.id);

        showNotification('Agent created', 'success');
      } catch (error) {
        console.error('[createAgent] Error:', error);
        showNotification('Failed to create agent', 'error');
      }
    }
    
    async function exportDesignBundle() {
      try {
        const response = await fetch(`${API_BASE}/design/export`, { headers: getAuthHeaders() });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const payload = await response.json();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `flowgrid-design-export-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);

        showNotification('Design export downloaded', 'success');
      } catch (error) {
        console.error('[exportDesignBundle] Error:', error);
        showNotification('Failed to export design bundle', 'error');
      }
    }

    function triggerImportDesignBundle() {
      const input = document.getElementById('design-import-input');
      if (!input) return;
      input.value = '';
      input.click();
    }

    async function importDesignBundle(file) {
      if (!file) return;
      try {
        const text = await file.text();
        const payload = JSON.parse(text);

        const response = await fetch(`${API_BASE}/design/import`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        await init();
        showNotification(`Import complete: ${result?.imported?.agentsCreated || 0} created, ${result?.imported?.agentsUpdated || 0} updated`, 'success');
      } catch (error) {
        console.error('[importDesignBundle] Error:', error);
        showNotification('Failed to import design bundle', 'error');
      }
    }

    function copyCode() {
      const code = document.getElementById('agent-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showNotification('Code copied to clipboard', 'success');
      });
    }
    
    // ============================================================================
    // UI Utilities
    // ============================================================================
    
    function updateStats() {
      const agentsList = agents.filter(a => a.type === 'Agent');
      const agentsCount = agentsList.length;
      const elementCount = agents.length;
      
      // Header stats
      document.getElementById('stat-elements').textContent = String(elementCount);
      document.getElementById('stat-agents').textContent = String(agentsCount);
      document.getElementById('stat-relationships').textContent = String(relationships.length);

      // Progress counters
      const configured = agentsList.filter(a => a.purpose || a.pattern).length;
      const compiled = agentsList.filter(a => a.status === 'compiled' || a.status === 'deployed').length;
      const deployed = agentsList.filter(a => a.status === 'deployed').length;
      
      document.getElementById('progress-configured').textContent = String(configured);
      document.getElementById('progress-compiled').textContent = String(compiled);
      document.getElementById('progress-deployed').textContent = String(deployed);
      
      // Progress bar
      const deployedPct = agentsCount > 0 ? Math.round((deployed / agentsCount) * 100) : 0;
      document.getElementById('progress-percentage').textContent = `${deployedPct}%`;
      document.getElementById('progress-bar-fill').style.width = `${deployedPct}%`;
      
      // Progress stats
      const withPurpose = agentsList.filter(a => a.purpose).length;
      const withDesign = agentsList.filter(a => a.pattern && a.capabilityGroup).length;
      
      document.getElementById('stat-total-agents').textContent = String(agentsCount);
      document.getElementById('stat-with-purpose').textContent = String(withPurpose);
      document.getElementById('stat-with-design').textContent = String(withDesign);

      // Workspace agents list
      const roster = document.getElementById('workspace-agents-list');
      if (roster) roster.textContent = agents.map(a => a.name).slice(0, 10).join(' ‚Ä¢ ') || 'No agents yet';
    }
    
    function showNotification(message, type = 'info') {
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6',
      };
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: ${colors[type]};
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    function showError(message) {
      const container = document.getElementById('element-list');
      container.innerHTML = `
        <div class="empty-state">
          <div class="icon">‚ö†Ô∏è</div>
          <p style="color: #ef4444;">${escapeHtml(message)}</p>
          <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="init()">Retry</button>
        </div>
      `;
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ============================================================================
    // Event Listeners
    // ============================================================================
    
    // Search input removed
    // Filter dropdown removed
    document.getElementById('design-import-input').addEventListener('change', (event) => {
      const file = event?.target?.files?.[0];
      if (file) importDesignBundle(file);
    });
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.FlowgridAuthUI?.initPage) {
        window.FlowgridAuthUI.initPage({ requireAuth: true, showSignOut: false });
      } else {
        console.warn('[design-studio] auth-ui.js not loaded; continuing with local token fallback');
      }

      init();
    });
    
    // CSS Animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    `;
    document.head.appendChild(style);

    // ============================================================================
    // BPMN Integration (Per-Process)
    // ============================================================================
    
    let bpmnModeler = null;
    let currentBpmnXml = null;
    let selectedProcessId = null;

    function escapeXml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }

    // Populate the process list in BPMN tab
    function renderBpmnProcessList() {
      const listEl = document.getElementById('bpmn-process-list');
      if (!listEl) return;
      
      // Show both Process elements AND agents with process steps
      const processes = agents.filter(a => a.elementType === 'Process');
      const agentsWithProcesses = agents.filter(a => 
        a.elementType !== 'Process' && 
        (a.config?.processSteps || a.config?.decisionPoints)
      );
      const allProcessItems = [...processes, ...agentsWithProcesses];
      
      if (allProcessItems.length === 0) {
        // Show the selected agent if it has no process steps
        const selectedAgent = agents.find(a => a.id === selectedAgentId);
        if (selectedAgent) {
          listEl.innerHTML = `
            <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
              <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.25rem;">${escapeHtml(selectedAgent.name)}</div>
              <div style="color: #64748b; font-size: 0.75rem;">No process flow defined</div>
              <button class="btn btn-primary" onclick="generateBpmnForAgent('${selectedAgent.id}')" style="margin-top: 0.5rem; font-size: 0.75rem;">üîÑ Generate Process Flow</button>
            </div>
          `;
        } else {
          listEl.innerHTML = '<p style="color: #64748b; font-size: 0.85rem;">Select an agent to view or generate its process flow.</p>';
        }
        return;
      }
      
      listEl.innerHTML = allProcessItems.map(p => `
        <div class="bpmn-process-item" 
             data-id="${p.id}" 
             onclick="selectBpmnProcess('${p.id}')"
             style="padding: 0.75rem; background: ${selectedProcessId === p.id ? '#334155' : '#0f172a'}; border-radius: 6px; cursor: pointer; border-left: 3px solid ${selectedProcessId === p.id ? '#f59e0b' : 'transparent'};"
             onmouseover="if(selectedProcessId !== '${p.id}') this.style.background='#1e293b'"
             onmouseout="if(selectedProcessId !== '${p.id}') this.style.background='#0f172a'">
          <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.25rem;">${escapeHtml(p.name)}</div>
          <div style="color: #64748b; font-size: 0.75rem;">
            ${p.elementType === 'Process' ? 'üîÑ Process' : 'ü§ñ Agent'}
            ${p.config?.processSteps ? ' ‚Ä¢ ‚úÖ Has flow' : ' ‚Ä¢ ‚ö†Ô∏è No flow'}
          </div>
        </div>
      `).join('');
    }
    
    // Store generated BPMN XML per agent
    const agentBpmnCache = {};
    
    // Generate BPMN for an agent that doesn't have process steps
    async function generateBpmnForAgent(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      // Set as selected process so Save works
      selectedProcessId = agentId;
      
      // Show loading state
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Generating...';
      }
      
      try {
        const response = await fetch('/api/wizard/generate-bpmn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({
            processId: agent.id,
            processName: agent.name,
            processDescription: agent.purpose || agent.description || '',
            capabilities: agent.capabilities?.map(c => c.capability_name || c.name || c) || [],
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          const bpmnXml = result.data?.bpmnXml;
          
          if (bpmnXml) {
            // Cache the BPMN XML
            agentBpmnCache[agentId] = bpmnXml;
            agent.config = agent.config || {};
            agent.config.bpmnXml = bpmnXml;
            agent.config.processSteps = result.data?.summary || 'Generated';
            
            // Save to database
            await saveBpmnToAgent(agentId, bpmnXml, result.data?.summary);
            
            // Display in canvas
            renderBpmnProcessList();
            await displayBpmnXml(bpmnXml, agent.name);
            
            if (btn) {
              btn.innerHTML = '‚úÖ Saved!';
              setTimeout(() => { btn.innerHTML = 'üîÑ Regenerate'; btn.disabled = false; }, 2000);
            }
          } else {
            throw new Error('No BPMN XML in response');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        console.error('Failed to generate BPMN:', err);
        if (btn) {
          btn.innerHTML = '‚ùå Failed';
          setTimeout(() => { btn.innerHTML = 'üîÑ Generate Process Flow'; btn.disabled = false; }, 2000);
        }
      }
    }
    
    // Import BPMN file
    async function importBPMNFile(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      
      if (!selectedProcessId) {
        alert('Please select an agent first');
        event.target.value = '';
        return;
      }
      
      try {
        const bpmnXml = await file.text();
        
        // Validate it's valid XML
        if (!bpmnXml.includes('bpmn:definitions') && !bpmnXml.includes('definitions')) {
          alert('Invalid BPMN file. Please select a valid .bpmn or .xml file.');
          event.target.value = '';
          return;
        }
        
        // Display in canvas
        await displayBpmnXml(bpmnXml, agents.find(a => a.id === selectedProcessId)?.name || 'Imported');
        
        // Cache it (not auto-saved - user can click Save)
        agentBpmnCache[selectedProcessId] = bpmnXml;
        
        // Flash the save button to indicate unsaved changes
        const saveBtn = document.getElementById('bpmn-save-btn');
        if (saveBtn) {
          saveBtn.style.animation = 'pulse 1s ease-in-out 3';
          saveBtn.innerHTML = 'üíæ Save*';
        }
        
        console.log('[BPMN] Imported from file:', file.name);
      } catch (err) {
        console.error('Failed to import BPMN:', err);
        alert('Failed to import BPMN file: ' + err.message);
      }
      
      // Reset file input
      event.target.value = '';
    }
    
    // Save current BPMN from editor to database
    async function saveCurrentBPMN() {
      const processId = selectedProcessId || selectedAgentId;
      if (!processId || !window.bpmnViewer) {
        alert('No BPMN to save');
        return;
      }
      
      const btn = document.getElementById('bpmn-save-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Saving...';
      }
      
      try {
        // Export current BPMN XML from the editor
        const { xml } = await window.bpmnViewer.saveXML({ format: true });
        
        if (xml) {
          await saveBpmnToAgent(processId, xml, 'User edited');
          agentBpmnCache[processId] = xml;
          
          const agent = agents.find(a => a.id === processId);
          if (agent) {
            agent.config = agent.config || {};
            agent.config.bpmnXml = xml;
          }
          
          if (btn) {
            btn.innerHTML = '‚úÖ Saved!';
            setTimeout(() => { btn.innerHTML = 'üíæ Save'; btn.disabled = false; }, 2000);
          }
        }
      } catch (err) {
        console.error('Failed to save BPMN:', err);
        if (btn) {
          btn.innerHTML = '‚ùå Failed';
          setTimeout(() => { btn.innerHTML = 'üíæ Save'; btn.disabled = false; }, 2000);
        }
      }
    }
    
    // Save BPMN to agent in database
    async function saveBpmnToAgent(agentId, bpmnXml, summary) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      try {
        // Merge BPMN into existing config
        const updatedConfig = {
          ...(agent.config || {}),
          bpmnXml: bpmnXml,
          processSteps: summary || 'Generated',
          bpmnGeneratedAt: new Date().toISOString(),
        };
        
        const response = await fetch(`${API_BASE}/${agentId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({ config: updatedConfig })
        });
        
        if (!response.ok) {
          console.warn('Failed to save BPMN to database:', response.status);
        } else {
          console.log('[BPMN] Saved to database for agent:', agentId);
        }
      } catch (err) {
        console.error('Failed to save BPMN:', err);
      }
    }
    
    // Display BPMN XML in the canvas using bpmn-js
    async function displayBpmnXml(bpmnXml, processName) {
      const canvas = document.getElementById('bpmn-canvas-main');
      const emptyState = document.getElementById('bpmn-empty-state');
      
      if (!canvas) return;
      
      emptyState.style.display = 'none';
      canvas.style.display = 'block';
      document.getElementById('bpmn-process-title').textContent = `üìä ${processName}`;
      document.getElementById('bpmn-actions').style.display = 'flex';
      
      // Initialize or reuse bpmn-js viewer
      if (!window.bpmnViewer) {
        if (typeof BpmnJS === 'undefined') {
          canvas.innerHTML = '<pre style="padding:1rem;color:#94a3b8;font-size:0.75rem;overflow:auto;max-height:400px;">' + escapeHtml(bpmnXml) + '</pre>';
          return;
        }
        window.bpmnViewer = new BpmnJS({ container: canvas });
      }
      
      try {
        await window.bpmnViewer.importXML(bpmnXml);
        window.bpmnViewer.get('canvas').zoom('fit-viewport');
      } catch (err) {
        console.error('BPMN render error:', err);
        canvas.innerHTML = '<div style="padding:1rem;color:#f87171;">Failed to render BPMN: ' + escapeHtml(err.message) + '</div>';
      }
    }

    // Select a process to show in BPMN canvas
    async function selectBpmnProcess(processId) {
      selectedProcessId = processId;
      const process = agents.find(a => a.id === processId);
      
      if (!process) return;
      
      // Update UI
      renderBpmnProcessList();
      document.getElementById('bpmn-process-desc').textContent = process.description || process.purpose || 'Process workflow diagram';
      
      // Check if we have cached BPMN XML
      const cachedBpmn = agentBpmnCache[processId] || process.config?.bpmnXml;
      
      if (cachedBpmn) {
        await displayBpmnXml(cachedBpmn, process.name);
      } else if (process.config?.processSteps && process.config.processSteps !== 'Generated') {
        // Generate from existing process steps
        await generateProcessBPMN(process);
      } else {
        // No BPMN - show generate button
        document.getElementById('bpmn-empty-state').style.display = 'flex';
        document.getElementById('bpmn-canvas-main').style.display = 'none';
        document.getElementById('bpmn-process-title').textContent = `üìä ${process.name}`;
        document.getElementById('bpmn-empty-state').innerHTML = `
          <div style="text-align: center; color: #64748b;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
            <p style="margin-bottom: 1rem;">No process flow defined for this agent</p>
            <button class="btn btn-primary" onclick="generateBpmnForAgent('${processId}')">üîÑ Generate Process Flow</button>
          </div>
        `;
      }
    }

    // Convert a single process to BPMN based on its processSteps/decisionPoints
    function convertProcessToBPMN(process) {
      const config = process.config || {};
      const processSteps = config.processSteps || '';
      const decisionPoints = config.decisionPoints || '';
      
      // Parse steps (split by newlines or numbered items)
      const stepLines = processSteps.split(/\n|(?=\d+\.)/).filter(s => s.trim());
      const steps = stepLines.map((s, i) => ({
        id: `Task_${i + 1}`,
        name: s.replace(/^\d+\.\s*/, '').trim().substring(0, 50)
      })).filter(s => s.name);
      
      // Parse decision points
      const decisionLines = decisionPoints.split(/\n|(?=\d+\.)/).filter(s => s.trim());
      const decisions = decisionLines.map((d, i) => ({
        id: `Gateway_${i + 1}`,
        name: d.replace(/^\d+\.\s*/, '').trim().substring(0, 30)
      })).filter(d => d.name);
      
      // If no steps defined, create a simple placeholder
      if (steps.length === 0) {
        steps.push({ id: 'Task_1', name: process.name });
      }

      // Build BPMN tasks
      const tasks = steps.map(s => 
        `    <bpmn:serviceTask id="${s.id}" name="${escapeXml(s.name)}" />`
      ).join('\n');
      
      // Build gateways for decisions
      const gateways = decisions.map(d =>
        `    <bpmn:exclusiveGateway id="${d.id}" name="${escapeXml(d.name)}" />`
      ).join('\n');

      // Build sequential flows between steps
      const flows = [];
      flows.push(`    <bpmn:sequenceFlow id="Flow_start" sourceRef="StartEvent_1" targetRef="${steps[0]?.id || 'EndEvent_1'}" />`);
      
      for (let i = 0; i < steps.length - 1; i++) {
        flows.push(`    <bpmn:sequenceFlow id="Flow_${i + 1}" sourceRef="${steps[i].id}" targetRef="${steps[i + 1].id}" />`);
      }
      
      if (steps.length > 0) {
        flows.push(`    <bpmn:sequenceFlow id="Flow_end" sourceRef="${steps[steps.length - 1].id}" targetRef="EndEvent_1" />`);
      }

      // Build shapes for visual layout
      const stepShapes = steps.map((s, i) => `      <bpmndi:BPMNShape id="${s.id}_di" bpmnElement="${s.id}">
        <dc:Bounds x="${250 + i * 160}" y="80" width="120" height="80" />
      </bpmndi:BPMNShape>`).join('\n');
      
      const gatewayShapes = decisions.map((d, i) => `      <bpmndi:BPMNShape id="${d.id}_di" bpmnElement="${d.id}">
        <dc:Bounds x="${250 + i * 160}" y="200" width="50" height="50" />
      </bpmndi:BPMNShape>`).join('\n');

      return `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Definitions_${process.id}" 
                  targetNamespace="http://flowgrid.io/bpmn">
  <bpmn:process id="Process_${process.id.substring(0, 8)}" name="${escapeXml(process.name)}" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="Start" />
    <bpmn:endEvent id="EndEvent_1" name="End" />
${tasks}
${gateways}
${flows.join('\n')}
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_${process.id.substring(0, 8)}">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="${300 + steps.length * 160}" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
${stepShapes}
${gatewayShapes}
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
    }

    async function generateProcessBPMN(process) {
      const container = document.getElementById('bpmn-canvas-main');
      if (!container) return;

      try {
        currentBpmnXml = convertProcessToBPMN(process);
        
        if (!bpmnModeler) {
          bpmnModeler = new BpmnJS({ container });
        }

        await bpmnModeler.importXML(currentBpmnXml);
        bpmnModeler.get('canvas').zoom('fit-viewport');
        
        // Update stats
        const statsEl = document.getElementById('bpmn-stats');
        const taskCount = (currentBpmnXml.match(/<bpmn:(service|user)Task/g) || []).length;
        const gatewayCount = (currentBpmnXml.match(/<bpmn:exclusiveGateway/g) || []).length;
        if (statsEl) statsEl.textContent = `${taskCount} tasks ‚Ä¢ ${gatewayCount} gateways`;
        
      } catch (err) {
        console.error('BPMN render error:', err);
        container.innerHTML = `<div style="padding: 2rem; color: #ef4444;">Error rendering BPMN: ${err.message}</div>`;
      }
    }

    async function regenerateProcessBPMN() {
      if (!selectedProcessId) return;
      const process = agents.find(a => a.id === selectedProcessId);
      if (process) {
        await generateProcessBPMN(process);
        showNotification('BPMN regenerated', 'success');
      }
    }

    function exportProcessBPMN() {
      if (!currentBpmnXml || !selectedProcessId) {
        showNotification('Select a process first', 'warning');
        return;
      }
      
      const process = agents.find(a => a.id === selectedProcessId);
      const filename = (process?.name || 'process').toLowerCase().replace(/\s+/g, '-') + '.bpmn';
      
      const blob = new Blob([currentBpmnXml], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      showNotification(`Exported ${filename}`, 'success');
    }

    // Render process list when BPMN tab is shown
    const originalShowWorkspaceTab = window.showWorkspaceTab;
    window.showWorkspaceTab = function(tabName) {
      if (originalShowWorkspaceTab) originalShowWorkspaceTab(tabName);
      if (tabName === 'bpmn') {
        renderBpmnProcessList();
      }
    };
  </script>
</body>
</html>
