<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>‚ö° Flowgrid Design - Flowgrid Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/bpmn-js@17/dist/bpmn-modeler.development.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/diagram-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/bpmn-js.css">
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17/dist/assets/bpmn-font/css/bpmn-embedded.css">
  <style>
    /* BPMN Custom Color Scheme - Light Blue */
    .bjs-container .djs-visual > * {
      stroke: #60a5fa !important;
    }
    .bjs-container .djs-visual text,
    .bjs-container .djs-visual text tspan,
    .bjs-container .djs-label {
      fill: #60a5fa !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      font-weight: 400 !important;
      font-size: 12px !important;
    }
    .bjs-container .djs-visual path,
    .bjs-container .djs-visual rect,
    .bjs-container .djs-visual circle,
    .bjs-container .djs-visual polygon {
      stroke: #60a5fa !important;
      fill: transparent !important;
    }
    .bjs-container .djs-visual .djs-hit {
      stroke: transparent !important;
      fill: transparent !important;
    }
    .bjs-container .djs-connection .djs-visual path {
      stroke: #60a5fa !important;
      marker-end: url(#sequenceflow-end-white-hsl-225-10-15);
    }
    /* Markers/arrows */
    .bjs-container marker path {
      fill: #60a5fa !important;
      stroke: #60a5fa !important;
    }
    /* Selection and hover */
    .bjs-container .djs-outline {
      stroke: #f59e0b !important;
    }
    /* Palette icons */
    .bjs-container .djs-palette .entry:hover {
      color: #60a5fa;
    }
    /* Canvas background */
    .bjs-container {
      background: #ffffff !important;
    }
    .bjs-container .djs-palette {
      background: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
    }
    .bjs-container .djs-palette .entry {
      color: #000000 !important;
    }
    .bjs-container .djs-palette .entry:hover {
      color: #60a5fa !important;
    }
    .bjs-container .djs-palette .entry img,
    .bjs-container .djs-palette .entry svg {
      filter: invert(0) !important;
    }
    /* BPMN diagram elements - force black text */
    .bjs-container svg text,
    .bjs-container svg tspan,
    .bjs-container .djs-group text,
    .bjs-container .djs-group tspan,
    .bjs-container .djs-element text,
    .bjs-container .djs-element tspan,
    .bjs-container .djs-visual text,
    .bjs-container .djs-visual tspan,
    .bjs-container .djs-label text,
    .bjs-container .djs-label tspan,
    #bpmn-canvas-main text,
    #bpmn-canvas-main tspan {
      fill: #000000 !important;
      stroke: none !important;
    }
    .bjs-container .djs-direct-editing-content,
    .bjs-container .djs-direct-editing-content * {
      color: #000000 !important;
    }
    /* BPMN shapes - black strokes */
    .bjs-container .djs-element .djs-visual path,
    .bjs-container .djs-element .djs-visual circle,
    .bjs-container .djs-element .djs-visual rect,
    .bjs-container .djs-element .djs-visual polygon {
      stroke: #000000 !important;
    }
  </style>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* Tag Input */
    .tag-input-container {
      display: flex; flex-wrap: wrap; gap: 0.25rem; padding: 0.35rem;
      border: 1px solid #334155; border-radius: 6px; background: #0f172a; min-height: 36px; align-items: center;
    }
    .tag-input-container .tag-item {
      display: inline-flex; align-items: center; gap: 0.25rem;
      background: #1e40af; color: #93c5fd; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem;
    }
    .tag-input-container .tag-item .tag-remove {
      cursor: pointer; font-size: 0.65rem; opacity: 0.7; margin-left: 0.15rem;
    }
    .tag-input-container .tag-item .tag-remove:hover { opacity: 1; }
    .tag-input-container .tag-input {
      border: none; background: transparent; color: #e2e8f0; outline: none;
      flex: 1; min-width: 80px; padding: 0.15rem; font-size: 0.8rem;
    }
    .tag-suggestions {
      background: #1e293b; border: 1px solid #334155; border-radius: 4px; margin-top: 0.25rem; max-height: 120px; overflow-y: auto;
    }
    .tag-suggestions .suggestion-item {
      padding: 0.35rem 0.5rem; font-size: 0.8rem; cursor: pointer; color: #94a3b8;
    }
    .tag-suggestions .suggestion-item:hover { background: #334155; color: #e2e8f0; }
    
    /* Manifest validation bar */
    .manifest-valid { background: #064e3b; color: #34d399; }
    .manifest-invalid { background: #7f1d1d; color: #fca5a5; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: #0f172a; 
      color: #e2e8f0; 
    }
    
    /* Header */
    .header { 
      background: #1e293b; 
      padding: 0.75rem 1.5rem; 
      border-bottom: 1px solid #334155; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    .header h1 { 
      font-size: 1.25rem; 
      color: #f59e0b; 
      display: flex; 
      align-items: center; 
      gap: 0.5rem;
    }
    .header .nav-links {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .header .nav-link {
      color: #94a3b8;
      text-decoration: none;
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .header .nav-link:hover { background: #334155; color: #e2e8f0; }
    .header .stats { 
      display: flex; 
      gap: 1.5rem; 
      font-size: 0.85rem; 
      color: #94a3b8; 
    }
    .header .stat { text-align: center; }
    .header .stat-value { 
      font-size: 1.25rem; 
      font-weight: bold; 
      color: #f1f5f9; 
    }
    
    /* Main Layout */
    .container { 
      display: flex; 
      height: calc(100vh - 56px); 
    }
    
    /* Sidebar */
    .sidebar { 
      background: #1e293b; 
      border-right: 1px solid #334155; 
      overflow-y: auto; 
      width: 280px; 
      min-width: 200px; 
      max-width: 400px; 
      flex-shrink: 0; 
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .sidebar-section { 
      padding: 1rem; 
      border-bottom: 1px solid #334155; 
    }
    .sidebar-section h3 { 
      font-size: 0.8rem; 
      color: #94a3b8; 
      margin-bottom: 0.5rem; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
    }
    .sidebar-section.elements-section {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    
    /* Search & Filters */
    input, select { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #334155; 
      border-radius: 6px; 
      background: #0f172a; 
      color: #e2e8f0; 
      margin-bottom: 0.5rem; 
      font-size: 0.85rem;
    }
    input:focus, select:focus { 
      outline: none; 
      border-color: #60a5fa; 
    }
    
    /* Element List */
    .element-list { 
      flex: 1;
      overflow-y: auto; 
    }
    .element-item { 
      padding: 0.6rem 0.75rem; 
      cursor: pointer; 
      border-radius: 6px; 
      margin-bottom: 2px; 
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      transition: all 0.15s;
    }
    .element-item:hover { background: #334155; }
    .element-item.selected { background: #3b82f6; }
    .element-name { font-weight: 500; }
    .element-type { 
      font-size: 0.7rem; 
      color: #94a3b8; 
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .element-item.selected .element-type { color: #bfdbfe; }

    /* Progress Section - Legacy Style */
    .progress-section {
      padding: 1rem;
      background: #1e293b;
    }
    .progress-section h3 {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .progress-counters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .progress-counter {
      flex: 1;
      background: #0f172a;
      border-radius: 6px;
      padding: 0.5rem;
      text-align: center;
    }
    .progress-counter-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #f1f5f9;
    }
    .progress-counter-label {
      font-size: 0.65rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .progress-counter.configured .progress-counter-value { color: #60a5fa; }
    .progress-counter.compiled .progress-counter-value { color: #a78bfa; }
    .progress-counter.deployed .progress-counter-value { color: #10b981; }
    
    .progress-bar-container {
      margin-bottom: 0.75rem;
    }
    .progress-bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .progress-bar {
      height: 6px;
      background: #334155;
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    
    .progress-stats {
      font-size: 0.75rem;
      color: #64748b;
    }
    .progress-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.2rem 0;
    }
    .progress-stat-value {
      color: #94a3b8;
    }
    
    /* Main Content */
    .main-content { 
      flex: 1; 
      min-width: 300px; 
      position: relative; 
      padding: 1rem; 
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
    }
    
    /* Agent Explore Header */
    .agent-explore-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .agent-explore-header h2 {
      font-size: 1rem;
      color: #60a5fa;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Graph Legend - Legacy Style */
    .graph-legend-container {
      background: #1e293b;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }
    .legend-row:last-of-type { margin-bottom: 0; }
    .legend-label {
      font-size: 0.7rem;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      min-width: 65px;
    }
    .legend-item { 
      display: flex; 
      align-items: center; 
      gap: 0.3rem; 
      font-size: 0.75rem; 
      color: #94a3b8; 
      cursor: pointer; 
      padding: 0.2rem 0.4rem; 
      border-radius: 3px; 
      transition: all 0.2s; 
    }
    .legend-item:hover { background: #334155; }
    .legend-item.disabled { opacity: 0.4; text-decoration: line-through; }
    .legend-color { 
      width: 12px; 
      height: 12px; 
      border-radius: 3px; 
    }
    .legend-line {
      width: 20px;
      height: 3px;
      border-radius: 1px;
    }
    .legend-stats {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid #334155;
    }
    
    /* Graph Container */
    .graph-container { 
      flex: 1;
      min-height: 400px; 
      background: #0f172a; 
      border-radius: 8px; 
      border: 1px solid #334155;
      position: relative;
    }

    .graph-state-overlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.82);
      border-radius: 8px;
      z-index: 10;
      text-align: center;
      padding: 1rem;
    }
    .graph-state-overlay.active { display: flex; }
    .graph-state-card { max-width: 420px; }
    .graph-state-icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .graph-state-title { font-size: 1rem; color: #f1f5f9; margin-bottom: 0.35rem; }
    .graph-state-message { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; }

    /* Interaction Legend */
    .interaction-legend {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
    }
    .interaction-legend-title {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    .interaction-legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    /* Overview Panel - Legacy Style */
    .overview-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }
    .select-element-card {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #334155;
    }
    .select-element-card h3 {
      color: #10b981;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .select-element-card p {
      color: #94a3b8;
      font-size: 0.85rem;
    }
    
    .element-distribution-card {
      background: #1e293b;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #334155;
      flex: 1;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }
    .element-distribution-card h3 {
      color: #10b981;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .distribution-chart-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2rem;
      flex: 1;
    }
    .chart-wrapper {
      width: 220px;
      height: 220px;
      position: relative;
    }
    .chart-legend {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #cbd5e1;
    }
    .chart-legend-color {
      width: 16px;
      height: 12px;
      border-radius: 2px;
    }
    
    /* Detail Panel */
    .detail-panel { 
      background: #1e293b; 
      border-left: 1px solid #334155; 
      padding: 1rem; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      width: 420px; 
      min-width: 350px; 
      max-width: 600px; 
      flex-shrink: 0; 
      position: relative; 
    }
    .detail-panel h2 { 
      font-size: 1.1rem; 
      color: #60a5fa; 
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #334155;
      padding-bottom: 0.5rem;
    }
    .detail-panel .agent-type {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .detail-panel .agent-type .badge {
      background: #3b82f6;
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
    }
    
    /* Enhanced Form Styling */
    .detail-panel .form-group { margin-bottom: 1rem; }
    .detail-panel .form-group label {
      display: block;
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-panel .form-group input,
    .detail-panel .form-group textarea,
    .detail-panel .form-group select {
      width: 100%;
      padding: 0.6rem 0.75rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 0.85rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .detail-panel .form-group input:focus,
    .detail-panel .form-group textarea:focus,
    .detail-panel .form-group select:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }
    .detail-panel .form-group textarea { resize: vertical; min-height: 60px; }
    .detail-panel .form-group select {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      cursor: pointer;
    }
    .detail-panel .form-group select:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e3a5f 100%);
    }
    
    /* Section Headers */
    .detail-panel .section-header {
      color: #f59e0b;
      font-size: 0.85rem;
      font-weight: 600;
      margin: 1.25rem 0 0.75rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .detail-panel .section-header:first-child { margin-top: 0; }
    
    /* Info Cards */
    .detail-panel .info-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .detail-panel .info-card h4 {
      color: #60a5fa;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .detail-panel .info-card p {
      color: #94a3b8;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    
    /* Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-badge.success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .status-badge.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .status-badge.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .status-badge.info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    
    /* Code Container */
    .detail-panel .code-container {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 1rem;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .detail-panel .code-container pre {
      margin: 0;
      font-family: 'Fira Code', 'Monaco', monospace;
      font-size: 0.75rem;
      color: #e2e8f0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    /* Detail Tabs - Legacy Style */
    .detail-tabs { 
      display: flex; 
      gap: 0.15rem; 
      margin-bottom: 1rem; 
      border-bottom: 1px solid #334155; 
      padding-bottom: 0.5rem; 
      flex-wrap: wrap; 
    }
    .detail-tab { 
      padding: 0.4rem 0.6rem; 
      background: transparent; 
      border-radius: 4px 4px 0 0; 
      cursor: pointer; 
      font-size: 0.75rem; 
      color: #94a3b8; 
      border: 1px solid transparent; 
      white-space: nowrap; 
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .detail-tab:hover { color: #e2e8f0; background: #334155; }
    .detail-tab.active { 
      background: #3b82f6; 
      color: white; 
      border-color: #3b82f6; 
    }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Form Styles */
    .form-group { margin-bottom: 0.75rem; }
    .form-group label { 
      display: block; 
      color: #94a3b8; 
      font-size: 0.75rem; 
      margin-bottom: 0.25rem; 
      text-transform: uppercase; 
      letter-spacing: 0.5px; 
    }
    .form-group textarea { 
      width: 100%; 
      padding: 0.5rem; 
      border: 1px solid #334155; 
      border-radius: 6px; 
      background: #0f172a; 
      color: #e2e8f0; 
      font-size: 0.85rem; 
      font-family: inherit;
      min-height: 80px;
      resize: vertical;
    }
    .form-group textarea:focus { outline: none; border-color: #60a5fa; }
    
    /* Buttons */
    .btn { 
      padding: 0.5rem 1rem; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: 500; 
      font-size: 0.85rem;
      transition: all 0.2s; 
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-secondary { background: #334155; color: #e2e8f0; }
    .btn-secondary:hover { background: #475569; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    
    /* Cards */
    .info-card {
      background: #0f172a;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    .info-card h4 {
      color: #60a5fa;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    .info-card p {
      color: #cbd5e1;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    
    /* Relationship List */
    .relationship-item {
      background: #0f172a;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }
    .relationship-type {
      background: #334155;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: #94a3b8;
    }
    .relationship-target {
      color: #60a5fa;
      cursor: pointer;
    }
    .relationship-target:hover { text-decoration: underline; }
    
    /* Code View */
    .code-container pre {
      background: #0f172a;
      padding: 1rem;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      color: #e2e8f0;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }
    
    /* Integration List */
    .integration-item {
      background: #0f172a;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .integration-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .integration-badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      background: #334155;
      color: #94a3b8;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #64748b;
    }
    .empty-state .icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }
    
    /* Resize Handle */
    .resize-handle { 
      width: 4px; 
      background: transparent; 
      cursor: col-resize; 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      z-index: 10; 
      transition: background 0.2s; 
    }
    .resize-handle:hover, .resize-handle.active { background: #3b82f6; }
    .sidebar .resize-handle { right: 0; }
    .detail-panel .resize-handle { left: 0; }
    
    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #64748b;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .workspace-panel { display: none; }
    .workspace-panel.active { display: flex; flex-direction: column; gap: 0.75rem; min-height: 0; flex: 1; }
    .legacy-header { gap: 1rem; }

    @media (max-width: 1400px) {
      .detail-panel { width: 360px; min-width: 320px; }
      .sidebar { width: 240px; }
    }

    @media (max-width: 1080px) {
      .container { flex-direction: column; height: auto; }
      .sidebar, .detail-panel { width: 100%; min-width: 0; max-width: none; border: 0; border-top: 1px solid #334155; }
      .main-content { min-height: 55vh; }
      .resize-handle { display: none; }
      .header { flex-wrap: wrap; }
      .distribution-chart-container { flex-direction: column; }
    }

    /* Agent Config Modal */
    #agent-config-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      overflow-y: auto;
      padding: 2rem;
    }
    #agent-config-modal .modal-content {
      max-width: 600px;
      margin: 0 auto;
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #334155;
    }
    #agent-config-modal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #334155;
    }
    #agent-config-modal .modal-header h3 {
      color: #10b981;
      margin: 0;
      font-size: 1.2rem;
    }
    #agent-config-modal .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #agent-config-modal .modal-close:hover { color: #f87171; }
    #agent-config-modal .modal-section {
      margin-bottom: 1.5rem;
    }
    #agent-config-modal .modal-section h4 {
      color: #f59e0b;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #agent-config-modal label {
      display: block;
      color: #94a3b8;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }
    #agent-config-modal input,
    #agent-config-modal textarea,
    #agent-config-modal select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #f1f5f9;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    #agent-config-modal select {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      border-color: #3b82f6;
      cursor: pointer;
    }
    #agent-config-modal select:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e3a5f 100%);
    }
    #agent-config-modal select:focus,
    #agent-config-modal input:focus,
    #agent-config-modal textarea:focus {
      border-color: #60a5fa;
      outline: none;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
    #agent-config-modal textarea { resize: vertical; }
    #agent-config-modal .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    #agent-config-modal .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #334155;
    }
    #agent-config-modal .btn-cancel {
      background: #475569;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    #agent-config-modal .btn-cancel:hover { background: #64748b; }
    #agent-config-modal .btn-save {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    #agent-config-modal .btn-save:hover { background: #059669; }

    /* Integration Config Modal */
    #integration-config-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    #integration-config-modal .modal-content {
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.5rem;
      border: 1px solid #334155;
    }
    #integration-config-modal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #334155;
    }
    #integration-config-modal .modal-header h3 {
      margin: 0;
      color: #8b5cf6;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #integration-config-modal .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #integration-config-modal .modal-close:hover { color: #f87171; }
    #integration-config-modal label {
      display: block;
      color: #94a3b8;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }
    #integration-config-modal input,
    #integration-config-modal textarea,
    #integration-config-modal select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #f1f5f9;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    #integration-config-modal .btn-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    #integration-config-modal .btn-cancel {
      flex: 1;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      border: none;
      background: #475569;
      color: #f1f5f9;
      cursor: pointer;
    }
    #integration-config-modal .btn-save {
      flex: 2;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      border: none;
      background: #8b5cf6;
      color: white;
      cursor: pointer;
      font-weight: 500;
    }
    #integration-config-modal .btn-save:hover { background: #7c3aed; }
    #integration-config-modal .integration-icon {
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    #integration-config-modal .integration-type-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #1e3a5f;
      color: #60a5fa;
      border-radius: 20px;
      font-size: 0.75rem;
      margin-bottom: 1rem;
    }

    /* Integration Catalog */
    .integration-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
    .integration-card { background: #0f172a; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; text-align: center; }
    .integration-card:hover { border-color: #3b82f6; transform: translateY(-2px); }
    .integration-card.added { border-color: #10b981; background: #0f172a; opacity: 0.6; cursor: default; }
    .integration-card .icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .integration-card .name { font-weight: 600; color: #f1f5f9; font-size: 0.8rem; }
    .integration-card .type { font-size: 0.65rem; color: #60a5fa; margin-top: 0.2rem; }
    .current-integrations { margin-top: 1.5rem; }
    .current-integrations h4 { color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.75rem; }
    .current-integration { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #1e293b; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid #8b5cf6; cursor: pointer; transition: all 0.2s; }
    .current-integration:hover { background: #334155; border-left-color: #a78bfa; }
    .current-integration .info { display: flex; align-items: center; gap: 0.75rem; }
    .current-integration .info .icon { font-size: 1.25rem; }
    .current-integration .info .details { }
    .current-integration .info .name { font-weight: 600; color: #f1f5f9; font-size: 0.85rem; }
    .current-integration .info .type { font-size: 0.7rem; color: #64748b; }
    .current-integration .remove-btn { background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.75rem; }
    .current-integration .remove-btn:hover { background: #dc2626; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header legacy-header">
    <h1>‚ö° Flowgrid Design</h1>
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="stat-elements">0</div>
        <div>Agents</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-relationships">0</div>
        <div>Relationships</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="stat-agents">0</div>
        <div>Agents</div>
      </div>
    </div>
    <div class="header-actions" style="display: flex; gap: 0.5rem;">
      <a href="/discovery/" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.5rem 1rem; text-decoration: none;">üîç Discovery Wizard</a>
      <a id="wizard-link" href="/wizard.html" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.5rem 1rem; text-decoration: none;" onclick="if(currentFoundation?.id){this.href='/wizard.html?foundation='+currentFoundation.id}">‚ú® Design Wizard</a>
    </div>
  </header>
  <input type="file" id="design-import-input" accept="application/json" style="display: none;">

  <div class="container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="resize-handle" id="sidebar-resize"></div>
      
      <!-- Filter Section - All 3 dropdowns -->
      <div class="sidebar-section foundation-section" id="foundation-section">
        <h3>üéØ Filters</h3>
        
        <!-- Foundation dropdown -->
        <label style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.25rem; display: block;">Foundation</label>
        <select id="foundation-select" onchange="onFoundationSelectChange(this.value)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; cursor: pointer;">
          <option value="">-- Select Foundation --</option>
        </select>
        
        <!-- Process dropdown -->
        <label style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.25rem; display: block;">Process</label>
        <select id="process-filter" onchange="onProcessFilterChange(this.value)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; cursor: pointer;">
          <option value="">All Processes</option>
        </select>
        
        <!-- Sub-process dropdown -->
        <label style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.25rem; display: block;">Sub-process</label>
        <select id="subprocess-filter" onchange="onSubprocessFilterChange(this.value)" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.8rem; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; cursor: pointer;">
          <option value="">All Sub-processes</option>
        </select>
        
        <!-- Hidden elements for compatibility -->
        <div id="foundation-name" style="display: none;"></div>
        <div id="foundation-tabs-container" style="display: none;">
          <div id="foundation-capabilities-list" class="foundation-list"></div>
          <div id="foundation-dataObjects-list" class="foundation-list"></div>
          <div id="foundation-processes-list" class="foundation-list"></div>
        </div>
        <span id="foundation-cap-count" style="display: none;">0</span>
        <span id="foundation-data-count" style="display: none;">0</span>
        <span id="foundation-proc-count" style="display: none;">0</span>
      </div>
      
      <div class="sidebar-section elements-section">
        <h3>ü§ñ Agents</h3>
        
        <!-- Agent count -->
        <div id="agent-filter-status" style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.5rem;"></div>
        
        <div class="element-list" id="element-list">
          <div class="loading"><div class="loading-spinner"></div><p style="margin-top: 0.5rem;">Loading...</p></div>
        </div>
      </div>
      <!-- Progress Section - Legacy Style -->
      <div class="progress-section">
        <h3>üìà Progress</h3>
        <div class="progress-counters">
          <div class="progress-counter configured">
            <div class="progress-counter-value" id="progress-configured">0</div>
            <div class="progress-counter-label">Configured</div>
          </div>
          <div class="progress-counter compiled">
            <div class="progress-counter-value" id="progress-compiled">0</div>
            <div class="progress-counter-label">Compiled</div>
          </div>
          <div class="progress-counter deployed">
            <div class="progress-counter-value" id="progress-deployed">0</div>
            <div class="progress-counter-label">Deployed</div>
          </div>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-label">
            <span>Deployed</span>
            <span id="progress-percentage">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%;"></div>
          </div>
        </div>
        <div class="progress-stats">
          <div class="progress-stat-row">
            <span>Total Agents:</span>
            <span class="progress-stat-value" id="stat-total-agents">0</span>
          </div>
          <div class="progress-stat-row">
            <span>With Purpose:</span>
            <span class="progress-stat-value" id="stat-with-purpose">0</span>
          </div>
          <div class="progress-stat-row">
            <span>With Design:</span>
            <span class="progress-stat-value" id="stat-with-design">0</span>
          </div>
        </div>
      </div>
      
      <!-- Foundation Counters (shown when foundation selected) -->
      <div id="foundation-counters" class="sidebar-section" style="display: none; padding: 0.75rem;">
        <h3 style="font-size: 0.8rem; margin-bottom: 0.5rem;">üìä Foundation Data</h3>
        <div style="display: flex; gap: 0.5rem;">
          <div style="flex: 1; text-align: center; padding: 0.5rem; background: #0f172a; border-radius: 6px; border-left: 3px solid #22d3ee;">
            <div id="counter-capabilities" style="font-size: 1.25rem; font-weight: 700; color: #22d3ee;">0</div>
            <div style="font-size: 0.65rem; color: #64748b;">Capabilities</div>
          </div>
          <div style="flex: 1; text-align: center; padding: 0.5rem; background: #0f172a; border-radius: 6px; border-left: 3px solid #a78bfa;">
            <div id="counter-data" style="font-size: 1.25rem; font-weight: 700; color: #a78bfa;">0</div>
            <div style="font-size: 0.65rem; color: #64748b;">Data Objects</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content - Agent Explore -->
    <main class="main-content">
      <div class="agent-explore-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üîé Agent Explore</h2>
        <button class="btn btn-secondary" onclick="openAgentConfigModal(selectedAgentId)" style="font-size: 0.85rem;">‚öôÔ∏è Configure</button>
      </div>
      <div class="detail-tabs" style="margin-bottom:0.75rem;">
        <button class="detail-tab active workspace-tab" data-tab="overview" onclick="showWorkspaceTab('overview')">Overview</button>
        <button class="detail-tab workspace-tab" data-tab="graph" onclick="showWorkspaceTab('graph')">Graph</button>
        <button class="detail-tab workspace-tab" data-tab="skills" onclick="showWorkspaceTab('skills')">üõ†Ô∏è Skills</button>
        <button class="detail-tab workspace-tab" data-tab="relationships" onclick="showWorkspaceTab('relationships')">Relationships</button>
        <button class="detail-tab workspace-tab" data-tab="integrations" onclick="showWorkspaceTab('integrations')">üîß Tools</button>
        <button class="detail-tab workspace-tab" data-tab="bpmn" onclick="showWorkspaceTab('bpmn')">üîÑ BPMN</button>
        <button class="detail-tab workspace-tab" data-tab="a2a-card" onclick="showWorkspaceTab('a2a-card')">ü§ñ A2A Card</button>
      </div>

      <!-- Overview Tab - Agent Summary -->
      <section class="workspace-panel active" id="workspace-overview">
        <div id="overview-no-selection" style="padding: 2rem; text-align: center;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üîé</div>
          <h3 style="color: #94a3b8; margin-bottom: 0.5rem;">Select an element</h3>
          <p style="color: #64748b;">Click on an element in the sidebar to view its details.</p>
        </div>
        
        <div id="overview-agent-content" style="display: none; padding: 1rem;">
          <!-- Agent Header -->
          <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #334155;">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
              <span id="overview-icon">ü§ñ</span>
            </div>
            <div style="flex: 1;">
              <h2 id="overview-name" style="color: #f1f5f9; margin: 0 0 0.25rem 0; font-size: 1.5rem;">Agent Name</h2>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <span id="overview-type-badge" style="background: #3b82f6; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem;">Agent</span>
                <span id="overview-pattern-badge" style="background: #8b5cf6; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.75rem; display: none;">Specialist</span>
              </div>
            </div>
          </div>
          
          <!-- Description -->
          <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 0.5rem;">Description</h4>
            <p id="overview-description" style="color: #e2e8f0; line-height: 1.6;">No description provided.</p>
          </div>
          
          <!-- Stats Grid -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: #1e293b; border-radius: 8px; padding: 1rem; text-align: center;">
              <div id="overview-skills-count" style="font-size: 1.75rem; font-weight: 600; color: #a78bfa;">0</div>
              <div style="font-size: 0.75rem; color: #64748b;">Skills</div>
            </div>
            <div style="background: #1e293b; border-radius: 8px; padding: 1rem; text-align: center;">
              <div id="overview-caps-count" style="font-size: 1.75rem; font-weight: 600; color: #22d3ee;">0</div>
              <div style="font-size: 0.75rem; color: #64748b;">Capabilities</div>
            </div>
            <div style="background: #1e293b; border-radius: 8px; padding: 1rem; text-align: center;">
              <div id="overview-tools-count" style="font-size: 1.75rem; font-weight: 600; color: #f59e0b;">0</div>
              <div style="font-size: 0.75rem; color: #64748b;">Tools</div>
            </div>
            <div style="background: #1e293b; border-radius: 8px; padding: 1rem; text-align: center;">
              <div id="overview-relations-count" style="font-size: 1.75rem; font-weight: 600; color: #10b981;">0</div>
              <div style="font-size: 0.75rem; color: #64748b;">Relations</div>
            </div>
          </div>
          
          <!-- Two Column Layout -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <!-- Left Column: Configuration -->
            <div>
              <h4 style="color: #f59e0b; font-size: 0.85rem; margin-bottom: 0.75rem;">‚öôÔ∏è Configuration</h4>
              <div style="background: #1e293b; border-radius: 8px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8; font-size: 0.85rem;">Value Stream</span>
                  <span id="overview-valuestream" style="color: #e2e8f0; font-size: 0.85rem;">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8; font-size: 0.85rem;">Autonomy</span>
                  <span id="overview-autonomy" style="color: #e2e8f0; font-size: 0.85rem;">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #334155;">
                  <span style="color: #94a3b8; font-size: 0.85rem;">Decision Authority</span>
                  <span id="overview-decision" style="color: #e2e8f0; font-size: 0.85rem;">‚Äî</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.4rem 0;">
                  <span style="color: #94a3b8; font-size: 0.85rem;">Interaction</span>
                  <span id="overview-interaction" style="color: #e2e8f0; font-size: 0.85rem;">‚Äî</span>
                </div>
              </div>
            </div>
            
            <!-- Right Column: Skills Preview -->
            <div>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h4 style="color: #a78bfa; font-size: 0.85rem; margin: 0;">üõ†Ô∏è Skills</h4>
                <button class="btn btn-sm" style="font-size: 0.7rem; padding: 0.2rem 0.5rem; background: #334155;" onclick="showWorkspaceTab('skills')">View All ‚Üí</button>
              </div>
              <div id="overview-skills-preview" style="background: #1e293b; border-radius: 8px; padding: 1rem; min-height: 120px;">
                <p style="color: #64748b; font-size: 0.85rem;">No skills defined yet</p>
              </div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
            <h4 style="color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 0.75rem;">Quick Actions</h4>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-secondary" style="font-size: 0.85rem;" onclick="showDetailTab('description')">‚úèÔ∏è Edit Description</button>
              <button class="btn btn-secondary" style="font-size: 0.85rem;" onclick="showWorkspaceTab('skills'); generateSkillsWithAI();">ü§ñ Generate Skills</button>
              <button class="btn btn-secondary" style="font-size: 0.85rem;" onclick="showWorkspaceTab('a2a-card')">üìÑ View A2A Card</button>
              <button class="btn btn-primary" style="font-size: 0.85rem;" onclick="showDetailTab('code')">üíª Generate Code</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Graph Tab -->
      <section class="workspace-panel" id="workspace-graph">
        <div class="graph-legend-container" id="graph-legend">
          <div class="legend-row" id="elements-legend-row">
            <span class="legend-label">ELEMENTS:</span>
            <!-- Populated dynamically -->
          </div>
          <div class="legend-row" id="relations-legend-row">
            <span class="legend-label">RELATIONS:</span>
            <!-- Populated dynamically -->
          </div>
          <div class="legend-stats">Click to toggle ‚Ä¢ <span id="graph-node-count">0</span> nodes, <span id="graph-edge-count">0</span> edges</div>
        </div>
        <div class="graph-container" id="graph-container">
          <div class="graph-state-overlay" id="graph-overlay">
            <div class="graph-state-card">
              <div class="graph-state-icon" id="graph-overlay-icon">‚è≥</div>
              <div class="graph-state-title" id="graph-overlay-title">Loading graph</div>
              <div class="graph-state-message" id="graph-overlay-message">Preparing network data...</div>
              <button class="btn btn-secondary" id="graph-overlay-action" style="display:none;" onclick="refreshData()">Retry</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Skills Tab (A2A Protocol) -->
      <section class="workspace-panel" id="workspace-skills">
        <div style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div>
              <h3 style="color: #a78bfa; margin-bottom: 0.25rem;">üõ†Ô∏è Agent Skills</h3>
              <p style="color: #94a3b8; font-size: 0.85rem;">A2A Protocol skills - executable capabilities exposed to other agents</p>
            </div>
            <div id="skills-actions" style="display: none; gap: 0.5rem;">
              <button class="btn btn-secondary" style="font-size: 0.85rem;" onclick="openAddSkillModal()">+ Add Skill</button>
              <button class="btn btn-primary" style="font-size: 0.85rem;" onclick="generateSkillsWithAI()">ü§ñ Generate with AI</button>
            </div>
          </div>
          
          <div id="workspace-skills-empty" style="color: #64748b; padding: 2rem; text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üõ†Ô∏è</div>
            <p>Select an agent to view or manage its skills.</p>
          </div>
          
          <div id="workspace-skills-list" style="display: none;">
            <!-- Skills populated by renderWorkspaceSkills() -->
          </div>
        </div>
      </section>

      <!-- Relationships Tab -->
      <section class="workspace-panel" id="workspace-relationships">
        <div style="padding: 1rem;">
          <h3 style="color: #60a5fa; margin-bottom: 0.5rem;">Relationships</h3>
          <p style="color: #94a3b8; margin-bottom: 1.5rem;">Explore relationships and connections for the selected element.</p>
          
          <div id="relationships-empty" style="color: #64748b; padding: 2rem; text-align: center;">
            Select an element to inspect relationships.
          </div>
          
          <div id="relationships-content" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
              <!-- Outgoing Column -->
              <div>
                <h4 style="color: #f59e0b; margin-bottom: 1rem;" id="outgoing-header">Outgoing ‚Üí (0)</h4>
                <div id="outgoing-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
              <!-- Incoming Column -->
              <div>
                <h4 style="color: #60a5fa; margin-bottom: 1rem;" id="incoming-header">‚Üê Incoming (0)</h4>
                <div id="incoming-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Integrations Tab -->
      <section class="workspace-panel" id="workspace-integrations">
        <div class="info-card">
          <h4>üîß Suggested Tools</h4>
          <p style="color: #64748b; font-size: 0.8rem; margin-bottom: 1rem;">Click to add a tool/integration to this agent</p>
          <div id="suggested-integrations" class="integration-grid">
            <p style="color: #64748b;">Select an agent to see suggestions</p>
          </div>
        </div>
        <div class="current-integrations">
          <h4>üìã Current Tools</h4>
          <div id="current-integrations-list">
            <p style="color: #64748b; font-size: 0.85rem;">No tools added yet</p>
          </div>
        </div>
      </section>

      <!-- Interactions Tab -->
      <section class="workspace-panel" id="workspace-interactions">
        <div class="info-card">
          <h4>A2A Interactions</h4>
          <p>Interaction contracts are shown in the right panel when an agent is selected.</p>
        </div>
      </section>

      <!-- Agents Tab -->
      <section class="workspace-panel" id="workspace-agents">
        <div class="info-card">
          <h4>Agents</h4>
          <p id="workspace-agents-list">Loading agent roster‚Ä¶</p>
        </div>
      </section>

      <!-- BPMN Tab -->
      <section class="workspace-panel" id="workspace-bpmn">
        <div style="height: calc(100vh - 200px);">
          <!-- Hidden process list for compatibility -->
          <div id="bpmn-process-list" style="display: none;"></div>
          
          <!-- BPMN Canvas Area -->
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <div>
                <h3 style="color: #f59e0b; margin-bottom: 0.25rem;" id="bpmn-process-title">üìä Select a Process</h3>
                <p style="color: #64748b; font-size: 0.85rem;" id="bpmn-process-desc">Choose a process from the list to view its workflow</p>
              </div>
              <div style="display: flex; gap: 0.5rem;" id="bpmn-actions" style="display: none;">
                <button class="btn btn-success" onclick="saveCurrentBPMN()" style="font-size: 0.85rem;" id="bpmn-save-btn">üíæ Save</button>
                <button class="btn btn-primary" onclick="regenerateProcessBPMN()" style="font-size: 0.85rem;">üîÑ Regenerate</button>
                <button class="btn btn-secondary" onclick="document.getElementById('bpmn-import-input').click()" style="font-size: 0.85rem;">üì§ Import</button>
                <button class="btn btn-secondary" onclick="exportProcessBPMN()" style="font-size: 0.85rem;">üì• Export</button>
                <input type="file" id="bpmn-import-input" accept=".bpmn,.xml" style="display: none;" onchange="importBPMNFile(event)">
              </div>
            </div>
            
            <!-- Empty state -->
            <div id="bpmn-empty-state" style="flex: 1; display: flex; align-items: center; justify-content: center; background: #1e293b; border: 1px dashed #334155; border-radius: 8px;">
              <div style="text-align: center; color: #64748b;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                <p>Select a process from the list to view its BPMN diagram</p>
              </div>
            </div>
            
            <!-- BPMN Canvas -->
            <div id="bpmn-canvas-main" style="flex: 1; display: none; background: #ffffff; border: 1px solid #334155; border-radius: 8px;"></div>
            
            <div style="margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
              <small style="color: #64748b;">Powered by <a href="https://bpmn.io" target="_blank" style="color: #60a5fa;">bpmn.io</a></small>
              <small style="color: #64748b;" id="bpmn-stats"></small>
            </div>
          </div>
        </div>
      </section>

      <!-- A2A Card Tab -->
      <section class="workspace-panel" id="workspace-a2a-card">
        <div class="a2a-card-container" style="padding: 1rem;">
          <div id="a2a-no-selection" style="text-align: center; color: #64748b; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ñ</div>
            <h3 style="color: #94a3b8; margin-bottom: 0.5rem;">No Agent Selected</h3>
            <p>Select an agent from the sidebar to view its A2A Card</p>
          </div>
          <div id="a2a-card-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="color: #f59e0b; margin: 0;">ü§ñ A2A Agent Card</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm" onclick="copyA2ACard()" title="Copy to clipboard">üìã Copy</button>
                <button class="btn btn-sm btn-primary" onclick="downloadA2ACard()" title="Download JSON">‚¨áÔ∏è Download</button>
              </div>
            </div>
            <div id="a2a-card-json" style="background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; overflow: auto; max-height: calc(100vh - 300px);">
              <pre style="margin: 0; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.8rem; color: #e2e8f0; white-space: pre-wrap;"><code id="a2a-card-code"></code></pre>
            </div>
            <div style="margin-top: 1rem; padding: 0.75rem; background: #1e3a5f; border: 1px solid #3b82f6; border-radius: 6px;">
              <div style="font-size: 0.85rem; color: #93c5fd;">
                <strong>üí° A2A Protocol</strong><br>
                This card follows the <a href="https://google.github.io/A2A/" target="_blank" style="color: #60a5fa;">Agent-to-Agent Protocol</a> specification.
                Use it to register this agent with A2A-compatible orchestrators.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Right Sidebar - Detail Panel with Legacy Tabs -->
    <aside class="detail-panel" id="detail-panel">
      <div class="resize-handle" id="detail-resize"></div>
      <div id="detail-empty" style="display: none;"></div>
      <div id="detail-content" style="display: none;">
        <h2 id="detail-name">Agent Name</h2>
        <div class="agent-type" id="detail-type">ü§ñ Agent ‚Ä¢ Specialist</div>
        
        <!-- Legacy-style tabs: Description, Design, Configure, Verify, Code, Deploy -->
        <div class="detail-tabs">
          <button class="detail-tab active" data-tab="description" onclick="showDetailTab('description')">üìù Description</button>
          <button class="detail-tab" data-tab="design" onclick="showDetailTab('design')">üé® Design</button>
          <button class="detail-tab" data-tab="configure" onclick="showDetailTab('configure')">‚öôÔ∏è Configure</button>
          <button class="detail-tab" data-tab="verify" onclick="showDetailTab('verify')">‚úÖ Verify</button>
          <button class="detail-tab" data-tab="code" onclick="showDetailTab('code')">üíª Code</button>
          <button class="detail-tab" data-tab="deploy" onclick="showDetailTab('deploy')">üöÄ Deploy</button>
        </div>

        <!-- Description Tab -->
        <div id="tab-description" class="tab-content active">
          <div class="section-header">üìù Identity</div>
          <div class="form-group">
            <label>Agent Name</label>
            <input type="text" id="agent-display-name" placeholder="Display name for this agent">
          </div>
          <div class="form-group">
            <label>Short Description</label>
            <input type="text" id="agent-short-desc" placeholder="Brief one-line description">
          </div>
          
          <div class="section-header">üéØ Purpose & Value</div>
          <div class="form-group">
            <label>Detailed Purpose</label>
            <textarea id="agent-purpose" placeholder="Describe what this agent does and its core function..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Business Value</label>
            <textarea id="agent-business-value" placeholder="What value does this agent provide to the business?" rows="2"></textarea>
          </div>
          
          <div class="form-group">
            <label>Success Criteria</label>
            <textarea id="agent-success-criteria" placeholder="How do we measure if this agent is successful?" rows="2"></textarea>
          </div>
          
          <!-- Process Info Section (shown for Process elements) -->
          <div id="process-info-section" style="display: none; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
            <h3 style="color: #ec4899; font-size: 1rem; margin-bottom: 1rem;">üîÑ Process Flow Details</h3>
            <div class="form-group">
              <label>Process Steps</label>
              <textarea id="agent-process-steps" placeholder="The steps in this process..." rows="4" readonly style="background: #0f172a;"></textarea>
            </div>
            <div class="form-group">
              <label>Decision Points</label>
              <textarea id="agent-decision-points" placeholder="Key decision points in the process..." rows="3" readonly style="background: #0f172a;"></textarea>
            </div>
            <div class="form-group">
              <label>Error Handling</label>
              <textarea id="agent-error-handling" placeholder="How errors are handled..." rows="3" readonly style="background: #0f172a;"></textarea>
            </div>
          </div>
        </div>

        <!-- Design Tab -->
        <div id="tab-design" class="tab-content">
          <div class="section-header">üé≠ Agentic Pattern</div>
          <div class="form-group">
            <label>Pattern</label>
            <select id="agent-pattern-design">
              <option value="">-- Select Pattern --</option>
              <option value="Specialist">üéØ Specialist</option>
              <option value="Orchestrator">üé≠ Orchestrator</option>
              <option value="Monitor">üëÅÔ∏è Monitor</option>
              <option value="Coordinator">üîÑ Coordinator</option>
              <option value="Validator">‚úÖ Validator</option>
              <option value="Executor">‚ö° Executor</option>
              <option value="Router">üîÄ Router</option>
              <option value="Transformer">üîÑ Transformer</option>
            </select>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div class="form-group">
              <label>Decision Authority</label>
              <select id="agent-decision-design">
                <option value="">-- Select --</option>
                <option value="propose-only">Propose Only</option>
                <option value="propose-and-execute">Propose & Execute</option>
                <option value="autonomous-low-risk">Autonomous (Low Risk)</option>
                <option value="fully-autonomous">Fully Autonomous</option>
              </select>
            </div>
            <div class="form-group">
              <label>Autonomy Level</label>
              <select id="agent-autonomy-design">
                <option value="">-- Select --</option>
                <option value="full">Full</option>
                <option value="supervised">Supervised</option>
                <option value="human-in-loop">Human in Loop</option>
              </select>
            </div>
          </div>
          
          <div class="section-header">üìä Classification</div>
          <div class="form-group">
            <label>Value Stream</label>
            <input type="text" id="agent-valuestream-design" placeholder="e.g., Strategy to Portfolio">
          </div>
          <!-- Capability Group hidden - not used in code generation -->
          <div class="form-group" style="display: none;">
            <label>Capability Group</label>
            <input type="text" id="agent-capgroup-design" placeholder="e.g., Incident Management">
          </div>
          
          <div class="section-header">üéØ Goals</div>
          <div class="form-group">
            <label>Objectives (one per line)</label>
            <textarea id="agent-objectives-design" rows="4" placeholder="Reduce incident resolution time by 30%&#10;Automate routine tasks&#10;Improve SLA compliance"></textarea>
          </div>
          <div class="form-group">
            <label>KPIs (one per line)</label>
            <textarea id="agent-kpis-design" rows="3" placeholder="Mean time to resolution&#10;Automation rate&#10;Customer satisfaction"></textarea>
          </div>
          
          <button class="btn btn-success" onclick="saveAgentDesign()" style="width: 100%; margin-top: 1rem;">üíæ Save Design</button>
        </div>

        <!-- Configure Tab -->
        <div id="tab-configure" class="tab-content">
          <!-- 1. Messaging Configuration -->
          <div class="section-header">üì° Messaging Configuration</div>
          <div class="form-group">
            <label>Interaction Pattern</label>
            <select id="agent-interaction-config">
              <option value="">-- Select --</option>
              <option value="request-response">Request-Response</option>
              <option value="event-driven">Event-Driven</option>
              <option value="publish-subscribe">Publish-Subscribe</option>
              <option value="orchestrated">Orchestrated</option>
            </select>
          </div>
          <div class="form-group">
            <label>Listen Topics</label>
            <div class="tag-input-container" id="listen-topics-container">
              <div class="tag-list" id="listen-topics-tags"></div>
              <input type="text" id="listen-topics-input" class="tag-input" placeholder="Type topic and press Enter" onkeydown="handleTagInput(event, 'listen-topics')">
            </div>
            <div id="listen-topics-suggestions" class="tag-suggestions" style="display:none;"></div>
          </div>
          <div class="form-group">
            <label>Publish Topics</label>
            <div class="tag-input-container" id="publish-topics-container">
              <div class="tag-list" id="publish-topics-tags"></div>
              <input type="text" id="publish-topics-input" class="tag-input" placeholder="Type topic and press Enter" onkeydown="handleTagInput(event, 'publish-topics')">
            </div>
          </div>
          <div class="form-group">
            <label>Message Types (comma-separated)</label>
            <input type="text" id="agent-message-types-config" placeholder="TaskRequest, StatusUpdate, ResultReport">
          </div>
          <div class="form-group">
            <label>Inbound Triggers (comma-separated)</label>
            <input type="text" id="agent-triggers-config" placeholder="incident created, change requested">
          </div>
          <div class="form-group">
            <label>Outbound Events (comma-separated)</label>
            <input type="text" id="agent-outputs-config" placeholder="analysis report, recommendations">
          </div>

          <!-- 2. Data Store Configuration -->
          <div class="section-header">üíæ Data Store Configuration</div>
          <div class="form-group">
            <label>Database Name</label>
            <input type="text" id="agent-db-name-config" placeholder="flowgrid-agents" value="flowgrid-agents">
          </div>
          <div class="form-group">
            <label>Collections</label>
            <div style="display: flex; flex-direction: column; gap: 0.4rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="col-memory" checked> üí≠ memory
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="col-state" checked> üìä state
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="col-tasks" checked> üìã tasks
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                <input type="checkbox" id="col-decisions" checked> ‚öñÔ∏è decisions
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>Partition Key</label>
            <input type="text" id="agent-partition-key-config" placeholder="/tenantId" value="/tenantId">
          </div>
          <div class="info-card" style="padding: 0.5rem; font-size: 0.75rem; color: #94a3b8;">
            ‚ÑπÔ∏è CosmosDB collections are auto-provisioned on deploy
          </div>

          <!-- 3. Model Configuration -->
          <div class="section-header">ü§ñ Model Configuration</div>
          <div id="model-recommendation" class="info-card" style="padding: 0.5rem; font-size: 0.75rem; color: #f59e0b; display: none;">
            üí° <span id="model-rec-text"></span>
          </div>
          <div class="form-group">
            <label>Provider</label>
            <select id="agent-model-provider" onchange="updateModelSuggestions()">
              <option value="">-- Select --</option>
              <option value="azure-openai" selected>Azure OpenAI</option>
              <option value="anthropic">Anthropic</option>
              <option value="openai">OpenAI</option>
            </select>
          </div>
          <div class="form-group">
            <label>Model / Deployment</label>
            <input type="text" id="agent-model-config" placeholder="gpt-4o" list="model-suggestions">
            <datalist id="model-suggestions"></datalist>
          </div>
          <div class="form-group">
            <label>System Prompt</label>
            <textarea id="agent-system-prompt-config" rows="3" placeholder="Pre-filled from agent purpose..." style="width:100%;padding:0.5rem;border:1px solid #334155;border-radius:6px;background:#0f172a;color:#e2e8f0;font-family:inherit;font-size:0.85rem;resize:vertical;"></textarea>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label>Max Tokens</label>
              <input type="number" id="agent-max-tokens-config" value="4096" min="256" max="128000">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Temperature: <span id="temp-value">0.3</span></label>
              <input type="range" id="agent-temperature-config" min="0" max="1" step="0.05" value="0.3" oninput="document.getElementById('temp-value').textContent = this.value" style="width:100%;accent-color:#f59e0b;">
            </div>
          </div>

          <!-- 4. HITL Configuration -->
          <div class="section-header">üôã HITL Configuration</div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="agent-hitl-required" onchange="document.getElementById('hitl-details').style.display = this.checked ? 'block' : 'none'"> Approval Required
            </label>
          </div>
          <div id="hitl-details" style="display: none;">
            <div class="form-group">
              <label>Approval Threshold</label>
              <select id="agent-hitl-threshold">
                <option value="all-decisions">All Decisions</option>
                <option value="high-risk-only">High Risk Only</option>
                <option value="cost-above-threshold">Cost Above Threshold</option>
              </select>
            </div>
            <div class="form-group">
              <label>Escalation Target</label>
              <select id="agent-hitl-escalation">
                <option value="">-- Select Agent --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Timeout (minutes)</label>
              <input type="number" id="agent-hitl-timeout" value="60" min="1" max="1440">
            </div>
          </div>

          <!-- 5. Tools -->
          <div class="section-header">üîß Tools</div>
          <div id="config-integrations-list" style="margin-bottom: 0.75rem;">
            <p style="color: #64748b; font-size: 0.85rem;">No tools configured</p>
          </div>
          <button class="btn btn-secondary" style="width: 100%;" onclick="showWorkspaceTab('integrations')">Manage Tools ‚Üí</button>

          <button class="btn btn-success" onclick="saveAgentConfig()" style="width: 100%; margin-top: 1rem;">üíæ Save Configuration</button>
        </div>

        <!-- Verify Tab -->
        <div id="tab-verify" class="tab-content">
          <div class="section-header">‚úÖ Configuration Completeness</div>
          <div id="verify-results" class="info-card">
            <p style="color: #64748b;">Run verification to check agent configuration.</p>
          </div>
          
          <div class="section-header">üìä Verification Checks</div>
          <div id="verify-checklist" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div class="verify-item" data-check="name">
              <span class="status-badge info">‚è≥</span> Agent Name
            </div>
            <div class="verify-item" data-check="purpose">
              <span class="status-badge info">‚è≥</span> Purpose Defined
            </div>
            <div class="verify-item" data-check="pattern">
              <span class="status-badge info">‚è≥</span> Pattern Selected
            </div>
            <div class="verify-item" data-check="integrations">
              <span class="status-badge info">‚è≥</span> Tools Configured <span style="color: #64748b; font-size: 0.75rem;">(optional)</span>
            </div>
            <div class="verify-item" data-check="relationships">
              <span class="status-badge info">‚è≥</span> Relationships Defined
            </div>
          </div>
          
          <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" onclick="runVerification()">üîç Run Verification</button>
        </div>

        <!-- Code Tab -->
        <div id="tab-code" class="tab-content">
          <!-- 1. Agent Manifest -->
          <div class="section-header">üìã Agent Manifest</div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <button class="btn btn-success" style="flex: 1;" onclick="generateManifest(selectedAgentId)">üìã Generate Manifest</button>
            <button class="btn btn-secondary" onclick="copyManifest()">üìã Copy</button>
            <button class="btn btn-secondary" onclick="downloadManifest()">‚¨áÔ∏è</button>
          </div>
          <div id="manifest-validation-bar" style="padding: 0.35rem 0.5rem; font-size: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; display: none;"></div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
            <label style="font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 0.35rem; cursor: pointer;">
              <input type="checkbox" id="manifest-edit-toggle" onchange="toggleManifestEdit(this.checked)"> Edit mode
            </label>
            <span id="manifest-timestamp" style="font-size: 0.7rem; color: #64748b; margin-left: auto;"></span>
          </div>
          <div class="code-container" style="max-height: 300px;">
            <pre id="manifest-display" contenteditable="false" style="font-size: 0.7rem; line-height: 1.4; outline: none;">// Click "Generate Manifest" to assemble from Description + Design + Configure tabs</pre>
          </div>

          <!-- 2. Code Scaffolding -->
          <div class="section-header" style="margin-top: 1rem;">üíª Code Scaffolding</div>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            <button class="btn btn-success" style="flex: 1;" onclick="generateCode()">ü§ñ Generate Function App Code</button>
            <button class="btn btn-primary" id="save-code-btn" onclick="saveGeneratedCode()">üíæ Save</button>
            <button class="btn btn-secondary" onclick="copyCode()">üìã Copy</button>
          </div>
          <p style="font-size: 0.7rem; color: #64748b; margin-bottom: 0.5rem;">Generates Azure Functions scaffolding based on manifest</p>
          <div class="code-container" style="max-height: 300px;">
            <pre id="agent-code" style="font-size: 0.7rem; line-height: 1.4;">// Generate manifest first, then generate Function App code</pre>
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-secondary" style="flex: 1;" onclick="generateBicepCode()">üèóÔ∏è Generate Bicep</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="downloadManifestPackage(selectedAgentId)">üì¶ Download Package</button>
          </div>
          <div class="code-container" style="max-height: 200px; margin-top: 0.5rem; display: none;" id="bicep-container">
            <pre id="bicep-code" style="font-size: 0.7rem; line-height: 1.4;"></pre>
          </div>
        </div>

        <!-- Deploy Tab -->
        <div id="tab-deploy" class="tab-content">
          <!-- Manifest Status -->
          <div class="section-header">üìã Manifest Status</div>
          <div class="info-card" id="deploy-manifest-status" style="padding: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.35rem;">
              <span id="deploy-manifest-badge" class="status-badge warning">‚ö†Ô∏è Not Generated</span>
              <span id="deploy-manifest-version" style="font-size: 0.7rem; color: #64748b;"></span>
            </div>
            <p id="deploy-manifest-text" style="font-size: 0.8rem; color: #94a3b8;">
              <a href="#" onclick="showDetailTab('code'); return false;" style="color: #60a5fa;">Generate manifest</a> in the Code tab first.
            </p>
          </div>

          <!-- Infrastructure Requirements -->
          <div class="section-header">üèóÔ∏è Infrastructure Requirements</div>
          <div class="info-card" id="deploy-infra-requirements" style="padding: 0.75rem;">
            <p style="color: #64748b; font-size: 0.85rem;">Generate manifest to detect requirements.</p>
          </div>
          <button class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem; opacity: 0.5; cursor: not-allowed;" disabled title="Coming in Level 3">
            üèóÔ∏è Provision Infrastructure (Level 3)
          </button>

          <!-- Deployment Target -->
          <div class="section-header">üéØ Deployment Target</div>
          <div class="form-group">
            <select id="deploy-target" onchange="updateDeployTarget(this.value)">
              <option value="azure-functions" selected>Azure Functions</option>
              <option value="container-apps">Container Apps</option>
              <option value="local-docker">Local Docker</option>
            </select>
          </div>

          <!-- Azure Configuration -->
          <div class="section-header">‚òÅÔ∏è Azure Configuration</div>
          <div id="azure-config-section">
            <div class="form-group">
              <label>Subscription</label>
              <select id="deploy-subscription" onchange="updateDeployConfig()">
                <option value="mcpp">MCPP Subscription</option>
                <option value="payg">Pay-As-You-Go</option>
              </select>
            </div>
            <div class="form-group">
              <label>Resource Group</label>
              <select id="deploy-resource-group" onchange="updateDeployConfig()">
                <option value="rg-flowgrid-dev">rg-flowgrid-dev</option>
                <option value="rg-flowgrid-staging">rg-flowgrid-staging</option>
                <option value="rg-flowgrid-prod">rg-flowgrid-prod</option>
              </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div class="form-group" style="margin-bottom: 0;">
                <label>Region</label>
                <select id="deploy-region" onchange="updateDeployConfig()">
                  <option value="westeurope" selected>West Europe</option>
                  <option value="northeurope">North Europe</option>
                  <option value="eastus">East US</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label>Function App Name</label>
                <input type="text" id="deploy-func-name" placeholder="func-agent-name" onchange="updateDeployConfig()">
              </div>
            </div>
          </div>

          <!-- Pre-Deploy Checklist -->
          <div class="section-header">‚úÖ Pre-Deploy Checklist</div>
          <div class="info-card" id="deploy-checklist" style="padding: 0.75rem;">
            <div id="checklist-items" style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem;">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <!-- Deploy Button -->
          <button id="deploy-btn" class="btn btn-success" style="width: 100%; margin: 1rem 0; padding: 0.75rem; font-size: 1rem;" onclick="deployAgent()" disabled>
            üöÄ Deploy to Azure
          </button>

          <!-- Current Deployment Status -->
          <div class="section-header">üìä Current Deployment</div>
          <div class="info-card" id="deploy-status-card">
            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
              <span id="deploy-status-badge" class="status-badge info">‚è≥ Not Deployed</span>
              <span id="deploy-version" style="font-size: 0.75rem; color: #64748b;"></span>
            </div>
            <div id="deploy-url-container" style="display: none; margin-bottom: 0.75rem;">
              <label style="font-size: 0.7rem; color: #64748b; text-transform: uppercase;">Endpoint URL</label>
              <a id="deploy-url" href="#" target="_blank" style="font-size: 0.8rem; color: #60a5fa; word-break: break-all;"></a>
            </div>
            <p id="deploy-status-text" style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.75rem;">This agent has not been deployed yet.</p>
            <div id="deploy-actions" style="display: none; display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-secondary" style="flex: 1; font-size: 0.8rem;" onclick="viewDeployLogs()">üìã Logs</button>
              <button class="btn btn-secondary" style="flex: 1; font-size: 0.8rem;" onclick="redeployAgent()">üîÑ Redeploy</button>
              <button class="btn btn-warning" style="font-size: 0.8rem;" onclick="stopAgent()">‚èπÔ∏è Stop</button>
            </div>
          </div>

          <!-- Deployment History -->
          <div class="section-header">üìú Deployment History</div>
          <div id="deploy-history" style="max-height: 150px; overflow-y: auto;">
            <div style="color: #64748b; font-size: 0.85rem; padding: 0.5rem;">No deployment history</div>
          </div>

          <!-- Export Options -->
          <div class="section-header">üì¶ Export Options</div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="exportAgentJSON()">üìÑ Export as JSON (A2A Card)</button>
            <button class="btn btn-secondary" onclick="exportAgentCode()">üíª Export Code Package</button>
          </div>

          <!-- Danger Zone -->
          <div class="section-header" style="color: #ef4444;">‚ö†Ô∏è Danger Zone</div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-danger" style="flex: 1;" onclick="deleteDeployment()">üóëÔ∏è Delete Deployment</button>
            <button class="btn btn-danger" onclick="deleteAgent()">üóëÔ∏è Delete Agent</button>
          </div>
        </div>

      </div>
    </aside>
  </div>
  
  <script src="./auth-ui.js"></script>
  <script>
    // ============================================================================
    // Configuration
    // ============================================================================
    
    const API_BASE = '/api/agents';

    function getAccessToken() {
      if (window.FlowgridAuthUI?.getAuthToken) {
        return window.FlowgridAuthUI.getAuthToken();
      }
      return localStorage.getItem('flowgrid_access_token') || localStorage.getItem('accessToken');
    }
    
    // State
    let agents = [];
    let relationships = [];
    let selectedAgentId = null;
    let network = null;
    let distributionChart = null;
    let hiddenTypes = new Set();
    let hiddenRelations = new Set();
    let graphState = 'loading';
    
    function normalizeNodeType(value) {
      if (!value) return 'Agent';
      const lower = String(value).toLowerCase();
      // Map common variations to standard types
      const typeMap = {
        'agent': 'Agent',
        'capability': 'Capability',
        'dataobject': 'DataObject',
        'data object': 'DataObject',
        'process': 'Process',
        'applicationfunction': 'ApplicationFunction',
        'application function': 'ApplicationFunction',
        'grouping': 'Grouping',
        'resource': 'Resource',
        'applicationservice': 'ApplicationService',
        'application service': 'ApplicationService',
        'requirement': 'Requirement',
        'businessservice': 'BusinessService',
        'business service': 'BusinessService',
      };
      return typeMap[lower] || value; // Return original if not mapped
    }

    // Node colors by element type (legacy + new)
    const nodeColors = {
      // Legacy ArchiMate types
      'ApplicationFunction': '#a855f7', // purple
      'Grouping': '#06b6d4', // cyan
      'Resource': '#10b981', // green
      'ApplicationService': '#f59e0b', // orange
      'Requirement': '#3b82f6', // blue
      'DataObject': '#ec4899', // pink
      'BusinessService': '#3b82f6', // blue
      // New FlowGrid types
      'Agent': '#10b981', // green
      'Capability': '#60a5fa', // blue
      'Process': '#ec4899', // pink
      'default': '#94a3b8'
    };

    // Relation/edge colors
    const relationColors = {
      'Realization': '#a855f7', // purple
      'Flow': '#3b82f6', // blue
      'Association': '#64748b', // gray
      'Composition': '#ec4899', // pink
      'Access': '#ef4444', // red
      'Serving': '#14b8a6', // teal
      'uses': '#60a5fa',
      'manages': '#22c55e',
      'delegates_to': '#f59e0b',
      'consults': '#a78bfa',
      'triggers': '#f97316',
      'reports_to': '#38bdf8',
      'depends_on': '#f43f5e',
      'informs': '#14b8a6',
      'message': '#64748b',
      'default': '#64748b'
    };

    // Extended element type colors for donut chart
    const elementTypeColors = {
      'Requirement': '#3b82f6',
      'Resource': '#10b981',
      'ApplicationService': '#f59e0b',
      'Artifact': '#ef4444',
      'ApplicationFunction': '#a855f7',
      'BusinessService': '#3b82f6',
      'DataObject': '#ec4899',
      'Grouping': '#06b6d4',
      'Capability': '#22c55e',
      'ValueStream': '#f97316',
      'Agent': '#10b981',
      'Process': '#ec4899',
    };

    // Note: relationColors is defined above and includes all interaction types

    function setGraphState(state, message) {
      graphState = state;
      const overlay = document.getElementById('graph-overlay');
      if (!overlay) return;

      const icon = document.getElementById('graph-overlay-icon');
      const title = document.getElementById('graph-overlay-title');
      const text = document.getElementById('graph-overlay-message');
      const action = document.getElementById('graph-overlay-action');

      if (state === 'ready') {
        overlay.classList.remove('active');
        return;
      }

      const byState = {
        loading: { icon: '‚è≥', title: 'Loading graph', message: 'Preparing network data...', action: false },
        empty: { icon: 'üï∏Ô∏è', title: 'No graph data yet', message: 'Create an agent or import a design bundle to start.', action: true },
        error: { icon: '‚ö†Ô∏è', title: 'Graph unavailable', message: message || 'Could not load graph data. Try refreshing.', action: true },
      };

      const config = byState[state] || byState.loading;
      icon.textContent = config.icon;
      title.textContent = config.title;
      text.textContent = message || config.message;
      action.style.display = config.action ? 'inline-flex' : 'none';
      overlay.classList.add('active');
    }
    
    // ============================================================================
    // Initialization
    // ============================================================================
    
    async function init() {
      console.log('[design-studio] Initializing...');
      setGraphState('loading');

      try {
        // Load available foundations for dropdown
        await loadFoundations();
        
        // Check for foundation query param
        const urlParams = new URLSearchParams(window.location.search);
        const foundationId = urlParams.get('foundation');
        if (foundationId) {
          await loadFoundation(foundationId);
        }
        
        await loadAgents();
        await loadRelationships();
        renderGraphLegend();
        initGraph();
        updateStats();
        updateDistributionChart();
        console.log('[design-studio] Ready');
      } catch (error) {
        console.error('[design-studio] Init error:', error);
        setGraphState('error', 'Failed to load data. Make sure the gateway and agent-service are running.');
        showError('Failed to load data. Make sure agent-service is running.');
      }
    }
    
    // ============================================================================
    // Foundation Loading
    // ============================================================================
    
    let currentFoundation = null;
    let availableFoundations = [];
    
    async function loadFoundations() {
      console.log('[design-studio] Loading available foundations...');
      try {
        const response = await fetch('/api/wizard/foundations', {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          console.warn('[design-studio] Failed to load foundations');
          return;
        }
        
        const data = await response.json();
        availableFoundations = data.foundations || [];
        
        const select = document.getElementById('foundation-select');
        select.innerHTML = '<option value="">-- Select Foundation --</option>' +
          availableFoundations.map(f => 
            `<option value="${f.id}">${f.name} (${f.capability_count || 0} capabilities)</option>`
          ).join('');
        
        console.log('[design-studio] Loaded', availableFoundations.length, 'foundations');
      } catch (error) {
        console.error('[design-studio] Foundations load error:', error);
      }
    }
    
    function onFoundationSelectChange(foundationId) {
      if (foundationId) {
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('foundation', foundationId);
        window.history.pushState({}, '', url);
        
        loadFoundation(foundationId);
      } else {
        // Clear foundation
        const url = new URL(window.location);
        url.searchParams.delete('foundation');
        window.history.pushState({}, '', url);
        
        currentFoundation = null;
        document.getElementById('foundation-name').style.display = 'none';
        document.getElementById('foundation-tabs-container').style.display = 'none';
        document.getElementById('foundation-counters').style.display = 'none';
        
        // Reset process/subprocess filters
        document.getElementById('process-filter').innerHTML = '<option value="">All Processes</option>';
        document.getElementById('subprocess-filter').innerHTML = '<option value="">All Sub-processes</option>';
        selectedProcessFilter = '';
        selectedSubprocessFilter = '';
        applyAgentFilters();
      }
    }
    
    async function loadFoundation(foundationId) {
      console.log('[design-studio] Loading foundation:', foundationId);
      try {
        const response = await fetch(`/api/wizard/foundations/${foundationId}`, {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) {
          console.warn('[design-studio] Foundation not found:', foundationId);
          return;
        }
        
        const data = await response.json();
        currentFoundation = data.foundation;
        
        if (currentFoundation) {
          renderFoundation(currentFoundation);
        }
      } catch (error) {
        console.error('[design-studio] Foundation load error:', error);
      }
    }
    
    function renderFoundation(foundation) {
      // Update dropdown selection
      const select = document.getElementById('foundation-select');
      if (select && foundation.id) {
        select.value = foundation.id;
      }
      
      // Update counts
      const capabilities = foundation.capabilities || [];
      const dataObjects = foundation.data_objects || [];
      const processes = foundation.processes || [];
      
      // Update hidden count elements (for compatibility)
      document.getElementById('foundation-cap-count').textContent = capabilities.length;
      document.getElementById('foundation-data-count').textContent = dataObjects.length;
      document.getElementById('foundation-proc-count').textContent = processes.length;
      
      // Update bottom counters
      document.getElementById('foundation-counters').style.display = 'block';
      document.getElementById('counter-capabilities').textContent = capabilities.length;
      document.getElementById('counter-data').textContent = dataObjects.length;
      
      // Populate process filter dropdown
      populateProcessFilter(processes);
    }
    
    // ============================================================================
    // Agent Filtering (Foundation ‚Üí Process ‚Üí Sub-process ‚Üí Agents)
    // ============================================================================
    
    let selectedProcessFilter = '';
    let selectedSubprocessFilter = '';
    
    function populateProcessFilter(processes) {
      const select = document.getElementById('process-filter');
      
      if (!processes || processes.length === 0) {
        select.innerHTML = '<option value="">All Processes</option>';
      } else {
        select.innerHTML = '<option value="">All Processes</option>' +
          processes.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join('');
      }
      
      // Reset filters and apply
      selectedProcessFilter = '';
      selectedSubprocessFilter = '';
      document.getElementById('subprocess-filter').innerHTML = '<option value="">All Sub-processes</option>';
      applyAgentFilters();
    }
    
    function onProcessFilterChange(processName) {
      selectedProcessFilter = processName;
      selectedSubprocessFilter = '';
      
      // Populate sub-process dropdown based on agents with matching processName
      populateSubprocessFilter(processName);
      applyAgentFilters();
    }
    
    function populateSubprocessFilter(processName) {
      const select = document.getElementById('subprocess-filter');
      
      if (!processName) {
        select.innerHTML = '<option value="">All Sub-processes</option>';
        return;
      }
      
      // Get unique sub-processes from agents matching this process
      const subprocesses = [...new Set(
        agents
          .filter(a => a.config?.processName === processName && a.config?.subProcessName)
          .map(a => a.config.subProcessName)
      )].sort();
      
      if (subprocesses.length === 0) {
        select.innerHTML = '<option value="">All Sub-processes</option>';
        return;
      }
      
      select.innerHTML = '<option value="">All Sub-processes</option>' +
        subprocesses.map(sp => `<option value="${escapeHtml(sp)}">${escapeHtml(sp)}</option>`).join('');
    }
    
    function onSubprocessFilterChange(subprocessName) {
      selectedSubprocessFilter = subprocessName;
      applyAgentFilters();
    }
    
    function applyAgentFilters() {
      let filtered = [...agents];
      
      // Filter by foundation (match processName to foundation processes)
      if (currentFoundation?.processes?.length) {
        const foundationProcessNames = currentFoundation.processes.map(p => p.name);
        // Only filter if we have a foundation selected - show agents whose processName matches foundation processes
        // OR show all if agent has no processName (legacy agents)
        filtered = filtered.filter(a => 
          !a.config?.processName || foundationProcessNames.includes(a.config.processName)
        );
      }
      
      // Filter by process
      if (selectedProcessFilter) {
        filtered = filtered.filter(a => a.config?.processName === selectedProcessFilter);
      }
      
      // Filter by sub-process
      if (selectedSubprocessFilter) {
        filtered = filtered.filter(a => a.config?.subProcessName === selectedSubprocessFilter);
      }
      
      // Update status text
      const statusEl = document.getElementById('agent-filter-status');
      if (selectedProcessFilter || selectedSubprocessFilter) {
        statusEl.textContent = `Showing ${filtered.length} of ${agents.length} agents`;
      } else if (currentFoundation) {
        statusEl.textContent = `${filtered.length} agents`;
      } else {
        statusEl.textContent = '';
      }
      
      // Re-render agent list with filtered agents
      renderAgentList(filtered);
      
      // Also update the graph with filtered agents
      initGraph();
    }
    
    function renderFoundationItems(items, type) {
      if (!items || items.length === 0) {
        return '<div style="color: #64748b; font-size: 0.8rem; padding: 0.5rem;">No items</div>';
      }
      
      const colors = {
        capability: '#22d3ee',
        data: '#a78bfa',
        process: '#f59e0b'
      };
      
      return items.map(item => `
        <div class="foundation-item" style="
          padding: 0.4rem 0.5rem;
          margin-bottom: 0.25rem;
          background: #0f172a;
          border-radius: 4px;
          border-left: 3px solid ${colors[type]};
          cursor: pointer;
          font-size: 0.8rem;
        " title="${item.description || ''}">
          <div style="font-weight: 500; color: #e2e8f0;">${item.name}</div>
          ${item.description ? `<div style="font-size: 0.7rem; color: #64748b; margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.description}</div>` : ''}
        </div>
      `).join('');
    }
    
    function showFoundationTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.foundation-tab').forEach(btn => {
        const isActive = btn.dataset.tab === tab;
        btn.style.background = isActive ? '#334155' : '#1e293b';
        btn.style.color = isActive ? '#e2e8f0' : '#94a3b8';
      });
      
      // Show/hide lists
      ['capabilities', 'dataObjects', 'processes'].forEach(t => {
        const list = document.getElementById(`foundation-${t}-list`);
        if (list) list.style.display = t === tab ? 'block' : 'none';
      });
    }
    
    // ============================================================================
    // Data Loading
    // ============================================================================

    function getAuthHeaders(extra = {}) {
      const accessToken = getAccessToken();
      return accessToken
        ? { ...extra, Authorization: `Bearer ${accessToken}` }
        : { ...extra };
    }
    
    async function loadAgents() {
      try {
        // Cache-bust to ensure fresh data after wizard completion
        const cacheBuster = `_t=${Date.now()}`;
        const response = await fetch(`${API_BASE}?limit=500&${cacheBuster}`, { 
          headers: getAuthHeaders(),
          cache: 'no-store'
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const payload = await response.json();
        const rawAgents = Array.isArray(payload)
          ? payload
          : Array.isArray(payload?.data)
            ? payload.data
            : [];

        console.log('[loadAgents] Raw response sample:', rawAgents.slice(0, 3).map(a => ({ name: a.name, elementType: a.elementType })));
        
        agents = rawAgents.map((agent) => ({
          ...agent,
          id: agent.id,
          name: agent.name || 'Unnamed agent',
          type: normalizeNodeType(agent.type),
          elementType: agent.elementType || 'Agent',
          pattern: agent.pattern || agent.config?.pattern || 'tool-use',
          purpose: agent.purpose || agent.description || '',
          valueStream: agent.valueStream || agent.config?.valueStream || '',
          capabilityGroup: agent.capabilityGroup || agent.config?.capabilityGroup || '',
          objectives: Array.isArray(agent.objectives) ? agent.objectives : [],
          kpis: Array.isArray(agent.kpis) ? agent.kpis : [],
          integrations: Array.isArray(agent.integrations) ? agent.integrations : [],
          status: agent.status || 'configured',
        }));

        renderElementList();
      } catch (error) {
        console.error('[loadAgents] Error:', error);
        agents = [];
        renderElementList();
      }
    }
    
    async function loadRelationships() {
      try {
        const cacheBuster = `_t=${Date.now()}`;
        const [relationshipsRes, interactionsRes] = await Promise.all([
          fetch(`${API_BASE}/relationships?${cacheBuster}`, { headers: getAuthHeaders(), cache: 'no-store' }),
          fetch(`/api/agent-interactions?${cacheBuster}`, { headers: getAuthHeaders(), cache: 'no-store' }),
        ]);

        const allRaw = [];

        if (relationshipsRes.ok) {
          const payload = await relationshipsRes.json();
          allRaw.push(...(Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : [])));
        }

        if (interactionsRes.ok) {
          const payload = await interactionsRes.json();
          allRaw.push(...(Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : [])));
        }

        const dedupe = new Map();
        allRaw.forEach((relation) => {
          const normalized = {
            id: relation.id,
            sourceId: relation.sourceId || relation.source_agent_id || relation.sourceAgentId,
            targetId: relation.targetId || relation.target_agent_id || relation.targetAgentId,
            type: relation.type || relation.message_type || relation.messageType || 'message',
            description: relation.description || '',
            config: relation.config || {},
          };
          if (normalized.sourceId && normalized.targetId) {
            dedupe.set(normalized.id || `${normalized.sourceId}:${normalized.targetId}:${normalized.type}`, normalized);
          }
        });

        relationships = Array.from(dedupe.values());
      } catch (error) {
        console.error('[loadRelationships] Error:', error);
        relationships = [];
      }
    }
    
    // ============================================================================
    // Element List Rendering
    // ============================================================================
    
    function renderElementList() {
      // Use filters if active, otherwise show all
      applyAgentFilters();
    }
    
    function renderAgentList(filteredAgents) {
      const container = document.getElementById('element-list');
      const filtered = filteredAgents || agents;
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîç</div>
            <p>No agents found</p>
            ${selectedProcessFilter || selectedSubprocessFilter ? '<p style="font-size: 0.75rem; color: #64748b;">Try adjusting filters</p>' : ''}
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(a => `
        <div class="element-item ${a.id === selectedAgentId ? 'selected' : ''}" 
             onclick="selectAgent('${a.id}')"
             data-id="${a.id}">
          <span class="element-name">${escapeHtml(a.name)}</span>
          <span class="element-type">
            <span style="width: 8px; height: 8px; border-radius: 2px; background: ${nodeColors[a.elementType] || nodeColors.default};"></span>
            ${a.elementType || 'Agent'}
          </span>
          ${a.config?.subProcessName ? `<span style="font-size: 0.65rem; color: #64748b; display: block; margin-top: 2px;">${escapeHtml(a.config.subProcessName)}</span>` : ''}
        </div>
      `).join('');
    }

    // ============================================================================
    // Distribution Chart (Donut)
    // ============================================================================

    function updateDistributionChart() {
      const canvas = document.getElementById('distribution-chart');
      const legendContainer = document.getElementById('chart-legend');
      
      if (!canvas || !legendContainer) return;

      // Count elements by type
      const typeCounts = {};
      agents.forEach(a => {
        const type = a.type || 'Unknown';
        typeCounts[type] = (typeCounts[type] || 0) + 1;
      });

      const labels = Object.keys(typeCounts);
      const data = Object.values(typeCounts);
      const colors = labels.map(label => elementTypeColors[label] || '#64748b');

      // Destroy existing chart if any
      if (distributionChart) {
        distributionChart.destroy();
      }

      // Create new chart
      const ctx = canvas.getContext('2d');
      distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: '#1e293b',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          cutout: '60%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#1e293b',
              titleColor: '#f1f5f9',
              bodyColor: '#cbd5e1',
              borderColor: '#334155',
              borderWidth: 1,
            }
          }
        }
      });

      // Update legend
      legendContainer.innerHTML = labels.map((label, i) => `
        <div class="chart-legend-item">
          <div class="chart-legend-color" style="background: ${colors[i]};"></div>
          <span>${escapeHtml(label)}</span>
        </div>
      `).join('');
    }
    
    // ============================================================================
    // Graph Visualization
    // ============================================================================
    
    function initGraph() {
      const container = document.getElementById('graph-container');

      // Apply foundation/process/subprocess filters first, then type visibility
      let filteredAgents = [...agents];
      
      // Filter by foundation processes
      if (currentFoundation?.processes?.length) {
        const foundationProcessNames = currentFoundation.processes.map(p => p.name);
        filteredAgents = filteredAgents.filter(a => 
          !a.config?.processName || foundationProcessNames.includes(a.config.processName)
        );
      }
      
      // Filter by selected process
      if (selectedProcessFilter) {
        filteredAgents = filteredAgents.filter(a => a.config?.processName === selectedProcessFilter);
      }
      
      // Filter by selected subprocess
      if (selectedSubprocessFilter) {
        filteredAgents = filteredAgents.filter(a => a.config?.subProcessName === selectedSubprocessFilter);
      }
      
      // Then apply type visibility filter
      const visibleAgents = filteredAgents.filter(a => !hiddenTypes.has(a.elementType || a.type));
      if (visibleAgents.length === 0) {
        if (network) {
          network.destroy();
          network = null;
        }
        setGraphState('empty');
        return;
      }

      const nodes = new vis.DataSet(
        visibleAgents.map(a => {
          const elemType = a.elementType || a.type || 'default';
          const bgColor = nodeColors[elemType] || nodeColors.default;
          return {
            id: a.id,
            label: a.name,
            color: {
              background: bgColor,
              border: bgColor,
              highlight: { background: bgColor, border: '#ffffff' },
              hover: { background: bgColor, border: '#ffffff' }
            },
            font: { color: '#ffffff', size: 11, face: 'Inter, sans-serif' },
            shape: 'box',
            borderWidth: 2,
            borderWidthSelected: 3,
            margin: 8,
            title: elemType, // tooltip shows element type
          };
        })
      );
      
      const edges = new vis.DataSet(
        relationships
          .filter(r => {
            if (hiddenRelations.has(r.type)) return false;
            const source = agents.find(a => a.id === r.sourceId);
            const target = agents.find(a => a.id === r.targetId);
            return source && target && !hiddenTypes.has(source.elementType || source.type) && !hiddenTypes.has(target.elementType || target.type);
          })
          .map(r => {
            const edgeColor = relationColors[r.type] || relationColors.default;
            return {
              id: r.id,
              from: r.sourceId,
              to: r.targetId,
              label: r.type,
              arrows: { to: { enabled: true, scaleFactor: 0.6, type: 'arrow' } },
              color: { color: edgeColor, highlight: edgeColor, hover: edgeColor },
              font: { color: '#94a3b8', size: 9, align: 'middle', strokeWidth: 0 },
              smooth: { type: 'curvedCW', roundness: 0.2 },
              width: 2,
            };
          })
      );
      
      const options = {
        nodes: {
          shadow: false,
          margin: 8,
        },
        edges: {
          shadow: false,
        },
        physics: {
          enabled: true,
          barnesHut: {
            gravitationalConstant: -3000,
            centralGravity: 0.2,
            springLength: 180,
            springConstant: 0.03,
            damping: 0.15,
          },
          stabilization: { iterations: 150 },
        },
        interaction: {
          hover: true,
          tooltipDelay: 200,
          zoomView: true,
          dragView: true,
        },
      };
      
      network = new vis.Network(container, { nodes, edges }, options);
      
      network.on('click', function(params) {
        if (params.nodes.length > 0) {
          selectAgent(params.nodes[0]);
        }
      });
      
      network.on('doubleClick', function(params) {
        if (params.nodes.length > 0) {
          network.focus(params.nodes[0], { scale: 1.5, animation: true });
        }
      });

      // Update graph stats
      const nodeCountEl = document.getElementById('graph-node-count');
      const edgeCountEl = document.getElementById('graph-edge-count');
      if (nodeCountEl) nodeCountEl.textContent = nodes.length;
      if (edgeCountEl) edgeCountEl.textContent = edges.length;

      setGraphState('ready');
    }

    function renderInteractionLegend() {
      const container = document.getElementById('interaction-legend-items');
      if (!container) return;

      const visibleRelationships = relationships.filter(r => {
        const source = agents.find(a => a.id === r.sourceId);
        const target = agents.find(a => a.id === r.targetId);
        return source && target && !hiddenTypes.has(source.elementType || source.type) && !hiddenTypes.has(target.elementType || target.type);
      });

      const types = [...new Set(visibleRelationships.map(r => r.type).filter(Boolean))].sort();

      if (types.length === 0) {
        container.innerHTML = '<span style="font-size: 0.75rem; color: #64748b;">No interactions to display</span>';
        return;
      }

      container.innerHTML = types.map(type => `
        <div class="legend-item" title="${escapeHtml(type)}">
          <div class="legend-color" style="background: ${relationColors[type] || relationColors.default};"></div>
          <span>${escapeHtml(type)}</span>
        </div>
      `).join('');
    }
    
    function toggleLegend(type) {
      const item = document.querySelector(`.legend-item[data-type="${type}"]`);
      if (hiddenTypes.has(type)) {
        hiddenTypes.delete(type);
        if (item) item.classList.remove('disabled');
      } else {
        hiddenTypes.add(type);
        if (item) item.classList.add('disabled');
      }
      initGraph();
    }

    function toggleRelationLegend(relType) {
      const item = document.querySelector(`.legend-item[data-relation="${relType}"]`);
      if (hiddenRelations.has(relType)) {
        hiddenRelations.delete(relType);
        if (item) item.classList.remove('disabled');
      } else {
        hiddenRelations.add(relType);
        if (item) item.classList.add('disabled');
      }
      initGraph();
    }

    function renderGraphLegend() {
      // Get unique element types from data
      const elementTypes = [...new Set(agents.map(a => a.elementType || a.type).filter(Boolean))].sort();
      const relationTypes = [...new Set(relationships.map(r => r.type).filter(Boolean))].sort();

      // Render element legend
      const elemRow = document.getElementById('elements-legend-row');
      if (elemRow) {
        elemRow.innerHTML = '<span class="legend-label">ELEMENTS:</span>' + 
          elementTypes.map(type => {
            const color = nodeColors[type] || nodeColors.default;
            const disabled = hiddenTypes.has(type) ? 'disabled' : '';
            return `<div class="legend-item ${disabled}" data-type="${type}" onclick="toggleLegend('${type}')"><div class="legend-color" style="background: ${color};"></div><span>${type}</span></div>`;
          }).join('');
      }

      // Render relation legend
      const relRow = document.getElementById('relations-legend-row');
      if (relRow) {
        relRow.innerHTML = '<span class="legend-label">RELATIONS:</span>' + 
          relationTypes.map(type => {
            const color = relationColors[type] || relationColors.default;
            const disabled = hiddenRelations.has(type) ? 'disabled' : '';
            return `<div class="legend-item ${disabled}" data-relation="${type}" onclick="toggleRelationLegend('${type}')"><div class="legend-line" style="background: ${color};"></div><span>${type}</span></div>`;
          }).join('');
      }
    }
    
    // ============================================================================
    // Agent Selection & Detail View
    // ============================================================================
    
    async function selectAgent(id) {
      selectedAgentId = id;
      let agent = agents.find(a => a.id === id);
      const detailPanel = document.getElementById('detail-panel');
      
      // Fetch full agent details (includes integrations, capabilities)
      if (agent && !agent._detailsLoaded) {
        try {
          const response = await fetch(`${API_BASE}/${id}`, { headers: getAuthHeaders() });
          if (response.ok) {
            const details = await response.json();
            console.log('[selectAgent] Loaded details:', { id, skills: details.skills?.length, capabilities: details.capabilities?.length, integrations: details.integrations?.length });
            // Explicitly copy key fields
            agent.skills = details.skills || [];
            agent.capabilities = details.capabilities || [];
            agent.integrations = details.integrations || [];
            agent.interactions = details.interactions || [];
            agent.config = details.config || agent.config;
            agent.description = details.description || agent.description;
            agent._detailsLoaded = true;
          } else {
            console.warn('[selectAgent] Failed to load details:', response.status);
          }
        } catch (err) {
          console.warn('Failed to load agent details:', err);
        }
      }
      
      if (!agent) {
        document.getElementById('detail-empty').style.display = 'block';
        document.getElementById('detail-content').style.display = 'none';
        loadA2ACard(null); // Clear A2A card
        return;
      }
      
      // Only show right panel for Agent elements
      const isAgent = agent.elementType === 'Agent' || !agent.elementType;
      if (detailPanel) {
        detailPanel.style.display = isAgent ? 'flex' : 'none';
      }
      
      // Update workspace panels regardless of element type
      updateWorkspacePanels(agent);
      renderRelationships(id);
      
      // Highlight in list
      renderElementList();
      
      // Focus in graph
      if (network) {
        network.selectNodes([id]);
      }
      
      // If not an Agent, don't populate the right panel
      if (!isAgent) {
        return;
      }
      
      document.getElementById('detail-empty').style.display = 'none';
      document.getElementById('detail-content').style.display = 'block';
      
      // Get config
      const config = agent.config || {};
      
      // Update header
      document.getElementById('detail-name').textContent = agent.name;
      const patternBadge = config.pattern ? `<span class="badge">${config.pattern}</span>` : '';
      document.getElementById('detail-type').innerHTML = `${getTypeIcon(agent.type)} ${agent.type} ${patternBadge}`;
      
      // === DESCRIPTION TAB ===
      document.getElementById('agent-display-name').value = agent.name || '';
      document.getElementById('agent-short-desc').value = config.shortDescription || '';
      document.getElementById('agent-purpose').value = config.detailedPurpose || agent.description || '';
      document.getElementById('agent-business-value').value = config.businessValue || '';
      document.getElementById('agent-success-criteria').value = config.successCriteria || '';
      
      // Update Capabilities section in Description tab
      const capsContainer = document.getElementById('agent-capabilities-list');
      const caps = agent.capabilities || [];
      capsContainer.innerHTML = caps.length 
        ? caps.map(c => `<span class="capability-tag" style="background: #164e63; color: #22d3ee; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${escapeHtml(c.capability_name || c.name || c)}</span>`).join('')
        : '<span style="color: #64748b; font-size: 0.85rem;">No capabilities</span>';
      
      // Update Skills section (A2A Protocol)
      renderSkillsList(agent);
      
      // Hide Process Info section
      const processSection = document.getElementById('process-info-section');
      if (processSection) processSection.style.display = 'none';
      
      // === DESIGN TAB ===
      document.getElementById('agent-pattern-design').value = config.pattern || '';
      document.getElementById('agent-decision-design').value = config.decisionAuthority || '';
      document.getElementById('agent-autonomy-design').value = config.autonomyLevel || '';
      document.getElementById('agent-valuestream-design').value = config.valueStream || '';
      document.getElementById('agent-capgroup-design').value = config.capabilityGroup || '';
      document.getElementById('agent-objectives-design').value = (config.objectives || []).join('\n');
      document.getElementById('agent-kpis-design').value = (config.kpis || []).join('\n');
      
      // === CONFIGURE TAB ===
      document.getElementById('agent-interaction-config').value = config.interactionPattern || '';
      document.getElementById('agent-triggers-config').value = (config.triggers || []).join(', ');
      document.getElementById('agent-outputs-config').value = (config.outputs || []).join(', ');
      
      // Tag fields
      tagData['listen-topics'] = [...(config.listenTopics || [])];
      tagData['publish-topics'] = [...(config.publishTopics || [])];
      renderTags('listen-topics');
      renderTags('publish-topics');
      document.getElementById('agent-message-types-config').value = (config.messageTypes || []).join(', ');
      
      // Data store
      const ds = config.dataStore || {};
      document.getElementById('agent-db-name-config').value = ds.database || 'flowgrid-agents';
      document.getElementById('col-memory').checked = ds.collections?.memory ?? true;
      document.getElementById('col-state').checked = ds.collections?.state ?? true;
      document.getElementById('col-tasks').checked = ds.collections?.tasks ?? true;
      document.getElementById('col-decisions').checked = ds.collections?.decisions ?? true;
      document.getElementById('agent-partition-key-config').value = ds.partitionKey || '/tenantId';
      
      // Model config
      const mc = config.modelConfig || {};
      document.getElementById('agent-model-provider').value = mc.provider || 'azure-openai';
      document.getElementById('agent-model-config').value = mc.deployment || config.llm?.defaultModel || '';
      document.getElementById('agent-system-prompt-config').value = mc.systemPrompt || config.detailedPurpose || agent.description || '';
      document.getElementById('agent-max-tokens-config').value = mc.maxTokens || 4096;
      document.getElementById('agent-temperature-config').value = mc.temperature ?? 0.3;
      document.getElementById('temp-value').textContent = mc.temperature ?? 0.3;
      updateModelSuggestions();
      showModelRecommendation(config.pattern);
      
      // HITL
      const hitl = config.hitl || {};
      document.getElementById('agent-hitl-required').checked = hitl.approvalRequired || false;
      document.getElementById('hitl-details').style.display = hitl.approvalRequired ? 'block' : 'none';
      document.getElementById('agent-hitl-threshold').value = hitl.approvalThreshold || 'high-risk-only';
      document.getElementById('agent-hitl-timeout').value = hitl.timeoutMinutes || 60;
      populateEscalationTargets();
      if (hitl.escalationTarget) document.getElementById('agent-hitl-escalation').value = hitl.escalationTarget;
      
      // Config integrations list
      const configIntList = document.getElementById('config-integrations-list');
      const ints = agent.integrations || [];
      const demotedToolsList = agent.tools || [];
      const intHtml = ints.map(i => `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;"><span>üîå</span><span style="color:#e2e8f0;font-size:0.85rem;">${escapeHtml(i.integration_name || i.integration_type)}</span></div>`).join('');
      const demotedHtml = demotedToolsList.map(t => `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0;"><span>üîß</span><div><span style="color:#e2e8f0;font-size:0.85rem;">${escapeHtml(t.name)}</span><span style="color:#64748b;font-size:0.75rem;"> (from ${escapeHtml(t.originalAgent || 'demoted agent')})</span></div></div>`).join('');
      configIntList.innerHTML = (intHtml + demotedHtml) || '<p style="color: #64748b; font-size: 0.85rem;">No tools configured</p>';

      // === VERIFY TAB ===
      updateVerifyChecklist(agent);

      // === DEPLOY TAB ===
      updateDeployStatus(agent);

      // === CODE TAB ===
      // Load manifest if exists
      if (config.manifest) {
        renderManifest(config.manifest);
        const validation = validateManifest(config.manifest);
        renderManifestValidation(validation);
      } else {
        document.getElementById('manifest-display').textContent = '// Click "Generate Manifest" to assemble from Description + Design + Configure tabs';
        document.getElementById('manifest-validation-bar').style.display = 'none';
        document.getElementById('manifest-timestamp').textContent = '';
      }
      document.getElementById('manifest-edit-toggle').checked = false;
      document.getElementById('manifest-display').contentEditable = 'false';
      document.getElementById('bicep-container').style.display = 'none';
      
      // Load saved code if exists
      const codeEl = document.getElementById('agent-code');
      if (config.generatedCode) {
        codeEl.textContent = config.generatedCode;
      } else {
        codeEl.textContent = '// Generate manifest first, then generate Function App code';
      }
      
      // Deploy tab manifest status
      updateDeployManifestStatus(agent);
      if (config.manifest) updateDeployInfraRequirements(config.manifest);
      
      // === BPMN TAB ===
      // If BPMN tab is active, refresh to show the selected agent's BPMN
      const bpmnTab = document.getElementById('tab-bpmn');
      if (bpmnTab && bpmnTab.style.display !== 'none') {
        // Update the process list and auto-select this agent
        renderBpmnProcessList();
        selectBpmnProcess(id);
      }
    }
    
    function getTypeIcon(type) {
      const icons = {
        'Agent': 'ü§ñ',
        'Capability': 'üì¶',
        'DataObject': 'üìÑ',
        'Process': 'üîÑ',
      };
      return icons[type] || 'üìã';
    }

    function updateWorkspacePanels(agent) {
      // Update Overview tab
      renderOverview(agent);
      
      // Update Skills tab
      renderWorkspaceSkills(agent);
      
      // Update workspace relationships
      const relationsContainer = document.getElementById('workspace-relations');
      if (relationsContainer) {
        const outgoing = relationships.filter(r => r.sourceId === agent.id);
        const incoming = relationships.filter(r => r.targetId === agent.id);
        
        relationsContainer.innerHTML = `
          <h4>Relationships for ${escapeHtml(agent.name)}</h4>
          <div style="font-size:0.75rem;color:#94a3b8;margin:.35rem 0;">OUTGOING (${outgoing.length})</div>
          ${outgoing.length ? outgoing.map(r => {
            const target = agents.find(a => a.id === r.targetId);
            return `<div class="relationship-item"><span class="relationship-type">${escapeHtml(r.type || 'message')}</span><span>‚Üí</span><span class="relationship-target" onclick="selectAgent('${r.targetId}')">${escapeHtml(target?.name || 'Unknown')}</span></div>`;
          }).join('') : '<p style="color:#64748b;font-size:0.85rem;">No outgoing relationships</p>'}
          <div style="font-size:0.75rem;color:#94a3b8;margin:.75rem 0 .35rem;">INCOMING (${incoming.length})</div>
          ${incoming.length ? incoming.map(r => {
            const source = agents.find(a => a.id === r.sourceId);
            return `<div class="relationship-item"><span class="relationship-target" onclick="selectAgent('${r.sourceId}')">${escapeHtml(source?.name || 'Unknown')}</span><span>‚Üí</span><span class="relationship-type">${escapeHtml(r.type || 'message')}</span></div>`;
          }).join('') : '<p style="color:#64748b;font-size:0.85rem;">No incoming relationships</p>'}
        `;
      }

      // Update workspace integrations (using catalog-based UI)
      loadSuggestedIntegrations(agent.id);
      
      // Update A2A Card panel
      loadA2ACard(agent.id);
      
      // Update BPMN tab with selected agent's BPMN
      loadAgentBpmn(agent);
    }
    
    // ============================================================================
    // A2A Card Functions
    // ============================================================================
    
    let currentA2ACard = null;
    
    async function loadA2ACard(agentId) {
      const noSelection = document.getElementById('a2a-no-selection');
      const content = document.getElementById('a2a-card-content');
      const codeEl = document.getElementById('a2a-card-code');
      
      if (!agentId) {
        noSelection.style.display = 'block';
        content.style.display = 'none';
        currentA2ACard = null;
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/${agentId}/a2a-card`, { headers: getAuthHeaders() });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        currentA2ACard = await response.json();
        
        // Pretty print with syntax highlighting
        const formatted = JSON.stringify(currentA2ACard, null, 2);
        codeEl.innerHTML = syntaxHighlightJSON(formatted);
        
        noSelection.style.display = 'none';
        content.style.display = 'block';
      } catch (error) {
        console.error('[A2A Card] Load error:', error);
        codeEl.textContent = `Error loading A2A card: ${error.message}`;
        noSelection.style.display = 'none';
        content.style.display = 'block';
        currentA2ACard = null;
      }
    }
    
    function syntaxHighlightJSON(json) {
      return json
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?)/g, (match) => {
          let cls = 'color: #a5d6ff;'; // string
          if (/:$/.test(match)) {
            cls = 'color: #7ee787;'; // key
          }
          return `<span style="${cls}">${match}</span>`;
        })
        .replace(/\b(true|false)\b/g, '<span style="color: #ff7b72;">$1</span>')
        .replace(/\b(null)\b/g, '<span style="color: #ff7b72;">$1</span>')
        .replace(/\b(\d+)\b/g, '<span style="color: #79c0ff;">$1</span>');
    }
    
    function copyA2ACard() {
      if (!currentA2ACard) {
        alert('No A2A card loaded');
        return;
      }
      
      const json = JSON.stringify(currentA2ACard, null, 2);
      navigator.clipboard.writeText(json).then(() => {
        alert('‚úÖ A2A Card copied to clipboard!');
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('‚ùå Failed to copy to clipboard');
      });
    }
    
    function downloadA2ACard() {
      if (!currentA2ACard) {
        alert('No A2A card loaded');
        return;
      }
      
      const json = JSON.stringify(currentA2ACard, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentA2ACard.name?.toLowerCase().replace(/\s+/g, '-') || 'agent'}-a2a-card.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    function renderRelationships(agentId) {
      // This updates the Configure tab's interactions section
      renderInteractions(agentId);
      
      // Also update the workspace Relationships tab
      renderWorkspaceRelationships(agentId);
    }
    
    function renderWorkspaceRelationships(agentId) {
      const emptyEl = document.getElementById('relationships-empty');
      const contentEl = document.getElementById('relationships-content');
      const outgoingHeader = document.getElementById('outgoing-header');
      const incomingHeader = document.getElementById('incoming-header');
      const outgoingList = document.getElementById('outgoing-list');
      const incomingList = document.getElementById('incoming-list');
      
      if (!contentEl) return;
      
      const agent = agents.find(a => a.id === agentId);
      if (!agent) {
        if (emptyEl) emptyEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }
      
      if (emptyEl) emptyEl.style.display = 'none';
      contentEl.style.display = 'block';
      
      const outgoing = relationships.filter(r => r.sourceId === agentId);
      const incoming = relationships.filter(r => r.targetId === agentId);
      
      // Update headers
      if (outgoingHeader) outgoingHeader.textContent = `Outgoing ‚Üí (${outgoing.length})`;
      if (incomingHeader) incomingHeader.textContent = `‚Üê Incoming (${incoming.length})`;
      
      const relationTypeColors = {
        'Realization': '#f97316',
        'Flow': '#3b82f6',
        'Association': '#eab308',
        'Composition': '#ec4899',
        'Access': '#ef4444',
        'Serving': '#14b8a6',
        'default': '#64748b'
      };
      
      function renderRelationCard(r, isOutgoing) {
        const otherAgent = isOutgoing 
          ? agents.find(a => a.id === r.targetId)
          : agents.find(a => a.id === r.sourceId);
        const typeColor = relationTypeColors[r.type] || relationTypeColors.default;
        const elementType = otherAgent?.elementType || otherAgent?.type || 'Unknown';
        
        return `
          <div style="background: #1e293b; border-left: 3px solid ${typeColor}; padding: 0.75rem 1rem; border-radius: 4px; cursor: pointer;" 
               onclick="selectAgent('${otherAgent?.id}')" 
               onmouseover="this.style.background='#334155'" 
               onmouseout="this.style.background='#1e293b'">
            <div style="color: ${typeColor}; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(r.type || 'Association')}</div>
            <div style="color: #e2e8f0; font-size: 0.9rem;">${escapeHtml(otherAgent?.name || 'Unknown')} <span style="color: #64748b;">(${elementType})</span></div>
          </div>
        `;
      }
      
      // Render outgoing
      if (outgoingList) {
        outgoingList.innerHTML = outgoing.length === 0 
          ? '<p style="color: #64748b; font-size: 0.85rem; padding: 1rem;">No outgoing relationships</p>'
          : outgoing.map(r => renderRelationCard(r, true)).join('');
      }
      
      // Render incoming
      if (incomingList) {
        incomingList.innerHTML = incoming.length === 0 
          ? '<p style="color: #64748b; font-size: 0.85rem; padding: 1rem;">No incoming relationships</p>'
          : incoming.map(r => renderRelationCard(r, false)).join('');
      }
    }
    
    function renderInteractions(agentId) {
      const container = document.getElementById('interactions-list');
      if (!container) return;

      const relevant = relationships.filter(r => r.sourceId === agentId || r.targetId === agentId);

      if (!relevant.length) {
        container.innerHTML = '<div class="empty-state" style="padding: 1rem;"><p>No interaction contracts found</p></div>';
        return;
      }

      container.innerHTML = relevant.map((r) => {
        const source = agents.find(a => a.id === r.sourceId);
        const target = agents.find(a => a.id === r.targetId);
        const direction = r.sourceId === agentId ? 'outbound' : 'inbound';
        return `
          <div class="relationship-item" style="display:flex; flex-direction:column; gap:0.25rem;">
            <div style="display:flex; justify-content:space-between; gap:0.5rem;">
              <span class="relationship-type">${escapeHtml(r.type || 'message')}</span>
              <span style="font-size:0.7rem; color:#94a3b8; text-transform:uppercase;">${direction}</span>
            </div>
            <div style="font-size:0.8rem; color:#cbd5e1;">
              ${escapeHtml(source?.name || 'Unknown')} ‚Üí ${escapeHtml(target?.name || 'Unknown')}
            </div>
            ${r.description ? `<div style="font-size:0.75rem; color:#94a3b8;">${escapeHtml(r.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderIntegrations(agent) {
      const container = document.getElementById('integrations-list');
      const integrations = agent.integrations || [];
      
      if (integrations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üîå</div>
            <p>No integrations configured</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = integrations.map(int => `
        <div class="integration-item">
          <div class="integration-name">
            <span>${int.icon || 'üîå'}</span>
            <span>${int.name}</span>
            <span class="integration-badge">${int.type}</span>
          </div>
          <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Configure</button>
        </div>
      `).join('');
    }

    function updateVerifyStatus(agent) {
      const statusEl = document.getElementById('verify-status');
      const resultsEl = document.getElementById('verify-results');
      
      const checks = [
        { name: 'Purpose defined', pass: !!agent.purpose },
        { name: 'Pattern selected', pass: !!agent.pattern },
        { name: 'Value stream assigned', pass: !!agent.valueStream },
        { name: 'Has integrations', pass: (agent.integrations || []).length > 0 },
      ];
      
      const passed = checks.filter(c => c.pass).length;
      const total = checks.length;
      
      statusEl.textContent = `${passed}/${total} checks passed`;
      resultsEl.innerHTML = checks.map(c => `
        <div class="relationship-item" style="justify-content: space-between;">
          <span>${escapeHtml(c.name)}</span>
          <span style="color: ${c.pass ? '#10b981' : '#f59e0b'};">${c.pass ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      `).join('');
    }

    function updateDeployStatus(agent) {
      // Call the full deploy status renderer
      renderDeployStatus(agent);
    }
    
    function generateAgentCode(agent) {
      const code = `# Agent: ${agent.name}
# Type: ${agent.type}
# Pattern: ${agent.pattern || 'general'}

## System Prompt

You are ${agent.name}, an AI agent in the Flowgrid platform.

### Purpose
${agent.purpose || 'No purpose defined'}

### Value Stream
${agent.valueStream || 'Not specified'}

### Capability Group  
${agent.capabilityGroup || 'Not specified'}

### Objectives
${(agent.objectives || ['No objectives defined']).map(o => `- ${o}`).join('\n')}

### Behavior Guidelines
- Follow the ${agent.pattern || 'general'} pattern
- Maintain audit trail of all actions
- Escalate when confidence is low
- Respect rate limits and quotas

### Integration Points
${(agent.integrations || []).map(i => `- ${i.name} (${i.type})`).join('\n') || '- None configured'}
`;
      
      document.getElementById('agent-code').textContent = code;
    }
    
    // ============================================================================
    // Tab Navigation
    // ============================================================================
    
    function showDetailTab(tabName) {
      document.querySelectorAll('#detail-content .detail-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      document.querySelectorAll('#detail-content .tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`)?.classList.add('active');
      
      // Refresh manifest status when switching to Code or Deploy
      if ((tabName === 'code' || tabName === 'deploy') && selectedAgentId) {
        const agent = agents.find(a => a.id === selectedAgentId);
        if (agent) {
          updateDeployManifestStatus(agent);
          if (agent.config?.manifest) {
            updateDeployInfraRequirements(agent.config.manifest);
            if (tabName === 'code') renderManifest(agent.config.manifest);
          }
        }
      }
      // Populate escalation targets when switching to Configure
      if (tabName === 'configure') {
        populateEscalationTargets();
        if (selectedAgentId) {
          const agent = agents.find(a => a.id === selectedAgentId);
          showModelRecommendation(agent?.config?.pattern);
        }
      }
    }

    function showWorkspaceTab(tabName) {
      document.querySelectorAll('.workspace-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      document.querySelectorAll('.workspace-panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(`workspace-${tabName}`)?.classList.add('active');
      
      if (tabName === 'graph' && network) {
        setTimeout(() => network.fit({ animation: { duration: 300 } }), 50);
      }
      
      // Re-fit BPMN when switching to BPMN tab
      if (tabName === 'bpmn' && bpmnModeler) {
        const fitBpmn = () => {
          try { bpmnModeler.get('canvas').zoom('fit-viewport'); } catch(e) {}
        };
        setTimeout(fitBpmn, 50);
        setTimeout(fitBpmn, 150);
      }
      
      // Render skills when switching to skills tab
      if (tabName === 'skills' && selectedAgentId) {
        const agent = agents.find(a => a.id === selectedAgentId);
        if (agent) renderWorkspaceSkills(agent);
      }
    }
    
    function renderOverview(agent) {
      const noSelection = document.getElementById('overview-no-selection');
      const content = document.getElementById('overview-agent-content');
      
      if (!agent) {
        if (noSelection) noSelection.style.display = 'block';
        if (content) content.style.display = 'none';
        return;
      }
      
      if (noSelection) noSelection.style.display = 'none';
      if (content) content.style.display = 'block';
      
      const config = agent.config || {};
      const skills = agent.skills || [];
      const caps = agent.capabilities || [];
      const tools = [...(agent.integrations || []), ...(agent.tools || [])];
      const agentRelations = relationships.filter(r => r.sourceId === agent.id || r.targetId === agent.id);
      
      // Set icon based on element type
      const icons = { Agent: 'ü§ñ', Capability: 'üì¶', DataObject: 'üíæ', Process: 'üîÑ' };
      document.getElementById('overview-icon').textContent = icons[agent.elementType] || 'ü§ñ';
      
      // Header
      document.getElementById('overview-name').textContent = agent.name;
      document.getElementById('overview-type-badge').textContent = agent.elementType || 'Agent';
      
      // Pattern badge
      const patternBadge = document.getElementById('overview-pattern-badge');
      if (config.pattern) {
        patternBadge.textContent = config.pattern;
        patternBadge.style.display = 'inline-block';
      } else {
        patternBadge.style.display = 'none';
      }
      
      // Description
      document.getElementById('overview-description').textContent = 
        config.detailedPurpose || agent.description || config.shortDescription || 'No description provided.';
      
      // Stats
      document.getElementById('overview-skills-count').textContent = skills.length;
      document.getElementById('overview-caps-count').textContent = caps.length;
      document.getElementById('overview-tools-count').textContent = tools.length;
      document.getElementById('overview-relations-count').textContent = agentRelations.length;
      
      // Configuration
      document.getElementById('overview-valuestream').textContent = config.valueStream || '‚Äî';
      document.getElementById('overview-autonomy').textContent = config.autonomyLevel || '‚Äî';
      document.getElementById('overview-decision').textContent = config.decisionAuthority || '‚Äî';
      document.getElementById('overview-interaction').textContent = config.interactionPattern || '‚Äî';
      
      // Skills preview (show first 3)
      const skillsPreview = document.getElementById('overview-skills-preview');
      if (skills.length > 0) {
        skillsPreview.innerHTML = skills.slice(0, 3).map(s => `
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0; border-bottom: 1px solid #334155;">
            <span style="color: #a78bfa;">‚ö°</span>
            <span style="color: #e2e8f0; font-size: 0.85rem;">${escapeHtml(s.display_name || s.name)}</span>
          </div>
        `).join('') + (skills.length > 3 ? `<div style="color: #64748b; font-size: 0.8rem; margin-top: 0.5rem;">+${skills.length - 3} more...</div>` : '');
      } else {
        skillsPreview.innerHTML = `
          <div style="text-align: center; padding: 1rem; color: #64748b;">
            <p style="margin-bottom: 0.5rem;">No skills defined</p>
            <button class="btn btn-sm btn-primary" style="font-size: 0.75rem;" onclick="showWorkspaceTab('skills'); generateSkillsWithAI();">ü§ñ Generate</button>
          </div>
        `;
      }
    }
    
    // ============================================================================
    // CRUD Operations
    // ============================================================================
    
    async function saveAgent() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      // Update from form
      agent.purpose = document.getElementById('agent-purpose').value;
      agent.valueStream = document.getElementById('agent-valuestream').value;
      agent.capabilityGroup = document.getElementById('agent-capgroup').value;
      agent.pattern = document.getElementById('agent-pattern').value;
      agent.objectives = document.getElementById('agent-objectives').value.split('\n').filter(o => o.trim());
      agent.kpis = document.getElementById('agent-kpis').value.split('\n').filter(k => k.trim());
      
      try {
        const response = await fetch(`${API_BASE}/${selectedAgentId}`, {
          method: 'PUT',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(agent),
        });
        
        if (response.ok) {
          showNotification('Agent saved successfully', 'success');
          generateAgentCode(agent);
          updateVerifyStatus(agent);
          updateStats();
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('[saveAgent] Error:', error);
        showNotification('Agent saved (demo mode)', 'success');
        generateAgentCode(agent);
        updateVerifyStatus(agent);
        updateStats();
      }
    }
    
    async function deleteAgent() {
      if (!selectedAgentId) return;
      
      if (!confirm('Are you sure you want to delete this agent?')) return;
      
      try {
        await fetch(`${API_BASE}/${selectedAgentId}`, { method: 'DELETE', headers: getAuthHeaders() });
        agents = agents.filter(a => a.id !== selectedAgentId);
        relationships = relationships.filter(r => r.sourceId !== selectedAgentId && r.targetId !== selectedAgentId);
        selectedAgentId = null;
        renderElementList();
        initGraph();
        updateStats();
        updateDistributionChart();
        document.getElementById('detail-empty').style.display = 'block';
        document.getElementById('detail-content').style.display = 'none';
        showNotification('Agent deleted', 'success');
      } catch (error) {
        console.error('[deleteAgent] Error:', error);
        showNotification('Delete failed (demo mode)', 'error');
      }
    }

    async function deployAgent() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;

      showNotification('Deploying agent...', 'info');
      
      // Simulate deployment
      setTimeout(() => {
        agent.status = 'deployed';
        updateDeployStatus(agent);
        updateStats();
        showNotification('Agent deployed successfully', 'success');
      }, 1500);
    }

    function runVerification() {
      if (!selectedAgentId) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;

      showNotification('Running verification...', 'info');
      
      setTimeout(() => {
        updateVerifyStatus(agent);
        showNotification('Verification complete', 'success');
      }, 500);
    }
    
    async function addIntegration() {
      if (!selectedAgentId) return;

      try {
        const catalogRes = await fetch('/api/integrations/catalog', { headers: getAuthHeaders() });
        if (!catalogRes.ok) throw new Error(`Catalog HTTP ${catalogRes.status}`);
        const catalogPayload = await catalogRes.json();
        const options = (catalogPayload.integrations || []).filter(i => i.status === 'available');

        if (!options.length) {
          showNotification('No integrations currently available', 'info');
          return;
        }

        const choice = prompt(`Add integration (${options.map(i => i.name).join(', ')})`, options[0].name);
        if (!choice) return;

        const putRes = await fetch(`/api/integrations/agent/${selectedAgentId}/${encodeURIComponent(choice)}`, {
          method: 'PUT',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ status: 'pending', config: {} }),
        });

        if (!putRes.ok) throw new Error(`Save HTTP ${putRes.status}`);

        const agent = agents.find(a => a.id === selectedAgentId);
        if (agent) {
          agent.integrations = Array.isArray(agent.integrations) ? agent.integrations : [];
          if (!agent.integrations.some(i => i.name === choice)) {
            agent.integrations.push({ name: choice, type: 'external', icon: 'üîå' });
          }
          renderIntegrations(agent);
          updateVerifyStatus(agent);
        }

        showNotification(`Integration '${choice}' added`, 'success');
      } catch (error) {
        console.error('[addIntegration] Error:', error);
        showNotification('Failed to add integration', 'error');
      }
    }
    
    async function generateCode() {
      if (!selectedAgentId) return;

      const codeEl = document.getElementById('agent-code');
      codeEl.textContent = '// Generating code with AI...\n// This may take a moment...';

      try {
        // Find the agent from workspace data
        const agent = workspaceData.agents.find(a => a.id === selectedAgentId);
        if (!agent) throw new Error('Agent not found');

        const response = await fetch('/api/wizard/generate-code', {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ 
            agentId: selectedAgentId,
            agent: agent
          }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        codeEl.textContent = result.code || '// No code generated';
        showNotification('Code generated successfully', 'success');
      } catch (error) {
        console.error('[generateCode] Error:', error);
        codeEl.textContent = `// Code generation failed:\n// ${error.message}\n\n// Please ensure the agent has:\n// - A description\n// - Capabilities defined\n// - Configuration saved`;
        showNotification('AI code generation failed: ' + error.message, 'error');
      }
    }

    async function refreshData() {
      await init();
      showNotification('Data refreshed', 'success');
    }

    async function createAgent() {
      const name = prompt('New agent name');
      if (!name) return;

      try {
        const response = await fetch(`${API_BASE}`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify({ name, type: 'Agent', description: '' }),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        await loadAgents();
        updateStats();
        updateDistributionChart();
        initGraph();

        const created = agents.find(a => a.name === name) || agents[0];
        if (created) selectAgent(created.id);

        showNotification('Agent created', 'success');
      } catch (error) {
        console.error('[createAgent] Error:', error);
        showNotification('Failed to create agent', 'error');
      }
    }
    
    async function exportDesignBundle() {
      try {
        const response = await fetch(`${API_BASE}/design/export`, { headers: getAuthHeaders() });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const payload = await response.json();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `flowgrid-design-export-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);

        showNotification('Design export downloaded', 'success');
      } catch (error) {
        console.error('[exportDesignBundle] Error:', error);
        showNotification('Failed to export design bundle', 'error');
      }
    }

    function triggerImportDesignBundle() {
      const input = document.getElementById('design-import-input');
      if (!input) return;
      input.value = '';
      input.click();
    }

    async function importDesignBundle(file) {
      if (!file) return;
      try {
        const text = await file.text();
        const payload = JSON.parse(text);

        const response = await fetch(`${API_BASE}/design/import`, {
          method: 'POST',
          headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        await init();
        showNotification(`Import complete: ${result?.imported?.agentsCreated || 0} created, ${result?.imported?.agentsUpdated || 0} updated`, 'success');
      } catch (error) {
        console.error('[importDesignBundle] Error:', error);
        showNotification('Failed to import design bundle', 'error');
      }
    }

    function copyCode() {
      const code = document.getElementById('agent-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showNotification('Code copied to clipboard', 'success');
      });
    }
    
    async function saveGeneratedCode() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const code = document.getElementById('agent-code').textContent;
      if (!code || code.includes('Click "Generate')) {
        return alert('Generate code first before saving.');
      }
      
      const btn = document.getElementById('save-code-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Saving...';
      btn.disabled = true;
      
      try {
        // Save code to agent config
        const updatedConfig = {
          ...agent.config,
          generatedCode: code,
          codeGeneratedAt: new Date().toISOString()
        };
        
        const response = await fetch(`${API_BASE}/${selectedAgentId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({ config: updatedConfig })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        agent.config = updatedConfig;
        btn.innerHTML = '‚úÖ Saved!';
        showNotification('Code saved to agent', 'success');
        
        // Update deploy checklist
        updateDeployChecklist();
        
        setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
      } catch (err) {
        console.error('Failed to save code:', err);
        btn.innerHTML = '‚ùå Error';
        showNotification('Failed to save code: ' + err.message, 'error');
        setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
      }
    }
    
    // ============================================================================
    // UI Utilities
    // ============================================================================
    
    function updateStats() {
      const agentsList = agents.filter(a => a.type === 'Agent');
      const agentsCount = agentsList.length;
      const elementCount = agents.length;
      
      // Header stats
      document.getElementById('stat-elements').textContent = String(elementCount);
      document.getElementById('stat-agents').textContent = String(agentsCount);
      document.getElementById('stat-relationships').textContent = String(relationships.length);

      // Progress counters
      const configured = agentsList.filter(a => a.purpose || a.pattern).length;
      const compiled = agentsList.filter(a => a.status === 'compiled' || a.status === 'deployed').length;
      const deployed = agentsList.filter(a => a.status === 'deployed').length;
      
      document.getElementById('progress-configured').textContent = String(configured);
      document.getElementById('progress-compiled').textContent = String(compiled);
      document.getElementById('progress-deployed').textContent = String(deployed);
      
      // Progress bar
      const deployedPct = agentsCount > 0 ? Math.round((deployed / agentsCount) * 100) : 0;
      document.getElementById('progress-percentage').textContent = `${deployedPct}%`;
      document.getElementById('progress-bar-fill').style.width = `${deployedPct}%`;
      
      // Progress stats
      const withPurpose = agentsList.filter(a => a.purpose).length;
      const withDesign = agentsList.filter(a => a.pattern && a.capabilityGroup).length;
      
      document.getElementById('stat-total-agents').textContent = String(agentsCount);
      document.getElementById('stat-with-purpose').textContent = String(withPurpose);
      document.getElementById('stat-with-design').textContent = String(withDesign);

      // Workspace agents list
      const roster = document.getElementById('workspace-agents-list');
      if (roster) roster.textContent = agents.map(a => a.name).slice(0, 10).join(' ‚Ä¢ ') || 'No agents yet';
    }
    
    // ==========================================================================
    // Agent Skills Management (A2A Protocol)
    // ==========================================================================
    
    function renderSkillsList(agent) {
      // Update skills count in description tab
      const countEl = document.getElementById('skills-count');
      const skills = agent?.skills || [];
      if (countEl) countEl.textContent = skills.length;
      
      // Render workspace skills panel
      renderWorkspaceSkills(agent);
    }
    
    function renderWorkspaceSkills(agent) {
      const emptyEl = document.getElementById('workspace-skills-empty');
      const listEl = document.getElementById('workspace-skills-list');
      const actionsEl = document.getElementById('skills-actions');
      
      if (!listEl || !emptyEl) return;
      
      const skills = agent?.skills || [];
      
      if (!agent) {
        emptyEl.style.display = 'block';
        listEl.style.display = 'none';
        if (actionsEl) actionsEl.style.display = 'none';
        return;
      }
      
      emptyEl.style.display = 'none';
      listEl.style.display = 'block';
      if (actionsEl) actionsEl.style.display = 'flex';
      
      if (skills.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #64748b;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
            <p style="margin-bottom: 1rem;">No skills defined yet for <strong>${escapeHtml(agent.name)}</strong></p>
            <div style="display: flex; gap: 0.5rem; justify-content: center;">
              <button class="btn btn-secondary" onclick="openAddSkillModal()">+ Add Manually</button>
              <button class="btn btn-primary" onclick="generateSkillsWithAI()">ü§ñ Generate with AI</button>
            </div>
          </div>
        `;
        return;
      }
      
      listEl.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 0.75rem;">
          ${skills.map(skill => `
            <div style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 1rem; transition: all 0.2s;" 
                 onmouseover="this.style.borderColor='#a78bfa'" onmouseout="this.style.borderColor='#334155'">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: #a78bfa; font-weight: 600; font-size: 0.95rem;">‚ö° ${escapeHtml(skill.display_name || skill.name)}</span>
                  </div>
                  <code style="font-size: 0.7rem; color: #64748b; background: #0f172a; padding: 0.15rem 0.4rem; border-radius: 3px; margin-top: 0.25rem; display: inline-block;">${escapeHtml(skill.name)}</code>
                </div>
                <div style="display: flex; gap: 0.25rem;">
                  <button onclick="editSkill('${skill.id}')" style="background: #334155; border: none; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">‚úèÔ∏è</button>
                  <button onclick="deleteSkill('${skill.id}')" style="background: #7f1d1d; border: none; color: #fca5a5; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">üóëÔ∏è</button>
                </div>
              </div>
              <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; line-height: 1.4;">${escapeHtml(skill.description || 'No description')}</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                ${(skill.tags || []).map(tag => `<span style="font-size: 0.7rem; background: #164e63; color: #22d3ee; padding: 0.2rem 0.5rem; border-radius: 4px;">${escapeHtml(tag)}</span>`).join('')}
              </div>
              ${skill.examples?.length ? `
                <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #334155;">
                  <span style="font-size: 0.7rem; color: #64748b;">Examples: ${skill.examples.length}</span>
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function openAddSkillModal() {
      document.getElementById('skill-modal-title').textContent = 'Add Skill';
      document.getElementById('skill-id').value = '';
      document.getElementById('skill-display-name').value = '';
      document.getElementById('skill-name').value = '';
      document.getElementById('skill-description').value = '';
      document.getElementById('skill-tags').value = '';
      document.getElementById('skill-input-schema').value = '';
      document.getElementById('skill-example').value = '';
      document.getElementById('skill-modal').style.display = 'flex';
    }
    
    function closeSkillModal() {
      document.getElementById('skill-modal').style.display = 'none';
    }
    
    function updateSkillName() {
      const displayName = document.getElementById('skill-display-name').value;
      const skillName = displayName.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
      document.getElementById('skill-name').value = skillName;
    }
    
    async function editSkill(skillId) {
      const agent = agents.find(a => a.id === selectedAgentId);
      const skill = (agent?.skills || []).find(s => s.id === skillId);
      if (!skill) return;
      
      document.getElementById('skill-modal-title').textContent = 'Edit Skill';
      document.getElementById('skill-id').value = skill.id;
      document.getElementById('skill-display-name').value = skill.display_name || '';
      document.getElementById('skill-name').value = skill.name || '';
      document.getElementById('skill-description').value = skill.description || '';
      document.getElementById('skill-tags').value = (skill.tags || []).join(', ');
      document.getElementById('skill-input-schema').value = skill.input_schema ? JSON.stringify(skill.input_schema, null, 2) : '';
      document.getElementById('skill-example').value = skill.examples?.[0]?.input ? JSON.stringify(skill.examples[0].input, null, 2) : '';
      document.getElementById('skill-modal').style.display = 'flex';
    }
    
    async function saveSkill() {
      if (!selectedAgentId) return;
      
      const skillId = document.getElementById('skill-id').value;
      const displayName = document.getElementById('skill-display-name').value.trim();
      const name = document.getElementById('skill-name').value.trim();
      const description = document.getElementById('skill-description').value.trim();
      const tagsStr = document.getElementById('skill-tags').value.trim();
      const inputSchemaStr = document.getElementById('skill-input-schema').value.trim();
      const exampleStr = document.getElementById('skill-example').value.trim();
      
      if (!displayName || !name) {
        return alert('Display name is required');
      }
      
      let inputSchema = {};
      let examples = [];
      
      try {
        if (inputSchemaStr) inputSchema = JSON.parse(inputSchemaStr);
      } catch (e) {
        return alert('Invalid JSON in Input Schema');
      }
      
      try {
        if (exampleStr) {
          examples = [{ name: displayName, input: JSON.parse(exampleStr) }];
        }
      } catch (e) {
        return alert('Invalid JSON in Example');
      }
      
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(Boolean) : [];
      
      const payload = {
        name,
        display_name: displayName,
        description,
        tags,
        input_schema: inputSchema,
        examples
      };
      
      try {
        const url = skillId 
          ? `${API_BASE}/${selectedAgentId}/skills/${skillId}`
          : `${API_BASE}/${selectedAgentId}/skills`;
        
        const response = await fetch(url, {
          method: skillId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        closeSkillModal();
        showNotification(skillId ? 'Skill updated' : 'Skill created', 'success');
        
        // Reload agent to get updated skills
        await reloadSelectedAgent();
      } catch (err) {
        console.error('Save skill error:', err);
        showNotification('Failed to save skill: ' + err.message, 'error');
      }
    }
    
    async function deleteSkill(skillId) {
      if (!selectedAgentId) return;
      if (!confirm('Delete this skill?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/${selectedAgentId}/skills/${skillId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        showNotification('Skill deleted', 'success');
        await reloadSelectedAgent();
      } catch (err) {
        console.error('Delete skill error:', err);
        showNotification('Failed to delete skill: ' + err.message, 'error');
      }
    }
    
    async function generateSkillsWithAI() {
      if (!selectedAgentId) return;
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      if (!confirm('Generate skills based on agent description and capabilities? This will add new skills.')) return;
      
      // Show loading spinner in skills panel
      const listEl = document.getElementById('workspace-skills-list');
      if (listEl) {
        listEl.style.display = 'block';
        listEl.innerHTML = `
          <div style="text-align: center; padding: 3rem;">
            <div class="loading-spinner" style="width: 48px; height: 48px; margin: 0 auto 1rem;"></div>
            <p style="color: #94a3b8;">Generating skills with AI...</p>
            <p style="color: #64748b; font-size: 0.8rem;">This may take a moment</p>
          </div>
        `;
      }
      const emptyEl = document.getElementById('workspace-skills-empty');
      if (emptyEl) emptyEl.style.display = 'none';
      
      try {
        // Use wizard service to generate skills
        const response = await fetch('/api/wizard/generate-skills', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({
            agentId: selectedAgentId,
            agentName: agent.name,
            description: agent.config?.detailedPurpose || agent.description,
            capabilities: (agent.capabilities || []).map(c => c.capability_name || c.name || c),
            pattern: agent.config?.pattern
          })
        });
        
        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        const generatedSkills = result.skills || [];
        
        console.log('[Skills] Generated skills:', generatedSkills);
        
        // Create each skill
        for (const skill of generatedSkills) {
          const createResp = await fetch(`${API_BASE}/${selectedAgentId}/skills`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify(skill)
          });
          console.log('[Skills] Create skill response:', createResp.status);
        }
        
        showNotification(`Generated ${generatedSkills.length} skills`, 'success');
        await reloadSelectedAgent();
      } catch (err) {
        console.error('Generate skills error:', err);
        showNotification('Failed to generate skills: ' + err.message, 'error');
        // Reset view
        if (agent) renderWorkspaceSkills(agent);
      }
    }
    
    async function reloadSelectedAgent() {
      if (!selectedAgentId) return;
      try {
        const response = await fetch(`${API_BASE}/${selectedAgentId}`, { headers: getAuthHeaders() });
        if (response.ok) {
          const details = await response.json();
          console.log('[reloadSelectedAgent] Loaded:', { skills: details.skills?.length, caps: details.capabilities?.length });
          const agent = agents.find(a => a.id === selectedAgentId);
          if (agent) {
            agent.skills = details.skills || [];
            agent.capabilities = details.capabilities || [];
            agent.integrations = details.integrations || [];
            agent.config = details.config || agent.config;
            renderSkillsList(agent);
            renderOverview(agent);
          }
        }
      } catch (err) {
        console.error('Reload agent error:', err);
      }
    }
    
    function showNotification(message, type = 'info') {
      const colors = {
        success: '#10b981',
        error: '#ef4444',
        info: '#3b82f6',
      };
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: ${colors[type]};
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    function showError(message) {
      const container = document.getElementById('element-list');
      container.innerHTML = `
        <div class="empty-state">
          <div class="icon">‚ö†Ô∏è</div>
          <p style="color: #ef4444;">${escapeHtml(message)}</p>
          <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="init()">Retry</button>
        </div>
      `;
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ============================================================================
    // Event Listeners
    // ============================================================================
    
    // Search input removed
    // Filter dropdown removed
    document.getElementById('design-import-input').addEventListener('change', (event) => {
      const file = event?.target?.files?.[0];
      if (file) importDesignBundle(file);
    });
    
    // 401 handling is now done by auth-ui.js installAutoRefresh() ‚Äî
    // it automatically refreshes the token and retries the request.
    // Only redirect to login if refresh also fails (handled in initPage).

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      if (window.FlowgridAuthUI?.initPage) {
        window.FlowgridAuthUI.initPage({ requireAuth: true, showSignOut: false });
      } else {
        console.warn('[design-studio] auth-ui.js not loaded; continuing with local token fallback');
      }

      init();
    });
    
    // CSS Animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    `;
    document.head.appendChild(style);

    // ============================================================================
    // BPMN Integration (Per-Process)
    // ============================================================================
    
    let bpmnModeler = null;
    let currentBpmnXml = null;
    let selectedProcessId = null;

    function escapeXml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }

    // Populate the process list in BPMN tab
    function renderBpmnProcessList() {
      const listEl = document.getElementById('bpmn-process-list');
      if (!listEl) return;
      
      // Show both Process elements AND agents with process steps
      const processes = agents.filter(a => a.elementType === 'Process');
      const agentsWithProcesses = agents.filter(a => 
        a.elementType !== 'Process' && 
        (a.config?.processSteps || a.config?.decisionPoints)
      );
      const allProcessItems = [...processes, ...agentsWithProcesses];
      
      if (allProcessItems.length === 0) {
        // Show the selected agent if it has no process steps
        const selectedAgent = agents.find(a => a.id === selectedAgentId);
        if (selectedAgent) {
          listEl.innerHTML = `
            <div style="padding: 0.75rem; background: #0f172a; border-radius: 6px;">
              <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.25rem;">${escapeHtml(selectedAgent.name)}</div>
              <div style="color: #64748b; font-size: 0.75rem;">No process flow defined</div>
              <button class="btn btn-primary" onclick="generateBpmnForAgent('${selectedAgent.id}')" style="margin-top: 0.5rem; font-size: 0.75rem;">üîÑ Generate Process Flow</button>
            </div>
          `;
        } else {
          listEl.innerHTML = '<p style="color: #64748b; font-size: 0.85rem;">Select an agent to view or generate its process flow.</p>';
        }
        return;
      }
      
      listEl.innerHTML = allProcessItems.map(p => `
        <div class="bpmn-process-item" 
             data-id="${p.id}" 
             onclick="selectBpmnProcess('${p.id}')"
             style="padding: 0.75rem; background: ${selectedProcessId === p.id ? '#334155' : '#0f172a'}; border-radius: 6px; cursor: pointer; border-left: 3px solid ${selectedProcessId === p.id ? '#f59e0b' : 'transparent'};"
             onmouseover="if(selectedProcessId !== '${p.id}') this.style.background='#1e293b'"
             onmouseout="if(selectedProcessId !== '${p.id}') this.style.background='#0f172a'">
          <div style="color: #e2e8f0; font-weight: 500; margin-bottom: 0.25rem;">${escapeHtml(p.name)}</div>
          <div style="color: #64748b; font-size: 0.75rem;">
            ${p.elementType === 'Process' ? 'üîÑ Process' : 'ü§ñ Agent'}
            ${p.config?.processSteps ? ' ‚Ä¢ ‚úÖ Has flow' : ' ‚Ä¢ ‚ö†Ô∏è No flow'}
          </div>
        </div>
      `).join('');
    }
    
    // Store generated BPMN XML per agent
    const agentBpmnCache = {};
    
    // Generate BPMN for an agent that doesn't have process steps
    async function generateBpmnForAgent(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      // Set as selected process so Save works
      selectedProcessId = agentId;
      
      // Show loading state
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Generating...';
      }
      
      try {
        const response = await fetch('/api/wizard/generate-bpmn', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({
            processId: agent.id,
            processName: agent.name,
            processDescription: agent.purpose || agent.description || '',
            capabilities: agent.capabilities?.map(c => c.capability_name || c.name || c) || [],
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          const bpmnXml = result.data?.bpmnXml;
          
          if (bpmnXml) {
            // Cache the BPMN XML
            agentBpmnCache[agentId] = bpmnXml;
            agent.config = agent.config || {};
            agent.config.bpmnXml = bpmnXml;
            agent.config.processSteps = result.data?.summary || 'Generated';
            
            // Save to database
            await saveBpmnToAgent(agentId, bpmnXml, result.data?.summary);
            
            // Display in canvas
            renderBpmnProcessList();
            await displayBpmnXml(bpmnXml, agent.name);
            
            if (btn) {
              btn.innerHTML = '‚úÖ Saved!';
              setTimeout(() => { btn.innerHTML = 'üîÑ Regenerate'; btn.disabled = false; }, 2000);
            }
          } else {
            throw new Error('No BPMN XML in response');
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        console.error('Failed to generate BPMN:', err);
        if (btn) {
          btn.innerHTML = '‚ùå Failed';
          setTimeout(() => { btn.innerHTML = 'üîÑ Generate Process Flow'; btn.disabled = false; }, 2000);
        }
      }
    }
    
    // Import BPMN file
    async function importBPMNFile(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      
      if (!selectedProcessId) {
        alert('Please select an agent first');
        event.target.value = '';
        return;
      }
      
      try {
        const bpmnXml = await file.text();
        
        // Validate it's valid XML
        if (!bpmnXml.includes('bpmn:definitions') && !bpmnXml.includes('definitions')) {
          alert('Invalid BPMN file. Please select a valid .bpmn or .xml file.');
          event.target.value = '';
          return;
        }
        
        // Display in canvas
        await displayBpmnXml(bpmnXml, agents.find(a => a.id === selectedProcessId)?.name || 'Imported');
        
        // Cache it (not auto-saved - user can click Save)
        agentBpmnCache[selectedProcessId] = bpmnXml;
        
        // Flash the save button to indicate unsaved changes
        const saveBtn = document.getElementById('bpmn-save-btn');
        if (saveBtn) {
          saveBtn.style.animation = 'pulse 1s ease-in-out 3';
          saveBtn.innerHTML = 'üíæ Save*';
        }
        
        console.log('[BPMN] Imported from file:', file.name);
      } catch (err) {
        console.error('Failed to import BPMN:', err);
        alert('Failed to import BPMN file: ' + err.message);
      }
      
      // Reset file input
      event.target.value = '';
    }
    
    // Save current BPMN from editor to database
    async function saveCurrentBPMN() {
      const processId = selectedProcessId || selectedAgentId;
      if (!processId || !window.bpmnViewer) {
        alert('No BPMN to save');
        return;
      }
      
      const btn = document.getElementById('bpmn-save-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Saving...';
      }
      
      try {
        // Export current BPMN XML from the editor
        const { xml } = await window.bpmnViewer.saveXML({ format: true });
        
        if (xml) {
          await saveBpmnToAgent(processId, xml, 'User edited');
          agentBpmnCache[processId] = xml;
          
          const agent = agents.find(a => a.id === processId);
          if (agent) {
            agent.config = agent.config || {};
            agent.config.bpmnXml = xml;
          }
          
          if (btn) {
            btn.innerHTML = '‚úÖ Saved!';
            setTimeout(() => { btn.innerHTML = 'üíæ Save'; btn.disabled = false; }, 2000);
          }
        }
      } catch (err) {
        console.error('Failed to save BPMN:', err);
        if (btn) {
          btn.innerHTML = '‚ùå Failed';
          setTimeout(() => { btn.innerHTML = 'üíæ Save'; btn.disabled = false; }, 2000);
        }
      }
    }
    
    // Save BPMN to agent in database
    async function saveBpmnToAgent(agentId, bpmnXml, summary) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      try {
        // Merge BPMN into existing config
        const updatedConfig = {
          ...(agent.config || {}),
          bpmnXml: bpmnXml,
          processSteps: summary || 'Generated',
          bpmnGeneratedAt: new Date().toISOString(),
        };
        
        const response = await fetch(`${API_BASE}/${agentId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({ config: updatedConfig })
        });
        
        if (!response.ok) {
          console.warn('Failed to save BPMN to database:', response.status);
        } else {
          console.log('[BPMN] Saved to database for agent:', agentId);
        }
      } catch (err) {
        console.error('Failed to save BPMN:', err);
      }
    }
    
    // Display BPMN XML in the canvas using bpmn-js
    async function displayBpmnXml(bpmnXml, processName) {
      const canvas = document.getElementById('bpmn-canvas-main');
      const emptyState = document.getElementById('bpmn-empty-state');
      
      if (!canvas) return;
      
      emptyState.style.display = 'none';
      canvas.style.display = 'block';
      document.getElementById('bpmn-process-title').textContent = `üìä ${processName}`;
      document.getElementById('bpmn-actions').style.display = 'flex';
      
      // Initialize or reuse bpmn-js viewer
      if (!window.bpmnViewer) {
        if (typeof BpmnJS === 'undefined') {
          canvas.innerHTML = '<pre style="padding:1rem;color:#94a3b8;font-size:0.75rem;overflow:auto;max-height:400px;">' + escapeHtml(bpmnXml) + '</pre>';
          return;
        }
        window.bpmnViewer = new BpmnJS({ container: canvas });
      }
      
      try {
        await window.bpmnViewer.importXML(bpmnXml);
        // Delayed fit to ensure container is visible and has dimensions
        setTimeout(() => {
          try {
            window.bpmnViewer.get('canvas').zoom('fit-viewport');
          } catch (e) { /* ignore if already destroyed */ }
        }, 100);
      } catch (err) {
        console.error('BPMN render error:', err);
        canvas.innerHTML = '<div style="padding:1rem;color:#f87171;">Failed to render BPMN: ' + escapeHtml(err.message) + '</div>';
      }
    }

    // Select a process to show in BPMN canvas
    async function selectBpmnProcess(processId) {
      selectedProcessId = processId;
      let process = agents.find(a => a.id === processId);
      
      if (!process) return;
      
      // Load full agent details if not already loaded (to get config.bpmnXml)
      if (!process._detailsLoaded) {
        try {
          const response = await fetch(`${API_BASE}/${processId}`, { headers: getAuthHeaders() });
          if (response.ok) {
            const details = await response.json();
            process.config = details.config || process.config;
            process.capabilities = details.capabilities || [];
            process._detailsLoaded = true;
          }
        } catch (err) {
          console.warn('Failed to load process details for BPMN:', err);
        }
      }
      
      // Update UI
      renderBpmnProcessList();
      document.getElementById('bpmn-process-desc').textContent = process.description || process.purpose || 'Process workflow diagram';
      
      // Check if we have cached BPMN XML
      const cachedBpmn = agentBpmnCache[processId] || process.config?.bpmnXml;
      
      if (cachedBpmn) {
        await displayBpmnXml(cachedBpmn, process.name);
      } else if (process.config?.processSteps && process.config.processSteps !== 'Generated') {
        // Generate from existing process steps
        await generateProcessBPMN(process);
      } else {
        // No BPMN - show generate button
        document.getElementById('bpmn-empty-state').style.display = 'flex';
        document.getElementById('bpmn-canvas-main').style.display = 'none';
        document.getElementById('bpmn-process-title').textContent = `üìä ${process.name}`;
        document.getElementById('bpmn-empty-state').innerHTML = `
          <div style="text-align: center; color: #64748b;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
            <p style="margin-bottom: 1rem;">No process flow defined for this agent</p>
            <button class="btn btn-primary" onclick="generateBpmnForAgent('${processId}')">üîÑ Generate Process Flow</button>
          </div>
        `;
      }
    }

    // Convert a single process to BPMN based on its processSteps/decisionPoints
    function convertProcessToBPMN(process) {
      const config = process.config || {};
      const processSteps = config.processSteps || '';
      const decisionPoints = config.decisionPoints || '';
      
      // Parse steps (split by newlines or numbered items)
      const stepLines = processSteps.split(/\n|(?=\d+\.)/).filter(s => s.trim());
      const steps = stepLines.map((s, i) => ({
        id: `Task_${i + 1}`,
        name: s.replace(/^\d+\.\s*/, '').trim().substring(0, 50)
      })).filter(s => s.name);
      
      // Parse decision points
      const decisionLines = decisionPoints.split(/\n|(?=\d+\.)/).filter(s => s.trim());
      const decisions = decisionLines.map((d, i) => ({
        id: `Gateway_${i + 1}`,
        name: d.replace(/^\d+\.\s*/, '').trim().substring(0, 30)
      })).filter(d => d.name);
      
      // If no steps defined, create a simple placeholder
      if (steps.length === 0) {
        steps.push({ id: 'Task_1', name: process.name });
      }

      // Build BPMN tasks
      const tasks = steps.map(s => 
        `    <bpmn:serviceTask id="${s.id}" name="${escapeXml(s.name)}" />`
      ).join('\n');
      
      // Build gateways for decisions
      const gateways = decisions.map(d =>
        `    <bpmn:exclusiveGateway id="${d.id}" name="${escapeXml(d.name)}" />`
      ).join('\n');

      // Build sequential flows between steps
      const flows = [];
      flows.push(`    <bpmn:sequenceFlow id="Flow_start" sourceRef="StartEvent_1" targetRef="${steps[0]?.id || 'EndEvent_1'}" />`);
      
      for (let i = 0; i < steps.length - 1; i++) {
        flows.push(`    <bpmn:sequenceFlow id="Flow_${i + 1}" sourceRef="${steps[i].id}" targetRef="${steps[i + 1].id}" />`);
      }
      
      if (steps.length > 0) {
        flows.push(`    <bpmn:sequenceFlow id="Flow_end" sourceRef="${steps[steps.length - 1].id}" targetRef="EndEvent_1" />`);
      }

      // Build shapes for visual layout
      const stepShapes = steps.map((s, i) => `      <bpmndi:BPMNShape id="${s.id}_di" bpmnElement="${s.id}">
        <dc:Bounds x="${250 + i * 160}" y="80" width="120" height="80" />
      </bpmndi:BPMNShape>`).join('\n');
      
      const gatewayShapes = decisions.map((d, i) => `      <bpmndi:BPMNShape id="${d.id}_di" bpmnElement="${d.id}">
        <dc:Bounds x="${250 + i * 160}" y="200" width="50" height="50" />
      </bpmndi:BPMNShape>`).join('\n');

      return `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                  id="Definitions_${process.id}" 
                  targetNamespace="http://flowgrid.io/bpmn">
  <bpmn:process id="Process_${process.id.substring(0, 8)}" name="${escapeXml(process.name)}" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="Start" />
    <bpmn:endEvent id="EndEvent_1" name="End" />
${tasks}
${gateways}
${flows.join('\n')}
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_${process.id.substring(0, 8)}">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="152" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="${300 + steps.length * 160}" y="102" width="36" height="36" />
      </bpmndi:BPMNShape>
${stepShapes}
${gatewayShapes}
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;
    }

    // Load and display BPMN for the selected agent
    async function loadAgentBpmn(agent) {
      const emptyState = document.getElementById('bpmn-empty-state');
      const canvas = document.getElementById('bpmn-canvas-main');
      const titleEl = document.getElementById('bpmn-process-title');
      const descEl = document.getElementById('bpmn-process-desc');
      
      if (!agent) {
        if (emptyState) emptyState.style.display = 'flex';
        if (canvas) canvas.style.display = 'none';
        if (titleEl) titleEl.textContent = 'üìä Select an Agent';
        if (descEl) descEl.textContent = 'Select an agent from the sidebar to view its BPMN workflow';
        return;
      }
      
      // Update title
      if (titleEl) titleEl.textContent = `üìä ${agent.name}`;
      if (descEl) descEl.textContent = agent.config?.subProcessName || agent.config?.processName || 'Agent workflow';
      
      // Set selected process for save/export
      selectedProcessId = agent.id;
      
      // Check if agent has BPMN
      const bpmnXml = agent.config?.bpmnXml;
      
      if (!bpmnXml) {
        // Show empty state with generate option
        if (emptyState) {
          emptyState.style.display = 'flex';
          emptyState.innerHTML = `
            <div style="text-align: center; color: #64748b;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
              <p style="margin-bottom: 1rem;">No BPMN workflow defined for this agent</p>
              <button class="btn btn-primary" onclick="generateBpmnForAgent('${agent.id}')" style="font-size: 0.9rem;">üîÑ Generate BPMN Workflow</button>
            </div>
          `;
        }
        if (canvas) canvas.style.display = 'none';
        return;
      }
      
      // Show BPMN
      if (emptyState) emptyState.style.display = 'none';
      if (canvas) canvas.style.display = 'block';
      
      try {
        currentBpmnXml = bpmnXml;
        
        if (!bpmnModeler) {
          bpmnModeler = new BpmnJS({ container: canvas });
        }
        
        await bpmnModeler.importXML(bpmnXml);
        // Multiple delayed fit attempts to handle visibility timing
        const fitCanvas = () => {
          try { bpmnModeler.get('canvas').zoom('fit-viewport'); } catch(e) {}
        };
        fitCanvas();
        setTimeout(fitCanvas, 50);
        setTimeout(fitCanvas, 150);
        setTimeout(fitCanvas, 300);
        
        // Update stats
        const statsEl = document.getElementById('bpmn-stats');
        const taskCount = (bpmnXml.match(/<bpmn:(service|user)Task/g) || []).length;
        const gatewayCount = (bpmnXml.match(/<bpmn:exclusiveGateway/g) || []).length;
        if (statsEl) statsEl.textContent = `${taskCount} tasks ‚Ä¢ ${gatewayCount} gateways`;
        
      } catch (err) {
        console.error('BPMN render error:', err);
        if (canvas) {
          canvas.style.display = 'block';
          canvas.innerHTML = `<div style="padding: 2rem; color: #ef4444;">Error rendering BPMN: ${err.message}</div>`;
        }
      }
    }

    async function generateProcessBPMN(process) {
      const container = document.getElementById('bpmn-canvas-main');
      if (!container) return;

      try {
        currentBpmnXml = convertProcessToBPMN(process);
        
        if (!bpmnModeler) {
          bpmnModeler = new BpmnJS({ container });
        }

        await bpmnModeler.importXML(currentBpmnXml);
        bpmnModeler.get('canvas').zoom('fit-viewport');
        
        // Update stats
        const statsEl = document.getElementById('bpmn-stats');
        const taskCount = (currentBpmnXml.match(/<bpmn:(service|user)Task/g) || []).length;
        const gatewayCount = (currentBpmnXml.match(/<bpmn:exclusiveGateway/g) || []).length;
        if (statsEl) statsEl.textContent = `${taskCount} tasks ‚Ä¢ ${gatewayCount} gateways`;
        
      } catch (err) {
        console.error('BPMN render error:', err);
        container.innerHTML = `<div style="padding: 2rem; color: #ef4444;">Error rendering BPMN: ${err.message}</div>`;
      }
    }

    async function regenerateProcessBPMN() {
      if (!selectedProcessId) return;
      const process = agents.find(a => a.id === selectedProcessId);
      if (process) {
        await generateProcessBPMN(process);
        showNotification('BPMN regenerated', 'success');
      }
    }

    function exportProcessBPMN() {
      if (!currentBpmnXml || !selectedProcessId) {
        showNotification('Select a process first', 'warning');
        return;
      }
      
      const process = agents.find(a => a.id === selectedProcessId);
      const filename = (process?.name || 'process').toLowerCase().replace(/\s+/g, '-') + '.bpmn';
      
      const blob = new Blob([currentBpmnXml], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      showNotification(`Exported ${filename}`, 'success');
    }

    // Render process list when BPMN tab is shown
    const originalShowWorkspaceTab = window.showWorkspaceTab;
    window.showWorkspaceTab = function(tabName) {
      if (originalShowWorkspaceTab) originalShowWorkspaceTab(tabName);
      if (tabName === 'bpmn') {
        renderBpmnProcessList();
      }
    };

    // ==========================================
    // Agent Configuration Modal
    // ==========================================
    
    function openAgentConfigModal(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) {
        alert('Please select an agent first');
        return;
      }
      
      const config = agent.config || {};
      
      // Set hidden ID
      document.getElementById('config-agent-id').value = agentId;
      document.getElementById('config-modal-title').textContent = `ü§ñ ${agent.name}`;
      
      // Basic Information
      document.getElementById('config-agent-name').value = agent.name || '';
      document.getElementById('config-agent-valuestream').value = config.valueStream || '';
      document.getElementById('config-agent-capgroup').value = config.capabilityGroup || '';
      document.getElementById('config-agent-purpose').value = agent.description || agent.purpose || '';
      document.getElementById('config-agent-objectives').value = (config.objectives || []).join('\n');
      
      // Capabilities from agent_capabilities table
      const caps = agent.capabilities || [];
      document.getElementById('config-agent-capabilities').value = caps.map(c => c.capability_name || c.name || c).join(', ');
      
      // Behavior
      document.getElementById('config-agent-pattern').value = config.pattern || '';
      document.getElementById('config-agent-decision').value = config.decisionAuthority || '';
      document.getElementById('config-agent-autonomy').value = config.autonomyLevel || '';
      document.getElementById('config-agent-risk').value = config.riskAppetite || '';
      
      // Interactions
      document.getElementById('config-agent-interaction').value = config.interactionPattern || '';
      document.getElementById('config-agent-triggers').value = (config.triggers || []).join(', ');
      document.getElementById('config-agent-outputs').value = (config.outputs || []).join(', ');
      document.getElementById('config-agent-escalation').value = config.escalationPath || '';
      
      // LLM Config
      document.getElementById('config-agent-model').value = config.llm?.defaultModel || '';
      
      // Show modal
      document.getElementById('agent-config-modal').style.display = 'block';
    }
    
    function closeAgentConfigModal() {
      document.getElementById('agent-config-modal').style.display = 'none';
    }
    
    async function saveAgentConfigModal() {
      const agentId = document.getElementById('config-agent-id').value;
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      
      const saveBtn = document.querySelector('#agent-config-modal .btn-save');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ Saving...';
      }
      
      try {
        // Collect form data
        const name = document.getElementById('config-agent-name').value;
        const description = document.getElementById('config-agent-purpose').value;
        
        // Merge with existing config to preserve bpmnXml, etc.
        const existingConfig = agent.config || {};
        const newConfig = {
          ...existingConfig,
          valueStream: document.getElementById('config-agent-valuestream').value || null,
          capabilityGroup: document.getElementById('config-agent-capgroup').value || null,
          objectives: document.getElementById('config-agent-objectives').value.split('\n').map(s => s.trim()).filter(s => s),
          pattern: document.getElementById('config-agent-pattern').value || null,
          decisionAuthority: document.getElementById('config-agent-decision').value || null,
          autonomyLevel: document.getElementById('config-agent-autonomy').value || null,
          riskAppetite: document.getElementById('config-agent-risk').value || null,
          interactionPattern: document.getElementById('config-agent-interaction').value || null,
          triggers: document.getElementById('config-agent-triggers').value.split(',').map(s => s.trim()).filter(s => s),
          outputs: document.getElementById('config-agent-outputs').value.split(',').map(s => s.trim()).filter(s => s),
          escalationPath: document.getElementById('config-agent-escalation').value || null,
          llm: {
            defaultModel: document.getElementById('config-agent-model').value || null
          }
        };
        
        // PUT to API
        const response = await fetch(`${API_BASE}/${agentId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({ name, description, config: newConfig })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const updated = await response.json();
        
        // Update local agent data
        Object.assign(agent, { name, description, config: newConfig });
        
        // Refresh UI
        renderElementList();
        if (selectedAgentId === agentId) {
          selectAgent(agentId);
        }
        
        if (saveBtn) {
          saveBtn.textContent = '‚úÖ Saved!';
          setTimeout(() => {
            saveBtn.textContent = 'üíæ Save';
            saveBtn.disabled = false;
            closeAgentConfigModal();
          }, 1000);
        }
        
      } catch (err) {
        console.error('Failed to save agent config:', err);
        if (saveBtn) {
          saveBtn.textContent = '‚ùå Failed';
          setTimeout(() => {
            saveBtn.textContent = 'üíæ Save';
            saveBtn.disabled = false;
          }, 2000);
        }
      }
    }
    
    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeAgentConfigModal();
      }
    });
    
    // Close modal on backdrop click
    document.getElementById('agent-config-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'agent-config-modal') {
        closeAgentConfigModal();
      }
    });

    // ==========================================
    // Integration Catalog Functions
    // ==========================================
    
    let integrationCatalog = [];
    
    async function loadIntegrationCatalog() {
      try {
        const response = await fetch('/api/integrations/catalog', {
          headers: getAuthHeaders()
        });
        if (response.ok) {
          const data = await response.json();
          // Ensure we always have an array
          integrationCatalog = Array.isArray(data) ? data : (data.integrations || []);
        }
      } catch (err) {
        console.error('Failed to load integration catalog:', err);
        integrationCatalog = [];
      }
    }
    
    async function loadSuggestedIntegrations(agentId) {
      const container = document.getElementById('suggested-integrations');
      const currentContainer = document.getElementById('current-integrations-list');
      
      if (!agentId) {
        container.innerHTML = '<p style="color: #64748b;">Select an agent to see suggestions</p>';
        currentContainer.innerHTML = '<p style="color: #64748b; font-size: 0.85rem;">No integrations added yet</p>';
        return;
      }
      
      try {
        // Load suggestions
        const response = await fetch(`/api/agents/${agentId}/integrations/suggest`, {
          headers: getAuthHeaders()
        });
        
        if (!response.ok) throw new Error('Failed to load suggestions');
        
        const data = await response.json();
        const suggestions = data.suggestions || [];
        const existing = data.existing || [];
        
        // Render suggestion cards
        if (suggestions.length > 0) {
          container.innerHTML = suggestions.map(int => {
            const isAdded = existing.includes(int.name);
            return `
              <div class="integration-card ${isAdded ? 'added' : ''}" 
                   onclick="${isAdded ? '' : `addIntegration('${agentId}', '${int.name}')`}"
                   title="${int.description || int.name}">
                <div class="icon">${int.icon || 'üîå'}</div>
                <div class="name">${int.name}</div>
                <div class="type">${int.type}</div>
                ${isAdded ? '<div style="font-size:0.65rem;color:#10b981;margin-top:0.25rem;">‚úì Added</div>' : ''}
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = '<p style="color: #64748b;">No suggestions available</p>';
        }
        
        // Load current integrations
        const agent = agents.find(a => a.id === agentId);
        const integrations = agent?.integrations || [];
        
        if (integrations.length > 0) {
          currentContainer.innerHTML = integrations.map(int => {
            const catalogItem = integrationCatalog.find(c => c.name === int.integration_name);
            const isConfigured = int.is_configured;
            return `
              <div class="current-integration" onclick="openIntegrationModal('${agentId}', '${int.integration_name}', '${int.id}')" title="Click to configure">
                <div class="info" style="display: flex; align-items: center; gap: 0.75rem;">
                  <div class="icon">${catalogItem?.icon || 'üîå'}</div>
                  <div class="details">
                    <div class="name">${int.integration_name}</div>
                    <div class="type">${int.integration_type || 'Custom'}</div>
                  </div>
                  <span class="status-badge ${isConfigured ? 'success' : 'warning'}" style="margin-left: auto; font-size: 0.65rem;">
                    ${isConfigured ? '‚úÖ Configured' : '‚ö†Ô∏è Not configured'}
                  </span>
                </div>
                <button class="remove-btn" onclick="event.stopPropagation(); removeIntegration('${agentId}', '${int.id}')">Remove</button>
              </div>
            `;
          }).join('');
        } else {
          currentContainer.innerHTML = '<p style="color: #64748b; font-size: 0.85rem;">No integrations added yet</p>';
        }
        
      } catch (err) {
        console.error('Failed to load integrations:', err);
        container.innerHTML = '<p style="color: #f87171;">Failed to load suggestions</p>';
      }
    }
    
    // Open modal for NEW integration (agentId, integrationName, no integrationId)
    async function addIntegration(agentId, integrationName) {
      openIntegrationModal(agentId, integrationName, null);
    }
    
    // Open integration configuration modal
    function openIntegrationModal(agentId, integrationName, integrationId) {
      const catalogItem = integrationCatalog.find(c => c.name === integrationName);
      const modal = document.getElementById('integration-config-modal');
      
      // Set hidden fields
      document.getElementById('integration-agent-id').value = agentId;
      document.getElementById('integration-id').value = integrationId || '';
      document.getElementById('integration-name-hidden').value = integrationName;
      
      // Set modal header/icon
      document.getElementById('integration-modal-icon').textContent = catalogItem?.icon || 'üîå';
      document.getElementById('integration-modal-big-icon').textContent = catalogItem?.icon || 'üîå';
      document.getElementById('integration-modal-title').textContent = integrationName;
      document.getElementById('integration-modal-type').textContent = catalogItem?.type || 'Integration';
      
      // If editing existing, load current config
      if (integrationId) {
        const agent = agents.find(a => a.id === agentId);
        const integration = agent?.integrations?.find(i => i.id === integrationId);
        if (integration) {
          document.getElementById('integration-endpoint').value = integration.config_endpoint || '';
          document.getElementById('integration-auth-type').value = integration.config_auth_type || 'API Key';
          document.getElementById('integration-api-key').value = integration.config_api_key || '';
          document.getElementById('integration-notes').value = integration.config?.notes || '';
        }
      } else {
        // Clear form for new integration
        document.getElementById('integration-endpoint').value = '';
        document.getElementById('integration-auth-type').value = 'API Key';
        document.getElementById('integration-api-key').value = '';
        document.getElementById('integration-notes').value = '';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeIntegrationModal() {
      document.getElementById('integration-config-modal').style.display = 'none';
    }
    
    async function saveIntegrationConfig() {
      const agentId = document.getElementById('integration-agent-id').value;
      const integrationId = document.getElementById('integration-id').value;
      const integrationName = document.getElementById('integration-name-hidden').value;
      const endpoint = document.getElementById('integration-endpoint').value;
      const authType = document.getElementById('integration-auth-type').value;
      const apiKey = document.getElementById('integration-api-key').value;
      const notes = document.getElementById('integration-notes').value;
      
      try {
        let response;
        const body = {
          integration_name: integrationName,
          config_endpoint: endpoint,
          config_auth_type: authType,
          config_api_key: apiKey,
          config: { notes },
          is_configured: !!(endpoint || apiKey)
        };
        
        if (integrationId) {
          // Update existing
          response = await fetch(`/api/agents/${agentId}/integrations/${integrationId}`, {
            method: 'PUT',
            headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify(body)
          });
        } else {
          // Create new
          response = await fetch(`/api/agents/${agentId}/integrations`, {
            method: 'POST',
            headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
            body: JSON.stringify(body)
          });
        }
        
        if (response.ok) {
          closeIntegrationModal();
          // Refresh agent details and integrations view
          const agent = agents.find(a => a.id === agentId);
          if (agent) agent._detailsLoaded = false;
          await selectAgent(agentId);
          await loadSuggestedIntegrations(agentId);
          showNotification('Integration saved successfully', 'success');
        } else {
          const err = await response.json().catch(() => ({}));
          showNotification(err.error || 'Failed to save integration', 'error');
        }
      } catch (err) {
        console.error('Failed to save integration:', err);
        showNotification('Failed to save integration', 'error');
      }
    }
    
    async function removeIntegration(agentId, integrationId) {
      if (!confirm('Remove this integration?')) return;
      
      try {
        const response = await fetch(`/api/agents/${agentId}/integrations/${integrationId}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        
        if (response.ok) {
          // Refresh agent details and integrations view
          const agent = agents.find(a => a.id === agentId);
          if (agent) agent._detailsLoaded = false;
          await selectAgent(agentId);
          await loadSuggestedIntegrations(agentId);
        } else {
          alert('Failed to remove integration');
        }
      } catch (err) {
        console.error('Failed to remove integration:', err);
        alert('Failed to remove integration');
      }
    }
    
    // Load catalog on startup
    loadIntegrationCatalog();

    // ==========================================
    // Right Panel Save Functions
    // ==========================================
    
    async function saveAgentDescription() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Saving...';
      
      try {
        const config = {
          ...(agent.config || {}),
          shortDescription: document.getElementById('agent-short-desc').value,
          detailedPurpose: document.getElementById('agent-purpose').value,
          businessValue: document.getElementById('agent-business-value').value,
          successCriteria: document.getElementById('agent-success-criteria').value,
        };
        
        const name = document.getElementById('agent-display-name').value || agent.name;
        const description = document.getElementById('agent-purpose').value;
        
        await saveAgentToAPI(selectedAgentId, { name, description, config });
        Object.assign(agent, { name, description, config });
        renderElementList();
        
        btn.textContent = '‚úÖ Saved!';
        setTimeout(() => { btn.textContent = 'üíæ Save Description'; btn.disabled = false; }, 1500);
      } catch (err) {
        console.error('Save failed:', err);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => { btn.textContent = 'üíæ Save Description'; btn.disabled = false; }, 2000);
      }
    }
    
    async function saveAgentDesign() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Saving...';
      
      try {
        const config = {
          ...(agent.config || {}),
          pattern: document.getElementById('agent-pattern-design').value,
          decisionAuthority: document.getElementById('agent-decision-design').value,
          autonomyLevel: document.getElementById('agent-autonomy-design').value,
          valueStream: document.getElementById('agent-valuestream-design').value,
          capabilityGroup: document.getElementById('agent-capgroup-design').value,
          objectives: document.getElementById('agent-objectives-design').value.split('\n').filter(s => s.trim()),
          kpis: document.getElementById('agent-kpis-design').value.split('\n').filter(s => s.trim()),
        };
        
        await saveAgentToAPI(selectedAgentId, { config });
        agent.config = config;
        
        btn.textContent = '‚úÖ Saved!';
        setTimeout(() => { btn.textContent = 'üíæ Save Design'; btn.disabled = false; }, 1500);
      } catch (err) {
        console.error('Save failed:', err);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => { btn.textContent = 'üíæ Save Design'; btn.disabled = false; }, 2000);
      }
    }
    
    async function saveAgentConfig() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Saving...';
      
      try {
        const config = {
          ...(agent.config || {}),
          interactionPattern: document.getElementById('agent-interaction-config').value,
          triggers: document.getElementById('agent-triggers-config').value.split(',').map(s => s.trim()).filter(s => s),
          outputs: document.getElementById('agent-outputs-config').value.split(',').map(s => s.trim()).filter(s => s),
          listenTopics: [...tagData['listen-topics']],
          publishTopics: [...tagData['publish-topics']],
          messageTypes: document.getElementById('agent-message-types-config').value.split(',').map(s => s.trim()).filter(Boolean),
          dataStore: {
            database: document.getElementById('agent-db-name-config').value,
            collections: {
              memory: document.getElementById('col-memory').checked,
              state: document.getElementById('col-state').checked,
              tasks: document.getElementById('col-tasks').checked,
              decisions: document.getElementById('col-decisions').checked,
            },
            partitionKey: document.getElementById('agent-partition-key-config').value,
          },
          modelConfig: {
            provider: document.getElementById('agent-model-provider').value,
            deployment: document.getElementById('agent-model-config').value,
            systemPrompt: document.getElementById('agent-system-prompt-config').value,
            maxTokens: parseInt(document.getElementById('agent-max-tokens-config').value) || 4096,
            temperature: parseFloat(document.getElementById('agent-temperature-config').value) || 0.3,
          },
          hitl: {
            approvalRequired: document.getElementById('agent-hitl-required').checked,
            approvalThreshold: document.getElementById('agent-hitl-threshold').value,
            escalationTarget: document.getElementById('agent-hitl-escalation').value,
            timeoutMinutes: parseInt(document.getElementById('agent-hitl-timeout').value) || 60,
          },
        };
        
        await saveAgentToAPI(selectedAgentId, { config });
        agent.config = config;
        
        btn.textContent = '‚úÖ Saved!';
        setTimeout(() => { btn.textContent = 'üíæ Save Configuration'; btn.disabled = false; }, 1500);
      } catch (err) {
        console.error('Save failed:', err);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => { btn.textContent = 'üíæ Save Configuration'; btn.disabled = false; }, 2000);
      }
    }
    
    async function saveAgentToAPI(agentId, updates) {
      const agent = agents.find(a => a.id === agentId);
      const mergedConfig = { ...(agent?.config || {}), ...(updates.config || {}) };
      
      const response = await fetch(`${API_BASE}/${agentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
        body: JSON.stringify({
          name: updates.name,
          description: updates.description,
          config: mergedConfig,
        })
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }
    
    // ==========================================
    // Manifest & Tag Input Functions
    // ==========================================
    
    // Tag input state
    const tagData = { 'listen-topics': [], 'publish-topics': [] };
    
    function handleTagInput(event, field) {
      if (event.key !== 'Enter') return;
      event.preventDefault();
      const input = event.target;
      const value = input.value.trim();
      if (!value || tagData[field].includes(value)) { input.value = ''; return; }
      tagData[field].push(value);
      input.value = '';
      renderTags(field);
    }
    
    function renderTags(field) {
      const container = document.getElementById(`${field}-tags`);
      container.innerHTML = tagData[field].map((tag, i) =>
        `<span class="tag-item">${escapeHtml(tag)}<span class="tag-remove" onclick="removeTag('${field}', ${i})">√ó</span></span>`
      ).join('');
    }
    
    function removeTag(field, index) {
      tagData[field].splice(index, 1);
      renderTags(field);
    }
    
    function getRecommendedModel(pattern) {
      const recs = {
        'orchestrator': { model: 'gpt-4o', temp: 0.1, reason: 'GPT-4o for complex orchestration & planning' },
        'specialist': { model: 'gpt-4o', temp: 0.3, reason: 'GPT-4o for domain-specific expertise' },
        'coordinator': { model: 'gpt-4o-mini', temp: 0.2, reason: 'GPT-4o Mini for efficient coordination' },
        'gatekeeper': { model: 'gpt-4o-mini', temp: 0.1, reason: 'GPT-4o Mini for rule-based gatekeeping' },
        'validator': { model: 'gpt-4o-mini', temp: 0.0, reason: 'GPT-4o Mini for deterministic validation' },
        'router': { model: 'gpt-4o-mini', temp: 0.1, reason: 'GPT-4o Mini for fast routing decisions' },
      };
      return recs[pattern] || { model: 'gpt-4o', temp: 0.3, reason: 'GPT-4o as general-purpose default' };
    }
    
    function updateModelSuggestions() {
      const provider = document.getElementById('agent-model-provider').value;
      const datalist = document.getElementById('model-suggestions');
      const suggestions = {
        'azure-openai': ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-35-turbo'],
        'anthropic': ['claude-sonnet-4-20250514', 'claude-3-5-haiku-20241022', 'claude-opus-4-20250514'],
        'openai': ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'o1-preview'],
      };
      datalist.innerHTML = (suggestions[provider] || []).map(m => `<option value="${m}">`).join('');
    }
    
    function getTopicSuggestions(agentId) {
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return [];
      const related = relationships.filter(r => r.sourceId === agentId || r.targetId === agentId);
      const topics = new Set();
      related.forEach(r => {
        const other = agents.find(a => a.id === (r.sourceId === agentId ? r.targetId : r.sourceId));
        if (other) {
          const name = (other.name || '').toLowerCase().replace(/[^a-z0-9]+/g, '-');
          topics.add(`flowgrid-${name}`);
        }
      });
      // Add common Service Bus topics
      ['flowgrid-s2p', 'flowgrid-r2d', 'flowgrid-r2f', 'flowgrid-d2c'].forEach(t => topics.add(t));
      return [...topics];
    }
    
    function generateManifest(agentId) {
      if (!agentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === agentId);
      if (!agent) return;
      const config = agent.config || {};
      
      const manifest = {
        manifestVersion: '1.0.0',
        agentId: agent.id,
        agentName: agent.name,
        pattern: config.pattern || 'specialist',
        autonomy: config.autonomyLevel || 'supervised',
        purpose: config.detailedPurpose || agent.description || '',
        messaging: {
          listenTopics: tagData['listen-topics'] || [],
          publishTopics: tagData['publish-topics'] || [],
          messageTypes: (document.getElementById('agent-message-types-config')?.value || '').split(',').map(s => s.trim()).filter(Boolean),
          interactionPattern: document.getElementById('agent-interaction-config')?.value || 'event-driven',
        },
        dataStore: {
          database: document.getElementById('agent-db-name-config')?.value || 'flowgrid-agents',
          collections: {
            memory: document.getElementById('col-memory')?.checked ?? true,
            state: document.getElementById('col-state')?.checked ?? true,
            tasks: document.getElementById('col-tasks')?.checked ?? true,
            decisions: document.getElementById('col-decisions')?.checked ?? true,
          },
          partitionKey: document.getElementById('agent-partition-key-config')?.value || '/tenantId',
        },
        model: {
          provider: document.getElementById('agent-model-provider')?.value || 'azure-openai',
          deployment: document.getElementById('agent-model-config')?.value || 'gpt-4o',
          systemPrompt: document.getElementById('agent-system-prompt-config')?.value || '',
          maxTokens: parseInt(document.getElementById('agent-max-tokens-config')?.value) || 4096,
          temperature: parseFloat(document.getElementById('agent-temperature-config')?.value) || 0.3,
        },
        capabilities: (agent.capabilities || []).map(c => c.capability_name || c.name || c),
        tools: [...(agent.integrations || []).map(i => i.integration_name || i.integration_type), ...(agent.tools || []).map(t => t.name)],
        hitl: {
          approvalRequired: document.getElementById('agent-hitl-required')?.checked || false,
          approvalThreshold: document.getElementById('agent-hitl-threshold')?.value || 'high-risk-only',
          escalationTarget: document.getElementById('agent-hitl-escalation')?.value || '',
          timeoutMinutes: parseInt(document.getElementById('agent-hitl-timeout')?.value) || 60,
        },
        relationships: {
          reportsTo: (() => {
            const incoming = relationships.filter(r => r.targetId === agentId && r.type === 'delegates');
            return incoming.length ? agents.find(a => a.id === incoming[0].sourceId)?.name || '' : '';
          })(),
          handsOffTo: relationships.filter(r => r.sourceId === agentId).map(r => agents.find(a => a.id === r.targetId)?.name).filter(Boolean),
          receivesFrom: relationships.filter(r => r.targetId === agentId).map(r => agents.find(a => a.id === r.sourceId)?.name).filter(Boolean),
        },
        runtime: {
          target: document.getElementById('deploy-target')?.value || 'azure-functions',
          subscription: document.getElementById('deploy-subscription')?.value || 'mcpp',
          resourceGroup: document.getElementById('deploy-resource-group')?.value || 'rg-flowgrid-dev',
          region: document.getElementById('deploy-region')?.value || 'westeurope',
          functionAppName: document.getElementById('deploy-func-name')?.value || `func-${(agent.name || 'agent').toLowerCase().replace(/[^a-z0-9]+/g, '-')}`,
        },
      };
      
      // Store manifest on agent config
      agent.config = { ...(agent.config || {}), manifest, manifestGeneratedAt: new Date().toISOString() };
      
      // Validate & render
      const validation = validateManifest(manifest);
      renderManifest(manifest);
      renderManifestValidation(validation);
      updateDeployManifestStatus(agent);
      updateDeployInfraRequirements(manifest);
      
      return manifest;
    }
    
    function validateManifest(manifest) {
      const errors = [];
      const required = ['manifestVersion', 'agentId', 'agentName', 'pattern', 'autonomy'];
      required.forEach(field => { if (!manifest[field]) errors.push(`Missing: ${field}`); });
      if (!manifest.messaging?.listenTopics?.length) errors.push('Missing: messaging.listenTopics');
      if (!manifest.model?.deployment) errors.push('Missing: model.deployment');
      // Cross-reference agents
      if (manifest.hitl?.escalationTarget) {
        const exists = agents.find(a => a.name === manifest.hitl.escalationTarget);
        if (!exists) errors.push(`Escalation target "${manifest.hitl.escalationTarget}" not found in network`);
      }
      return { valid: errors.length === 0, errors };
    }
    
    function renderManifest(manifest) {
      const el = document.getElementById('manifest-display');
      el.textContent = JSON.stringify(manifest, null, 2);
      const ts = document.getElementById('manifest-timestamp');
      ts.textContent = `Generated: ${new Date().toLocaleTimeString()}`;
    }
    
    function renderManifestValidation(validation) {
      const bar = document.getElementById('manifest-validation-bar');
      bar.style.display = 'block';
      if (validation.valid) {
        bar.className = 'manifest-valid';
        bar.textContent = '‚úÖ Manifest valid';
      } else {
        bar.className = 'manifest-invalid';
        bar.textContent = '‚ùå ' + validation.errors.join(', ');
      }
    }
    
    function toggleManifestEdit(enabled) {
      document.getElementById('manifest-display').contentEditable = enabled ? 'true' : 'false';
      document.getElementById('manifest-display').style.border = enabled ? '1px solid #f59e0b' : 'none';
    }
    
    function copyManifest() {
      const text = document.getElementById('manifest-display').textContent;
      navigator.clipboard.writeText(text);
    }
    
    function downloadManifest() {
      const text = document.getElementById('manifest-display').textContent;
      const agent = agents.find(a => a.id === selectedAgentId);
      const name = (agent?.name || 'agent').toLowerCase().replace(/[^a-z0-9]+/g, '-');
      downloadFile(`${name}-manifest.json`, text, 'application/json');
    }
    
    function downloadFile(filename, content, type) {
      const blob = new Blob([content], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    
    function generateBicep(manifest) {
      const name = (manifest.agentName || 'agent').toLowerCase().replace(/[^a-z0-9]+/g, '-');
      const collections = Object.entries(manifest.dataStore?.collections || {}).filter(([,v]) => v).map(([k]) => k);
      const topics = [...new Set([...(manifest.messaging?.listenTopics || []), ...(manifest.messaging?.publishTopics || [])])];
      
      return `// Bicep template for ${manifest.agentName}
// Generated by FlowGrid Design Module

param location string = '${manifest.runtime?.region || 'westeurope'}'
param environment string = 'dev'

// Service Bus Topics
resource serviceBusNamespace 'Microsoft.ServiceBus/namespaces@2022-10-01-preview' existing = {
  name: 'sb-flowgrid-\${environment}'
}

${topics.map(t => `resource topic_${t.replace(/[^a-zA-Z0-9]/g, '_')} 'Microsoft.ServiceBus/namespaces/topics@2022-10-01-preview' = {
  parent: serviceBusNamespace
  name: '${t}'
  properties: { maxSizeInMegabytes: 1024 }
}
`).join('\n')}
// CosmosDB
resource cosmosAccount 'Microsoft.DocumentDB/databaseAccounts@2023-11-15' existing = {
  name: 'cosmos-flowgrid-\${environment}'
}

resource database 'Microsoft.DocumentDB/databaseAccounts/sqlDatabases@2023-11-15' = {
  parent: cosmosAccount
  name: '${manifest.dataStore?.database || 'flowgrid-agents'}'
  properties: { resource: { id: '${manifest.dataStore?.database || 'flowgrid-agents'}' } }
}

${collections.map(c => `resource container_${c} 'Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers@2023-11-15' = {
  parent: database
  name: '${c}'
  properties: {
    resource: { id: '${c}', partitionKey: { paths: ['${manifest.dataStore?.partitionKey || '/tenantId'}'], kind: 'Hash' } }
  }
}
`).join('\n')}
// Function App
resource functionApp 'Microsoft.Web/sites@2023-01-01' = {
  name: '${manifest.runtime?.functionAppName || `func-${name}`}'
  location: location
  kind: 'functionapp'
  properties: {
    siteConfig: {
      appSettings: [
        { name: 'COSMOS_DATABASE', value: '${manifest.dataStore?.database || 'flowgrid-agents'}' }
        { name: 'SERVICE_BUS_CONNECTION', value: '@Microsoft.KeyVault(SecretUri=...)' }
        { name: 'OPENAI_DEPLOYMENT', value: '${manifest.model?.deployment || 'gpt-4o'}' }
      ]
    }
  }
}
`;
    }
    
    function generateBicepCode() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      const manifest = agent?.config?.manifest;
      if (!manifest) return alert('Generate manifest first');
      const bicep = generateBicep(manifest);
      document.getElementById('bicep-code').textContent = bicep;
      document.getElementById('bicep-container').style.display = 'block';
    }
    
    function downloadManifestPackage(agentId) {
      if (!agentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === agentId);
      if (!agent?.config?.manifest) return alert('Generate manifest first');
      const manifest = agent.config.manifest;
      const name = (agent.name || 'agent').toLowerCase().replace(/[^a-z0-9]+/g, '-');
      
      // Build a text representation of the package structure
      const pkg = `üì¶ ${name}-package/
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ index.js (${agent.config.generatedCode ? 'generated' : 'not yet generated'})
‚îî‚îÄ‚îÄ infra/
    ‚îî‚îÄ‚îÄ main.bicep

--- manifest.json ---
${JSON.stringify(manifest, null, 2)}

--- infra/main.bicep ---
${generateBicep(manifest)}

${agent.config.generatedCode ? `--- src/index.js ---\n${agent.config.generatedCode}` : '// Generate Function App Code first'}`;
      
      downloadFile(`${name}-package.txt`, pkg, 'text/plain');
    }
    
    function checkInfraRequirements(manifest) {
      // Stub - returns mock status data
      const topics = [...new Set([...(manifest.messaging?.listenTopics || []), ...(manifest.messaging?.publishTopics || [])])];
      const results = [];
      topics.forEach(t => results.push({ type: 'Service Bus Topic', name: t, status: Math.random() > 0.5 ? 'exists' : 'needs-creation' }));
      results.push({ type: 'CosmosDB Database', name: manifest.dataStore?.database || 'flowgrid-agents', status: 'exists' });
      results.push({ type: 'Azure OpenAI', name: manifest.model?.deployment || 'gpt-4o', status: 'exists' });
      return results;
    }
    
    function updateDeployManifestStatus(agent) {
      const manifest = agent?.config?.manifest;
      const badge = document.getElementById('deploy-manifest-badge');
      const version = document.getElementById('deploy-manifest-version');
      const text = document.getElementById('deploy-manifest-text');
      if (!badge) return;
      
      if (manifest) {
        const validation = validateManifest(manifest);
        badge.className = `status-badge ${validation.valid ? 'success' : 'warning'}`;
        badge.textContent = validation.valid ? '‚úÖ Valid' : '‚ö†Ô∏è Has Issues';
        version.textContent = `v${manifest.manifestVersion} ‚Ä¢ ${new Date(agent.config.manifestGeneratedAt).toLocaleTimeString()}`;
        text.innerHTML = validation.valid 
          ? 'Manifest ready for deployment.' 
          : `Issues: ${validation.errors.join(', ')}. <a href="#" onclick="showDetailTab('code'); return false;" style="color:#60a5fa;">Fix in Code tab</a>`;
      } else {
        badge.className = 'status-badge warning';
        badge.textContent = '‚ö†Ô∏è Not Generated';
        version.textContent = '';
        text.innerHTML = '<a href="#" onclick="showDetailTab(\'code\'); return false;" style="color:#60a5fa;">Generate manifest</a> in the Code tab first.';
      }
    }
    
    function updateDeployInfraRequirements(manifest) {
      const container = document.getElementById('deploy-infra-requirements');
      if (!container || !manifest) return;
      const reqs = checkInfraRequirements(manifest);
      container.innerHTML = `<div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.5rem;">This agent requires:</div>` +
        reqs.map(r => {
          const icon = r.status === 'exists' ? '‚úÖ' : '‚ö†Ô∏è';
          return `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0;font-size:0.8rem;">
            <span>${icon}</span><span style="color:#64748b;">${r.type}:</span><span style="color:#e2e8f0;">${escapeHtml(r.name)}</span>
            <span style="font-size:0.7rem;color:${r.status === 'exists' ? '#34d399' : '#fbbf24'};">${r.status === 'exists' ? 'exists' : 'needs creation'}</span>
          </div>`;
        }).join('');
    }
    
    function populateEscalationTargets() {
      const select = document.getElementById('agent-hitl-escalation');
      if (!select) return;
      const currentId = selectedAgentId;
      select.innerHTML = '<option value="">-- Select Agent --</option>' +
        agents.filter(a => a.id !== currentId && (a.elementType === 'Agent' || !a.elementType))
          .map(a => `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`).join('');
    }
    
    function showModelRecommendation(pattern) {
      const rec = getRecommendedModel(pattern);
      const recDiv = document.getElementById('model-recommendation');
      const recText = document.getElementById('model-rec-text');
      if (pattern && recDiv) {
        recDiv.style.display = 'block';
        recText.textContent = `Recommended: ${rec.reason}`;
      } else if (recDiv) {
        recDiv.style.display = 'none';
      }
    }

    // ==========================================
    // Verify Functions
    // ==========================================
    
    function updateVerifyChecklist(agent) {
      const config = agent.config || {};
      const checks = {
        name: !!agent.name,
        purpose: !!(config.detailedPurpose || agent.description),
        pattern: !!config.pattern,
        integrations: (agent.integrations || []).length > 0,
        relationships: (agent.interactions || []).length > 0,
      };
      
      // Integrations are optional, so handle differently
      const optionalChecks = ['integrations'];
      
      document.querySelectorAll('#verify-checklist .verify-item').forEach(item => {
        const check = item.dataset.check;
        const badge = item.querySelector('.status-badge');
        const isOptional = optionalChecks.includes(check);
        
        if (checks[check]) {
          badge.className = 'status-badge success';
          badge.textContent = '‚úÖ';
        } else if (isOptional) {
          // Optional checks show info (blue) instead of warning
          badge.className = 'status-badge info';
          badge.textContent = '‚è≥';
        } else {
          badge.className = 'status-badge warning';
          badge.textContent = '‚ö†Ô∏è';
        }
      });
    }
    
    function runVerification() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      updateVerifyChecklist(agent);
      
      const config = agent.config || {};
      const issues = [];
      const warnings = [];
      
      // Required checks
      if (!agent.name) issues.push('Agent name is missing');
      if (!config.detailedPurpose && !agent.description) issues.push('Purpose is not defined');
      if (!config.pattern) issues.push('Agentic pattern not selected');
      if (!(agent.interactions || []).length) issues.push('No relationships defined with other agents');
      
      // Optional checks (warnings only)
      if (!(agent.integrations?.length)) warnings.push('No tools configured (optional)');
      
      const resultsEl = document.getElementById('verify-results');
      if (issues.length === 0 && warnings.length === 0) {
        resultsEl.innerHTML = '<div style="color: #10b981;">‚úÖ All checks passed! Agent is ready for deployment.</div>';
      } else if (issues.length === 0) {
        resultsEl.innerHTML = `<div style="color: #10b981;">‚úÖ Required checks passed!</div>${warnings.length ? `<div style="color: #94a3b8; margin-top: 0.5rem; font-size: 0.85rem;"><strong>Suggestions:</strong><ul style="margin-top: 0.25rem;">${warnings.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}`;
      } else {
        resultsEl.innerHTML = `<div style="color: #f59e0b;">‚ö†Ô∏è ${issues.length} issue(s) found:</div><ul style="color: #94a3b8; margin-top: 0.5rem; font-size: 0.85rem;">${issues.map(i => `<li>${i}</li>`).join('')}</ul>${warnings.length ? `<div style="color: #94a3b8; margin-top: 0.75rem; font-size: 0.85rem;"><strong>Suggestions:</strong><ul style="margin-top: 0.25rem;">${warnings.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}`;
      }
    }
    
    // ==========================================
    // Deploy Functions
    // ==========================================
    
    // updateDeployStatus is defined earlier - this duplicate removed
    
    // ==========================================
    // Deploy Tab Functions
    // ==========================================
    
    let deploymentTarget = 'azure-functions';
    let deploymentConfig = {
      subscription: 'mcpp',
      resourceGroup: 'rg-flowgrid-dev',
      region: 'westeurope',
      funcName: ''
    };
    
    function updateDeployTarget(target) {
      deploymentTarget = target;
      const azureSection = document.getElementById('azure-config-section');
      if (azureSection) {
        azureSection.style.display = target === 'local-docker' ? 'none' : 'block';
      }
      updateDeployChecklist();
    }
    
    function updateDeployConfig() {
      deploymentConfig.subscription = document.getElementById('deploy-subscription')?.value || 'mcpp';
      deploymentConfig.resourceGroup = document.getElementById('deploy-resource-group')?.value || 'rg-flowgrid-dev';
      deploymentConfig.region = document.getElementById('deploy-region')?.value || 'westeurope';
      deploymentConfig.funcName = document.getElementById('deploy-func-name')?.value || '';
    }
    
    function updateDeployChecklist() {
      if (!selectedAgentId) return;
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const config = agent.config || {};
      const checks = [
        {
          id: 'code',
          label: 'Code generated',
          passed: !!config.generatedCode || document.getElementById('agent-code')?.textContent?.includes('export default'),
          hint: 'Generate code in the Code tab'
        },
        {
          id: 'config',
          label: 'Agent configuration complete',
          passed: !!(config.model && config.systemPrompt),
          hint: 'Configure model and system prompt'
        },
        {
          id: 'secrets',
          label: 'Integration secrets configured',
          passed: true, // For now, assume ok
          hint: 'Configure API keys in integrations'
        },
        {
          id: 'bpmn',
          label: 'BPMN process defined',
          passed: !!config.bpmnXml,
          hint: 'Create a process in the BPMN tab',
          optional: true
        }
      ];
      
      const container = document.getElementById('checklist-items');
      if (!container) return;
      
      container.innerHTML = checks.map(check => `
        <div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.35rem 0; ${check.optional ? 'opacity: 0.6;' : ''}">
          <span style="flex-shrink: 0;">${check.passed ? '‚úÖ' : '‚ö†Ô∏è'}</span>
          <div>
            <div style="color: ${check.passed ? '#e2e8f0' : '#fbbf24'};">${check.label}${check.optional ? ' (optional)' : ''}</div>
            ${!check.passed && check.hint ? `<div style="font-size: 0.8rem; color: #64748b; margin-top: 0.15rem;">${check.hint}</div>` : ''}
          </div>
        </div>
      `).join('');
      
      // Enable/disable deploy button based on required checks
      const requiredPassed = checks.filter(c => !c.optional).every(c => c.passed);
      const deployBtn = document.getElementById('deploy-btn');
      if (deployBtn) {
        deployBtn.disabled = !requiredPassed;
        deployBtn.style.opacity = requiredPassed ? '1' : '0.5';
      }
    }
    
    function renderDeployStatus(agent) {
      const deployment = agent?.config?.deployment || {};
      const isDeployed = deployment.status === 'running';
      
      // Update status badge
      const badge = document.getElementById('deploy-status-badge');
      if (badge) {
        if (isDeployed) {
          badge.className = 'status-badge success';
          badge.textContent = 'üü¢ Running';
        } else if (deployment.status === 'stopped') {
          badge.className = 'status-badge warning';
          badge.textContent = 'üü° Stopped';
        } else if (deployment.status === 'failed') {
          badge.className = 'status-badge error';
          badge.textContent = 'üî¥ Failed';
        } else {
          badge.className = 'status-badge info';
          badge.textContent = '‚è≥ Not Deployed';
        }
      }
      
      // Update version
      const versionEl = document.getElementById('deploy-version');
      if (versionEl) {
        versionEl.textContent = deployment.version ? `v${deployment.version}` : '';
      }
      
      // Update URL
      const urlContainer = document.getElementById('deploy-url-container');
      const urlEl = document.getElementById('deploy-url');
      if (urlContainer && urlEl) {
        if (deployment.url) {
          urlContainer.style.display = 'block';
          urlEl.href = deployment.url;
          urlEl.textContent = deployment.url;
        } else {
          urlContainer.style.display = 'none';
        }
      }
      
      // Update status text
      const statusText = document.getElementById('deploy-status-text');
      if (statusText) {
        if (isDeployed) {
          statusText.textContent = `Last deployed: ${deployment.lastDeployed ? new Date(deployment.lastDeployed).toLocaleString() : 'Unknown'}`;
        } else if (deployment.status === 'failed') {
          statusText.textContent = `Deployment failed: ${deployment.error || 'Unknown error'}`;
        } else {
          statusText.textContent = 'This agent has not been deployed yet.';
        }
      }
      
      // Show/hide action buttons
      const actionsEl = document.getElementById('deploy-actions');
      if (actionsEl) {
        actionsEl.style.display = deployment.status ? 'flex' : 'none';
      }
      
      // Update function name if not set
      const funcNameEl = document.getElementById('deploy-func-name');
      if (funcNameEl && !funcNameEl.value && agent?.name) {
        funcNameEl.value = `func-${agent.name.toLowerCase().replace(/\s+/g, '-')}`;
      }
      
      // Render deployment history
      renderDeployHistory(deployment.history || []);
      
      // Update checklist
      updateDeployChecklist();
    }
    
    function renderDeployHistory(history) {
      const container = document.getElementById('deploy-history');
      if (!container) return;
      
      if (!history || history.length === 0) {
        container.innerHTML = '<div style="color: #64748b; font-size: 0.85rem; padding: 0.5rem;">No deployment history</div>';
        return;
      }
      
      container.innerHTML = history.slice(0, 10).map((item, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${i % 2 === 0 ? '#0f172a' : 'transparent'}; border-radius: 4px; font-size: 0.8rem;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: ${item.status === 'success' ? '#10b981' : '#ef4444'};">${item.status === 'success' ? '‚úÖ' : '‚ùå'}</span>
            <span style="color: #94a3b8;">#${history.length - i}</span>
            <span style="color: #64748b;">${new Date(item.timestamp).toLocaleString()}</span>
          </div>
          <span style="color: #60a5fa;">v${item.version || '1.0.0'}</span>
        </div>
      `).join('');
    }
    
    async function deployAgent() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const deployBtn = document.getElementById('deploy-btn');
      const originalText = deployBtn.innerHTML;
      deployBtn.innerHTML = '‚è≥ Deploying...';
      deployBtn.disabled = true;
      
      try {
        // Simulate deployment (replace with actual API call)
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Update agent with deployment info
        const deployment = agent.config?.deployment || {};
        const newVersion = deployment.version ? (parseFloat(deployment.version) + 0.1).toFixed(1) : '1.0';
        
        agent.config = {
          ...agent.config,
          deployment: {
            status: 'running',
            url: `https://${deploymentConfig.funcName || 'func-' + agent.name.toLowerCase().replace(/\s+/g, '-')}.azurewebsites.net`,
            lastDeployed: new Date().toISOString(),
            version: newVersion,
            target: deploymentTarget,
            resourceGroup: deploymentConfig.resourceGroup,
            region: deploymentConfig.region,
            history: [
              { status: 'success', timestamp: new Date().toISOString(), version: newVersion },
              ...(deployment.history || [])
            ].slice(0, 10)
          }
        };
        
        // Save to backend (mock for now)
        // await saveAgentConfig(agent);
        
        renderDeployStatus(agent);
        alert(`‚úÖ Agent deployed successfully!\n\nURL: ${agent.config.deployment.url}`);
        
      } catch (err) {
        alert(`‚ùå Deployment failed: ${err.message}`);
      } finally {
        deployBtn.innerHTML = originalText;
        deployBtn.disabled = false;
      }
    }
    
    function viewDeployLogs() {
      const agent = agents.find(a => a.id === selectedAgentId);
      const url = agent?.config?.deployment?.url;
      if (url) {
        window.open(`https://portal.azure.com/#view/WebsitesExtension/FunctionMenuBlade/~/log`, '_blank');
      } else {
        alert('No deployment found. Deploy the agent first.');
      }
    }
    
    async function redeployAgent() {
      if (confirm('Are you sure you want to redeploy this agent?')) {
        await deployAgent();
      }
    }
    
    function stopAgent() {
      if (!selectedAgentId) return;
      if (!confirm('Are you sure you want to stop this agent?')) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (agent?.config?.deployment) {
        agent.config.deployment.status = 'stopped';
        renderDeployStatus(agent);
        alert('Agent stopped.');
      }
    }
    
    function deleteDeployment() {
      if (!selectedAgentId) return;
      if (!confirm('Are you sure you want to delete this deployment? This will remove it from Azure.')) return;
      
      const agent = agents.find(a => a.id === selectedAgentId);
      if (agent?.config) {
        delete agent.config.deployment;
        renderDeployStatus(agent);
        alert('Deployment deleted.');
      }
    }
    
    function deleteAgent() {
      if (!selectedAgentId) return;
      if (!confirm('Are you sure you want to delete this agent? This cannot be undone.')) return;
      // TODO: Implement delete API call
      alert('Delete functionality coming soon.');
    }
    
    function exportAgentJSON() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const json = JSON.stringify(agent, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${agent.name.replace(/\s+/g, '-').toLowerCase()}-a2a.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function exportAgentCode() {
      const code = document.getElementById('agent-code').textContent;
      if (!code || code.includes('Click "Generate')) {
        return alert('Generate code first before exporting.');
      }
      
      const blob = new Blob([code], { type: 'text/typescript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'index.ts';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // ==========================================
    // Code Generation
    // ==========================================
    
    async function generateCode() {
      if (!selectedAgentId) return alert('No agent selected');
      const agent = agents.find(a => a.id === selectedAgentId);
      if (!agent) return;
      
      const codeEl = document.getElementById('agent-code');
      codeEl.textContent = '// ‚è≥ Generating Azure Functions code...\n// This may take a moment...';
      
      try {
        const response = await fetch('/api/wizard/generate-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
          body: JSON.stringify({ agentId: agent.id, agent })
        });
        
        if (response.ok) {
          const result = await response.json();
          codeEl.textContent = result.code || '// No code generated';
        } else {
          codeEl.textContent = `// ‚ùå Error generating code: HTTP ${response.status}`;
        }
      } catch (err) {
        codeEl.textContent = `// ‚ùå Error: ${err.message}`;
      }
    }
    
    function copyCode() {
      const code = document.getElementById('agent-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('Code copied to clipboard!');
      });
    }
  </script>

  <!-- Agent Configuration Modal -->
  <div id="agent-config-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="config-modal-title">ü§ñ Agent Configuration</h3>
        <button class="modal-close" onclick="closeAgentConfigModal()">√ó</button>
      </div>
      <input type="hidden" id="config-agent-id">

      <!-- Basic Information -->
      <div class="modal-section">
        <h4>üìã Basic Information</h4>
        <label>Agent Name</label>
        <input type="text" id="config-agent-name">
        <div class="form-group">
          <label>Value Stream</label>
          <input type="text" id="config-agent-valuestream">
        </div>
        <!-- Capability Group hidden -->
        <div style="display: none;">
          <label>Capability Group</label>
          <input type="text" id="config-agent-capgroup">
        </div>
        <label>Purpose</label>
        <textarea id="config-agent-purpose" rows="2"></textarea>
        <label>Objectives (one per line)</label>
        <textarea id="config-agent-objectives" rows="3" placeholder="Reduce incident resolution time by 30%&#10;Automate routine ticket triage&#10;Improve SLA compliance to 95%"></textarea>
        <label>Capabilities (comma-separated)</label>
        <textarea id="config-agent-capabilities" rows="2"></textarea>
      </div>

      <!-- Behavior -->
      <div class="modal-section">
        <h4>‚öôÔ∏è Behavior</h4>
        <div class="form-row">
          <div>
            <label>Agent Pattern</label>
            <select id="config-agent-pattern">
              <option value="">-- Select --</option>
              <option value="Specialist">Specialist</option>
              <option value="Orchestrator">Orchestrator</option>
              <option value="Monitor">Monitor</option>
              <option value="Coordinator">Coordinator</option>
              <option value="Validator">Validator</option>
              <option value="Executor">Executor</option>
              <option value="Router">Router</option>
              <option value="Transformer">Transformer</option>
            </select>
          </div>
          <div>
            <label>Decision Authority</label>
            <select id="config-agent-decision">
              <option value="">-- Select --</option>
              <option value="propose-only">Propose Only</option>
              <option value="propose-and-execute">Propose & Execute</option>
              <option value="autonomous-low-risk">Autonomous (Low Risk)</option>
              <option value="fully-autonomous">Fully Autonomous</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Autonomy Level</label>
            <select id="config-agent-autonomy">
              <option value="">-- Select --</option>
              <option value="full">Full</option>
              <option value="supervised">Supervised</option>
              <option value="human-in-loop">Human in Loop</option>
            </select>
          </div>
          <div>
            <label>Risk Appetite</label>
            <select id="config-agent-risk">
              <option value="">-- Select --</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Interactions -->
      <div class="modal-section">
        <h4>üîó Interactions</h4>
        <label>Interaction Pattern</label>
        <select id="config-agent-interaction">
          <option value="">-- Select --</option>
          <option value="request-response">Request-Response</option>
          <option value="event-driven">Event-Driven</option>
          <option value="publish-subscribe">Publish-Subscribe</option>
          <option value="orchestrated">Orchestrated</option>
          <option value="collaborative">Collaborative</option>
        </select>
        <label>Triggers (comma-separated)</label>
        <input type="text" id="config-agent-triggers" placeholder="demand data update, forecast request">
        <label>Outputs (comma-separated)</label>
        <input type="text" id="config-agent-outputs" placeholder="demand analysis, capacity recommendations">
        <label>Escalation Path</label>
        <input type="text" id="config-agent-escalation" placeholder="IT Manager, Service Owner">
      </div>

      <!-- LLM Configuration hidden - all agents use same model for now -->
      <div class="modal-section" style="display: none;">
        <h4>ü§ñ LLM Model Configuration</h4>
        <label>Default Model</label>
        <select id="config-agent-model">
          <option value="">-- Select --</option>
          <option value="claude-sonnet">Claude Sonnet</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4o-mini">GPT-4o Mini</option>
          <option value="gemini-pro">Gemini Pro</option>
        </select>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeAgentConfigModal()">Cancel</button>
        <button class="btn-save" onclick="saveAgentConfigModal()">üíæ Save</button>
      </div>
    </div>
  </div>
<!-- Integration Configuration Modal -->
  <div id="integration-config-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><span id="integration-modal-icon">üîå</span> <span id="integration-modal-title">Configure Integration</span></h3>
        <button class="modal-close" onclick="closeIntegrationModal()">√ó</button>
      </div>
      <input type="hidden" id="integration-agent-id">
      <input type="hidden" id="integration-id">
      <input type="hidden" id="integration-name-hidden">
      
      <div style="text-align: center; margin-bottom: 1rem;">
        <div id="integration-modal-big-icon" class="integration-icon">üîå</div>
        <span id="integration-modal-type" class="integration-type-badge">Integration</span>
      </div>

      <label>Endpoint URL</label>
      <input type="url" id="integration-endpoint" placeholder="https://api.example.com/v1">

      <label>Authentication Type</label>
      <select id="integration-auth-type">
        <option value="API Key">API Key</option>
        <option value="OAuth2">OAuth 2.0</option>
        <option value="Basic Auth">Basic Auth</option>
        <option value="Bearer Token">Bearer Token</option>
        <option value="None">None</option>
      </select>

      <label>API Key / Token</label>
      <input type="password" id="integration-api-key" placeholder="Enter your API key or token">

      <label>Additional Notes</label>
      <textarea id="integration-notes" rows="2" placeholder="Any configuration notes..."></textarea>

      <div class="btn-row">
        <button class="btn-cancel" onclick="closeIntegrationModal()">Cancel</button>
        <button class="btn-save" onclick="saveIntegrationConfig()">üíæ Save Configuration</button>
      </div>
    </div>
  </div>

<!-- Skill Modal -->
  <div id="skill-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: #1e293b; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid #334155;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #334155;">
        <h3 style="color: #a78bfa; margin: 0;">üõ†Ô∏è <span id="skill-modal-title">Add Skill</span></h3>
        <button onclick="closeSkillModal()" style="background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer;">√ó</button>
      </div>
      <div style="padding: 1rem;">
        <input type="hidden" id="skill-id">
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">Display Name *</label>
          <input type="text" id="skill-display-name" placeholder="e.g., Analyze Incident" oninput="updateSkillName()">
        </div>
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">ID (auto-generated)</label>
          <input type="text" id="skill-name" placeholder="analyze_incident" readonly style="background: #0f172a; color: #64748b;">
        </div>
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">Description *</label>
          <textarea id="skill-description" rows="2" placeholder="What does this skill do?"></textarea>
        </div>
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">Tags (comma-separated)</label>
          <input type="text" id="skill-tags" placeholder="incident, analysis, triage">
        </div>
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">Input Schema (JSON)</label>
          <textarea id="skill-input-schema" rows="3" placeholder='{"type": "object", "properties": {...}}' style="font-family: monospace; font-size: 0.8rem;"></textarea>
        </div>
        
        <div class="form-group">
          <label style="color: #94a3b8; font-size: 0.8rem;">Example Input (JSON)</label>
          <textarea id="skill-example" rows="2" placeholder='{"incidentId": "INC001"}' style="font-family: monospace; font-size: 0.8rem;"></textarea>
        </div>
        
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button class="btn btn-secondary" style="flex: 1;" onclick="closeSkillModal()">Cancel</button>
          <button class="btn btn-success" style="flex: 1;" onclick="saveSkill()">üíæ Save Skill</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
